<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">CalPanda</title>
    <!-- Incluye Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Fondo muy claro, casi blanco */
            color: #334155; /* Texto principal en gris oscuro */
        }
        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content horizontally */
        }
        .header-section {
            width: 750px; /* Match container width */
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align items to the top */
            padding: 1.5rem 2.5rem 0rem 2.5rem; /* Top padding, match container horizontal padding */
            box-sizing: border-box; /* Include padding in width */
        }
        .container {
            max-width: 750px; /* Ancho ajustado para parecer una hoja A4 */
            margin: 1.5rem auto; /* Margen superior/inferior aumentado, espacio después del header */
            padding: 2.5rem; /* Relleno aumentado */
            background-color: #ffffff;
            border-radius: 16px; /* Esquinas más redondeadas */
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 8px 15px -8px rgba(0, 0, 0, 0.08); /* Sombra más profunda y refinada */
            position: relative;
            border: 1px solid #e2e8f0; /* Borde sutil */
        }
        input[type="text"], input[type="number"], input[type="date"] {
            border-radius: 8px;
            padding: 0.8rem 1rem; /* Relleno ligeramente mayor */
            border: 1px solid #cbd5e1; /* Borde gris más suave */
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        /* Específico para textarea para mayor padding */
        textarea {
            border-radius: 8px;
            padding: 1.25rem 1.5rem; /* Increased padding specifically for textareas for more internal space */
            border: 1px solid #cbd5e1; /* Borde gris más suave */
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, textarea:focus {
            outline: none;
            border-color: #60a5fa; /* Borde azul al enfocar */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); /* Sombra de enfoque */
        }
        /* Estilo para los inputs que actúan como labels (sin borde, transparente) */
        .editable-label-input {
            background-color: transparent;
            border: none;
            padding: 0;
            font-weight: 600; /* Semi-bold como los labels */
            color: #334155; /* Color de texto como los labels */
            font-size: 1rem; /* Tamaño de fuente estándar */
            height: auto; /* Permitir que la altura se ajuste al contenido */
            box-shadow: none; /* Eliminar sombra predeterminada de input */
            text-align: left; /* Asegurar alineación izquierda */
            width: auto; /* Ajustar ancho al contenido, se estirará por el grid */
        }
        .editable-label-input:focus {
            outline: none;
            border: 1px solid #60a5fa;
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
            padding: 0.2rem 0.4rem;
            margin: -0.2rem -0.4rem;
        }

        button {
            border-radius: 10px; /* Esquinas más redondeadas para botones */
            padding: 0.85rem 1.75rem; /* Relleno ligeramente mayor */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.1s ease-out, box-shadow 0.2s ease-in-out; /* Added color transition */
            
            /* Colores predeterminados para Añadir elemento, Añadir impuesto, Guardar ajuste de factura, y Language Toggle */
            background-color: #e2e8f0; /* Gris claro */
            color: #1f2937; /* Texto gris muy oscuro */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* Sombra de botón */
        }
        /* Hover effect for all buttons except generatePdfBtn and delete-btn */
        button:hover:not(#generatePdfBtn):not(.delete-btn) {
            background-color: #1a1a1a; /* Negro oscuro al pasar el ratón */
            color: white; /* Texto blanco al pasar el ratón */
            transform: translateY(-1px); /* Ligero efecto de levantamiento */
            box-shadow: 0 6px 8px -2px rgba(0, 0, 0, 0.15), 0 3px 5px -3px rgba(0, 0, 0, 0.08);
        }
        button:active {
            transform: translateY(0); /* Vuelve a la posición original al hacer clic */
            box-shadow: none;
        }
        /* Estilos específicos para el botón Generar PDF */
        #generatePdfBtn {
            background-color: #0d9488; /* Color cian para Generar PDF */
            color: white;
        }
        #generatePdfBtn:hover {
            background-color: #0f766e; /* Cian más oscuro al pasar el ratón */
            color: white;
            /* Eliminar transform y box-shadow para hover específicos de este botón */
            transform: none;
            box-shadow: none;
        }
        /* El botón saveLoadConfigBtn ya recibe el estilo base de button */


        .delete-btn {
            background-color: #dc2626; /* Rojo más oscuro para eliminar */
            color: white;
            box-shadow: none; /* Eliminar sombra extra para botones de eliminar */
            width: 28px; /* Fixed width for 'X' button */
            height: 28px; /* Fixed height for 'X' button */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem; /* Larger font for 'X' */
            font-weight: 700;
            border-radius: 50%; /* Make it round */
        }
        .delete-btn:hover {
            background-color: #b91c1c; /* Rojo aún más oscuro */
            transform: none;
            box-shadow: none;
        }
        table {
            width: 100%;
            border-collapse: separate; /* Permite bordes redondeados en la tabla */
            border-spacing: 0;
            margin-top: 1.5rem;
        }
        table thead {
            background-color: #f1f5f9; /* Fondo suave para el encabezado */
        }
        table th {
            padding: 1rem; /* Más padding para los encabezados */
            text-align: left;
            font-weight: 700; /* Más negrita */
            color: #475569; /* Color de texto del encabezado */
            border-bottom: 1px solid #e2e8f0;
        }
        table th:first-child { border-top-left-radius: 8px; }
        table th:last-child { border-top-right-radius: 8px; }

        /* Estilos para los inputs dentro de los THs (encabezados editables) */
        table th input {
            background-color: transparent;
            border: none;
            padding: 0;
            font-weight: inherit;
            color: inherit;
            text-align: inherit; /* Hereda la alineación de la celda */
            transition: all 0.2s ease-in-out;
        }
        table th input:focus {
            outline: none;
            border: 1px solid #60a5fa;
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
            padding: 0.2rem 0.4rem; /* Pequeño padding al enfocar para visibilidad */
            margin: -0.2rem -0.4rem; /* Ajustar el margen para compensar el padding */
        }

        table td {
            padding: 0.9rem; /* Más padding para las celdas */
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        table tbody tr:last-child td {
            border-bottom: none; /* Sin borde inferior en la última fila */
        }
        table tbody tr:hover {
            background-color: #f8fafc; /* Fondo sutil al pasar el ratón por la fila */
        }

        /* Asegurar que los inputs dentro de las celdas de la tabla también se ajusten a los nuevos anchos */
        #invoiceItems input[type="text"],
        #invoiceItems input[type="number"],
        #invoiceItems textarea { /* Added textarea here */
            width: 100%; /* El input ocupa el 100% del ancho de su celda ajustada */
        }

        /* Estilo para la sección de impuestos y totales */
        .total-summary-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-top: 2rem;
            padding: 1rem 0;
            border-top: 1px solid #e2e8f0;
            width: 100%; /* Permite que la sección sea más ancha */
            max-width: 450px; /* Ancho máximo aumentado para este bloque */
            margin-left: auto; /* Alinea a la derecha */
        }

        .tax-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 400px; /* Ancho para las filas de impuesto dentro de la sección */
            margin-bottom: 0.5rem;
        }

        .tax-row input[type="text"] { /* Estilo para el label del impuesto (ej. IVA) */
            width: 120px; /* Ancho fijo para el nombre del impuesto */
            padding: 0.2rem 0.5rem;
            text-align: left;
            font-size: 0.9rem;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            margin-right: 0.5rem;
        }
        .tax-row input[type="text"]:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
        }

        .tax-row input[type="number"] { /* Ancho para el porcentaje del impuesto */
            width: 60px;
            padding: 0.2rem 0.5rem;
            text-align: center;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        /* Nuevo estilo para el botón de operación de impuesto (+/-) */
        .tax-operation-btn {
            background-color: #cbd5e1; /* Gris medio claro */
            color: #334155; /* Texto gris oscuro */
            border-radius: 50%; /* Redondo */
            width: 24px; /* Tamaño fijo */
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 0.9rem;
            margin-right: 0.5rem; /* Espacio a la derecha */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .tax-operation-btn:hover {
            background-color: #94a3b8; /* Gris más oscuro al pasar el ratón */
            color: white;
            transform: scale(1.05);
        }

        .tax-row .delete-tax-btn {
            background-color: #dc2626;
            color: white;
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            border-radius: 6px;
            margin-left: 0.5rem;
            box-shadow: none;
        }
        .tax-row .delete-tax-btn:hover {
            background-color: #b91c1c;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 250px;
            margin-bottom: 0.5rem;
        }

        .total-row span {
            font-weight: 500;
        }

        .final-grand-total {
            background-color: #f1f5f9; /* Gris muy claro para el fondo del total */
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0; /* Borde gris suave */
            margin-top: 1.5rem;
            width: 100%;
            max-width: 250px;
            text-align: right;
            color: #000000; /* Texto negro */
        }

        .final-grand-total span.label,
        .final-grand-total span.value {
            font-size: 1.25rem; /* Mismo tamaño para ambos */
            font-weight: 700; /* Negrita para ambos */
            color: #000000; /* Color negro para la cifra total y la etiqueta */
        }
        .calpanda-logo {
            display: block;
            width: 250px; /* Tamaño del logo en el encabezado */
            height: auto;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Fondo negro semi-transparente */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Asegura que esté encima */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
        }
        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #334155;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #334155;
        }
        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        /* Estilos para los botones del modal */
        .modal-body button {
            background-color: #e2e8f0; /* Gris claro */
            color: #334155; /* Texto gris oscuro */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .modal-body button:hover {
            background-color: #cbd5e1; /* Gris un poco más oscuro al pasar el ratón */
            color: #1a1a1a; /* Texto aún más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }
        .modal-file-input {
            margin-top: 1rem;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
        }
        .modal-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            background-color: #e0f2fe;
            color: #1e40af;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .local-settings-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .local-settings-list-item:last-child {
            border-bottom: none;
        }
        .local-settings-list-item span {
            flex-grow: 1;
            font-weight: 500;
            color: #334155;
        }
        .local-settings-list-item button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            margin-left: 0.5rem;
            border-radius: 6px;
            box-shadow: none;
        }
        .local-settings-list-item button.load-btn {
            background-color: #0d9488; /* Cian */
            color: white;
        }
        .local-settings-list-item button.load-btn:hover {
            background-color: #0f766e; /* Cian más oscuro */
        }
        .local-settings-list-item button.delete-btn-local {
            background-color: #dc2626; /* Rojo */
            color: white;
        }
        .local-settings-list-item button.delete-btn-local:hover {
            background-color: #b91c1c; /* Rojo más oscuro */
        }
        /* Estilos para el input de tipo file para el logo */
        #logoUploadInput {
            display: none; /* Ocultar el input original */
        }
        .logo-preview {
            max-width: 250px; /* Tamaño máximo del logo en la interfaz */
            max-height: 150px;
            border-radius: 8px;
        }
        .logo-container {
            position: static; /* Remove absolute positioning */
            margin: 0; /* Remove default margins */
        }
        .top-right-buttons {
            position: static; /* Remove absolute positioning */
            gap: 1rem; /* Increased gap */
            display: flex; /* Ensure flexbox */
            flex-wrap: nowrap; /* Prevent wrapping */
            justify-content: flex-end; /* Align buttons to the right */
            align-items: center; /* Align items vertically in the center */
        }
        .top-right-buttons button {
            padding: 0.85rem 1.75rem; /* Increased padding */
            font-size: 1rem; /* Larger font */
            white-space: nowrap; /* Ensure text stays on one line */
        }
        .logo-pdf {
            max-width: 100px; /* Tamaño del logo en el PDF */
            max-height: 80px;
        }

        /* Styles for ON/OFF buttons in visibility modal */
        .toggle-button {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            width: 100px; /* Fixed width for consistency */
            text-align: center;
        }
        .toggle-button.on {
            background-color: #10B981; /* Green for ON */
            color: white;
        }
        .toggle-button.off {
            background-color: #EF4444; /* Red for OFF */
            color: white;
        }
        .toggle-button:hover.on {
            background-color: #059669;
        }
        .toggle-button:hover.off {
            background-color: #DC2626;
        }
        .visibility-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .visibility-setting-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="header-section">
            <div class="logo-container">
                <img id="invoiceLogo" src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/calpanda-logo.png" alt="CalPanda Logo" class="calpanda-logo">
                <input type="file" id="logoUploadInput" accept="image/*">
            </div>
            <div class="top-right-buttons">
                <button id="languageToggleBtn" data-key="languageToggleText"></button>
                <button id="toggleVisibilitySettingsBtn" data-key="toggleVisibilitySettingsButton"></button>
                <button id="uploadLogoBtn" data-key="uploadLogoButton"></button>
            </div>
        </div>

        <div class="container">
            <!-- Sección de detalles de la factura -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Columna Izquierda: Datos del Cliente -->
                <div id="clientDataSection">
                    <input type="text" id="clientDataLabelInput" class="editable-label-input block mb-2" data-key="clientDataLabelDefault">
                    <textarea id="clientData" rows="5" data-key="clientDataPlaceholder" placeholder="Nombre del cliente, dirección, CIF, etc." class="focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <!-- Columna Derecha: Número de Factura, Fecha y Datos del Emisor -->
                <div class="flex flex-col gap-6">
                    <!-- Número de Factura y Fecha (arriba a la derecha) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input type="text" id="invoiceNumberLabelInput" class="editable-label-input block mb-2" data-key="invoiceNumberLabelDefault">
                            <input type="text" id="invoiceNumber" data-key="invoiceNumberPlaceholder" placeholder="Ej: INV-2023-001" class="focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <input type="text" id="invoiceDateLabelInput" class="editable-label-input block mb-2" data-key="invoiceDateLabelDefault">
                            <input type="date" id="invoiceDate" class="focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <!-- Datos del Emisor (debajo de Fecha/Número) -->
                    <div id="senderDataSection">
                        <input type="text" id="senderDataLabelInput" class="editable-label-input block mb-2" data-key="senderDataLabelDefault">
                        <textarea id="senderData" rows="5" data-key="senderDataPlaceholder" placeholder="Tu nombre/empresa, dirección, CIF, etc." class="focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- Sección de ítems de la factura con el título editable -->
            <input type="text" id="servicesTitle" value="Servicios" class="text-2xl font-bold text-gray-700 mb-4 w-full text-center" data-key="servicesTitleDefault">
            
            <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th><input type="text" data-key="tableHeaderProject" value="Proyecto" class="bg-transparent font-bold text-gray-700 border-none p-0 w-full text-left"></th>
                            <th class="rate-column-header"><input type="text" data-key="tableHeaderRate" value="Tarifa (€)" class="bg-transparent font-bold text-gray-700 border-none p-0 w-full text-center"></th>
                            <th class="quantity-column-header"><input type="text" data-key="tableHeaderQuantity" value="Volumen" class="bg-transparent font-bold text-gray-700 border-none p-0 w-full text-center"></th>
                            <th><input type="text" data-key="tableHeaderTotal" value="Total (€)" class="bg-transparent font-bold text-gray-700 border-none p-0 w-full text-right"></th>
                            <!-- La columna de Acciones se ha eliminado del encabezado -->
                        </tr>
                    </thead>
                    <tbody id="invoiceItems">
                        <!-- Las filas de los ítems se añadirán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>

            <button id="addItemBtn" class="mt-8 px-6 py-3" data-key="addItemButton">Añadir elemento</button>

            <!-- Sección de Impuestos y Total Final (se mantiene la UI pero no se usa en PDF) -->
            <div class="total-summary-section">
                <div class="total-row">
                    <span data-key="subtotalLabel">Subtotal:</span>
                    <span id="subTotalAmount" class="font-bold">0.00 €</span>
                </div>
                <div id="taxFieldsContainer">
                    <!-- Los campos de impuestos se añadirán aquí dinámicamente -->
                </div>
                <button id="addTaxBtn" class="mt-4 px-4 py-2 text-sm" data-key="addTaxButton">Añadir impuesto</button>

                <div class="final-grand-total">
                    <span class="label" data-key="finalTotalLabel">Total:</span>
                    <span id="grandTotal" class="value">0.00 €</span>
                </div>
            </div>

            <!-- Campo para Información de Pago / Aclaraciones -->
            <div class="mt-8" id="paymentInfoSection">
                <!-- La etiqueta ahora es un input editable -->
                <input type="text" id="paymentInfoLabel" class="editable-label-input block mb-2" data-key="paymentInfoLabelDefault">
                <textarea id="paymentInfo" rows="4" data-key="paymentInfoPlaceholder" placeholder="Condiciones de pago, datos bancarios, notas adicionales, etc." class="focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <!-- Botones de Acción -->
            <div class="mt-8 text-center flex justify-center gap-4">
                <button id="decimalToggleBtn" class="px-4 py-2" data-key="decimalPoint"></button>
                <button id="saveLoadConfigBtn" class="px-6 py-3 text-lg" data-key="saveLoadConfigButton">Guardar / cargar configuración</button>
                <button id="generatePdfBtn" class="px-8 py-4 text-lg" data-key="generatePdfButton">GENERAR PDF</button>
            </div>
        </div>
    </div>

    <!-- Modal para Guardar/Cargar Configuración -->
    <div id="configModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-key="configModalTitle">Guardar / cargar configuración</h3>
                <button class="modal-close-btn" id="closeConfigModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-text-explanation mb-4 text-sm text-gray-700">
                    <p data-key="configModalExplanationTitle" class="font-semibold mb-2">Acerca de la configuración de factura:</p>
                    <p data-key="configModalExplanationPara1" class="mb-1">Guarda o carga tus ajustes de factura para ahorrar tiempo la próxima vez.</p>
                    <p data-key="configModalExplanationPara2" class="mb-1">Por ejemplo, puedes guardar un ajuste por cliente con sus datos, los datos del emisor, impuestos e información de pago.</p>
                    <p data-key="configModalExplanationLocalStorage" class="mb-1">Si lo guardas localmente, se queda almacenado en tu navegador y nadie más puede acceder a esa información.</p>
                    <p data-key="configModalExplanationFile">También puedes descargar un archivo con el ajuste y luego cargarlo en cualquier momento.</p>
                </div>
                <button id="saveToFileBtn" data-key="saveToFileButton">Guardar a archivo</button>
                <button id="loadFromFileBtn" data-key="loadFromFileButton">Cargar desde archivo</button>
                <input type="file" id="fileLoader" class="hidden modal-file-input" accept=".json">
                <button id="saveToLocalBtn" data-key="saveToLocalButton">Guardar localmente</button>
                <button id="loadFromLocalBtn" data-key="loadFromLocalButton">Cargar localmente</button>
            </div>
            <div id="modalMessage" class="modal-message hidden"></div>
        </div>
    </div>

    <!-- New Modal for PDF Naming -->
    <div id="pdfNameModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-key="pdfNameModalTitle">Nombrar archivo PDF</h3>
                <button class="modal-close-btn" id="closePdfNameModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <label for="pdfFileNameInput" class="block text-gray-700 font-semibold mb-2" data-key="pdfFileNameLabel">Nombre del archivo:</label>
                <input type="text" id="pdfFileNameInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="confirmPdfNameBtn" class="mt-4" data-key="confirmPdfNameButton">Generar</button>
            </div>
        </div>
    </div>

    <!-- New Modal for Save to File Naming -->
    <div id="saveFileModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-key="saveFileModalTitle">Guardar configuración como...</h3>
                <button class="modal-close-btn" id="closeSaveFileModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <label for="saveFileNameInput" class="block text-gray-700 font-semibold mb-2" data-key="saveFileNameLabel">Nombre del archivo:</label>
                <input type="text" id="saveFileNameInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="confirmSaveFileNameBtn" class="mt-4" data-key="confirmSaveFileNameButton">Guardar</button>
            </div>
        </div>
    </div>

    <!-- New Modal for Local Save Naming -->
    <div id="saveLocalModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-key="saveLocalModalTitle">Guardar ajuste localmente como...</h3>
                <button class="modal-close-btn" id="closeSaveLocalModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <label for="saveLocalNameInput" class="block text-gray-700 font-semibold mb-2" data-key="saveLocalNameLabel">Nombre del ajuste:</label>
                <input type="text" id="saveLocalNameInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="confirmSaveLocalNameBtn" class="mt-4" data-key="confirmSaveLocalNameButton">Guardar</button>
            </div>
        </div>
    </div>

    <!-- New Modal for Local Load Selection -->
    <div id="loadLocalModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-key="loadLocalModalTitle">Cargar ajuste local</h3>
                <button class="modal-close-btn" id="closeLoadLocalModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-gray-700 mb-4" data-key="loadLocalExplanation">Los ajustes guardados localmente se almacenan en tu navegador y nadie más puede acceder a esta información.</p>
                <ul id="localSettingsList" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                    <!-- Local settings will be listed here -->
                </ul>
            </div>
            <div id="modalMessageLocalLoad" class="modal-message hidden"></div>
        </div>
    </div>

    <!-- New Modal for Visibility Settings -->
    <div id="visibilitySettingsModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-key="visibilitySettingsModalTitle">Mostrar / Ocultar elementos</h3>
                <button class="modal-close-btn" id="closeVisibilitySettingsModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex flex-col gap-2">
                    <div class="visibility-setting-item">
                        <span data-key="toggleRateColumnLabel">Mostrar columna "Tarifa"</span>
                        <button id="toggleRateColumnBtn" class="toggle-button"></button>
                    </div>
                    <div class="visibility-setting-item">
                        <span data-key="toggleQuantityColumnLabel">Mostrar columna "Volumen"</span>
                        <button id="toggleQuantityColumnBtn" class="toggle-button"></button>
                    </div>
                    <div class="visibility-setting-item">
                        <span data-key="toggleClientDataLabel">Mostrar datos del cliente</span>
                        <button id="toggleClientDataBtn" class="toggle-button"></button>
                    </div>
                    <div class="visibility-setting-item">
                        <span data-key="toggleSenderDataLabel">Mostrar datos del emisor</span>
                        <button id="toggleSenderDataBtn" class="toggle-button"></button>
                    </div>
                    <div class="visibility-setting-item">
                        <span data-key="togglePaymentInfoLabel">Mostrar información de pago</span>
                        <button id="togglePaymentInfoBtn" class="toggle-button"></button>
                    </div>
                </div>
                <button id="applyVisibilitySettingsBtn" class="mt-4" data-key="applyVisibilitySettingsButton">Aplicar</button>
            </div>
        </div>
    </div>


    <!-- Incluye jsPDF para la generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Incluye jspdf-autotable para la generación de tablas en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Inicializa jsPDF de la ventana global
        const { jsPDF } = window.jspdf;

        // --- Traducciones ---
        const translations = {
            es: {
                appTitle: "CalPanda",
                clientDataLabelDefault: "Datos del cliente:",
                clientDataPlaceholder: "Nombre del cliente, dirección, CIF, etc.",
                invoiceNumberLabelDefault: "Número de factura:",
                invoiceNumberPlaceholder: "Ej: INV-2023-001",
                invoiceDateLabelDefault: "Fecha:",
                senderDataLabelDefault: "Datos del emisor:",
                senderDataPlaceholder: "Tu nombre/empresa, dirección, CIF, etc.",
                servicesTitleDefault: "Servicios",
                tableHeaderProject: "Proyecto",
                tableHeaderRate: "Tarifa (€)",
                tableHeaderQuantity: "Volumen",
                tableHeaderTotal: "Total (€)",
                tableHeaderActions: "", // Eliminar el texto del encabezado de Acciones
                addItemButton: "Añadir elemento",
                subtotalLabel: "Subtotal:",
                addTaxButton: "Añadir impuesto",
                finalTotalLabel: "Total:",
                generatePdfButton: "GENERAR PDF",
                paymentInfoLabelDefault: "Información de pago:",
                paymentInfoPlaceholder: "Condiciones de pago, datos bancarios, notas adicionales, etc.",
                saveLoadConfigButton: "GUARDAR/CARGAR PLANTILLA", // Updated text
                configModalTitle: "Guardar / cargar configuración",
                saveToFileButton: "Guardar a archivo",
                loadFromFileButton: "Cargar desde archivo",
                saveToLocalButton: "Guardar localmente",
                loadFromLocalButton: "Cargar localmente",
                modalMessageSuccessSaveFile: "Configuración guardada en archivo.",
                modalMessageSuccessLoadFile: "Configuración cargada desde archivo.",
                modalMessageSuccessSaveLocal: "Configuración guardada localmente.",
                modalMessageSuccessLoadLocal: "Configuración cargada localmente.",
                modalMessageErrorLoad: "Error al cargar la configuración.",
                modalMessageErrorParse: "Error: El archivo no es un formato de configuración válido.",
                pdfTitle: "Factura", // Este se elimina en el PDF, pero se mantiene para la traducción del key.
                pdfInvoiceNumber: "Número de factura:",
                pdfDate: "Fecha:",
                pdfClientData: "Datos del cliente:",
                pdfSenderData: "Datos del emisor:",
                pdfServicesTitle: "Servicios",
                pdfSubtotal: "Subtotal:",
                pdfTotal: "Total:",
                pdfPaymentInfo: "Información de pago:",
                deleteButton: "X", // Changed to 'X'
                deleteTaxButton: "Eliminar",
                languageToggleText: "English",
                taxDefaultIvaName: "IVA",
                taxDefaultIrpfName: "IRPF",
                configModalExplanationTitle: "Acerca de la configuración de factura:",
                configModalExplanationPara1: "Guarda o carga tus ajustes de factura para ahorrar tiempo la próxima vez.",
                configModalExplanationPara2: "Por ejemplo, puedes guardar un ajuste por cliente con sus datos, los datos del emisor, impuestos e información de pago.",
                configModalExplanationLocalStorage: "Si lo guardas localmente, se queda almacenado en tu navegador y nadie más puede acceder a esa información.",
                configModalExplanationFile: "También puedes descargar un archivo con el ajuste y luego cargarlo en cualquier momento.",
                pdfNameModalTitle: "Nombrar archivo PDF",
                pdfFileNameLabel: "Nombre del archivo:",
                confirmPdfNameButton: "Generar",
                saveFileModalTitle: "Guardar configuración como...",
                saveFileNameLabel: "Nombre del archivo:",
                confirmSaveFileNameButton: "Guardar",
                saveLocalModalTitle: "Guardar ajuste localmente como...",
                saveLocalNameLabel: "Nombre del ajuste:",
                confirmSaveLocalNameButton: "Guardar",
                loadLocalModalTitle: "Cargar ajuste local",
                loadLocalExplanation: "Los ajustes guardados localmente se almacenan en tu navegador y nadie más puede acceder a esta información.",
                loadLocalLoadButton: "Cargar",
                loadLocalDeleteButton: "Eliminar",
                loadLocalNoSettings: "No hay ajustes guardados localmente.",
                loadLocalConfirmDelete: "¿Estás seguro de que quieres eliminar este ajuste?",
                decimalPoint: "CAMBIAR A COMA (0,00)", // Text when current is POINT
                decimalComma: "CAMBIAR A PUNTO (0.00)",  // Text when current is COMMA
                toggleVisibilitySettingsButton: "Ocultar elementos", // Updated button text
                uploadLogoButton: "Subir logo",
                visibilitySettingsModalTitle: "Mostrar / Ocultar elementos", // New modal title
                toggleRateColumnLabel: "Mostrar columna 'Tarifa'",
                toggleQuantityColumnLabel: "Mostrar columna 'Volumen'",
                toggleClientDataLabel: "Mostrar datos del cliente",
                toggleSenderDataLabel: "Mostrar datos del emisor",
                togglePaymentInfoLabel: "Mostrar información de pago",
                applyVisibilitySettingsButton: "Aplicar",
                onButton: "ON",
                offButton: "OFF"
            },
            en: {
                appTitle: "CalPanda",
                clientDataLabelDefault: "Client details:",
                clientDataPlaceholder: "Client name, address, tax ID, etc.",
                invoiceNumberLabelDefault: "Invoice number:",
                invoiceNumberPlaceholder: "Ex: INV-2023-001",
                invoiceDateLabelDefault: "Date:",
                senderDataLabelDefault: "Sender details:",
                senderDataPlaceholder: "Your name/company, address, tax ID, etc.",
                servicesTitleDefault: "Services",
                tableHeaderProject: "Project",
                tableHeaderRate: "Rate (€)",
                tableHeaderQuantity: "Volume",
                tableHeaderTotal: "Total (€)",
                tableHeaderActions: "", // Remove Actions header text
                addItemButton: "Add item",
                subtotalLabel: "Subtotal:",
                addTaxButton: "Add tax",
                finalTotalLabel: "Total:",
                generatePdfButton: "GENERATE PDF",
                paymentInfoLabelDefault: "Payment information:",
                paymentInfoPlaceholder: "Payment terms, bank details, additional notes, etc.",
                saveLoadConfigButton: "SAVE/LOAD TEMPLATE", // Updated text
                configModalTitle: "Save / load configuration",
                saveToFileButton: "Save to file",
                loadFromFileButton: "Load from file",
                saveToLocalButton: "Save locally",
                loadFromLocalButton: "Load locally",
                modalMessageSuccessSaveFile: "Configuration saved to file.",
                modalMessageSuccessLoadFile: "Configuration loaded from file.",
                modalMessageSuccessSaveLocal: "Configuration saved locally.",
                modalMessageSuccessLoadLocal: "Configuration loaded locally.",
                modalMessageErrorLoad: "Error loading configuration.",
                modalMessageErrorParse: "Error: The file is not a valid configuration format.",
                pdfTitle: "Invoice",
                pdfInvoiceNumber: "Invoice number:",
                pdfDate: "Date:",
                pdfClientData: "Client details:",
                pdfSenderData: "Sender details:",
                pdfServicesTitle: "Services",
                pdfSubtotal: "Subtotal:",
                pdfTotal: "Total:",
                pdfPaymentInfo: "Payment information:",
                deleteButton: "X", // Changed to 'X'
                deleteTaxButton: "Delete",
                languageToggleText: "Español",
                taxDefaultIvaName: "VAT",
                taxDefaultIrpfName: "IRPF",
                configModalExplanationTitle: "About Invoice Configuration:",
                configModalExplanationPara1: "Save and load your invoice settings to save time in the future.",
                configModalExplanationPara2: "For example, you can create a custom configuration for each client, including their details, your sender information, tax settings, and payment terms.",
                configModalExplanationLocalStorage: "If you choose to save the settings locally, the data is stored in your browser only and can't be accessed by anyone else.",
                configModalExplanationFile: "You can also download your configuration as a file and load it whenever you need it.",
                decimalPoint: "USE DECIMAL COMMA (0,00)", // Updated text for point to comma toggle
                decimalComma: "USE DECIMAL POINT (0.00)",  // Updated text for comma to point toggle
                toggleVisibilitySettingsButton: "Hide elements", // Updated button text
                uploadLogoButton: "Upload logo",
                visibilitySettingsModalTitle: "Show / Hide elements", // New modal title
                toggleRateColumnLabel: "Show 'Rate' column",
                toggleQuantityColumnLabel: "Show 'Volume' column",
                toggleClientDataLabel: "Show client data",
                toggleSenderDataLabel: "Show sender data",
                togglePaymentInfoLabel: "Show payment info",
                applyVisibilitySettingsButton: "Apply",
                onButton: "ON",
                offButton: "OFF"
            }
        };

        // Idioma actual (por defecto español)
        let currentLanguage = 'es';
        // Decimal separator state: '.' for point, ',' for comma
        let currentDecimalSeparator = '.'; 
        // Visibility state variables (default to true for all visible)
        let rateColumnVisible = true;
        let quantityColumnVisible = true;
        let clientDataVisible = true;
        let senderDataVisible = true;
        let paymentInfoVisible = true;
        // Logo data (base64 or URL)
        let logoData = null;

        // --- Obtiene referencias a elementos del DOM ---
        const invoiceItemsTable = document.getElementById('invoiceItems');
        const addItemBtn = document.getElementById('addItemBtn');
        const grandTotalSpan = document.getElementById('grandTotal');
        const subTotalAmountSpan = document.getElementById('subTotalAmount');
        const taxFieldsContainer = document.getElementById('taxFieldsContainer');
        const addTaxBtn = document.getElementById('addTaxBtn');

        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const clientDataInput = document.getElementById('clientData');
        const invoiceDateInput = document.getElementById('invoiceDate');
        const invoiceNumberInput = document.getElementById('invoiceNumber');
        const senderDataInput = document.getElementById('senderData');
        const languageToggleBtn = document.getElementById('languageToggleBtn');
        const decimalToggleBtn = document.getElementById('decimalToggleBtn'); // New decimal toggle button
        const servicesTitleInput = document.getElementById('servicesTitle');
        const paymentInfoInput = document.getElementById('paymentInfo');
        const paymentInfoLabelInput = document.getElementById('paymentInfoLabel');

        // New editable label inputs for main sections
        const clientDataLabelInput = document.getElementById('clientDataLabelInput');
        const invoiceNumberLabelInput = document.getElementById('invoiceNumberLabelInput');
        const invoiceDateLabelInput = document.getElementById('invoiceDateLabelInput');
        const senderDataLabelInput = document.getElementById('senderDataLabelInput');

        // References to the table header inputs
        const tableHeaderProjectInput = document.querySelector('th input[data-key="tableHeaderProject"]');
        const tableHeaderRateInput = document.querySelector('th input[data-key="tableHeaderRate"]');
        const tableHeaderQuantityInput = document.querySelector('th input[data-key="tableHeaderQuantity"]');
        const tableHeaderTotalInput = document.querySelector('th input[data-key="tableHeaderTotal"]');

        // New column toggle button (now opens settings modal)
        const toggleVisibilitySettingsBtn = document.getElementById('toggleVisibilitySettingsBtn');
        const rateColumnHeader = document.querySelector('.rate-column-header');
        const quantityColumnHeader = document.querySelector('.quantity-column-header');

        // Logo upload elements
        const invoiceLogo = document.getElementById('invoiceLogo');
        const uploadLogoBtn = document.getElementById('uploadLogoBtn');
        const logoUploadInput = document.getElementById('logoUploadInput');

        // Modal elements
        const saveLoadConfigBtn = document.getElementById('saveLoadConfigBtn');
        const configModalOverlay = document.getElementById('configModalOverlay');
        const closeConfigModalBtn = document.getElementById('closeConfigModalBtn');
        const saveToFileBtn = document.getElementById('saveToFileBtn');
        const loadFromFileBtn = document.getElementById('loadFromFileBtn');
        const fileLoader = document.getElementById('fileLoader');
        const saveToLocalBtn = document.getElementById('saveToLocalBtn');
        const loadFromLocalBtn = document.getElementById('loadFromLocalBtn');
        const modalMessage = document.getElementById('modalMessage');

        // PDF Naming Modal elements
        const pdfNameModalOverlay = document.getElementById('pdfNameModalOverlay');
        const closePdfNameModalBtn = document.getElementById('closePdfNameModalBtn');
        const pdfFileNameInput = document.getElementById('pdfFileNameInput');
        const confirmPdfNameBtn = document.getElementById('confirmPdfNameBtn');

        // Save to File Naming Modal elements
        const saveFileModalOverlay = document.getElementById('saveFileModalOverlay');
        const closeSaveFileModalBtn = document.getElementById('closeSaveFileModalBtn');
        const saveFileNameInput = document.getElementById('saveFileNameInput');
        const confirmSaveFileNameBtn = document.getElementById('confirmSaveFileNameBtn');

        // Save to Local Naming Modal elements
        const saveLocalModalOverlay = document.getElementById('saveLocalModalOverlay');
        const closeSaveLocalModalBtn = document.getElementById('closeSaveLocalModalBtn');
        const saveLocalNameInput = document.getElementById('saveLocalNameInput');
        const confirmSaveLocalNameBtn = document.getElementById('confirmSaveLocalNameBtn');

        // Load Local Selection Modal elements
        const loadLocalModalOverlay = document.getElementById('loadLocalModalOverlay');
        const closeLoadLocalModalBtn = document.getElementById('closeLoadLocalModalBtn');
        const localSettingsList = document.getElementById('localSettingsList');
        const modalMessageLocalLoad = document.getElementById('modalMessageLocalLoad');

        // Visibility Settings Modal elements
        const visibilitySettingsModalOverlay = document.getElementById('visibilitySettingsModalOverlay');
        const closeVisibilitySettingsModalBtn = document.getElementById('closeVisibilitySettingsModalBtn');
        const toggleRateColumnBtn = document.getElementById('toggleRateColumnBtn');
        const toggleQuantityColumnBtn = document.getElementById('toggleQuantityColumnBtn');
        const toggleClientDataBtn = document.getElementById('toggleClientDataBtn');
        const toggleSenderDataBtn = document.getElementById('toggleSenderDataBtn');
        const togglePaymentInfoBtn = document.getElementById('togglePaymentInfoBtn');
        const applyVisibilitySettingsBtn = document.getElementById('applyVisibilitySettingsBtn');

        // Sections to hide/show
        const clientDataSection = document.getElementById('clientDataSection');
        const senderDataSection = document.getElementById('senderDataSection');
        const paymentInfoSection = document.getElementById('paymentInfoSection');


        let itemCount = 0;
        let taxCount = 0;

        /**
         * Applies sentence capitalization (first letter uppercase, rest lowercase)
         * to a string of text.
         * @param {string} text - The text to capitalize.
         * @returns {string} The text with sentence capitalization.
         */
        function toSentenceCase(text) {
            if (!text) return '';
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        /**
         * Formats a number according to the current decimal separator.
         * @param {number} num - The number to format.
         * @param {number} decimals - Number of decimal places.
         * @returns {string} The formatted number string.
         */
        function formatNumber(num, decimals = 2) {
            let formatted = parseFloat(num).toFixed(decimals);
            if (currentDecimalSeparator === ',') {
                formatted = formatted.replace('.', ',');
            }
            return formatted;
        }

        /**
         * Parses a number string according to the current decimal separator.
         * @param {string} str - The string to parse.
         * @returns {number} The parsed number.
         */
        function parseNumber(str) {
            if (currentDecimalSeparator === ',') {
                str = str.replace(',', '.');
            }
            return parseFloat(str);
        }

        /**
         * Updates all UI texts to the current language and decimal separator.
         */
        function updateTexts() {
            const elements = document.querySelectorAll('[data-key]');
            elements.forEach(element => {
                const key = element.dataset.key;
                let translatedText = translations[currentLanguage][key];

                // Special handling for decimal toggle button
                if (element.id === 'decimalToggleBtn') {
                    // This logic is inverse: if current is '.', show text to change to ','
                    // if current is ',', show text to change to '.'
                    element.textContent = (currentDecimalSeparator === '.') ? 
                                          translations[currentLanguage].decimalComma : 
                                          translations[currentLanguage].decimalPoint;
                } else if (element.id === 'toggleVisibilitySettingsBtn') {
                    element.textContent = translations[currentLanguage].toggleVisibilitySettingsButton;
                }
                else if (element.id === 'generatePdfBtn' || element.id === 'saveLoadConfigBtn') {
                    element.textContent = translatedText.toUpperCase(); 
                } else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    if (element.id === 'servicesTitle' || element.id === 'paymentInfoLabel' ||
                        element.id === 'clientDataLabelInput' || element.id === 'invoiceNumberLabelInput' ||
                        element.id === 'invoiceDateLabelInput' || element.id === 'senderDataLabelInput') {
                         if (!element._isUserModified) {
                            element.value = toSentenceCase(translatedText);
                        }
                    } else if (element.closest('th')) {
                        element.value = toSentenceCase(translatedText);
                    } else {
                        element.placeholder = toSentenceCase(translatedText);
                    }
                } else if (element.tagName === 'TITLE') {
                    document.title = toSentenceCase(translatedText);
                } else {
                    element.textContent = toSentenceCase(translatedText);
                }
            });

            document.querySelectorAll('.item-total-input').forEach(input => { // Changed to input
                input.value = formatNumber(parseNumber(input.value)); // Read value from input
            });

            document.querySelectorAll('.tax-amount').forEach(span => {
                span.textContent = formatNumber(parseNumber(span.textContent));
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.textContent = translations[currentLanguage].deleteButton;
            });
            document.querySelectorAll('.delete-tax-btn').forEach(btn => {
                btn.textContent = toSentenceCase(translations[currentLanguage].deleteTaxButton);
            });

            // Update ON/OFF button texts
            updateToggleButtonState(toggleRateColumnBtn, rateColumnVisible);
            updateToggleButtonState(toggleQuantityColumnBtn, quantityColumnVisible);
            updateToggleButtonState(toggleClientDataBtn, clientDataVisible);
            updateToggleButtonState(toggleSenderDataBtn, senderDataVisible);
            updateToggleButtonState(togglePaymentInfoBtn, paymentInfoVisible);

            calculateTotals();
        }

        // Mark user-modified fields
        servicesTitleInput.addEventListener('input', () => servicesTitleInput._isUserModified = true);
        paymentInfoLabelInput.addEventListener('input', () => paymentInfoLabelInput._isUserModified = true);
        clientDataLabelInput.addEventListener('input', () => clientDataLabelInput._isUserModified = true);
        invoiceNumberLabelInput.addEventListener('input', () => invoiceNumberLabelInput._isUserModified = true);
        invoiceDateLabelInput.addEventListener('input', () => invoiceDateLabelInput._isUserModified = true);
        senderDataLabelInput.addEventListener('input', () => senderDataLabelInput._isUserModified = true);


        /**
         * Adds a new row to the invoice items table.
         */
        function addItem() {
            itemCount++;
            const row = document.createElement('tr');
            row.id = `item-${itemCount}`;
            row.innerHTML = `
                <td>
                    <div class="flex items-start gap-2">
                        <button class="delete-btn px-2 py-1 text-xs">X</button>
                        <textarea rows="2" placeholder="${toSentenceCase(translations[currentLanguage].tableHeaderProject)}" class="py-2 focus:ring-blue-500 focus:border-blue-500 w-full resize-y"></textarea>
                    </div>
                </td>
                <td class="item-rate-cell"><input type="number" step="0.01" value="${formatNumber(0.00)}" class="item-rate py-2 focus:ring-blue-500 focus:border-blue-500 w-full text-center"></td>
                <td class="item-quantity-cell"><input type="number" step="1" value="${formatNumber(0)}" class="item-quantity py-2 focus:ring-blue-500 focus:border-blue-500 w-full text-center"></td>
                <td><input type="number" step="0.01" value="${formatNumber(0.00)}" class="item-total-input text-right block w-full"></td>
            `;

            invoiceItemsTable.appendChild(row);

            const rateInput = row.querySelector('.item-rate');
            const quantityInput = row.querySelector('.item-quantity');
            const totalInput = row.querySelector('.item-total-input'); // Changed to input
            const deleteBtn = row.querySelector('.delete-btn');

            const calculateItemSubTotal = () => {
                if (rateColumnVisible || quantityColumnVisible) { // Only calculate if at least one column is visible
                    const rate = parseNumber(rateInput.value);
                    const quantity = parseNumber(quantityInput.value);
                    const total = (rate * quantity);
                    totalInput.value = formatNumber(total);
                }
                calculateTotals();
            };

            rateInput.addEventListener('input', calculateItemSubTotal);
            quantityInput.addEventListener('input', calculateItemSubTotal);
            totalInput.addEventListener('input', calculateTotals); // Listen for manual input on total

            deleteBtn.addEventListener('click', () => {
                row.remove();
                calculateTotals();
            });
            calculateItemSubTotal();
            // Apply current visibility state to new row
            applyVisibilitySettings(); 
        }

        /**
         * Updates the text and class of a toggle button.
         * @param {HTMLElement} button - The button element.
         * @param {boolean} isOn - True if the state is 'ON', false if 'OFF'.
         */
        function updateToggleButtonState(button, isOn) {
            if (isOn) {
                button.textContent = translations[currentLanguage].onButton;
                button.classList.add('on');
                button.classList.remove('off');
            } else {
                button.textContent = translations[currentLanguage].offButton;
                button.classList.add('off');
                button.classList.remove('on');
            }
        }

        /**
         * Applies the visibility settings for columns and textareas.
         */
        function applyVisibilitySettings() {
            // Toggle Rate Column
            const rateCells = document.querySelectorAll('.item-rate-cell');
            rateColumnHeader.style.display = rateColumnVisible ? '' : 'none';
            rateCells.forEach(cell => cell.style.display = rateColumnVisible ? '' : 'none');

            // Toggle Quantity Column
            const quantityCells = document.querySelectorAll('.item-quantity-cell');
            quantityColumnHeader.style.display = quantityColumnVisible ? '' : 'none';
            quantityCells.forEach(cell => cell.style.display = quantityColumnVisible ? '' : 'none');

            // Handle total input editability: editable only if BOTH rate and quantity are hidden
            const totalInputs = document.querySelectorAll('.item-total-input');
            totalInputs.forEach(input => {
                input.readOnly = (rateColumnVisible || quantityColumnVisible); 
                input.classList.toggle('bg-gray-100', (rateColumnVisible || quantityColumnVisible)); 
            });

            // Adjust table column widths based on visibility
            const table = document.querySelector('table');
            if (table) {
                const style = document.createElement('style');
                style.id = 'dynamic-table-styles';
                let projectColWidth;

                if (rateColumnVisible && quantityColumnVisible) {
                    projectColWidth = '45%';
                } else if (rateColumnVisible && !quantityColumnVisible) {
                    projectColWidth = '60%';
                } else if (!rateColumnVisible && quantityColumnVisible) {
                    projectColWidth = '60%';
                } else { // Both hidden
                    projectColWidth = '70%';
                }

                style.innerHTML = `
                    #invoiceItems td:nth-child(1) { width: ${projectColWidth}; }
                    #invoiceItems td:nth-child(2) { display: ${rateColumnVisible ? '' : 'none'}; }
                    #invoiceItems td:nth-child(3) { display: ${quantityColumnVisible ? '' : 'none'}; }
                `;
                const existingStyle = document.getElementById('dynamic-table-styles');
                if (existingStyle) {
                    existingStyle.remove();
                }
                document.head.appendChild(style);
            }

            // Toggle Textarea Section Visibility
            clientDataSection.style.display = clientDataVisible ? 'block' : 'none';
            senderDataSection.style.display = senderDataVisible ? 'block' : 'none';
            paymentInfoSection.style.display = paymentInfoVisible ? 'block' : 'none';

            updateTexts(); // Update button text and other elements
            calculateTotals(); // Recalculate totals as inputs might change behavior
        }


        /**
         * Adds a new dynamic tax field.
         * @param {string} defaultName - Default name for the tax.
         * @param {number} defaultValue - Default percentage for the tax.
         * @param {string} defaultOperation - Default operation ('+' or '-').
         */
        function addTaxField(defaultName = '', defaultValue = 0, defaultOperation = '+') {
            taxCount++;
            const taxRow = document.createElement('div');
            taxRow.className = 'tax-row';
            taxRow.id = `tax-row-${taxCount}`;
            taxRow.innerHTML = `
                <button class="tax-operation-btn" data-operation="${defaultOperation}">${defaultOperation}</button>
                <input type="text" value="${defaultName}" class="tax-name-input">
                <input type="number" step="0.01" value="${formatNumber(defaultValue)}" class="tax-percentage-input">
                <span>%:</span>
                <span class="tax-amount font-bold ml-2">${formatNumber(0.00)}</span>
                <button class="delete-tax-btn">${toSentenceCase(translations[currentLanguage].deleteTaxButton)}</button>
            `;
            taxFieldsContainer.appendChild(taxRow);

            const taxOperationBtn = taxRow.querySelector('.tax-operation-btn');
            const taxNameInput = taxRow.querySelector('.tax-name-input');
            const taxPercentageInput = taxRow.querySelector('.tax-percentage-input');
            const deleteTaxBtn = taxRow.querySelector('.delete-tax-btn');

            taxOperationBtn.addEventListener('click', () => {
                const currentOp = taxOperationBtn.dataset.operation;
                const newOp = currentOp === '+' ? '-' : '+';
                taxOperationBtn.dataset.operation = newOp;
                taxOperationBtn.textContent = newOp;
                calculateTotals();
            });
            taxNameInput.addEventListener('input', calculateTotals);
            taxPercentageInput.addEventListener('input', calculateTotals);
            deleteTaxBtn.addEventListener('click', () => {
                taxRow.remove();
                calculateTotals();
            });
            calculateTotals();
        }

        /**
         * Calculates the subtotal, tax amounts, and final total.
         */
        function calculateTotals() {
            let subTotal = 0;
            document.querySelectorAll('.item-total-input').forEach(itemTotalInput => { // Changed to input
                subTotal += parseNumber(itemTotalInput.value); // Read value from input
            });
            subTotalAmountSpan.textContent = formatNumber(subTotal) + ' €';

            let totalTaxAmount = 0;
            document.querySelectorAll('.tax-row').forEach(taxRow => {
                const taxOperationBtn = taxRow.querySelector('.tax-operation-btn');
                const taxPercentageInput = taxRow.querySelector('.tax-percentage-input');
                const taxAmountSpan = taxRow.querySelector('.tax-amount');
                
                const percentage = parseNumber(taxPercentageInput.value);
                const taxAmount = (subTotal * (percentage / 100));
                taxAmountSpan.textContent = formatNumber(taxAmount) + ' €';

                const operation = taxOperationBtn.dataset.operation;
                if (operation === '-') {
                    totalTaxAmount -= taxAmount;
                } else { // '+'
                    totalTaxAmount += taxAmount;
                }
            });
            
            const finalTotal = (subTotal + totalTaxAmount);
            grandTotalSpan.textContent = formatNumber(finalTotal) + ' €';
        }

        /**
         * Helper function to add multi-line text to PDF.
         * @param {jsPDF} doc - The jsPDF object.
         * @param {string} text - The text to add.
         * @param {number} x - La coordenada X inicial.
         * @param {number} y - La coordenada Y inicial.
         * @param {number} maxWidth - El ancho máximo para el texto antes de envolverlo.
         * @param {string} align - Alineación del texto ("left", "center", "right").
         * @returns {number} La coordenada Y final después de añadir el texto.
         */
        function addMultiLineText(doc, text, x, y, maxWidth, align = "left") {
            const lines = doc.splitTextToSize(text, maxWidth);
            doc.text(lines, x, y, { align: align });
            return y + (lines.length * doc.getLineHeight());
        }

        /**
         * Generates the invoice PDF document.
         * @param {string} fileName - The desired name for the PDF file.
         */
        function generatePdf(fileName) {
            const doc = new jsPDF();

            // Define consistent margins
            const pdfMarginX = 15; // Margen izquierdo
            const pdfPageWidth = doc.internal.pageSize.getWidth();
            const pdfRightAlignedX = pdfPageWidth - pdfMarginX; // Coordenada X alineada a la derecha
            let currentY = 20; // Y inicial para elementos superiores (margen superior más estrecho)

            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);

            // Add logo if available
            if (logoData) {
                const img = new Image();
                img.src = logoData;

                // Calculate proportional dimensions
                const maxWidth = 40; // Max width for the logo in PDF
                const maxHeight = 30; // Max height for the logo in PDF

                let width = img.width;
                let height = img.height;

                // If image is wider than maxWidth, scale down proportionally
                if (width > maxWidth) {
                    height = height * (maxWidth / width);
                    width = maxWidth;
                }

                // If image is taller than maxHeight, scale down proportionally
                if (height > maxHeight) {
                    width = width * (maxHeight / height);
                    height = maxHeight;
                }
                
                doc.addImage(logoData, 'PNG', pdfMarginX, currentY, width, height);
            } else {
                // If no custom logo, use the default CalPanda logo
                doc.addImage(invoiceLogo.src, 'PNG', pdfMarginX, currentY, 40, 30); // Use the default logo
            }
            currentY += 35; // Move Y down after placing logo or its placeholder

            // Invoice number and date (always present)
            doc.text(`${toSentenceCase(invoiceNumberLabelInput.value)} ${invoiceNumberInput.value}`, pdfRightAlignedX, currentY, null, null, "right");
            currentY += 7;
            doc.text(`${toSentenceCase(invoiceDateLabelInput.value)} ${invoiceDateInput.value}`, pdfRightAlignedX, currentY, null, null, "right");
            currentY += 10; // Space after invoice number/date

            let maxSectionY = currentY;

            // Client Data (left)
            if (clientDataVisible) {
                doc.setFont("helvetica", "bold");
                doc.text(toSentenceCase(clientDataLabelInput.value), pdfMarginX, currentY);
                doc.setFont("helvetica", "normal");
                maxSectionY = addMultiLineText(doc, clientDataInput.value, pdfMarginX, currentY + 7, 80, "left");
            }

            // Sender Data (right)
            if (senderDataVisible) {
                doc.setFont("helvetica", "bold");
                doc.text(toSentenceCase(senderDataLabelInput.value), pdfRightAlignedX, currentY, null, null, "right");
                doc.setFont("helvetica", "normal");
                const senderDataCurrentY = addMultiLineText(doc, senderDataInput.value, pdfRightAlignedX, currentY + 7, 80, "right");
                maxSectionY = Math.max(maxSectionY, senderDataCurrentY); // Update maxSectionY with sender data's final Y
            }

            let tableStartY = maxSectionY + 15; // Space after the client/sender data block
            
            // Title of services (editable)
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text(toSentenceCase(servicesTitleInput.value), pdfMarginX, tableStartY);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            tableStartY += 10; // Espacio entre título y tabla

            const headers = [
                tableHeaderProjectInput.value,
            ];
            const columnStylesPdf = {
                0: { cellWidth: 'auto' }
            };

            let currentPdfColIndex = 1;
            if (rateColumnVisible) {
                headers.push(tableHeaderRateInput.value);
                columnStylesPdf[currentPdfColIndex++] = { halign: 'center' };
            }
            if (quantityColumnVisible) {
                headers.push(tableHeaderQuantityInput.value);
                columnStylesPdf[currentPdfColIndex++] = { halign: 'center' };
            }
            headers.push(tableHeaderTotalInput.value);
            columnStylesPdf[currentPdfColIndex] = { halign: 'right' };

            const data = [];
            document.querySelectorAll('#invoiceItems tr').forEach(row => {
                const rowData = [];
                rowData.push(row.querySelector('td:nth-child(1) textarea').value);
                if (rateColumnVisible) {
                    rowData.push(row.querySelector('.item-rate').value);
                }
                if (quantityColumnVisible) {
                    rowData.push(row.querySelector('.item-quantity').value);
                }
                rowData.push(row.querySelector('.item-total-input').value); // Get value from input
                data.push(rowData);
            });

            const foot = [];
            const whiteFootCellStyles = {
                fillColor: [255, 255, 255], // White background
                textColor: [0, 0, 0],       // Black text
                lineColor: [255, 255, 255], // White border
                lineWidth: 0.5              // Thin border for separation, but visually "white on white"
            };
            
            // Adjust colSpan for footer based on column visibility
            let emptyColSpanForAlignment = 0;
            if (rateColumnVisible && quantityColumnVisible) {
                emptyColSpanForAlignment = 2;
            } else if (rateColumnVisible || quantityColumnVisible) {
                emptyColSpanForAlignment = 1;
            } else { // Both hidden
                emptyColSpanForAlignment = 0; // No columns to span, so just the labels and totals
            }


            foot.push([
                { content: '', colSpan: emptyColSpanForAlignment, styles: whiteFootCellStyles },
                { content: toSentenceCase(translations[currentLanguage].subtotalLabel), styles: { ...whiteFootCellStyles, halign: 'right', fontStyle: 'bold' } },
                { content: subTotalAmountSpan.textContent, styles: { ...whiteFootCellStyles, halign: 'right', fontStyle: 'bold' } }
            ]);

            document.querySelectorAll('.tax-row').forEach(taxRow => {
                const taxName = taxRow.querySelector('.tax-name-input').value;
                const taxPercentage = taxRow.querySelector('.tax-percentage-input').value;
                const taxAmount = taxRow.querySelector('.tax-amount').textContent;
                const taxOperation = taxRow.querySelector('.tax-operation-btn').dataset.operation;

                foot.push([
                    { content: '', colSpan: emptyColSpanForAlignment, styles: whiteFootCellStyles },
                    { content: `${taxName.toUpperCase()} (${formatNumber(parseNumber(taxPercentage), 0)}%)${taxOperation === '-' ? ' (-)' : ''}:`, styles: { ...whiteFootCellStyles, halign: 'right' } },
                    { content: taxAmount, styles: { ...whiteFootCellStyles, halign: 'right' } }
                ]);
            });

            foot.push([
                { content: '', colSpan: emptyColSpanForAlignment, styles: whiteFootCellStyles },
                { content: toSentenceCase(translations[currentLanguage].finalTotalLabel), styles: { ...whiteFootCellStyles, halign: 'right', fontStyle: 'bold', fontSize: 12 } },
                { content: grandTotalSpan.textContent, styles: { ...whiteFootCellStyles, halign: 'right', fontStyle: 'bold', fontSize: 12 } }
            ]);

            doc.autoTable({
                startY: tableStartY,
                head: [headers],
                body: data,
                foot: foot,
                styles: { fontSize: 10, cellPadding: 3, halign: 'left' },
                headStyles: { fillColor: [71, 85, 105], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [248, 250, 252] },
                margin: { left: pdfMarginX, right: pdfMarginX },
                columnStyles: columnStylesPdf,
                footStyles: {
                    lineColor: [255, 255, 255],
                    lineWidth: 0.5,
                    fontStyle: 'normal',
                }
            });

            let finalY = doc.autoTable.previous.finalY;

            if (paymentInfoInput.value.trim() !== '' && paymentInfoVisible) {
                finalY += 20;
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text(toSentenceCase(paymentInfoLabelInput.value), pdfMarginX, finalY);
                doc.setFont("helvetica", "normal");
                finalY += 7;
                addMultiLineText(doc, paymentInfoInput.value, pdfMarginX, finalY, pdfPageWidth - (pdfMarginX * 2), "left");
            }

            doc.save(`${fileName}.pdf`);
            pdfNameModalOverlay.classList.remove('visible');
        }

        /**
         * Recopila todos los datos de la factura en un único objeto.
         * @returns {object} El objeto de configuración de la factura.
         */
        function getInvoiceConfig() {
            const items = [];
            document.querySelectorAll('#invoiceItems tr').forEach(row => {
                items.push({
                    project: row.querySelector('td:nth-child(1) textarea').value,
                    rate: parseNumber(row.querySelector('.item-rate').value), // Parse from formatted string
                    quantity: parseNumber(row.querySelector('.item-quantity').value), // Parse from formatted string
                    total: parseNumber(row.querySelector('.item-total-input').value) // Get total value
                });
            });

            const taxes = [];
            document.querySelectorAll('.tax-row').forEach(taxRow => {
                const operationBtn = taxRow.querySelector('.tax-operation-btn');
                taxes.push({
                    name: taxRow.querySelector('.tax-name-input').value,
                    percentage: parseNumber(taxRow.querySelector('.tax-percentage-input').value), // Parse from formatted string
                    operation: operationBtn ? operationBtn.dataset.operation : '+'
                });
            });

            const headerInputs = {};
            document.querySelectorAll('th input[data-key]').forEach(input => {
                headerInputs[input.dataset.key] = input.value;
            });

            return {
                clientDataLabel: clientDataLabelInput.value,
                clientData: clientDataInput.value,
                invoiceNumberLabel: invoiceNumberLabelInput.value,
                invoiceNumber: invoiceNumberInput.value,
                invoiceDateLabel: invoiceDateLabelInput.value,
                invoiceDate: invoiceDateInput.value,
                senderDataLabel: senderDataLabelInput.value,
                senderData: senderDataInput.value,
                servicesTitle: servicesTitleInput.value,
                paymentInfoLabel: paymentInfoLabelInput.value,
                paymentInfoText: paymentInfoInput.value,
                tableHeaders: headerInputs,
                items: items,
                taxes: taxes,
                language: currentLanguage,
                decimalSeparator: currentDecimalSeparator, // Save the current decimal separator
                rateColumnVisible: rateColumnVisible,
                quantityColumnVisible: quantityColumnVisible,
                clientDataVisible: clientDataVisible,
                senderDataVisible: senderDataVisible,
                paymentInfoVisible: paymentInfoVisible,
                logoData: logoData // Save logo data
            };
        }

        /**
         * Aplica una configuración cargada al formulario de factura.
         * @param {object} config - El objeto de configuración de la factura.
         */
        function applyInvoiceConfig(config) {
            try {
                currentLanguage = config.language || 'es';
                currentDecimalSeparator = config.decimalSeparator || '.'; // Load decimal separator
                rateColumnVisible = config.rateColumnVisible !== undefined ? config.rateColumnVisible : true;
                quantityColumnVisible = config.quantityColumnVisible !== undefined ? config.quantityColumnVisible : true;
                clientDataVisible = config.clientDataVisible !== undefined ? config.clientDataVisible : true;
                senderDataVisible = config.senderDataVisible !== undefined ? config.senderDataVisible : true;
                paymentInfoVisible = config.paymentInfoVisible !== undefined ? config.paymentInfoVisible : true;
                logoData = config.logoData || null; // Load logo data

                if (logoData) {
                    invoiceLogo.src = logoData;
                    invoiceLogo.classList.remove('calpanda-logo');
                    invoiceLogo.classList.add('logo-preview');
                } else {
                    invoiceLogo.src = "https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/calpanda-logo.png";
                    invoiceLogo.classList.add('calpanda-logo');
                    invoiceLogo.classList.remove('logo-preview');
                }


                updateTexts(); // This will re-render all texts and reformat numbers on UI

                clientDataLabelInput.value = config.clientDataLabel || '';
                clientDataLabelInput._isUserModified = true;
                clientDataInput.value = config.clientData || '';

                invoiceNumberLabelInput.value = config.invoiceNumberLabel || '';
                invoiceNumberLabelInput._isUserModified = true;
                invoiceNumberInput.value = config.invoiceNumber || '';

                invoiceDateLabelInput.value = config.invoiceDateLabel || '';
                invoiceDateLabelInput._isUserModified = true;
                invoiceDateInput.value = config.invoiceDate || '';

                senderDataLabelInput.value = config.senderDataLabel || '';
                senderDataLabelInput._isUserModified = true;
                senderDataInput.value = config.senderData || '';

                servicesTitleInput.value = config.servicesTitle || translations[currentLanguage].servicesTitleDefault;
                servicesTitleInput._isUserModified = true;

                paymentInfoLabelInput.value = config.paymentInfoLabel || translations[currentLanguage].paymentInfoLabelDefault;
                paymentInfoLabelInput._isUserModified = true;
                paymentInfoInput.value = config.paymentInfoText || '';

                if (config.tableHeaders) {
                    for (const key in config.tableHeaders) {
                        const input = document.querySelector(`th input[data-key="${key}"]`);
                        if (input) {
                            input.value = config.tableHeaders[key];
                        }
                    }
                }

                invoiceItemsTable.innerHTML = '';
                itemCount = 0;
                if (config.items && config.items.length > 0) {
                    config.items.forEach(item => {
                        addItem();
                        const lastRow = invoiceItemsTable.lastElementChild;
                        const projectInput = lastRow.querySelector('td:nth-child(1) textarea');
                        const rateInput = lastRow.querySelector('.item-rate');
                        const quantityInput = lastRow.querySelector('.item-quantity');
                        const totalInput = lastRow.querySelector('.item-total-input');

                        projectInput.value = item.project;
                        rateInput.value = formatNumber(item.rate !== undefined ? item.rate : 0);
                        quantityInput.value = formatNumber(item.quantity !== undefined ? item.quantity : 0, 0);
                        totalInput.value = formatNumber(item.total !== undefined ? item.total : 0); // Set total value

                        // No need to dispatch input event if total is manually set
                        if (rateColumnVisible || quantityColumnVisible) {
                            const event = new Event('input', { bubbles: true });
                            quantityInput.dispatchEvent(event); // Trigger calculation if columns are visible
                        }
                    });
                } else {
                    addItem();
                }

                taxFieldsContainer.innerHTML = '';
                taxCount = 0;
                if (config.taxes && config.taxes.length > 0) {
                    config.taxes.forEach(tax => {
                        addTaxField(tax.name, tax.percentage, tax.operation);
                        const lastTaxRow = taxFieldsContainer.lastElementChild;
                        const taxOpBtn = lastTaxRow.querySelector('.tax-operation-btn');
                        if (taxOpBtn) {
                            taxOpBtn.textContent = tax.operation;
                        }
                    });
                } else {
                    addTaxField(translations[currentLanguage].taxDefaultIvaName, 21, '+');
                    addTaxField(translations[currentLanguage].taxDefaultIrpfName, 15, '-');
                }

                // Set toggle button states in the modal
                updateToggleButtonState(toggleRateColumnBtn, rateColumnVisible);
                updateToggleButtonState(toggleQuantityColumnBtn, quantityColumnVisible);
                updateToggleButtonState(toggleClientDataBtn, clientDataVisible);
                updateToggleButtonState(toggleSenderDataBtn, senderDataVisible);
                updateToggleButtonState(togglePaymentInfoBtn, paymentInfoVisible);
                
                applyVisibilitySettings(); // Apply loaded visibility settings
                calculateTotals();
                showMessage(translations[currentLanguage].modalMessageSuccessLoadFile);
            } catch (e) {
                console.error("Error al aplicar configuración de factura:", e);
                showMessage(translations[currentLanguage].modalMessageErrorParse, true);
            }
        }


        /**
         * Muestra un mensaje en el modal.
         * @param {string} msg - El mensaje a mostrar.
         * @param {boolean} isError - True si es un mensaje de error.
         */
        function showMessage(msg, isError = false) {
            modalMessage.textContent = msg;
            modalMessage.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800');
            modalMessage.classList.add(isError ? 'bg-red-100' : 'bg-blue-100', isError ? 'text-red-800' : 'text-blue-800');
            modalMessage.style.display = 'block'; // Asegura que sea visible
            setTimeout(() => {
                modalMessage.classList.add('hidden');
                modalMessage.style.display = 'none'; // Ocultar correctamente
            }, 3000);
        }

        /**
         * Displays a message in the local load modal.
         * @param {string} msg - The message to display.
         * @param {boolean} isError - True if it's an error message.
         */
        function showMessageLocalLoad(msg, isError = false) {
            modalMessageLocalLoad.textContent = msg;
            modalMessageLocalLoad.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800');
            modalMessageLocalLoad.classList.add(isError ? 'bg-red-100' : 'bg-blue-100', isError ? 'text-red-800' : 'text-blue-800');
            modalMessageLocalLoad.style.display = 'block'; // Ensure it's visible
            setTimeout(() => {
                modalMessageLocalLoad.classList.add('hidden');
                modalMessageLocalLoad.style.display = 'none'; // Hide properly
            }, 3000);
        }


        // --- Event Listeners ---
        addItemBtn.addEventListener('click', addItem);
        addTaxBtn.addEventListener('click', () => addTaxField('', 0));

        // GENERATE PDF button - now opens naming modal
        generatePdfBtn.addEventListener('click', () => {
            pdfNameModalOverlay.classList.add('visible');
            pdfFileNameInput.value = invoiceNumberInput.value || `factura_${new Date().toISOString().slice(0,10)}`; // Default to invoice number or date
            pdfFileNameInput.focus();
            pdfFileNameInput.select(); // Select the text for easy overwrite
        });
        confirmPdfNameBtn.addEventListener('click', () => {
            const fileName = pdfFileNameInput.value.trim();
            if (fileName) {
                generatePdf(fileName);
            } else {
                // Use a custom modal or message box instead of alert()
                showMessage("Por favor, introduce un nombre de archivo.", true); 
            }
        });
        closePdfNameModalBtn.addEventListener('click', () => {
            pdfNameModalOverlay.classList.remove('visible');
        });
        pdfNameModalOverlay.addEventListener('click', (e) => {
            if (e.target === pdfNameModalOverlay) {
                pdfNameModalOverlay.classList.remove('visible');
            }
        });


        // Event listener para el botón de cambio de idioma
        languageToggleBtn.addEventListener('click', () => {
            currentLanguage = currentLanguage === 'es' ? 'en' : 'es';
            updateTexts();
            // Clear and re-add default taxes so their names are updated (operations reset to default too)
            taxFieldsContainer.innerHTML = '';
            addTaxField(translations[currentLanguage].taxDefaultIvaName, 21, '+');
            addTaxField(translations[currentLanguage].taxDefaultIrpfName, 15, '-');
        });

        // Decimal separator toggle
        decimalToggleBtn.addEventListener('click', () => {
            currentDecimalSeparator = (currentDecimalSeparator === '.') ? ',' : '.';
            updateTexts(); // Re-render all numbers with new separator
        });

        // Toggle visibility settings modal
        toggleVisibilitySettingsBtn.addEventListener('click', () => {
            visibilitySettingsModalOverlay.classList.add('visible');
            // Ensure toggle buttons reflect current state when opening modal
            updateToggleButtonState(toggleRateColumnBtn, rateColumnVisible);
            updateToggleButtonState(toggleQuantityColumnBtn, quantityColumnVisible);
            updateToggleButtonState(toggleClientDataBtn, clientDataVisible);
            updateToggleButtonState(toggleSenderDataBtn, senderDataVisible);
            updateToggleButtonState(togglePaymentInfoBtn, paymentInfoVisible);
        });
        closeVisibilitySettingsModalBtn.addEventListener('click', () => {
            visibilitySettingsModalOverlay.classList.remove('visible');
        });
        visibilitySettingsModalOverlay.addEventListener('click', (e) => {
            if (e.target === visibilitySettingsModalOverlay) {
                visibilitySettingsModalOverlay.classList.remove('visible');
            }
        });

        // Event listeners for individual toggle buttons in the modal
        toggleRateColumnBtn.addEventListener('click', () => {
            rateColumnVisible = !rateColumnVisible;
            updateToggleButtonState(toggleRateColumnBtn, rateColumnVisible);
        });
        toggleQuantityColumnBtn.addEventListener('click', () => {
            quantityColumnVisible = !quantityColumnVisible;
            updateToggleButtonState(toggleQuantityColumnBtn, quantityColumnVisible);
        });
        toggleClientDataBtn.addEventListener('click', () => {
            clientDataVisible = !clientDataVisible;
            updateToggleButtonState(toggleClientDataBtn, clientDataVisible);
        });
        toggleSenderDataBtn.addEventListener('click', () => {
            senderDataVisible = !senderDataVisible;
            updateToggleButtonState(toggleSenderDataBtn, senderDataVisible);
        });
        togglePaymentInfoBtn.addEventListener('click', () => {
            paymentInfoVisible = !paymentInfoVisible;
            updateToggleButtonState(togglePaymentInfoBtn, paymentInfoVisible);
        });

        applyVisibilitySettingsBtn.addEventListener('click', () => {
            applyVisibilitySettings();
            visibilitySettingsModalOverlay.classList.remove('visible');
        });


        // Logo upload functionality
        uploadLogoBtn.addEventListener('click', () => {
            logoUploadInput.click(); // Trigger hidden file input click
        });

        logoUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    logoData = e.target.result; // Store base64 data
                    invoiceLogo.src = logoData;
                    invoiceLogo.classList.remove('calpanda-logo'); // Remove default logo styling
                    invoiceLogo.classList.add('logo-preview'); // Add preview styling
                };
                reader.readAsDataURL(file);
            }
        });


        // Main Config Modal event listeners
        saveLoadConfigBtn.addEventListener('click', () => {
            configModalOverlay.classList.add('visible');
            modalMessage.classList.add('hidden'); // Ocultar mensajes anteriores
        });
        closeConfigModalBtn.addEventListener('click', () => {
            configModalOverlay.classList.remove('visible');
        });
        configModalOverlay.addEventListener('click', (e) => {
            if (e.target === configModalOverlay) {
                configModalOverlay.classList.remove('visible');
            }
        });

        // Save to File - now opens naming modal
        saveToFileBtn.addEventListener('click', () => {
            saveFileModalOverlay.classList.add('visible');
            saveFileNameInput.value = `calpanda_config_${new Date().toISOString().slice(0,10)}.json`; // Default name
            saveFileNameInput.focus();
            saveFileNameInput.select();
            configModalOverlay.classList.remove('visible'); // Close main config modal
        });
        confirmSaveFileNameBtn.addEventListener('click', () => {
            const fileName = saveFileNameInput.value.trim();
            if (fileName) {
                const config = getInvoiceConfig();
                const configJson = JSON.stringify(config, null, 2);
                const blob = new Blob([configJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName.endsWith('.json') ? fileName : `${fileName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage(translations[currentLanguage].modalMessageSuccessSaveFile);
                saveFileModalOverlay.classList.remove('visible'); // Close save file naming modal
            } else {
                showMessage("Por favor, introduce un nombre de archivo para tu configuración.", true); 
            }
        });
        closeSaveFileModalBtn.addEventListener('click', () => {
            saveFileModalOverlay.classList.remove('visible');
        });
        saveFileModalOverlay.addEventListener('click', (e) => {
            if (e.target === saveFileModalOverlay) {
                saveFileModalOverlay.classList.remove('visible');
            }
        });


        // Load from File - remains the same, triggered by hidden input
        loadFromFileBtn.addEventListener('click', () => {
            fileLoader.click(); // Trigger hidden file input click
        });

        fileLoader.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const config = JSON.parse(e.target.result);
                        applyInvoiceConfig(config);
                        showMessage(translations[currentLanguage].modalMessageSuccessLoadFile);
                        configModalOverlay.classList.remove('visible'); // Close main config modal
                    } catch (error) {
                        console.error("Error al analizar el archivo de configuración:", error);
                        showMessage(translations[currentLanguage].modalMessageErrorParse, true);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Save to Local - now opens naming modal
        saveToLocalBtn.addEventListener('click', () => {
            saveLocalModalOverlay.classList.add('visible');
            const defaultName = `Ajuste ${new Date().toLocaleDateString()}`;
            saveLocalNameInput.value = defaultName;
            saveLocalNameInput.focus();
            saveLocalNameInput.select();
            configModalOverlay.classList.remove('visible'); // Close main config modal
        });
        confirmSaveLocalNameBtn.addEventListener('click', () => {
            const settingName = saveLocalNameInput.value.trim();
            if (settingName) {
                try {
                    let localConfigs = JSON.parse(localStorage.getItem('calpanda_local_configs') || '{}');
                    localConfigs[settingName] = getInvoiceConfig();
                    localStorage.setItem('calpanda_local_configs', JSON.stringify(localConfigs));
                    showMessage(translations[currentLanguage].modalMessageSuccessSaveLocal);
                    saveLocalModalOverlay.classList.remove('visible'); // Close naming modal
                    renderLocalSettingsList(); // Update the list immediately after saving
                } catch (e) {
                    console.error("Error al guardar en el almacenamiento local:", e);
                    showMessage(translations[currentLanguage].modalMessageErrorLoad, true);
                }
            } else {
                showMessage("Por favor, introduce un nombre para tu ajuste local.", true);
            }
        });
        closeSaveLocalModalBtn.addEventListener('click', () => {
            saveLocalModalOverlay.classList.remove('visible');
        });
        saveLocalModalOverlay.addEventListener('click', (e) => {
            if (e.target === saveLocalModalOverlay) {
                saveLocalModalOverlay.classList.remove('visible');
            }
        });

        // Load from Local - now opens selection modal
        loadFromLocalBtn.addEventListener('click', () => {
            loadLocalModalOverlay.classList.add('visible');
            configModalOverlay.classList.remove('visible'); // Close main config modal
            renderLocalSettingsList();
        });
        closeLoadLocalModalBtn.addEventListener('click', () => {
            loadLocalModalOverlay.classList.remove('visible');
        });
        loadLocalModalOverlay.addEventListener('click', (e) => {
            if (e.target === loadLocalModalOverlay) {
                loadLocalModalOverlay.classList.remove('visible');
            }
        });

        /**
         * Renders the list of locally saved settings in the load local modal.
         */
        function renderLocalSettingsList() {
            localSettingsList.innerHTML = ''; // Clear previous list
            const localConfigs = JSON.parse(localStorage.getItem('calpanda_local_configs') || '{}');
            const configNames = Object.keys(localConfigs);

            if (configNames.length === 0) {
                localSettingsList.innerHTML = `<li class="text-center py-4 text-gray-500">${toSentenceCase(translations[currentLanguage].loadLocalNoSettings)}</li>`;
                return;
            }

            configNames.forEach(name => {
                const listItem = document.createElement('li');
                listItem.className = 'local-settings-list-item'; // Use the new class
                listItem.innerHTML = `
                    <span>${name}</span>
                    <div>
                        <button class="load-btn px-3 py-1 text-sm">${toSentenceCase(translations[currentLanguage].loadLocalLoadButton)}</button>
                        <button class="delete-btn-local px-3 py-1 text-sm">${toSentenceCase(translations[currentLanguage].loadLocalDeleteButton)}</button>
                    </div>
                `;
                localSettingsList.appendChild(listItem);

                // Add event listeners for load and delete buttons
                listItem.querySelector('.load-btn').addEventListener('click', (e) => {
                    const nameToLoad = name; // Use the closure variable `name`
                    const configToLoad = localConfigs[nameToLoad];
                    if (configToLoad) {
                        applyInvoiceConfig(configToLoad);
                        showMessageLocalLoad(toSentenceCase(translations[currentLanguage].modalMessageSuccessLoadLocal));
                        loadLocalModalOverlay.classList.remove('visible');
                    } else {
                        showMessageLocalLoad(toSentenceCase(translations[currentLanguage].modalMessageErrorLoad), true);
                    }
                });

                listItem.querySelector('.delete-btn-local').addEventListener('click', (e) => {
                    const nameToDelete = name; // Use the closure variable `name`
                    // Use a custom modal or message box instead of confirm()
                    if (confirm(toSentenceCase(translations[currentLanguage].loadLocalConfirmDelete))) {
                        delete localConfigs[nameToDelete];
                        localStorage.setItem('calpanda_local_configs', JSON.stringify(localConfigs));
                        renderLocalSettingsList(); // Re-render the list
                        showMessageLocalLoad(toSentenceCase(translations[currentLanguage].deleteButton) + ' ' + toSentenceCase(nameToDelete) + ' ' + toSentenceCase('eliminado.'), false); // Custom success message
                    }
                });
            });
        }


        // --- Inicialización ---
        // Add an initial item on page load
        addItem();
        // Set current date by default
        invoiceDateInput.valueAsDate = new Date();

        // Inicializar inputs de etiqueta editables (no son placeholders, así que establecer valor)
        clientDataLabelInput.value = toSentenceCase(translations[currentLanguage].clientDataLabelDefault);
        clientDataLabelInput._isUserModified = false;
        invoiceNumberLabelInput.value = toSentenceCase(translations[currentLanguage].invoiceNumberLabelDefault);
        invoiceNumberLabelInput._isUserModified = false;
        invoiceDateLabelInput.value = toSentenceCase(translations[currentLanguage].invoiceDateLabelDefault);
        invoiceDateLabelInput._isUserModified = false;
        senderDataLabelInput.value = toSentenceCase(translations[currentLanguage].senderDataLabelDefault);
        senderDataLabelInput._isUserModified = false;
        
        servicesTitleInput.value = toSentenceCase(translations[currentLanguage].servicesTitleDefault);
        servicesTitleInput._isUserModified = false;

        paymentInfoLabelInput.value = toSentenceCase(translations[currentLanguage].paymentInfoLabelDefault);
        paymentInfoLabelInput._isUserModified = false;

        // Add default taxes on initial load
        taxFieldsContainer.innerHTML = ''; // Clear any pre-existing default taxes before adding
        addTaxField(translations[currentLanguage].taxDefaultIvaName, 21, '+');
        addTaxField(translations[currentLanguage].taxDefaultIrpfName, 15, '-');

        // Update all texts at page load (defaults to Spanish)
        updateTexts();

        // Set initial toggle button states for visibility settings
        // By default, all are visible (ON)
        rateColumnVisible = true;
        quantityColumnVisible = true;
        clientDataVisible = true;
        senderDataVisible = true;
        paymentInfoVisible = true;

        updateToggleButtonState(toggleRateColumnBtn, rateColumnVisible);
        updateToggleButtonState(toggleQuantityColumnBtn, quantityColumnVisible);
        updateToggleButtonState(toggleClientDataBtn, clientDataVisible);
        updateToggleButtonState(toggleSenderDataBtn, senderDataVisible);
        updateToggleButtonState(togglePaymentInfoBtn, paymentInfoVisible);
        
        applyVisibilitySettings(); // Apply initial visibility settings
    </script>
</body>
</html>
