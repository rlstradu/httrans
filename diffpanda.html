<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="documentTitle">Diffpanda - Comparador de textos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas CDN (for PDF export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom styles for Diffpanda, overriding or extending Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #373737; /* Dark text color from logo */
        }

        /* Specific colors for diff highlighting */
        .diff-unchanged {
            background-color: #f9fafb; /* Very light gray for unchanged lines */
            border-left: 4px solid #cbd5e1; /* Light gray border */
            padding-left: 0.5rem;
        }
        .diff-added {
            background-color: #d1fae5; /* Light green for added lines */
            border-left: 4px solid #34d399; /* Green border */
            padding-left: 0.5rem;
        }
        .diff-removed {
            background-color: #fee2e2; /* Light red for removed lines */
            border-left: 4px solid #ef4444; /* Red border */
            padding-left: 0.5rem;
        }
        .diff-changed-word-added {
            background-color: #a7f3d0; /* Slightly darker green for added words */
            padding: 0 2px;
            border-radius: 4px;
        }
        .diff-changed-word-removed {
            background-color: #fecaca; /* Slightly darker red for removed words */
            padding: 0 2px;
            border-radius: 4px;
            text-decoration: line-through; /* Strikethrough for removed words */
        }

        /* Message box styling */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #373737;
            color: #ECA5E5;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            font-weight: 600;
            text-align: center;
        }

        /* Loading spinner styling */
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #ECA5E5; /* Diffpanda pink */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ensure textareas and diff output scroll if content overflows */
        textarea {
            overflow-y: auto;
        }
        /* Styles for the three-column diff output */
        #diffOutput {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Three equal columns */
            gap: 1rem; /* Gap between columns */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5;
            max-height: 24rem; /* max-h-96 */
            overflow-y: auto;
            white-space: pre-wrap; /* Preserve whitespace and allow wrapping */
            word-break: break-word; /* Changed from break-all to break-word */
        }
        #diffOutput > div {
            padding: 0.5rem;
            border-radius: 0.25rem;
            min-height: 2rem; /* Ensure consistent row height */
            word-break: break-word; /* Changed from break-all to break-word */
        }
        .diff-header {
            font-weight: bold;
            color: #373737;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        /* Specific styling for the comparison column */
        .comparison-cell {
            background-color: #f0f0f0; /* Slightly different background for comparison column */
            border: 1px dashed #ccc; /* Dashed border for visual distinction */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner"></div>

    <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-5xl">
        <!-- Header -->
        <header class="flex flex-col items-center justify-center mb-8 relative">
            <!-- Language selector buttons moved inside the white canvas -->
            <div class="flex space-x-2 absolute top-0 right-0 mt-4 mr-4">
                <button id="langEsBtn" class="font-bold py-2 px-4 rounded-lg transition-colors duration-200">ES</button>
                <button id="langEnBtn" class="font-bold py-2 px-4 rounded-lg transition-colors duration-200">EN</button>
            </div>

            <!-- Logo with 125px height and no shadow, centered -->
            <img src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/diffpanda-logo.png" alt="Diffpanda Logo" class="h-[125px] w-auto mb-2">
            <!-- Capitalization applied to the tagline, centered below logo -->
            <p class="text-lg text-gray-600 text-center" data-key="tagline">Compara textos y genera informes de cambios de manera rápida y sencilla.</p>
        </header>

        <!-- Input Text Areas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="text1" class="block text-gray-700 text-sm font-semibold mb-2" data-key="originalTextLabel">Texto original:</label>
                <textarea id="text1" rows="15" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ECA5E5] focus:border-transparent outline-none transition-all duration-200 resize-y" data-key="placeholderText1" placeholder="Pega el primer texto aquí..."></textarea>
                <input type="file" id="fileInput1" accept=".txt,.srt,.po,.tmx" class="hidden">
                <button id="uploadBtn1" class="mt-2 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75" data-key="uploadButton1">Subir archivo...</button>
            </div>
            <div>
                <label for="text2" class="block text-gray-700 text-sm font-semibold mb-2" data-key="modifiedTextLabel">Texto modificado:</label>
                <textarea id="text2" rows="15" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ECA5E5] focus:border-transparent outline-none transition-all duration-200 resize-y" data-key="placeholderText2" placeholder="Pega el segundo texto aquí..."></textarea>
                <input type="file" id="fileInput2" accept=".txt,.srt,.po,.tmx" class="hidden">
                <button id="uploadBtn2" class="mt-2 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75" data-key="uploadButton2">Subir archivo...</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
            <button id="compareBtn" class="bg-[#ECA5E5] text-[#373737] font-bold py-3 px-6 rounded-lg shadow-md hover:bg-[#d494d4] transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[#ECA5E5] focus:ring-opacity-75" data-key="compareButton">
                Comparar textos
            </button>
            <button id="exportHtmlBtn" class="bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75" data-key="exportHtmlButton">
                Exportar a HTML
            </button>
            <button id="exportPdfBtn" class="bg-red-200 text-red-800 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-red-300 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75" data-key="exportPdfButton">
                Exportar a PDF
            </button>
        </div>

        <!-- Comparison Output -->
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-inner">
            <h2 class="text-2xl font-semibold text-[#373737] mb-4" data-key="resultsHeader">Resultados de la comparación:</h2>
            <div id="diffOutput" class="whitespace-pre-wrap text-sm leading-relaxed max-h-96 overflow-y-auto">
                <!-- Column headers are dynamically added by JS now -->
                <p class="text-gray-500 col-span-3" data-key="initialMessage">Haz clic en "comparar textos" para ver las diferencias.</p>
            </div>
        </div>
    </div>

    <script>
        // Get DOM elements
        const text1El = document.getElementById('text1');
        const text2El = document.getElementById('text2');
        const compareBtn = document.getElementById('compareBtn');
        const exportHtmlBtn = document.getElementById('exportHtmlBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const diffOutputEl = document.getElementById('diffOutput');
        const messageBox = document.getElementById('messageBox');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const langEsBtn = document.getElementById('langEsBtn');
        const langEnBtn = document.getElementById('langEnBtn');
        const fileInput1 = document.getElementById('fileInput1');
        const uploadBtn1 = document.getElementById('uploadBtn1');
        const fileInput2 = document.getElementById('fileInput2');
        const uploadBtn2 = document.getElementById('uploadBtn2');

        // Localization texts
        const texts = {
            es: {
                documentTitle: "Diffpanda - Comparador de Textos",
                tagline: "Compara textos y genera informes de cambios de manera rápida y sencilla.",
                originalTextLabel: "Texto original:",
                modifiedTextLabel: "Texto modificado:",
                compareButton: "Comparar textos",
                exportHtmlButton: "Exportar a HTML",
                exportPdfButton: "Exportar a PDF",
                resultsHeader: "Resultados de la comparación:",
                initialMessage: "Haz clic en \"comparar textos\" para ver las diferencias.",
                comparisonCompleted: "Comparación completada.",
                htmlReportTitle: "Informe de diferencias - Diffpanda",
                pdfReportTitle: "Informe de diferencias - Diffpanda",
                pdfLibrariesError: "Error: Librerías de PDF no cargadas. Intenta recargar la página.",
                pdfGenerationError: "Error al generar el informe PDF. Consulta la consola para más detalles.",
                htmlReportGenerated: "Informe HTML generado.",
                pdfReportGenerated: "Informe PDF generado.",
                originalColumn: "original",
                comparisonColumn: "comparación",
                revisedColumn: "revisado",
                placeholderText1: "Pega el primer texto aquí...",
                placeholderText2: "Pega el segundo texto aquí...",
                uploadButton1: "Subir archivo...",
                uploadButton2: "Subir archivo...",
                fileReadError: "Error al leer el archivo.",
                unsupportedFileType: "Tipo de archivo no soportado. Por favor, sube archivos TXT, SRT, PO o TMX."
            },
            en: {
                documentTitle: "Diffpanda - Text Comparator",
                tagline: "Compare texts and generate change reports quickly and easily.",
                originalTextLabel: "Original text:",
                modifiedTextLabel: "Modified text:",
                compareButton: "Compare texts",
                exportHtmlButton: "Export to HTML",
                exportPdfButton: "Export to PDF",
                resultsHeader: "Comparison results:",
                initialMessage: "Click \"compare texts\" to see differences.",
                comparisonCompleted: "Comparison completed.",
                htmlReportTitle: "Difference Report - Diffpanda",
                pdfReportTitle: "Difference Report - Diffpanda",
                pdfLibrariesError: "Error: PDF libraries not loaded. Try reloading the page.",
                pdfGenerationError: "Error generating PDF report. Check console for details.",
                htmlReportGenerated: "HTML report generated.",
                pdfReportGenerated: "PDF report generated.",
                originalColumn: "original",
                comparisonColumn: "comparison",
                revisedColumn: "revised",
                placeholderText1: "Paste the first text here...",
                placeholderText2: "Paste the second text here...",
                uploadButton1: "Upload file...",
                uploadButton2: "Upload file...",
                fileReadError: "Error reading file.",
                unsupportedFileType: "Unsupported file type. Please upload TXT, SRT, PO, or TMX files."
            }
        };

        let currentLang = 'es'; // Default language

        // Function to update UI elements based on selected language
        function updateUI(lang) {
            currentLang = lang;
            document.title = texts[lang].documentTitle;

            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (texts[lang][key]) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = texts[lang][key];
                    } else {
                        element.textContent = texts[lang][key];
                    }
                }
            });

            // Specific updates for button texts
            compareBtn.textContent = texts[lang].compareButton;
            exportHtmlBtn.textContent = texts[lang].exportHtmlButton;
            exportPdfBtn.textContent = texts[lang].exportPdfButton;
            uploadBtn1.textContent = texts[lang].uploadButton1;
            uploadBtn2.textContent = texts[lang].uploadButton2;

            // Update placeholders manually as data-key on textarea affects content, not placeholder
            text1El.placeholder = texts[lang].placeholderText1;
            text2El.placeholder = texts[lang].placeholderText2;

            // Update language button styles
            if (currentLang === 'es') {
                langEsBtn.className = 'font-bold py-2 px-4 rounded-lg transition-colors duration-200 bg-[#373737] text-[#ECA5E5] hover:bg-gray-700';
                langEnBtn.className = 'font-bold py-2 px-4 rounded-lg transition-colors duration-200 bg-[#ECA5E5] text-[#373737] hover:bg-[#d494d4]';
            } else { // currentLang === 'en'
                langEsBtn.className = 'font-bold py-2 px-4 rounded-lg transition-colors duration-200 bg-[#ECA5E5] text-[#373737] hover:bg-[#d494d4]';
                langEnBtn.className = 'font-bold py-2 px-4 rounded-lg transition-colors duration-200 bg-[#373737] text-[#ECA5E5] hover:bg-gray-700';
            }

            // Re-run comparison to update diff output headers and initial message
            compareTexts();
        }

        // Function to display a custom message box instead of alert()
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // Function to show loading spinner
        function showLoading() {
            loadingSpinner.style.display = 'block';
        }

        // Function to hide loading spinner
        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        /**
         * Parses SRT content to extract dialogue lines.
         * @param {string} srtContent - The raw SRT file content.
         * @returns {string} Cleaned text containing only dialogue.
         */
        function parseSrt(srtContent) {
            // Regex to match and remove SRT specific lines (sequence numbers, timestamps)
            const cleanedContent = srtContent.replace(/^\d+\s*$/gm, '') // Remove sequence numbers
                                             .replace(/^\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3}\s*$/gm, '') // Remove timestamps
                                             .replace(/^\s*[\r\n]+/gm, '') // Remove empty lines that result from removal
                                             .trim();
            return cleanedContent;
        }

        /**
         * Parses PO content to extract msgstr entries.
         * @param {string} poContent - The raw PO file content.
         * @returns {string} Concatenated msgstr entries.
         */
        function parsePo(poContent) {
            const lines = poContent.split('\n');
            let extractedText = [];
            let inMsgstr = false;

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('msgstr')) {
                    inMsgstr = true;
                    // Extract content after msgstr, removing quotes
                    const match = trimmedLine.match(/^msgstr\s+"(.*)"$/);
                    if (match && match[1]) {
                        extractedText.push(match[1]);
                    }
                } else if (inMsgstr && trimmedLine.startsWith('"') && trimmedLine.endsWith('"')) {
                    // Handle multi-line msgstr
                    extractedText.push(trimmedLine.slice(1, -1));
                } else {
                    inMsgstr = false; // Reset if not a msgstr line or continuation
                }
            }
            return extractedText.join('\n');
        }

        /**
         * Parses TMX content to extract segment text from tuv elements.
         * @param {string} tmxContent - The raw TMX file content.
         * @returns {string} Concatenated segment texts.
         */
        function parseTmx(tmxContent) {
            let extractedText = [];
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(tmxContent, "text/xml");

                // Check for parsing errors
                const errorNode = xmlDoc.querySelector('parsererror');
                if (errorNode) {
                    console.error('Error parsing TMX XML:', errorNode.textContent);
                    showMessage(texts[currentLang].fileReadError + ": Error de formato TMX.", 5000);
                    return '';
                }

                const tuvElements = xmlDoc.querySelectorAll('tuv seg');
                tuvElements.forEach(seg => {
                    extractedText.push(seg.textContent.trim());
                });
            } catch (e) {
                console.error('Error parsing TMX:', e);
                showMessage(texts[currentLang].fileReadError + ": Error de formato TMX.", 5000);
                return '';
            }
            return extractedText.join('\n');
        }

        /**
         * Handles file upload and populates the corresponding textarea.
         * @param {Event} event - The file input change event.
         * @param {HTMLTextAreaElement} textareaEl - The textarea element to populate.
         */
        function handleFileUpload(event, textareaEl) {
            showLoading();
            const file = event.target.files[0];
            if (!file) {
                hideLoading();
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                let content = e.target.result;
                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.txt')) {
                    // No special parsing needed for TXT
                } else if (fileName.endsWith('.srt')) {
                    content = parseSrt(content);
                } else if (fileName.endsWith('.po')) {
                    content = parsePo(content);
                } else if (fileName.endsWith('.tmx')) {
                    content = parseTmx(content);
                } else {
                    showMessage(texts[currentLang].unsupportedFileType, 5000);
                    textareaEl.value = ''; // Clear textarea if unsupported
                    hideLoading();
                    return;
                }
                textareaEl.value = content;
                hideLoading();
                showMessage(texts[currentLang].comparisonCompleted); // Re-use message for file loaded
            };

            reader.onerror = () => {
                showMessage(texts[currentLang].fileReadError, 5000);
                hideLoading();
            };

            reader.readAsText(file);
        }

        /**
         * Performs a word-level diff between two lines and returns HTML for the comparison column.
         * @param {string} line1 - The original line.
         * @param {string} line2 - The modified line.
         * @returns {string} HTML string with removed words struck through and added words highlighted.
         */
        function getWordDiffHtml(line1, line2) {
            const words1 = line1.split(/(\s+)/).filter(w => w.length > 0); // Keep delimiters
            const words2 = line2.split(/(\s+)/).filter(w => w.length > 0);

            let output = '';
            let i = 0; // pointer for words1
            let j = 0; // pointer for words2

            while (i < words1.length || j < words2.length) {
                if (i < words1.length && j < words2.length && words1[i] === words2[j]) {
                    // Common word
                    output += `<span>${words1[i]}</span>`;
                    i++;
                    j++;
                } else {
                    // Words are different, or one list ended
                    let foundMatchForWord1 = -1;
                    if (i < words1.length) {
                        foundMatchForWord1 = words2.indexOf(words1[i], j + 1); // Look ahead in words2 for current word1
                    }

                    let foundMatchForWord2 = -1;
                    if (j < words2.length) {
                        foundMatchForWord2 = words1.indexOf(words2[j], i + 1); // Look ahead in words1 for current word2
                    }

                    if (i < words1.length && (foundMatchForWord1 === -1 || (foundMatchForWord2 !== -1 && foundMatchForWord2 < foundMatchForWord1))) {
                        // Word1 is removed (or changed, but we represent it as removed and then added new)
                        output += `<span class="diff-changed-word-removed">${words1[i]}</span>`;
                        i++;
                    } else if (j < words2.length) {
                        // Word2 is added
                        output += `<span class="diff-changed-word-added">${words2[j]}</span>`;
                        j++;
                    } else {
                        // Fallback for end of one list, or complex mismatch
                        if (i < words1.length) {
                            output += `<span class="diff-changed-word-removed">${words1[i]}</span>`;
                            i++;
                        }
                        if (j < words2.length) {
                            output += `<span class="diff-changed-word-added">${words2[j]}</span>`;
                            j++;
                        }
                    }
                }
            }
            return output.trim();
        }


        // Main function to compare texts
        function compareTexts() {
            showLoading();
            const text1 = text1El.value;
            const text2 = text2El.value;

            const lines1 = text1.split('\n');
            const lines2 = text2.split('\n');

            let diffHtml = '';

            // Add column headers based on current language
            diffHtml += `<div class="diff-header">${texts[currentLang].originalColumn}</div>`;
            diffHtml += `<div class="diff-header">${texts[currentLang].comparisonColumn}</div>`;
            diffHtml += `<div class="diff-header">${texts[currentLang].revisedColumn}</div>`;

            // Simple line-by-line comparison with look-ahead for better diff
            // This is a basic implementation and not a full Myers diff algorithm.
            // It tries to find matching lines to determine additions/removals/changes.
            let i = 0; // pointer for lines1
            let j = 0; // pointer for lines2

            while (i < lines1.length || j < lines2.length) {
                const line1 = lines1[i] !== undefined ? lines1[i] : null;
                const line2 = lines2[j] !== undefined ? lines2[j] : null;

                if (line1 === line2 && line1 !== null) {
                    // Identical lines
                    diffHtml += `<div class="diff-unchanged">${line1}</div>`; // Original
                    diffHtml += `<div class="diff-unchanged comparison-cell">${line1}</div>`; // Comparison
                    diffHtml += `<div class="diff-unchanged">${line2}</div>`; // Revised
                    i++;
                    j++;
                } else {
                    // Lines are different or one is missing
                    let line1IsRemoved = false;
                    let line2IsAdded = false;
                    let lineIsChanged = false;

                    // Try to find line1 in future lines of text2
                    let nextMatchIn2 = -1;
                    if (line1 !== null) {
                        nextMatchIn2 = lines2.indexOf(line1, j + 1);
                    }

                    // Try to find line2 in future lines of text1
                    let nextMatchIn1 = -1;
                    if (line2 !== null) {
                        nextMatchIn1 = lines1.indexOf(line2, i + 1);
                    }

                    if (line1 !== null && (line2 === null || nextMatchIn2 === -1 || (nextMatchIn1 !== -1 && nextMatchIn1 < nextMatchIn2))) {
                        // Line1 is removed or changed (if line2 also exists)
                        if (line2 !== null && (nextMatchIn1 === -1 || (nextMatchIn2 !== -1 && nextMatchIn2 < nextMatchIn1))) {
                            // Both lines exist but are different, consider it a change
                            lineIsChanged = true;
                        } else {
                            // Line1 is purely removed
                            line1IsRemoved = true;
                        }
                    } else if (line2 !== null) {
                        // Line2 is purely added
                        line2IsAdded = true;
                    }


                    if (lineIsChanged) {
                        const comparisonHtml = getWordDiffHtml(line1, line2);
                        diffHtml += `<div class="diff-removed">${line1}</div>`; // Original
                        diffHtml += `<div class="comparison-cell">${comparisonHtml}</div>`; // Comparison (word diff)
                        diffHtml += `<div class="diff-added">${line2}</div>`; // Revised
                        i++;
                        j++;
                    } else if (line1IsRemoved) {
                        diffHtml += `<div class="diff-removed">${line1}</div>`; // Original
                        diffHtml += `<div class="comparison-cell"><span class="diff-changed-word-removed">${line1}</span></div>`; // Comparison (removed)
                        diffHtml += `<div></div>`; // Revised (empty)
                        i++;
                    } else if (line2IsAdded) {
                        diffHtml += `<div></div>`; // Original (empty)
                        diffHtml += `<div class="comparison-cell"><span class="diff-changed-word-added">${line2}</span></div>`; // Comparison (added)
                        diffHtml += `<div class="diff-added">${line2}</div>`; // Revised
                        j++;
                    } else {
                        // Fallback for unexpected cases or end of one text
                        if (line1 !== null) {
                            diffHtml += `<div class="diff-removed">${line1}</div>`;
                            diffHtml += `<div class="comparison-cell"><span class="diff-changed-word-removed">${line1}</span></div>`;
                            diffHtml += `<div></div>`;
                            i++;
                        } else if (line2 !== null) {
                            diffHtml += `<div></div>`;
                            diffHtml += `<div class="comparison-cell"><span class="diff-changed-word-added">${line2}</span></div>`;
                            diffHtml += `<div class="diff-added">${line2}</div>`;
                            j++;
                        } else {
                            i++; j++; // Avoid infinite loop if both are null
                        }
                    }
                }
            }

            // If no differences and texts are empty, show initial message
            if (diffHtml.trim() === `<div class="diff-header">${texts[currentLang].originalColumn}</div><div class="diff-header">${texts[currentLang].comparisonColumn}</div><div class="diff-header">${texts[currentLang].revisedColumn}</div>`) {
                diffHtml += `<p class="text-gray-500 col-span-3" data-key="initialMessage">${texts[currentLang].initialMessage}</p>`;
            }

            diffOutputEl.innerHTML = diffHtml;
            hideLoading();
            showMessage(texts[currentLang].comparisonCompleted);
        }

        // Function to export the comparison report to HTML
        function exportToHtml() {
            showLoading();
            // Capture the entire diffOutputEl content, including headers
            const reportContent = diffOutputEl.innerHTML;
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${texts[currentLang].htmlReportTitle}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; background-color: #f9fafb; color: #373737; }
                        h1 { color: #373737; text-align: center; margin-bottom: 30px; }
                        .diff-container { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background-color: #ffffff; padding: 15px; }
                        /* Styles for the three-column grid in export */
                        .diff-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 1rem;
                            font-size: 0.9rem;
                            line-height: 1.5;
                            white-space: pre-wrap;
                            word-break: break-word; /* Changed from break-all to break-word */
                        }
                        .diff-grid > div {
                            padding: 0.5rem;
                            border-radius: 0.25rem;
                            min-height: 2rem;
                        }
                        .diff-header {
                            font-weight: bold;
                            color: #373737;
                            border-bottom: 2px solid #e5e7eb;
                            padding-bottom: 0.5rem;
                            margin-bottom: 0.5rem;
                        }
                        .diff-unchanged { background-color: #f9fafb; border-left: 4px solid #cbd5e1; }
                        .diff-added { background-color: #d1fae5; border-left: 4px solid #34d399; }
                        .diff-removed { background-color: #fee2e2; border-left: 4px solid #ef4444; }
                        .diff-changed-word-added { background-color: #a7f3d0; padding: 0 2px; border-radius: 4px; }
                        .diff-changed-word-removed { background-color: #fecaca; padding: 0 2px; border-radius: 4px; text-decoration: line-through; }
                        .logo-header { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo-header img { height: 125px; width: auto; margin-right: 10px; }
                        .comparison-cell {
                            background-color: #f0f0f0;
                            border: 1px dashed #ccc;
                        }
                    </style>
                </head>
                <body>
                    <div class="logo-header">
                        <img src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/diffpanda-logo.png" alt="Diffpanda Logo">
                        <h1>${texts[currentLang].htmlReportTitle}</h1>
                    </div>
                    <div class="diff-container">
                        <div class="diff-grid">
                            ${reportContent}
                        </div>
                    </div>
                </body>
                </html>
            `;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diffpanda_report.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up the URL object
            hideLoading();
            showMessage(texts[currentLang].htmlReportGenerated);
        }

        // Function to export the comparison report to PDF
        async function exportToPdf() {
            showLoading();
            try {
                // Ensure jsPDF and html2canvas are loaded
                if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
                    showMessage(texts[currentLang].pdfLibrariesError, 5000);
                    hideLoading();
                    return;
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4'); // Portrait, points, A4 size

                // Create a temporary div to render the content for PDF, including header
                const pdfContent = document.createElement('div');
                pdfContent.style.padding = '20px';
                pdfContent.style.fontFamily = 'Inter, sans-serif';
                pdfContent.style.color = '#373737';
                pdfContent.style.backgroundColor = '#ffffff'; // Ensure white background for PDF

                // Add logo and title to PDF content
                pdfContent.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <!-- Updated logo size for PDF export -->
                        <img src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/diffpanda-logo.png" style="height: 125px; width: auto; margin-right: 10px;">
                        <h1 style="color: #373737; font-size: 24px; text-align: center;">${texts[currentLang].pdfReportTitle}</h1>
                    </div>
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background-color: #ffffff; padding: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word;">
                            ${diffOutputEl.innerHTML}
                        </div>
                    </div>
                `;
                document.body.appendChild(pdfContent); // Temporarily add to DOM for html2canvas

                // Use html2canvas to render the content to an image
                const canvas = await html2canvas(pdfContent, {
                    scale: 2, // Higher scale for better resolution in PDF
                    useCORS: true, // Needed if images are from external domains
                    logging: false // Disable logging for cleaner console
                });

                // Remove the temporary div
                document.body.removeChild(pdfContent);

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 595; // A4 width in points
                const pageHeight = 842; // A4 height in points
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save('diffpanda_report.pdf');
                showMessage(texts[currentLang].pdfReportGenerated);

            } catch (error) {
                console.error('Error al generar el PDF:', error);
                showMessage(texts[currentLang].pdfGenerationError, 5000);
            } finally {
                hideLoading();
            }
        }

        // Event Listeners
        compareBtn.addEventListener('click', compareTexts);
        exportHtmlBtn.addEventListener('click', exportToHtml);
        exportPdfBtn.addEventListener('click', exportToPdf);
        langEsBtn.addEventListener('click', () => updateUI('es'));
        langEnBtn.addEventListener('click', () => updateUI('en'));

        // File input listeners
        uploadBtn1.addEventListener('click', () => fileInput1.click());
        fileInput1.addEventListener('change', (e) => handleFileUpload(e, text1El));
        uploadBtn2.addEventListener('click', () => fileInput2.click());
        fileInput2.addEventListener('change', (e) => handleFileUpload(e, text2El));


        // Initial content for text areas (optional)
        text1El.value = `¡Hola mundo!
Esta es la primera línea.
Aquí hay un cambio importante.
Una línea más.
Fin del texto.`;

        text2El.value = `¡Hola universo!
Esta es la primera línea.
Aquí hay un cambio muy significativo.
Una línea más.
Nueva línea añadida.
Fin del texto.`;

        // Run comparison on initial load and set default language
        updateUI('es'); // Set default language to Spanish
    </script>
</body>
</html>
