<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="appTitle">PandaScript</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; overflow: hidden; }
    #left, #right { overflow: auto; }
    #left::-webkit-scrollbar, #right::-webkit-scrollbar { width: 0px; background: transparent; }
    #resizer { flex-basis: 2px; flex-shrink: 0; cursor: col-resize; transition: background-color 0.2s ease-in-out; }
    #resizer:hover { background-color: #FF4853; }
    .timestamp { color: #FF4853 !important; text-decoration: underline !important; cursor: pointer; background: none !important; }
    
    #video-player-container { position: relative; overflow: hidden; }
    #video-controls-overlay {
        position: absolute; bottom: 0; left: 0; right: 0;
        padding: 8px;
        background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
        opacity: 0; visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    #video-player-container:hover #video-controls-overlay { opacity: 1; visibility: visible; }
    
    #progressBarContainer {
        width: 95%; height: 5px; background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px; cursor: pointer; margin: 0 auto;
    }
    #progressBar { width: 0%; height: 100%; background-color: #FF4853; border-radius: 10px; }

    .control-button-row { display: flex; justify-content: center; align-items: center; gap: 6px; }
    .control-button {
        background-color: rgba(55, 55, 55, 0.8); color: white;
        border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px;
        padding: 4px 8px; transition: background-color 0.2s, transform 0.2s;
        font-size: 0.75rem; line-height: 1;
    }
    .control-button:hover { background-color: #FF4853; transform: scale(1.05); }
    .control-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(55, 55, 55, 0.8); }
    #playPauseBtn { font-size: 1rem; padding: 6px 10px; }
    #playPauseBtn.playing i:before { content: "\f04c"; }
    .volume-container { display: flex; align-items: center; gap: 8px; }
    #volumeSlider { width: 70px; height: 5px; -webkit-appearance: none; appearance: none; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; transition: opacity 0.2s; }
    #volumeSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: #FF4853; border-radius: 50%; cursor: pointer; }
    #volumeSlider::-moz-range-thumb { width: 12px; height: 12px; background: #FF4853; border-radius: 50%; cursor: pointer; }

    #tcrDisplay { font-family: 'Courier New', monospace; }
    .recurring-btn:hover { background-color: #FF4853 !important; }

    #editor { min-height: 200px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
    
    .editor-button-group { display: flex; align-items: center; gap: 0.5rem; }
    .editor-button { padding: 0.375rem 0.625rem; }
    .dropdown-item { display: block; width: 100%; text-align: left; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content { position: relative; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); max-width: 500px; width: 90%; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .shortcut-button.is-listening { border-color: #FF4853; color: #FF4853; }
    #modalBody { max-height: 60vh; overflow-y: auto; }
    .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }

    /* Find & Replace Bar Styles */
    #find-replace-bar {
        padding: 8px;
        border-bottom: 1px solid;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    #find-replace-bar input[type="text"] {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid;
        font-size: 0.875rem;
    }
    #find-replace-bar button {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.875rem;
        transition: background-color 0.2s;
    }
  </style>
</head>
<body class="flex flex-row h-screen">

  <div id="left" class="p-4 flex flex-col relative" style="flex-basis: 40%;">
    
    <div id="video-player-container" class="relative w-full overflow-hidden rounded-lg mb-4 shadow-2xl" style="padding-top: 56.25%;">
        <div class="absolute inset-0 bg-black flex items-center justify-center">
            <video id="video" class="w-full h-full object-contain"></video> 
            <div id="emptyPlayerOverlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black text-gray-400">
                <img src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/pandascript-logo.png" alt="PandaScript Logo" class="h-24 mb-2"> 
                <span class="text-xl font-bold">PandaScript</span>
            </div>
        </div>
        <div id="video-controls-overlay">
            <div id="progressBarContainer">
                <div id="progressBar"></div>
            </div>
            <div class="control-button-row">
                <button id="speedDownBtn" class="control-button">-0.25x</button>
                <button id="rewind5sBtn" class="control-button">-5s</button>
                <button id="rewind1sBtn" class="control-button">-1s</button>
                <button id="rewind1fBtn" class="control-button">-1f</button>
                <button id="playPauseBtn" class="control-button"><i class="fas fa-play"></i></button>
                <button id="forward1fBtn" class="control-button">+1f</button>
                <button id="forward1sBtn" class="control-button">+1s</button>
                <button id="forward5sBtn" class="control-button">+5s</button>
                <button id="speedUpBtn" class="control-button">+0.25x</button>
                <span id="speedDisplay" class="text-white text-xs font-semibold mx-2">1.0x</span>
                <div class="volume-container">
                    <button id="muteBtn" class="control-button"><i class="fas fa-volume-up"></i></button>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
                </div>
            </div>
        </div>
    </div>
    
    <button id="importVideoAudioBtn" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out mb-4" data-i18n="openMediaFile" data-i18n-title="openMediaFileTitle"><i class="fas fa-file-video mr-2"></i>Open Video/Audio File</button>
    <input type="file" id="videoFileInput" accept="video/*,audio/*" class="hidden" />

    <div id="waveform-container" class="w-full h-24 mb-4 rounded-lg shadow-md hidden"></div>
    
    <div id="tcrDisplay" class="font-mono text-4xl p-4 text-center rounded-lg mb-4 shadow-md w-full">--:--:--,---</div>

    <div class="flex flex-wrap gap-2 mb-4 w-full">
      <button id="insertTimecodeBtn" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><span data-i18n="insertTimecode">Insert Timecode</span></button>
      <button id="timecodeFormatBtn" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm" data-i18n="timecodeFormat"><i class="fas fa-gear mr-2"></i>Timecode Format</button>
      <button id="setInitialTimecodeBtn" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm" data-i18n="setInitialTimecode"><i class="fas fa-play mr-2"></i>Set Initial Timecode</button>
    </div>
    
    <div id="recurringTextSection" class="mt-auto mb-6 w-full">
      <div class="flex items-center justify-between mb-3 border-b pb-2">
        <h4 class="text-lg font-semibold" data-i18n="recurringTextHeader">Recurring Text</h4>
        <button id="addRecurringTextBtn" class="font-bold p-1 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><i class="fas fa-plus"></i></button>
      </div>
      <div id="recurringTextContainer" class="flex flex-col gap-2 justify-center"></div>
    </div>
  </div>

  <div id="resizer"></div>

  <div id="right" class="p-4 flex flex-col relative" style="flex-basis: 60%;">
    <div id="controls" class="mb-4 flex flex-wrap items-center gap-2">
        <div class="relative inline-block text-left">
            <button id="fileMenuBtn" type="button" class="inline-flex justify-center rounded-md border shadow-sm px-4 py-2 text-sm font-medium focus:outline-none">
                <span data-i18n="fileMenu">File</span>
                <i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5"></i>
            </button>
            <div id="fileMenuDropdown" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                <div class="py-1" role="menu" aria-orientation="vertical">
                    <a href="#" id="newTranscriptionBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-file-alt mr-3"></i><span data-i18n="newTranscription">Nueva transcripción</span></a>
                    <a href="#" id="importTextBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-file-import mr-3"></i><span data-i18n="importText">Import .txt</span></a>
                    <a href="#" id="exportBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-file-export mr-3"></i><span data-i18n="export">Export</span></a>
                    <a href="#" id="backupBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-save mr-3"></i><span data-i18n="backup">Copia de seguridad</span></a>
                </div>
            </div>
        </div>
        <div class="relative inline-block text-left">
            <button id="settingsMenuBtn" type="button" class="inline-flex justify-center rounded-md border shadow-sm px-4 py-2 text-sm font-medium focus:outline-none">
                <span data-i18n="settingsMenu">Settings</span>
                <i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5"></i>
            </button>
            <div id="settingsMenuDropdown" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                <div class="py-1" role="menu" aria-orientation="vertical">
                    <a href="#" id="shortcutsBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-keyboard mr-3"></i><span data-i18n="shortcutsButton">Keyboard Shortcuts</span></a>
                    <a href="#" id="themeToggleBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i id="themeIcon" class="fas fa-moon mr-3"></i><span id="themeText" data-i18n="darkMode">Dark Mode</span></a>
                    <a href="#" id="languageToggleBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-language mr-3"></i><span id="languageText" data-i18n="changeLanguageButton">Change Language</span></a>
                </div>
            </div>
        </div>
        <div class="border-l h-6 mx-2" id="controlsSeparator"></div>
        <div class="editor-button-group">
            <input type="file" id="textFileInput" accept=".txt" class="hidden" />
            <input type="file" id="shortcutImportInput" accept=".json" class="hidden" />
            <button id="boldBtn" class="editor-button rounded-md border shadow-sm"><i class="fas fa-bold"></i></button>
            <button id="italicBtn" class="editor-button rounded-md border shadow-sm"><i class="fas fa-italic"></i></button>
            <button id="uppercaseBtn" class="editor-button rounded-md border shadow-sm font-bold">aA</button>
            <button id="lowercaseBtn" class="editor-button rounded-md border shadow-sm font-bold">Aa</button>
            <select id="fontFamilySelect" title="Select Font Family" class="rounded-md border shadow-sm px-2 py-1.5 text-sm focus:outline-none"></select>
            <select id="fontSizeSelect" title="Select Font Size" class="rounded-md border shadow-sm px-2 py-1.5 text-sm focus:outline-none"></select>
        </div>
    </div>
    
    <div id="find-replace-bar" class="hidden">
        <div class="flex flex-col gap-2 flex-grow">
            <div class="flex items-center gap-2">
                <input type="text" id="find-input" class="flex-grow" data-i18n-placeholder="findPlaceholder" />
                <span id="find-results-count" class="text-sm">0/0</span>
                <button id="find-prev-btn" data-i18n-title="tooltip_find_previous"><i class="fas fa-arrow-up"></i></button>
                <button id="find-next-btn" data-i18n-title="tooltip_find_next"><i class="fas fa-arrow-down"></i></button>
                <button id="toggle-replace-btn" data-i18n-title="tooltip_toggle_replace" class="px-2 py-1"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div id="replace-controls" class="hidden items-center gap-2">
                <input type="text" id="replace-input" class="flex-grow" />
                <button id="replace-btn" data-i18n="replace">Replace</button>
                <button id="replace-all-btn" data-i18n="replaceAll">Replace All</button>
            </div>
        </div>
        <div class="flex items-center gap-2 ml-auto pl-4">
             <label class="flex items-center gap-1 text-sm cursor-pointer">
                <input type="checkbox" id="match-case-checkbox" />
                <span data-i18n="caseSensitive">Match case</span>
            </label>
        </div>
    </div>

    <div id="editor" contenteditable="true" spellcheck="true" aria-label="Text editor" class="w-full flex-1 rounded-lg p-4 text-sm overflow-y-auto outline-none shadow-inner">
      <p data-i18n="editorPlaceholder">Start transcribing here...</p>
    </div>
  </div>

  <div id="customModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
      <p id="modalMessage" class="mb-4"></p>
      <div id="modalBody" class="mb-4"></div>
      <div id="modalButtons" class="modal-buttons"></div>
    </div>
  </div>

  <script type="module">
        // --- DOM Element References ---
        const video = document.getElementById('video');
        const videoFileInput = document.getElementById('videoFileInput');
        const importVideoAudioBtn = document.getElementById('importVideoAudioBtn');
        const textFileInput = document.getElementById('textFileInput');
        const editor = document.getElementById('editor');
        const tcrDisplay = document.getElementById('tcrDisplay');
        const emptyPlayerOverlay = document.getElementById('emptyPlayerOverlay');
        const recurringTextContainer = document.getElementById('recurringTextContainer');
        const addRecurringTextBtn = document.getElementById('addRecurringTextBtn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const rewind5sBtn = document.getElementById('rewind5sBtn');
        const rewind1sBtn = document.getElementById('rewind1sBtn');
        const rewind1fBtn = document.getElementById('rewind1fBtn');
        const forward1fBtn = document.getElementById('forward1fBtn');
        const forward1sBtn = document.getElementById('forward1sBtn');
        const forward5sBtn = document.getElementById('forward5sBtn');
        const speedDownBtn = document.getElementById('speedDownBtn');
        const speedUpBtn = document.getElementById('speedUpBtn');
        const speedDisplay = document.getElementById('speedDisplay');
        const muteBtn = document.getElementById('muteBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const insertTimecodeBtn = document.getElementById('insertTimecodeBtn');
        const timecodeFormatBtn = document.getElementById('timecodeFormatBtn');
        const setInitialTimecodeBtn = document.getElementById('setInitialTimecodeBtn');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const uppercaseBtn = document.getElementById('uppercaseBtn');
        const lowercaseBtn = document.getElementById('lowercaseBtn');
        const fileMenuBtn = document.getElementById('fileMenuBtn');
        const fileMenuDropdown = document.getElementById('fileMenuDropdown');
        const settingsMenuBtn = document.getElementById('settingsMenuBtn');
        const settingsMenuDropdown = document.getElementById('settingsMenuDropdown');
        const newTranscriptionBtn = document.getElementById('newTranscriptionBtn');
        const importTextBtn = document.getElementById('importTextBtn');
        const exportBtn = document.getElementById('exportBtn');
        const backupBtn = document.getElementById('backupBtn');
        const shortcutsBtn = document.getElementById('shortcutsBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const languageToggleBtn = document.getElementById('languageToggleBtn');
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('left');
        const rightPanel = document.getElementById('right');
        const fontFamilySelect = document.getElementById('fontFamilySelect');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        const waveformContainer = document.getElementById('waveform-container');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const shortcutImportInput = document.getElementById('shortcutImportInput');
        // Find & Replace elements
        const findReplaceBar = document.getElementById('find-replace-bar');
        const findInput = document.getElementById('find-input');
        const replaceInput = document.getElementById('replace-input');
        const findResultsCount = document.getElementById('find-results-count');
        const findPrevBtn = document.getElementById('find-prev-btn');
        const findNextBtn = document.getElementById('find-next-btn');
        const matchCaseCheckbox = document.getElementById('match-case-checkbox');
        const replaceBtn = document.getElementById('replace-btn');
        const replaceAllBtn = document.getElementById('replace-all-btn');
        const toggleReplaceBtn = document.getElementById('toggle-replace-btn');
        const replaceControls = document.getElementById('replace-controls');

        // --- Estado de la Aplicación ---
        const DEFAULT_FRAMERATE = 30;
        let tcrOffsetSeconds = 0;
        let isDarkMode = false;
        let currentLanguage = localStorage.getItem('pandascript_language') || 'en';
        let wavesurfer = null;
        let lastVolume = 1;
        let shortcuts = {};
        let isEditorPristine = true;
        let listeningForShortcut = null;
        let tempShortcuts = {};

        // --- Traducciones ---
        const translations = {
            en: { appTitle: "PandaScript", openMediaFile: "Open Video/Audio File", insertTimecode: "Insert timecode", timecodeFormat: "Timecode Format", setInitialTimecode: "Set Initial Timecode", recurringTextHeader: "Recurring Text", fileMenu: "File", settingsMenu: "Settings", newTranscription: "New transcription", importText: "Import .txt", export: "Export", backup: "Backup", shortcutsButton: "Keyboard Shortcuts", darkMode: "Dark Mode", lightMode: "Light Mode", changeLanguageButton: "Change Language", editorPlaceholder: "Open a video or audio file and start transcribing. Use the built-in commands and keyboard shortcuts to speed up your workflow.", exportModalTitle: "Export Transcription", filenameLabel: "Filename:", formatLabel: "Format:", exportBtnText: "Export", newTranscriptionConfirm: "Are you sure you want to start a new transcription? Any unsaved progress will be lost.", backupFoundTitle: "Backup Found", backupFoundMessage: "An automatic backup was found. Do you want to restore it?", restore: "Restore", discard: "Discard", noBackup: "No backup available.", shortcutsModalTitle: "Customize Keyboard Shortcuts", shortcutsModalMessage: "Click on a button to set a new shortcut.", resetShortcuts: "Restore", pressNewShortcut: "Press new keys...", saveShortcuts: "Save", importShortcuts: "Import", exportShortcuts: "Export", shortcutsImported: "Shortcuts imported successfully.", shortcutsImportError: "Error importing shortcuts. Invalid file format.", shortcutLabel_playPause: "Play/Pause", shortcutLabel_rewind5s: "Rewind 5s", shortcutLabel_forward5s: "Forward 5s", shortcutLabel_rewind1s: "Rewind 1s", shortcutLabel_forward1s: "Forward 1s", shortcutLabel_rewind1frame: "Rewind 1 frame", shortcutLabel_forward1frame: "Forward 1 frame", shortcutLabel_speedUp: "Speed Up", shortcutLabel_speedDown: "Speed Down", shortcutLabel_insertTimecode: "Insert timecode", shortcutLabel_insertRecurringText: "Insert recurring text", unsavedChangesTitle: "Unsaved Changes", unsavedChangesMessage: "You have unsaved changes in the shortcuts. Do you want to close without saving?", continueAndClose: "Continue and Close", goBack: "Go Back", findPlaceholder: "Find...", caseSensitive: "Match case", replace: "Replace", replaceAll: "Replace All", shortcutLabel_bold: "Bold", shortcutLabel_italic: "Italic", shortcutLabel_uppercase: "Uppercase", shortcutLabel_lowercase: "Lowercase", tooltip_add_recurring: "Add text to editor", tooltip_delete_recurring: "Delete field", shortcutLabel_find: "Find", shortcutLabel_replace: "Replace", tooltip_find_previous: "Find Previous", tooltip_find_next: "Find Next", tooltip_toggle_replace: "Toggle Replace", tooltip_close_find_bar: "Close", languageModalTitle: "Change Language", save: "Save", cancel: "Cancel" },
            es: { appTitle: "PandaScript", openMediaFile: "Abrir Vídeo/Audio", insertTimecode: "Insertar código de tiempo", timecodeFormat: "Formato TCR", setInitialTimecode: "TCR Inicial", recurringTextHeader: "Texto recurrente", fileMenu: "Archivo", settingsMenu: "Ajustes", newTranscription: "Nueva transcripción", importText: "Importar .txt", export: "Exportar", backup: "Copia de seguridad", shortcutsButton: "Atajos de teclado", darkMode: "Modo oscuro", lightMode: "Modo claro", changeLanguageButton: "Cambiar idioma", editorPlaceholder: "Abre un archivo de vídeo o audio y empieza a transcribir aquí. Utiliza los diferentes comandos y atajos de teclado para transcribir de manera productiva.", exportModalTitle: "Exportar Transcripción", filenameLabel: "Nombre del archivo:", formatLabel: "Formato:", exportBtnText: "Exportar", newTranscriptionConfirm: "¿Seguro que quieres empezar una nueva transcripción? Se perderá todo el progreso no guardado.", backupFoundTitle: "Copia de seguridad encontrada", backupFoundMessage: "Se encontró una copia de seguridad automática. ¿Quieres restaurarla?", restore: "Restaurar", discard: "Descartar", noBackup: "No hay ninguna copia de seguridad disponible.", shortcutsModalTitle: "Personalizar Atajos de Teclado", shortcutsModalMessage: "Haz clic en un botón para asignar un nuevo atajo.", resetShortcuts: "Restaurar", pressNewShortcut: "Pulsa las nuevas teclas...", saveShortcuts: "Guardar", importShortcuts: "Importar", exportShortcuts: "Exportar", shortcutsImported: "Atajos importados correctamente.", shortcutsImportError: "Error al importar atajos. Formato de archivo no válido.", shortcutLabel_playPause: "Reproducir/Pausar", shortcutLabel_rewind5s: "Retroceder 5s", shortcutLabel_forward5s: "Avanzar 5s", shortcutLabel_rewind1s: "Retroceder 1s", shortcutLabel_forward1s: "Avanzar 1s", shortcutLabel_rewind1frame: "Retroceder 1 fotograma", shortcutLabel_forward1frame: "Avanzar 1 fotograma", shortcutLabel_speedUp: "Acelerar", shortcutLabel_speedDown: "Ralentizar", shortcutLabel_insertTimecode: "Insertar código de tiempo", shortcutLabel_insertRecurringText: "Insertar texto recurrente", unsavedChangesTitle: "Cambios no guardados", unsavedChangesMessage: "Tienes cambios sin guardar en los atajos. ¿Quieres cerrar sin guardar?", continueAndClose: "Continuar y cerrar", goBack: "Volver", findPlaceholder: "Buscar...", caseSensitive: "Distinguir mayúsculas", replace: "Reemplazar", replaceAll: "Reemplazar todos", shortcutLabel_bold: "Negrita", shortcutLabel_italic: "Cursiva", shortcutLabel_uppercase: "Mayúsculas", shortcutLabel_lowercase: "Minúsculas", tooltip_add_recurring: "Añadir texto al editor", tooltip_delete_recurring: "Eliminar campo", shortcutLabel_find: "Buscar", shortcutLabel_replace: "Reemplazar", tooltip_find_previous: "Buscar anterior", tooltip_find_next: "Buscar siguiente", tooltip_toggle_replace: "Habilitar buscar y reemplazar", tooltip_close_find_bar: "Cerrar", languageModalTitle: "Cambiar Idioma", save: "Guardar", cancel: "Cancelar" }
        };

        const availableLanguages = {
            en: 'English',
            es: 'Español'
        };

        // --- Definición de Temas ---
        const themeClasses = {
            dark: { bodyBg: 'bg-gray-950', bodyText: 'text-gray-200', panelBg: 'bg-gray-800', border: 'border-gray-700', editorBg: 'bg-gray-900', editorText: 'text-gray-200', btnNeutral: 'bg-gray-600 hover:bg-gray-500 text-white', menuBtnBg: 'bg-gray-700', menuBtnText: 'text-gray-200', menuBtnHoverBg: 'hover:bg-gray-600', waveformContainerBg: 'bg-gray-900', waveColor: '#373737', progressColor: '#FF4853', cursorColor: '#FF4853', dropdownBg: 'bg-gray-800', modalContentBg: 'bg-gray-800', modalContentText: 'text-gray-200', findBarBg: 'bg-gray-800', findBarBorder: 'border-gray-700', findBarInputBg: 'bg-gray-700', findBarInputBorder: 'border-gray-600' },
            light: { bodyBg: 'bg-gray-50', bodyText: 'text-gray-900', panelBg: 'bg-white', border: 'border-gray-300', editorBg: 'bg-white', editorText: 'text-black', btnNeutral: 'bg-gray-200 hover:bg-gray-300 text-black', menuBtnBg: 'bg-white', menuBtnText: 'text-gray-700', menuBtnHoverBg: 'hover:bg-gray-50', waveformContainerBg: 'bg-gray-200', waveColor: '#CBD5E0', progressColor: '#FF4853', cursorColor: '#FF4853', dropdownBg: 'bg-white', modalContentBg: 'bg-white', modalContentText: 'text-gray-900', findBarBg: 'bg-gray-100', findBarBorder: 'border-gray-300', findBarInputBg: 'bg-white', findBarInputBorder: 'border-gray-400' }
        };

        // --- Formatos de TCR ---
        const pad = (num, len = 2) => String(num).padStart(len, '0');
        const tcrFormats = [
            { name: "HH:MM:SS,MSS", format: (t) => { if(isNaN(t)) return '--:--:--,---'; const h=Math.floor(t/3600),m=Math.floor(t%3600/60),s=Math.floor(t%60),ms=Math.floor(t%1*1000); return `${pad(h)}:${pad(m)}:${pad(s)},${pad(ms,3)}`; }},
            { name: "HH:MM:SS:FF", format: (t, fr) => { if(isNaN(t)) return '--:--:--:--'; const tf=Math.floor(t*fr),h=Math.floor(tf/(3600*fr)),m=Math.floor(tf/(60*fr)%60),s=Math.floor(tf/fr%60),f=tf%fr; return `${pad(h)}:${pad(m)}:${pad(s)}:${pad(f)}`; }},
            { name: "MM:SS,MSS", format: (t) => { if(isNaN(t)) return '--:--,---'; const m=Math.floor(t/60),s=Math.floor(t%60),ms=Math.floor(t%1*1000); return `${pad(m)}:${pad(s)},${pad(ms,3)}`; }},
            { name: "MM:SS", format: (t) => { if(isNaN(t)) return '--:--'; const m=Math.floor(t/60),s=Math.floor(t%60); return `${pad(m)}:${pad(s)}`; }},
            { name: "MM:SS:FF", format: (t, fr) => { if(isNaN(t)) return '--:--:--'; const tf=Math.floor(t*fr),m=Math.floor(tf/(60*fr)),s=Math.floor(tf/fr%60),f=tf%fr; return `${pad(m)}:${pad(s)}:${pad(f)}`; }},
        ];
        let currentTCRFormatIndex = 0;

        // --- Funciones Principales ---
        function applyLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            // Update text content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const target = el.querySelector('span') || el;
                if (translations[lang] && translations[lang][key]) {
                    target.textContent = translations[lang][key];
                }
            });
             // Update titles
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (translations[lang] && translations[lang][key]) {
                    el.title = translations[lang][key];
                }
            });
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            if (isEditorPristine) {
                editor.querySelector('p').textContent = translations[currentLanguage].editorPlaceholder;
            }
            updateTooltips();
            applyTheme(isDarkMode ? 'dark' : 'light');
        }

        function applyTheme(themeName) {
            const theme = themeClasses[themeName];
            isDarkMode = (themeName === 'dark');
            document.body.className = `flex flex-row h-screen overflow-hidden ${theme.bodyBg} ${theme.bodyText}`;
            leftPanel.className = `p-4 flex flex-col relative ${theme.panelBg}`;
            rightPanel.className = `p-4 flex flex-col relative ${theme.panelBg}`;
            resizer.className = `cursor-col-resize bg-gray-300 dark:bg-gray-700`;
            importVideoAudioBtn.className = `w-full font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out mb-4 ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-black'}`;
            document.querySelectorAll('#left > .flex-wrap > button').forEach(btn => {
                btn.className = `flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm ${theme.btnNeutral}`;
            });
            addRecurringTextBtn.className = `font-bold p-1 rounded-lg shadow-md transition duration-200 ease-in-out text-sm ${theme.btnNeutral}`;
            document.querySelectorAll('#controls .relative button, #controls .editor-button-group button, #controls .editor-button-group select').forEach(el => {
                el.classList.remove('bg-gray-700', 'text-gray-200', 'hover:bg-gray-600', 'bg-white', 'text-gray-700', 'hover:bg-gray-50');
                el.classList.add(theme.menuBtnBg, theme.menuBtnText, theme.menuBtnHoverBg);
            });
            [fileMenuDropdown, settingsMenuDropdown].forEach(dd => {
                dd.classList.remove('bg-gray-800', 'bg-white');
                dd.classList.add(theme.dropdownBg);
            });
            editor.className = `flex-1 rounded-lg p-4 text-sm overflow-y-auto outline-none shadow-inner ${theme.editorBg} ${theme.editorText}`;
            if (wavesurfer) {
                wavesurfer.setOptions({ waveColor: theme.waveColor, progressColor: theme.progressColor, cursorColor: theme.cursorColor });
            }
            waveformContainer.classList.remove('bg-gray-900', 'bg-gray-200');
            waveformContainer.classList.add(theme.waveformContainerBg);
            document.querySelector('.modal-content').classList.remove('bg-white', 'text-gray-900', 'bg-gray-800', 'text-gray-200');
            document.querySelector('.modal-content').classList.add(theme.modalContentBg, theme.modalContentText);

            // Theme for Find/Replace bar
            findReplaceBar.classList.remove('bg-gray-100', 'border-gray-300', 'bg-gray-800', 'border-gray-700');
            findReplaceBar.classList.add(theme.findBarBg, theme.findBarBorder);
            [findInput, replaceInput].forEach(input => {
                input.classList.remove('bg-white', 'border-gray-400', 'bg-gray-700', 'border-gray-600');
                input.classList.add(theme.findBarInputBg, theme.findBarInputBorder);
            });
            document.querySelectorAll('#find-replace-bar button').forEach(btn => {
                 btn.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'bg-gray-600', 'hover:bg-gray-500');
                 btn.classList.add(...theme.btnNeutral.split(' '));
            });
            
            const themeText = document.getElementById('themeText');
            const themeIcon = document.getElementById('themeIcon');
            themeText.textContent = isDarkMode ? translations[currentLanguage].lightMode : translations[currentLanguage].darkMode;
            themeIcon.className = `fas ${isDarkMode ? 'fa-sun' : 'fa-moon'} mr-3`;
        }

        function togglePlaybackControls(disabled) {
            const controls = [playPauseBtn, rewind5sBtn, rewind1sBtn, rewind1fBtn, forward1fBtn, forward1sBtn, forward5sBtn, speedDownBtn, speedUpBtn, muteBtn, volumeSlider];
            controls.forEach(btn => btn.disabled = disabled);
        }

        function seekMedia(seconds) {
            if (video.src) {
                video.currentTime = Math.max(0, video.currentTime + seconds);
            }
        }

        function executeShortcut(action) {
            const actions = {
                'playPause': () => {
                    if (video.paused) {
                        video.play().catch(e => console.error("Error al reproducir:", e));
                    } else {
                        video.pause();
                    }
                },
                'rewind5s': () => seekMedia(-5), 'rewind1s': () => seekMedia(-1),
                'rewind1frame': () => seekMedia(-1 / DEFAULT_FRAMERATE), 'forward1frame': () => seekMedia(1 / DEFAULT_FRAMERATE),
                'forward1s': () => seekMedia(1), 'forward5s': () => seekMedia(5),
                'speedUp': () => { video.playbackRate = Math.min(4, video.playbackRate + 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; },
                'speedDown': () => { video.playbackRate = Math.max(0.5, video.playbackRate - 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; },
                'insertTimecode': insertTimecode,
                'bold': () => document.execCommand('bold'),
                'italic': () => document.execCommand('italic'),
                'find': () => showFindReplaceBar(false),
                'replace': () => showFindReplaceBar(true),
            };
            if (action.startsWith('insertRecurringText')) {
                const index = parseInt(action.replace('insertRecurringText', ''));
                const inputs = recurringTextContainer.querySelectorAll('input');
                if (inputs[index - 1] && inputs[index - 1].value) {
                    document.execCommand('insertText', false, inputs[index - 1].value + ' ');
                }
            } else if (actions[action]) {
                actions[action]();
            }
        }

        function updateTCRDisplay() {
            if (video.src) {
                tcrDisplay.textContent = tcrFormats[currentTCRFormatIndex].format(video.currentTime + tcrOffsetSeconds, DEFAULT_FRAMERATE);
            }
        }
        
        function addRecurringTextField(value = '') {
            const container = document.createElement('div');
            container.className = 'flex items-center gap-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.value = value;
            input.className = 'flex-1 min-w-[120px] p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-300';
            const addBtn = document.createElement('button');
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.className = 'recurring-btn font-bold p-1 px-2 rounded-lg shadow-md transition duration-200 ease-in-out text-sm';
            addBtn.onclick = () => {
                if(input.value) {
                    if (isEditorPristine) {
                        editor.innerHTML = '<div><br></div>';
                        isEditorPristine = false;
                    }
                    document.execCommand('insertText', false, input.value + ' ');
                }
            };
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
            removeBtn.className = 'recurring-btn font-bold p-1 px-2 rounded-lg shadow-md transition duration-200 ease-in-out text-sm';
            removeBtn.onclick = () => container.remove();
            
            container.appendChild(input);
            container.appendChild(addBtn);
            container.appendChild(removeBtn);
            recurringTextContainer.appendChild(container);
            
            const theme = themeClasses[isDarkMode ? 'dark' : 'light'];
            [addBtn, removeBtn].forEach(btn => btn.classList.add(...theme.btnNeutral.split(' ').filter(c => !c.startsWith('hover:'))));
            updateTooltips();
        }

        function showModal(title, message, buttons, bodyContent = '', onClose = null) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalBody').innerHTML = bodyContent;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';
            buttons.forEach(buttonConfig => {
                const button = document.createElement('button');
                button.textContent = buttonConfig.text;
                button.className = `font-bold py-1.5 px-2.5 rounded-lg shadow-md transition`;
                button.onclick = () => {
                    if (buttonConfig.handler) buttonConfig.handler();
                    if (!buttonConfig.preventClose) modal.classList.remove('show');
                };
                modalButtons.appendChild(button);
            });
            const closeBtn = modal.querySelector('.modal-close-btn');
            closeBtn.onclick = onClose ? onClose : () => modal.classList.remove('show');
            modal.classList.add('show');
        }

        function insertTimecode() {
            if (!video.src) return;
            const timecode = tcrDisplay.textContent;
            const seconds = video.currentTime + tcrOffsetSeconds;
            const html = `<span class="timestamp" data-seconds="${seconds}" contenteditable="false">[${timecode}]</span>&nbsp;`;
            document.execCommand('insertHTML', false, html);
        }

        function parseTimeCodeToSeconds(timeCodeString) {
            let match = timeCodeString.match(/(\d{2}):(\d{2}):(\d{2})[,:](\d{2,3})/);
            if(match) return parseInt(match[1])*3600 + parseInt(match[2])*60 + parseInt(match[3]) + parseInt(match[4])/(match[4].length === 3 ? 1000 : DEFAULT_FRAMERATE);
            match = timeCodeString.match(/(\d{2}):(\d{2})[,:](\d{2,3})/);
            if(match) return parseInt(match[1])*60 + parseInt(match[2]) + parseInt(match[3])/(match[3].length === 3 ? 1000 : DEFAULT_FRAMERATE);
            match = timeCodeString.match(/(\d{2}):(\d{2})/);
            if(match) return parseInt(match[1])*60 + parseInt(match[2]);
            return null;
        }

        function showSetInitialTCRModal() {
            const body = `<input type="text" id="initialTCRInput" class="w-full p-2 border rounded" placeholder="HH:MM:SS,MMM or HH:MM:SS:FF">`;
            const buttons = [{ text: 'Cancel' }, { text: 'Set', handler: () => {
                const inputVal = document.getElementById('initialTCRInput').value;
                const desiredSeconds = parseTimeCodeToSeconds(inputVal);
                if (desiredSeconds !== null) {
                    tcrOffsetSeconds = desiredSeconds - video.currentTime;
                    updateTCRDisplay();
                } else {
                    alert('Invalid timecode format');
                }
            }}];
            showModal('Set Initial Timecode', '', buttons, body);
        }

        function showTCRFormatModal() {
            let optionsHtml = '<div class="space-y-2">';
            tcrFormats.forEach((format, index) => {
                optionsHtml += `<label class="flex items-center cursor-pointer"><input type="radio" name="tcrFormat" value="${index}" class="form-radio" ${index === currentTCRFormatIndex ? 'checked' : ''}><span class="ml-2">${format.name}</span></label>`;
            });
            optionsHtml += '</div>';
            const buttons = [{ text: 'Cancel' }, { text: 'Save', handler: () => {
                const selected = document.querySelector('input[name="tcrFormat"]:checked');
                if (selected) {
                    currentTCRFormatIndex = parseInt(selected.value);
                    updateTCRDisplay();
                    updateAllTimestampsInEditor();
                }
            }}];
            showModal('Select Timecode Format', '', buttons, optionsHtml);
        }
        
        function updateAllTimestampsInEditor() {
            editor.querySelectorAll('.timestamp').forEach(span => {
                const seconds = parseFloat(span.dataset.seconds);
                if (!isNaN(seconds)) {
                    span.textContent = `[${tcrFormats[currentTCRFormatIndex].format(seconds, DEFAULT_FRAMERATE)}]`;
                }
            });
        }

        function showExportModal() {
            const body = `
                <div>
                    <label for="filenameInput" class="block mb-2">${translations[currentLanguage].filenameLabel}</label>
                    <input type="text" id="filenameInput" class="w-full p-2 border rounded mb-4" value="transcription">
                    <label class="block mb-2">${translations[currentLanguage].formatLabel}</label>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="txt" class="form-radio" checked><span class="ml-2">.txt (Plain Text)</span></label>
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="html" class="form-radio"><span class="ml-2">.html (Formatted)</span></label>
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="pdf" class="form-radio"><span class="ml-2">.pdf (Document)</span></label>
                    </div>
                </div>
            `;
            const buttons = [{ text: 'Cancel' }, { text: translations[currentLanguage].exportBtnText, handler: () => {
                const filename = document.getElementById('filenameInput').value || 'transcription';
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                exportContent(format, filename);
            }}];
            showModal(translations[currentLanguage].exportModalTitle, '', buttons, body);
        }

        function exportContent(format, filename) {
            let content, mimeType, fileExtension;
            if (format === 'txt') {
                content = editor.innerText;
                mimeType = 'text/plain';
                fileExtension = '.txt';
            } else if (format === 'html') {
                content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${editor.innerHTML}</body></html>`;
                mimeType = 'text/html';
                fileExtension = '.html';
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont('Arial', 'normal');
                doc.setFontSize(11);
                const lines = doc.splitTextToSize(editor.innerText, 180);
                doc.text(lines, 10, 10);
                doc.save(`${filename}.pdf`);
                return;
            }

            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}${fileExtension}`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function saveBackup() {
            if (!isEditorPristine) {
                localStorage.setItem('pandascript_backup', editor.innerHTML);
            }
        }

        function loadBackup() {
            const backup = localStorage.getItem('pandascript_backup');
            if (backup) {
                const buttons = [
                    { text: translations[currentLanguage].discard, handler: () => localStorage.removeItem('pandascript_backup') },
                    { text: translations[currentLanguage].restore, handler: () => {
                        editor.innerHTML = backup;
                        isEditorPristine = false;
                        localStorage.removeItem('pandascript_backup');
                    }}
                ];
                showModal(translations[currentLanguage].backupFoundTitle, translations[currentLanguage].backupFoundMessage, buttons, '');
            }
        }
        
        function showBackupModal() {
            const backup = localStorage.getItem('pandascript_backup');
            if (backup) {
                const body = `<div class="p-2 border rounded bg-white dark:bg-gray-800 text-black dark:text-white">${backup}</div>`;
                const buttons = [
                    { text: 'Close' },
                    { text: translations[currentLanguage].restore, handler: () => {
                        editor.innerHTML = backup;
                        isEditorPristine = false;
                    }}
                ];
                showModal(translations[currentLanguage].backup, '', buttons, body);
            } else {
                showModal(translations[currentLanguage].backup, translations[currentLanguage].noBackup, [{ text: 'OK' }]);
            }
        }

        function showLanguageModal() {
            let optionsHtml = '<div class="space-y-2">';
            for (const [code, name] of Object.entries(availableLanguages)) {
                optionsHtml += `<label class="flex items-center cursor-pointer">
                    <input type="radio" name="language" value="${code}" class="form-radio" ${code === currentLanguage ? 'checked' : ''}>
                    <span class="ml-2">${name}</span>
                </label>`;
            }
            optionsHtml += '</div>';

            const buttons = [
                { text: translations[currentLanguage].cancel },
                { text: translations[currentLanguage].save, handler: () => {
                    const selectedLang = document.querySelector('input[name="language"]:checked').value;
                    if (selectedLang) {
                        localStorage.setItem('pandascript_language', selectedLang);
                        applyLanguage(selectedLang);
                    }
                }}
            ];
            showModal(translations[currentLanguage].languageModalTitle, '', buttons, optionsHtml);
        }

        function resetApplication() {
            video.src = '';
            wavesurfer.empty();
            waveformContainer.classList.add('hidden');
            emptyPlayerOverlay.classList.remove('hidden');
            video.style.visibility = 'hidden';
            editor.innerHTML = `<p data-i18n="editorPlaceholder">${translations[currentLanguage].editorPlaceholder}</p>`;
            isEditorPristine = true;
            tcrOffsetSeconds = 0;
            updateTCRDisplay();
            togglePlaybackControls(true);
            localStorage.removeItem('pandascript_backup');
        }

        function showNewTranscriptionConfirm() {
            const buttons = [
                { text: 'Cancel' },
                { text: 'OK', handler: resetApplication }
            ];
            showModal('Start New Transcription', translations[currentLanguage].newTranscriptionConfirm, buttons, '');
        }
        
        // --- Lógica de Atajos de Teclado ---
        const defaultShortcuts = {
            'playPause': 'Alt+P', 'rewind5s': 'Shift+ArrowLeft', 'forward5s': 'Shift+ArrowRight', 'rewind1s': 'Control+ArrowLeft', 'forward1s': 'Control+ArrowRight', 'rewind1frame': 'Alt+ArrowLeft', 'forward1frame': 'Alt+ArrowRight', 'speedUp': 'Alt+ArrowUp', 'speedDown': 'Alt+ArrowDown', 'insertTimecode': 'Alt+Q',
            'bold': 'Control+B', 'italic': 'Control+I', 'find': 'Control+F', 'replace': 'Control+H'
        };

        function loadShortcuts() {
            const saved = JSON.parse(localStorage.getItem('pandascript_shortcuts'));
            shortcuts = { ...defaultShortcuts, ...saved };
            for(let i = 1; i <= 9; i++) {
                if (!shortcuts[`insertRecurringText${i}`]) {
                    shortcuts[`insertRecurringText${i}`] = `Alt+${i}`;
                }
            }
            updateTooltips();
        }

        function saveShortcutsToStorage() {
            localStorage.setItem('pandascript_shortcuts', JSON.stringify(shortcuts));
            updateTooltips();
        }

        function updateTooltips() {
            boldBtn.title = `${translations[currentLanguage].shortcutLabel_bold} (${shortcuts.bold || ''})`;
            italicBtn.title = `${translations[currentLanguage].shortcutLabel_italic} (${shortcuts.italic || ''})`;
            uppercaseBtn.title = translations[currentLanguage].shortcutLabel_uppercase;
            lowercaseBtn.title = translations[currentLanguage].shortcutLabel_lowercase;
        }

        function keyEventToString(e) {
            let parts = [];
            if (e.ctrlKey) parts.push('Control');
            if (e.altKey) parts.push('Alt');
            if (e.shiftKey) parts.push('Shift');
            if (e.metaKey) parts.push('Meta');
            if (!['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) {
                parts.push(e.key.length === 1 ? e.key.toUpperCase() : e.key);
            }
            return parts.join('+');
        }

        function showShortcutsModal() {
            tempShortcuts = JSON.parse(JSON.stringify(shortcuts));
            
            const renderShortcuts = () => {
                let bodyHtml = '<div class="space-y-2">';
                const actions = [
                    'playPause', 'rewind5s', 'forward5s', 'rewind1s', 'forward1s', 'rewind1frame', 'forward1frame', 'speedUp', 'speedDown', 'insertTimecode', 'bold', 'italic', 'find', 'replace'
                ];
                actions.forEach(action => {
                    let label = translations[currentLanguage][`shortcutLabel_${action}`] || action;
                    bodyHtml += `<div class="flex justify-between items-center"><span>${label}</span><button class="shortcut-button font-mono p-1 px-2 border-2 rounded" data-action="${action}">${tempShortcuts[action] || 'Not set'}</button></div>`;
                });
                for (let i = 1; i <= recurringTextContainer.children.length; i++) {
                    const action = `insertRecurringText${i}`;
                    let label = `${translations[currentLanguage]['shortcutLabel_insertRecurringText']} ${i}`;
                    bodyHtml += `<div class="flex justify-between items-center"><span>${label}</span><button class="shortcut-button font-mono p-1 px-2 border-2 rounded" data-action="${action}">${tempShortcuts[action] || 'Not set'}</button></div>`;
                }
                bodyHtml += '</div>';
                return bodyHtml;
            }

            const buttons = [
                { text: translations[currentLanguage].importShortcuts, handler: () => shortcutImportInput.click(), preventClose: true },
                { text: translations[currentLanguage].exportShortcuts, handler: () => {
                    const blob = new Blob([JSON.stringify(shortcuts, null, 2)], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'pandascript_shortcuts.json';
                    link.click();
                }, preventClose: true },
                { text: translations[currentLanguage].resetShortcuts, handler: () => {
                    tempShortcuts = { ...defaultShortcuts };
                    document.getElementById('modalBody').innerHTML = renderShortcuts();
                    addShortcutButtonListeners();
                }, preventClose: true },
                { text: translations[currentLanguage].saveShortcuts, handler: () => {
                    shortcuts = { ...tempShortcuts };
                    saveShortcutsToStorage();
                }}
            ];

            showModal(translations[currentLanguage].shortcutsModalTitle, translations[currentLanguage].shortcutsModalMessage, buttons, renderShortcuts(), confirmCloseShortcutsModal);
            addShortcutButtonListeners();
        }

        function addShortcutButtonListeners() {
            document.querySelectorAll('.shortcut-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (listeningForShortcut) {
                        const prevButton = document.querySelector(`.shortcut-button[data-action="${listeningForShortcut}"]`);
                        if (prevButton) {
                          prevButton.textContent = tempShortcuts[listeningForShortcut];
                          prevButton.classList.remove('is-listening');
                        }
                    }
                    listeningForShortcut = e.target.dataset.action;
                    e.target.textContent = translations[currentLanguage].pressNewShortcut;
                    e.target.classList.add('is-listening');
                });
            });
        }
        
        function confirmCloseShortcutsModal() {
            const hasChanged = JSON.stringify(shortcuts) !== JSON.stringify(tempShortcuts);
            if (hasChanged) {
                const buttons = [
                    { text: translations[currentLanguage].goBack, preventClose: true, handler: () => showShortcutsModal() },
                    { text: translations[currentLanguage].continueAndClose, handler: () => document.getElementById('customModal').classList.remove('show') }
                ];
                showModal(translations[currentLanguage].unsavedChangesTitle, translations[currentLanguage].unsavedChangesMessage, buttons, '');
            } else {
                document.getElementById('customModal').classList.remove('show');
            }
        }
        
        // --- Lógica de Búsqueda y Reemplazo ---
        function showFindReplaceBar(showReplace) {
            findReplaceBar.classList.remove('hidden');
            if (showReplace) {
                replaceControls.classList.remove('hidden');
                replaceControls.classList.add('flex');
                toggleReplaceBtn.classList.add('rotate-90');
            } else {
                replaceControls.classList.add('hidden');
                replaceControls.classList.remove('flex');
                toggleReplaceBtn.classList.remove('rotate-90');
            }
            findInput.focus();
            findInput.select();
            updateFindResults();
        }

        function hideFindReplaceBar() {
            findReplaceBar.classList.add('hidden');
            window.getSelection().removeAllRanges(); // Clear selection
            editor.focus();
        }

        function findInEditor(backwards = false) {
            const query = findInput.value;
            if (!query) return;
            // window.find is simple but has limitations. We use it to navigate.
            window.find(query, matchCaseCheckbox.checked, backwards, true, false, false, false);
        }

        function updateFindResults() {
            const query = findInput.value;
            if (!query) {
                findResultsCount.textContent = '0/0';
                return;
            }
            
            const flags = matchCaseCheckbox.checked ? 'g' : 'gi';
            const regex = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), flags);
            const matches = editor.innerText.match(regex) || [];
            
            let currentIndex = 0;
            if (window.getSelection && window.getSelection().rangeCount > 0) {
                const selection = window.getSelection();
                const precedingText = editor.innerText.substring(0, selection.anchorOffset);
                const precedingMatches = precedingText.match(regex) || [];
                currentIndex = precedingMatches.length;
            }
            
            findResultsCount.textContent = `${currentIndex}/${matches.length}`;
        }

        function replaceCurrent() {
            const query = findInput.value;
            const replacement = replaceInput.value;
            const selection = window.getSelection();
            
            if (query && selection.rangeCount > 0 && selection.toString().length > 0) {
                const text = selection.toString();
                const comparisonText = matchCaseCheckbox.checked ? text : text.toLowerCase();
                const comparisonQuery = matchCaseCheckbox.checked ? query : query.toLowerCase();

                if (comparisonText === comparisonQuery) {
                    document.execCommand('insertText', false, replacement);
                }
                // Find the next one automatically
                findInEditor(false);
            }
        }

        function replaceAll() {
            const query = findInput.value;
            const replacement = replaceInput.value;
            if (!query) return;

            const flags = matchCaseCheckbox.checked ? 'g' : 'gi';
            const regex = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), flags);
            
            const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const nodesToModify = [];
            while(node = walker.nextNode()) {
                if (node.nodeValue.match(regex)) {
                    nodesToModify.push(node);
                }
            }

            // Modify nodes after finding them all to avoid issues with the TreeWalker
            nodesToModify.forEach(textNode => {
                textNode.nodeValue = textNode.nodeValue.replace(regex, replacement);
            });
            updateFindResults();
        }

        // --- Inicialización ---
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        isDarkMode = (savedTheme === 'dark');
        
        wavesurfer = WaveSurfer.create({
            container: '#waveform-container', media: video, barWidth: 3, barRadius: 3, barGap: 2, height: 80, responsive: true,
            waveColor: themeClasses[savedTheme].waveColor, progressColor: themeClasses[savedTheme].progressColor, cursorColor: themeClasses[savedTheme].cursorColor, cursorWidth: 2,
            scrollParent: true, autoCenter: true, minPxPerSec: 100
        });

        applyLanguage(currentLanguage);
        applyTheme(isDarkMode ? 'dark' : 'light');
        togglePlaybackControls(true);
        for(let i = 0; i < 4; i++) addRecurringTextField();
        loadBackup();
        loadShortcuts();
        setInterval(saveBackup, 30000);

        const fonts = ['Arial', 'Verdana', 'Georgia', 'Times New Roman', 'Courier New', 'monospace'];
        fonts.forEach(font => {
            const option = document.createElement('option');
            option.value = font; option.textContent = font;
            fontFamilySelect.appendChild(option);
        });
        const fontSizes = ['8px', '10px', '12px', '14px', '16px', '18px', '20px', '24px', '32px', '48px'];
        fontSizes.forEach(size => {
            const option = document.createElement('option');
            option.value = size; option.textContent = size;
            fontSizeSelect.appendChild(option);
        });
        fontSizeSelect.value = '14px';

        // --- Event Listeners ---

        importVideoAudioBtn.addEventListener('click', () => videoFileInput.click());
        videoFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          togglePlaybackControls(true);
          waveformContainer.classList.remove('hidden');
          const url = URL.createObjectURL(file);
          video.src = url;
          video.load();
          wavesurfer.load(url);
        });

        video.addEventListener('canplay', () => {
            togglePlaybackControls(false);
            emptyPlayerOverlay.classList.add('hidden');
            video.style.visibility = 'visible';
            updateTCRDisplay();
        });

        video.addEventListener('play', () => playPauseBtn.classList.add('playing'));
        video.addEventListener('pause', () => playPauseBtn.classList.remove('playing'));
        video.addEventListener('timeupdate', () => {
            updateTCRDisplay();
            if (video.duration) {
                const progress = (video.currentTime / video.duration) * 100;
                progressBar.style.width = `${progress}%`;
            }
        });

        playPauseBtn.addEventListener('click', () => executeShortcut('playPause'));
        rewind5sBtn.addEventListener('click', () => seekMedia(-5));
        rewind1sBtn.addEventListener('click', () => seekMedia(-1));
        rewind1fBtn.addEventListener('click', () => seekMedia(-1 / DEFAULT_FRAMERATE));
        forward1fBtn.addEventListener('click', () => seekMedia(1 / DEFAULT_FRAMERATE));
        forward1sBtn.addEventListener('click', () => seekMedia(1));
        forward5sBtn.addEventListener('click', () => seekMedia(5));
        speedDownBtn.addEventListener('click', () => { video.playbackRate = Math.max(0.5, video.playbackRate - 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; });
        speedUpBtn.addEventListener('click', () => { video.playbackRate = Math.min(4, video.playbackRate + 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; });
        
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            video.volume = volume;
            lastVolume = volume;
            muteBtn.innerHTML = volume > 0 ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
        });

        muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
            volumeSlider.value = video.muted ? 0 : lastVolume;
            muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        });

        progressBarContainer.addEventListener('click', (e) => {
            if (!video.duration) return;
            const rect = progressBarContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const progress = clickX / rect.width;
            video.currentTime = video.duration * progress;
        });

        insertTimecodeBtn.addEventListener('click', insertTimecode);
        timecodeFormatBtn.addEventListener('click', showTCRFormatModal);
        setInitialTimecodeBtn.addEventListener('click', showSetInitialTCRModal);
        
        addRecurringTextBtn.addEventListener('click', () => addRecurringTextField());
        
        boldBtn.addEventListener('click', () => document.execCommand('bold'));
        italicBtn.addEventListener('click', () => document.execCommand('italic'));
        uppercaseBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                if (selectedText) {
                    range.deleteContents();
                    range.insertNode(document.createTextNode(selectedText.toUpperCase()));
                }
            }
        });
        lowercaseBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                if (selectedText) {
                    range.deleteContents();
                    range.insertNode(document.createTextNode(selectedText.toLowerCase()));
                }
            }
        });
        
        fontFamilySelect.addEventListener('change', (e) => document.execCommand('fontName', false, e.target.value));
        fontSizeSelect.addEventListener('change', (e) => {
            document.execCommand('fontSize', false, '7');
            const fontElements = editor.querySelectorAll("font[size='7']");
            fontElements.forEach(el => {
                el.style.fontSize = e.target.value;
                el.removeAttribute('size');
            });
        });
        
        function setupDropdown(button, dropdown) {
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                const isHidden = dropdown.classList.contains('hidden');
                document.querySelectorAll('.origin-top-left').forEach(d => d.classList.add('hidden'));
                if (isHidden) dropdown.classList.remove('hidden');
            });
        }
        setupDropdown(fileMenuBtn, fileMenuDropdown);
        setupDropdown(settingsMenuBtn, settingsMenuDropdown);
        window.addEventListener('click', () => {
            fileMenuDropdown.classList.add('hidden');
            settingsMenuDropdown.classList.add('hidden');
        });

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        });

        function handleMouseMove(e) {
            const totalWidth = document.body.offsetWidth;
            const leftWidth = e.clientX;
            const rightWidth = totalWidth - e.clientX - resizer.offsetWidth;
            if (leftWidth > 300 && rightWidth > 300) {
                leftPanel.style.flexBasis = `${leftWidth}px`;
                rightPanel.style.flexBasis = `${rightWidth}px`;
            }
        }
        function handleMouseUp() {
            document.removeEventListener('mousemove', handleMouseMove);
        }

        editor.addEventListener('focus', () => {
            if (isEditorPristine) {
                editor.innerHTML = '<div><br></div>';
                isEditorPristine = false;
            }
        });

        editor.addEventListener('click', (e) => {
            if (e.target.classList.contains('timestamp')) {
                const seconds = parseFloat(e.target.dataset.seconds);
                if (!isNaN(seconds)) {
                    video.currentTime = seconds;
                }
            }
        });

        newTranscriptionBtn.addEventListener('click', (e) => { e.preventDefault(); showNewTranscriptionConfirm(); });
        importTextBtn.addEventListener('click', (e) => { e.preventDefault(); textFileInput.click(); });
        
        textFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                editor.innerHTML = event.target.result.replace(/\n/g, '<br>');
                isEditorPristine = false;
            };
            reader.readAsText(file);
        });

        exportBtn.addEventListener('click', (e) => { e.preventDefault(); showExportModal(); });
        backupBtn.addEventListener('click', (e) => { e.preventDefault(); showBackupModal(); });
        shortcutsBtn.addEventListener('click', (e) => { e.preventDefault(); showShortcutsModal(); });
        languageToggleBtn.addEventListener('click', (e) => { e.preventDefault(); showLanguageModal(); });

        themeToggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const newTheme = isDarkMode ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });

        document.addEventListener('keydown', (e) => {
            // Handle shortcuts modal key listening
            if (listeningForShortcut) {
                e.preventDefault();
                e.stopPropagation();
                if (['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) return;
                const newShortcutStr = keyEventToString(e);
                tempShortcuts[listeningForShortcut] = newShortcutStr;
                const button = document.querySelector(`.shortcut-button[data-action="${listeningForShortcut}"]`);
                if (button) {
                    button.textContent = newShortcutStr;
                    button.classList.remove('is-listening');
                }
                listeningForShortcut = null;
                return;
            }
            
            // Handle Find/Replace bar keydown
            if (!findReplaceBar.classList.contains('hidden')) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    findInEditor(e.shiftKey); // Find previous on Shift+Enter
                    return;
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    hideFindReplaceBar();
                    return;
                }
            }

            // Global shortcuts
            const pressedShortcut = keyEventToString(e).replace('Meta', 'Control');
            for (const action in shortcuts) {
                if (shortcuts[action] && shortcuts[action].replace('Meta', 'Control') === pressedShortcut) {
                    const activeEl = document.activeElement;
                    if (activeEl.tagName === 'INPUT' && activeEl !== findInput && activeEl !== replaceInput) return;
                    if (activeEl.isContentEditable && activeEl !== editor) return;
                    
                    // Allow Ctrl+F/H even if find bar is open to re-focus
                    if (action === 'find' || action === 'replace') {
                         e.preventDefault();
                         executeShortcut(action);
                         break;
                    }
                    
                    if (activeEl === findInput || activeEl === replaceInput) return;

                    e.preventDefault();
                    executeShortcut(action);
                    break;
                }
            }
        });

        shortcutImportInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    shortcuts = { ...shortcuts, ...imported };
                    saveShortcutsToStorage();
                    showShortcutsModal(); // Refresh modal
                } catch (err) {
                    alert(translations[currentLanguage].shortcutsImportError);
                }
            };
            reader.readAsText(file);
        });
        
        // Find & Replace Event Listeners
        findInput.addEventListener('input', updateFindResults);
        matchCaseCheckbox.addEventListener('change', updateFindResults);
        findNextBtn.addEventListener('click', () => findInEditor(false));
        findPrevBtn.addEventListener('click', () => findInEditor(true));
        replaceBtn.addEventListener('click', replaceCurrent);
        replaceAllBtn.addEventListener('click', replaceAll);
        toggleReplaceBtn.addEventListener('click', () => {
             replaceControls.classList.toggle('hidden');
             replaceControls.classList.toggle('flex');
             toggleReplaceBtn.classList.toggle('rotate-90');
        });
        document.addEventListener('selectionchange', () => {
            if (!findReplaceBar.classList.contains('hidden')) {
                updateFindResults();
            }
        });

  </script>
</body>
</html>
