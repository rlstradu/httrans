<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="appTitle">PandaScript</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- jsPDF para exportar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF autoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.autotable.umd.js"></script>
  <!-- Wavesurfer.js CDN -->
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <!-- Wavesurfer.js Regions Plugin CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/7.7.5/plugins/regions.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; overflow: hidden; }
    #left, #right { overflow: auto; }
    /* Ocultar scrollbars por defecto */
    #left::-webkit-scrollbar, #right::-webkit-scrollbar, #ad-table-container::-webkit-scrollbar { width: 4px; }
    #left::-webkit-scrollbar-thumb, #right::-webkit-scrollbar-thumb, #ad-table-container::-webkit-scrollbar-thumb { background: #FF4853; border-radius: 4px; }
    #left:hover::-webkit-scrollbar, #right:hover::-webkit-scrollbar, #ad-table-container:hover::-webkit-scrollbar { width: 4px; }
    
    #resizer { flex-basis: 2px; flex-shrink: 0; cursor: col-resize; transition: background-color 0.2s ease-in-out; }
    #resizer:hover { background-color: #FF4853; }
    .timestamp { color: #FF4853 !important; text-decoration: underline !important; cursor: pointer; background: none !important; }
    
    #video-player-container { position: relative; overflow: hidden; }
    #video-controls-overlay {
        position: absolute; bottom: 0; left: 0; right: 0;
        padding: 8px;
        background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
        opacity: 0; visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    #video-player-container:hover #video-controls-overlay { opacity: 1; visibility: visible; }
    
    #progressBarContainer {
        width: 95%; height: 5px; background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px; cursor: pointer; margin: 0 auto;
    }
    #progressBar { width: 0%; height: 100%; background-color: #FF4853; border-radius: 10px; }

    .control-button-row { display: flex; justify-content: center; align-items: center; gap: 6px; }
    .control-button {
        background-color: rgba(55, 55, 55, 0.8); color: white;
        border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px;
        padding: 4px 8px; transition: background-color 0.2s, transform 0.2s;
        font-size: 0.75rem; line-height: 1;
    }
    .control-button:hover { background-color: #FF4853; transform: scale(1.05); }
    .control-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(55, 55, 55, 0.8); }
    #playPauseBtn { font-size: 1rem; padding: 6px 10px; }
    #playPauseBtn.playing i:before { content: "\f04c"; }
    .volume-container { display: flex; align-items: center; gap: 8px; }
    #volumeSlider { width: 70px; height: 5px; -webkit-appearance: none; appearance: none; background: rgba(255,255,255,0.3); border-radius: 5px; outline: none; transition: opacity 0.2s; }
    #volumeSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: #FF4853; border-radius: 50%; cursor: pointer; }
    #volumeSlider::-moz-range-thumb { width: 12px; height: 12px; background: #FF4853; border-radius: 50%; cursor: pointer; }

    #tcrDisplay { font-family: 'Courier New', monospace; }
    .recurring-btn:hover { background-color: #FF4853 !important; }

    #editor { min-height: 200px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
    
    .editor-button-group { display: flex; align-items: center; gap: 0.5rem; }
    .editor-button { padding: 0.375rem 0.625rem; }
    .dropdown-item { display: block; width: 100%; text-align: left; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content { position: relative; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); max-width: 500px; width: 90%; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .shortcut-button.is-listening { border-color: #FF4853; color: #FF4853; }
    #modalBody { max-height: 60vh; overflow-y: auto; }
    .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    
    /* Z-index para menús desplegables */
    #fileMenuDropdown, #settingsMenuDropdown {
        z-index: 20;
    }

    /* Find & Replace Bar Styles */
    #find-replace-bar {
        padding: 8px;
        border-bottom: 1px solid;
        margin-bottom: 8px;
        /* display: flex; <-- Se controla por JS */
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        z-index: 5; /* Asegurar que esté sobre la tabla pero bajo menús */
        position: relative;
    }
    #find-replace-bar input[type="text"] {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid;
        font-size: 0.875rem;
    }
    #find-replace-bar button {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.875rem;
        transition: background-color 0.2s;
    }
    
    /* --- Estilos para Modo AD --- */
    #ad-view {
        /* display: flex; <-- Se controla por JS */
        flex-direction: column;
        height: 100%; /* Ocupa todo el espacio del panel derecho */
    }
    #ad-table-container {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid; /* Se ajustará con el tema */
        border-radius: 8px;
    }
    #ad-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
        table-layout: fixed; /* Añadido para redimensionar columnas */
    }
    #ad-table th, #ad-table td {
        padding: 6px 8px;
        border: 1px solid; /* Aplicar borde en los 4 lados */
        border-color: inherit; /* Hereda color del tema */
        text-align: left;
        vertical-align: top;
    }
    #ad-table th {
        position: sticky;
        top: 0;
        z-index: 10;
        font-weight: 600;
        resize: horizontal; /* Añadido para redimensionar */
        overflow: hidden; /* Modificado */
    }
    #ad-table tbody tr {
        cursor: pointer;
        transition: background-color 0.1s ease-in-out;
    }
    #ad-table tbody tr.selected-row {
        outline: 2px solid #FF4853;
        outline-offset: -1px;
    }
    /* Estilo para búsqueda en tabla AD */
    #ad-table .highlight-find {
        background-color: #FF4853;
        color: white;
        border-radius: 2px;
    }
    #ad-table input[type="text"], #ad-table textarea {
        width: 100%;
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid; /* Se ajustará con el tema */
        font-size: 0.875rem;
        font-family: 'Courier New', monospace;
    }
    #ad-table textarea {
        font-family: 'Inter', sans-serif;
        min-height: 40px;
        resize: vertical;
    }
    #ad-table .col-time { width: 100px; }
    #ad-table .col-dur { width: 70px; }
    #ad-table .col-cps { width: 70px; }
    #ad-table .col-text { width: 40%; }
    #ad-table .col-notes { width: 30%; }
    
    .cps-warning {
        color: #ef4444; /* text-red-500 */
        font-weight: bold;
    }

    /* Estilos para Regiones de Wavesurfer */
    #waveform-container ::part(region) {
        z-index: 3 !important;
        background-color: rgba(255, 72, 83, 0.2);
        border-left: 1px solid rgba(255, 72, 83, 0.7);
        border-right: 1px solid rgba(255, 72, 83, 0.7);
        transition: background-color 0.15s ease;
        overflow: visible !important; /* Permitir que el contenido se salga */
    }
    #waveform-container ::part(region):hover {
        background-color: rgba(255, 72, 83, 0.3);
    }
    /* Estilo de región seleccionada */
    #waveform-container ::part(region.selected-region) {
        background-color: rgba(255, 72, 83, 0.5) !important;
        border-color: rgba(255, 0, 0, 0.9) !important;
    }
    #waveform-container ::part(region-handle-left),
    #waveform-container ::part(region-handle-right) {
        background-color: rgba(255, 72, 83, 0.7);
        width: 5px;
        cursor: ew-resize;
    }
    /* Contenido de la región */
    .ad-region-content {
        padding: 2px 4px;
        font-size: 10px;
        color: black;
        pointer-events: none;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 3px;
        position: absolute;
        top: -18px;
        left: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }
  </style>
</head>
<body class="flex flex-row h-screen">

  <!-- Panel Izquierdo -->
  <div id="left" class="p-4 flex flex-col relative" style="flex-basis: 40%;">
    
    <div id="video-player-container" class="relative w-full overflow-hidden rounded-lg mb-4 shadow-2xl" style="padding-top: 56.25%;">
        <div class="absolute inset-0 bg-black flex items-center justify-center">
            <video id="video" class="w-full h-full object-contain"></video> 
            <div id="emptyPlayerOverlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black text-gray-400">
                <img src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/pandascript-logo.png" alt="PandaScript Logo" class="h-24 mb-2"> 
                <span class="text-xl font-bold">PandaScript</span>
            </div>
        </div>
        <div id="video-controls-overlay">
            <div id="progressBarContainer">
                <div id="progressBar"></div>
            </div>
            <div class="control-button-row">
                <button id="speedDownBtn" class="control-button">-0.25x</button>
                <button id="rewind5sBtn" class="control-button">-5s</button>
                <button id="rewind1sBtn" class="control-button">-1s</button>
                <button id="rewind1fBtn" class="control-button">-1f</button>
                <button id="playPauseBtn" class="control-button"><i class="fas fa-play"></i></button>
                <button id="forward1fBtn" class="control-button">+1f</button>
                <button id="forward1sBtn" class="control-button">+1s</button>
                <button id="forward5sBtn" class="control-button">+5s</button>
                <button id="speedUpBtn" class="control-button">+0.25x</button>
                <span id="speedDisplay" class="text-white text-xs font-semibold mx-2">1.0x</span>
                <div class="volume-container">
                    <button id="muteBtn" class="control-button"><i class="fas fa-volume-up"></i></button>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
                </div>
            </div>
        </div>
    </div>
    
    <button id="importVideoAudioBtn" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out mb-4" data-i18n="openMediaFile" data-i18n-title="openMediaFileTitle"><i class="fas fa-file-video mr-2"></i>Open Video/Audio File</button>
    <input type="file" id="videoFileInput" accept="video/*,audio/*" class="hidden" />
    <input type="file" id="projectFileInput" accept=".pscript" class="hidden" />


    <div id="waveform-container" class="w-full h-24 mb-4 rounded-lg shadow-md hidden"></div>
    
    <div id="tcrDisplay" class="font-mono text-4xl p-4 text-center rounded-lg mb-4 shadow-md w-full">--:--:--,---</div>

    <div class="flex flex-wrap gap-2 mb-4 w-full">
      <button id="insertTimecodeBtn" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><span data-i18n="insertTimecode">Insert Timecode</span></button>
      <button id="timecodeFormatBtn" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm" data-i18n="timecodeFormat"><i class="fas fa-gear mr-2"></i>Timecode Format</button>
      <button id="setInitialTimecodeBtn" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm" data-i18n="setInitialTimecode"><i class="fas fa-play mr-2"></i>Set Initial Timecode</button>
    </div>
    
    <div id="recurringTextSection" class="mt-auto mb-6 w-full">
      <div class="flex items-center justify-between mb-3 border-b pb-2">
        <h4 class="text-lg font-semibold" data-i18n="recurringTextHeader">Recurring Text</h4>
        <button id="addRecurringTextBtn" class="font-bold p-1 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><i class="fas fa-plus"></i></button>
      </div>
      <div id="recurringTextContainer" class="flex flex-col gap-2 justify-center"></div>
    </div>
  </div>

  <!-- Divisor Flexible -->
  <div id="resizer"></div>

  <!-- Panel Derecho -->
  <div id="right" class="p-4 flex flex-col relative" style="flex-basis: 60%;">
    <div id="controls" class="mb-4 flex flex-wrap items-center gap-2">
        <!-- Menú File -->
        <div class="relative inline-block text-left">
            <button id="fileMenuBtn" type="button" class="inline-flex justify-center rounded-md border shadow-sm px-4 py-2 text-sm font-medium focus:outline-none">
                <span data-i18n="fileMenu">File</span>
                <i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5"></i>
            </button>
            <div id="fileMenuDropdown" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden">
                <div class="py-1" role="menu" aria-orientation="vertical">
                    <a href="#" id="newTranscriptionBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-file-alt mr-3"></i><span data-i18n="newTranscription">New Transcription</span></a>
                    <a href="#" id="openProjectBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-folder-open mr-3"></i><span data-i18n="openProject">Open Project</span></a>
                    <a href="#" id="saveProjectBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-save mr-3"></i><span data-i18n="saveProject">Save Project</span></a>
                    <hr class="my-1">
                    <a href="#" id="importTextBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-file-import mr-3"></i><span data-i18n="importText">Import .txt</span></a>
                    <a href="#" id="exportTranscriptionBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-file-export mr-3"></i><span data-i18n="export">Export Transcription</span></a>
                    <a href="#" id="exportAdBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-file-export mr-3"></i><span data-i18n="exportAd">Export Audio Description</span></a>
                    <a href="#" id="backupBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-save mr-3"></i><span data-i18n="backup">Backup</span></a>
                </div>
            </div>
        </div>
        <!-- Menú Settings -->
        <div class="relative inline-block text-left">
            <button id="settingsMenuBtn" type="button" class="inline-flex justify-center rounded-md border shadow-sm px-4 py-2 text-sm font-medium focus:outline-none">
                <span data-i18n="settingsMenu">Settings</span>
                <i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5"></i>
            </button>
            <div id="settingsMenuDropdown" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden">
                <div class="py-1" role="menu" aria-orientation="vertical">
                    <a href="#" id="shortcutsBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-keyboard mr-3"></i><span data-i18n="shortcutsButton">Keyboard Shortcuts</span></a>
                    <a href="#" id="toggleAdModeBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-audio-description mr-3"></i><span data-i18n="adMode">Audio Description Mode</span></a>
                    <a href="#" id="cpsSettingsBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-tachometer-alt mr-3"></i><span data-i18n="cpsSettings">CPS Settings</span></a>
                    <a href="#" id="themeToggleBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i id="themeIcon" class="fas fa-moon mr-3"></i><span id="themeText" data-i18n="darkMode">Dark Mode</span></a>
                    <a href="#" id="languageToggleBtn" class="dropdown-item px-4 py-2 text-sm flex items-center" role="menuitem"><i class="fas fa-language mr-3"></i><span id="languageText" data-i18n="changeLanguageButton">Change Language</span></a>
                </div>
            </div>
        </div>
        
        <!-- Botones Deshacer/Rehacer -->
        <button id="undoBtn" class="editor-button rounded-md border shadow-sm" data-i18n-title="undo" disabled><i class="fas fa-undo"></i></button>
        <button id="redoBtn" class="editor-button rounded-md border shadow-sm" data-i18n-title="redo" disabled><i class="fas fa-redo"></i></button>

        <!-- Separador -->
        <div class="border-l h-6 mx-2" id="controlsSeparator"></div>
        <!-- Botones restantes -->
        <div class="editor-button-group">
            <input type="file" id="textFileInput" accept=".txt" class="hidden" />
            <input type="file" id="shortcutImportInput" accept=".json" class="hidden" />
            <button id="boldBtn" class="editor-button rounded-md border shadow-sm"><i class="fas fa-bold"></i></button>
            <button id="italicBtn" class="editor-button rounded-md border shadow-sm"><i class="fas fa-italic"></i></button>
            <button id="uppercaseBtn" class="editor-button rounded-md border shadow-sm font-bold">aA</button>
            <button id="lowercaseBtn" class="editor-button rounded-md border shadow-sm font-bold">Aa</button>
            <select id="fontFamilySelect" title="Select Font Family" class="rounded-md border shadow-sm px-2 py-1.5 text-sm focus:outline-none"></select>
            <select id="fontSizeSelect" title="Select Font Size" class="rounded-md border shadow-sm px-2 py-1.5 text-sm focus:outline-none"></select>
        </div>
    </div>
    
    <!-- Barra de Búsqueda y Reemplazo -->
    <div id="find-replace-bar" class="hidden">
        <div class="flex flex-col gap-2 flex-grow">
            <div class="flex items-center gap-2">
                <input type="text" id="find-input" class="flex-grow" data-i18n-placeholder="findPlaceholder" />
                <span id="find-results-count" class="text-sm">0/0</span>
                <button id="find-prev-btn" data-i18n-title="tooltip_find_previous"><i class="fas fa-arrow-up"></i></button>
                <button id="find-next-btn" data-i18n-title="tooltip_find_next"><i class="fas fa-arrow-down"></i></button>
                <button id="toggle-replace-btn" data-i18n-title="tooltip_toggle_replace" class="px-2 py-1"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div id="replace-controls" class="hidden items-center gap-2">
                <input type="text" id="replace-input" class="flex-grow" />
                <button id="replace-btn" data-i18n="replace">Replace</button>
                <button id="replace-all-btn" data-i18n="replaceAll">Replace All</button>
            </div>
        </div>
        <div class="flex items-center gap-2 ml-auto pl-4">
             <label class="flex items-center gap-1 text-sm cursor-pointer">
                <input type="checkbox" id="match-case-checkbox" />
                <span data-i18n="caseSensitive">Match case</span>
            </label>
        </div>
    </div>

    <!-- Editor de Texto -->
    <div id="editor-container" class="w-full flex-1 flex flex-col">
        <div id="editor" contenteditable="true" spellcheck="true" aria-label="Text editor" class="w-full flex-1 rounded-lg p-4 text-sm overflow-y-auto outline-none shadow-inner">
          <p data-i18n="editorPlaceholder">Start transcribing here...</p>
        </div>
    </div>
    
    <!-- NUEVO: Vista de Modo AD -->
    <div id="ad-view" style="display: none;" class="w-full flex-1 flex-col">
        <!-- Botones de control AD -->
        <div id="ad-controls" class="mb-2 flex gap-2">
            <button id="addAdLineBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center" data-i18n="addAdLine"><i class="fas fa-plus mr-2"></i>Añadir Línea (Alt+W)</button>
            <button id="setAdInBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center" data-i18n="setAdIn"><i class="fas fa-sign-in-alt mr-2"></i>Fijar Entrada (Alt+E)</button>
            <button id="setAdOutBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center" data-i18n="setAdOut"><i class="fas fa-sign-out-alt mr-2"></i>Fijar Salida (Alt+R)</button>
            <button id="deleteAdLineBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center" data-i18n="deleteAdLine"><i class="fas fa-trash-alt mr-2"></i>Eliminar Línea (Alt+D)</button>
        </div>
        
        <!-- Contenedor de la tabla AD -->
        <div id="ad-table-container" class="flex-1 rounded-lg overflow-auto shadow-inner">
            <table id="ad-table" class="w-full">
                <thead>
                    <tr>
                        <th class="col-time" data-i18n="adColIn">Entrada</th>
                        <th class="col-time" data-i18n="adColOut">Salida</th>
                        <th class="col-dur" data-i18n="adColDur">Dur.</th>
                        <th class="col-cps" data-i18n="adColCps">CPS</th>
                        <th class="col-text" data-i18n="adColText">Texto</th>
                        <th class="col-notes" data-i18n="adColNotes">Notas</th>
                    </tr>
                </thead>
                <tbody id="ad-table-body">
                    <!-- Las filas se generarán dinámicamente aquí -->
                </tbody>
            </table>
        </div>
    </div>

  </div>

  <!-- Modal -->
  <div id="customModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
      <p id="modalMessage" class="mb-4"></p>
      <div id="modalBody" class="mb-4"></div>
      <div id="modalButtons" class="modal-buttons"></div>
    </div>
  </div>

  <script type"module">
        // --- DOM Element References ---
        const video = document.getElementById('video');
        const videoFileInput = document.getElementById('videoFileInput');
        const projectFileInput = document.getElementById('projectFileInput');
        const importVideoAudioBtn = document.getElementById('importVideoAudioBtn');
        const textFileInput = document.getElementById('textFileInput');
        const editorContainer = document.getElementById('editor-container'); // Contenedor del editor
        const editor = document.getElementById('editor');
        const tcrDisplay = document.getElementById('tcrDisplay');
        const emptyPlayerOverlay = document.getElementById('emptyPlayerOverlay');
        const recurringTextContainer = document.getElementById('recurringTextContainer');
        const addRecurringTextBtn = document.getElementById('addRecurringTextBtn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const rewind5sBtn = document.getElementById('rewind5sBtn');
        const rewind1sBtn = document.getElementById('rewind1sBtn');
        const rewind1fBtn = document.getElementById('rewind1fBtn');
        const forward1fBtn = document.getElementById('forward1fBtn');
        const forward1sBtn = document.getElementById('forward1sBtn');
        const forward5sBtn = document.getElementById('forward5sBtn');
        const speedDownBtn = document.getElementById('speedDownBtn');
        const speedUpBtn = document.getElementById('speedUpBtn');
        const speedDisplay = document.getElementById('speedDisplay');
        const muteBtn = document.getElementById('muteBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const insertTimecodeBtn = document.getElementById('insertTimecodeBtn');
        const timecodeFormatBtn = document.getElementById('timecodeFormatBtn');
        const setInitialTimecodeBtn = document.getElementById('setInitialTimecodeBtn');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const uppercaseBtn = document.getElementById('uppercaseBtn');
        const lowercaseBtn = document.getElementById('lowercaseBtn');
        const fileMenuBtn = document.getElementById('fileMenuBtn');
        const fileMenuDropdown = document.getElementById('fileMenuDropdown');
        const settingsMenuBtn = document.getElementById('settingsMenuBtn');
        const settingsMenuDropdown = document.getElementById('settingsMenuDropdown');
        const newTranscriptionBtn = document.getElementById('newTranscriptionBtn');
        const openProjectBtn = document.getElementById('openProjectBtn');
        const saveProjectBtn = document.getElementById('saveProjectBtn');
        const importTextBtn = document.getElementById('importTextBtn');
        const exportTranscriptionBtn = document.getElementById('exportTranscriptionBtn'); // Renombrado
        const exportAdBtn = document.getElementById('exportAdBtn'); // Nuevo
        const backupBtn = document.getElementById('backupBtn');
        const shortcutsBtn = document.getElementById('shortcutsBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const languageToggleBtn = document.getElementById('languageToggleBtn');
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('left');
        const rightPanel = document.getElementById('right');
        const fontFamilySelect = document.getElementById('fontFamilySelect');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        const waveformContainer = document.getElementById('waveform-container');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const shortcutImportInput = document.getElementById('shortcutImportInput');
        // Find & Replace elements
        const findReplaceBar = document.getElementById('find-replace-bar');
        const findInput = document.getElementById('find-input');
        const replaceInput = document.getElementById('replace-input');
        const findResultsCount = document.getElementById('find-results-count');
        const findPrevBtn = document.getElementById('find-prev-btn');
        const findNextBtn = document.getElementById('find-next-btn');
        const matchCaseCheckbox = document.getElementById('match-case-checkbox');
        const replaceBtn = document.getElementById('replace-btn');
        const replaceAllBtn = document.getElementById('replace-all-btn');
        const toggleReplaceBtn = document.getElementById('toggle-replace-btn');
        const replaceControls = document.getElementById('replace-controls');
        // Botones del editor
        const editorButtonGroup = document.querySelector('.editor-button-group');
        // Botones Deshacer/Rehacer
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');


        // --- Nuevos elementos AD ---
        const toggleAdModeBtn = document.getElementById('toggleAdModeBtn');
        const cpsSettingsBtn = document.getElementById('cpsSettingsBtn');
        const adView = document.getElementById('ad-view');
        const adControls = document.getElementById('ad-controls');
        const adTableContainer = document.getElementById('ad-table-container');
        const adTableBody = document.getElementById('ad-table-body');
        const addAdLineBtn = document.getElementById('addAdLineBtn');
        const setAdInBtn = document.getElementById('setAdInBtn');
        const setAdOutBtn = document.getElementById('setAdOutBtn');
        const deleteAdLineBtn = document.getElementById('deleteAdLineBtn');

        // --- Estado de la Aplicación ---
        const DEFAULT_FRAMERATE = 30;
        let tcrOffsetSeconds = 0;
        let isDarkMode = false;
        let currentLanguage = localStorage.getItem('pandascript_language') || 'en';
        let wavesurfer = null;
        let lastVolume = 1;
        let shortcuts = {};
        let isEditorPristine = true;
        let listeningForShortcut = null;
        let tempShortcuts = {};
        let currentMediaFile = null; // To store the loaded media file object
        let projectDB = null;
        
        // --- Nuevo estado AD ---
        let isAdMode = false;
        let adEntries = []; // Array para guardar los objetos de AD
        let adCpsLimit = 15;
        let wsRegions = null; // Para el plugin de regiones
        let selectedAdRowId = null; // ID de la fila de AD seleccionada
        let isWavesurferReady = false; // Flag para saber si wavesurfer está listo
        
        // --- Estado de Deshacer/Rehacer ---
        let historyStack = [];
        let redoStack = [];
        let isUndoingOrRedoing = false; // Flag para evitar bucles

        // --- Traducciones ---
        const translations = {
            en: {
                appTitle: "PandaScript", openMediaFile: "Open Video/Audio File", insertTimecode: "Insert timecode", timecodeFormat: "Timecode Format", setInitialTimecode: "Set Initial Timecode", recurringTextHeader: "Recurring Text", fileMenu: "File", settingsMenu: "Settings", newTranscription: "New Transcription", openProject: "Open Project", saveProject: "Save Project", importText: "Import .txt", export: "Export Transcription", exportAd: "Export Audio Description", backup: "Backup", shortcutsButton: "Keyboard Shortcuts", darkMode: "Dark Mode", lightMode: "Light Mode", changeLanguageButton: "Change Language", editorPlaceholder: "Open a video or audio file and start transcribing here. Use the different commands and keyboard shortcuts to transcribe productively.",
                findPlaceholder: "Find...", caseSensitive: "Match case", replace: "Replace", replaceAll: "Replace All", shortcutLabel_bold: "Bold", shortcutLabel_italic: "Italic", shortcutLabel_uppercase: "Uppercase", shortcutLabel_lowercase: "Lowercase", tooltip_add_recurring: "Add text to editor", tooltip_delete_recurring: "Delete field", shortcutLabel_find: "Find", shortcutLabel_replace: "Replace", tooltip_find_previous: "Find Previous", tooltip_find_next: "Find Next", tooltip_toggle_replace: "Toggle Replace", tooltip_close_find_bar: "Close", languageModalTitle: "Change Language", save: "Save", cancel: "Cancel", openProjectTitle: "Open Project", recentProjects: "Recent Projects", openFromFile: "Open from file...", noRecentProjects: "No recent projects found.",
                adMode: "Audio Description Mode", cpsSettings: "CPS Settings", addAdLine: "Add Line (Alt+W)", setAdIn: "Set In (Alt+E)", setAdOut: "Set Out (Alt+R)", deleteAdLine: "Delete Line (Alt+D)",
                adColIn: "In", adColOut: "Out", adColDur: "Dur.", adColCps: "CPS", adColText: "Text", adColNotes: "Notes",
                cpsSettingsTitle: "CPS Limit Settings", cpsSettingsMessage: "Set the CPS limit. Cells exceeding this limit will be marked red.", cpsLimitLabel: "CPS Limit:",
                exportAdModalTitle: "Export Audio Description", exportFormatSrt: ".srt (SubRip)", exportFormatTxt: ".txt (Plain Text)", exportFormatHtml: ".html (Table)", exportFormatPdf: ".pdf (Table)",
                exportModalTitle: "Export Transcription", filenameLabel: "Filename:", formatLabel: "Format:", exportBtnText: "Export",
                newTranscriptionConfirm: "Are you sure you want to start a new transcription? Any unsaved progress will be lost.",
                backupFoundTitle: "Backup Found", backupFoundMessage: "An automatic backup was found. Do you want to restore it?",
                restore: "Restore", discard: "Discard", noBackup: "No backup available.",
                shortcutsModalTitle: "Customize Keyboard Shortcuts", shortcutsModalMessage: "Click on a button to set a new shortcut.",
                resetShortcuts: "Restore", pressNewShortcut: "Press new keys...", saveShortcuts: "Save",
                importShortcuts: "Import", exportShortcuts: "Export", shortcutsImported: "Shortcuts imported successfully.",
                shortcutsImportError: "Error importing shortcuts. Invalid file format.",
                shortcutLabel_playPause: "Play/Pause", shortcutLabel_rewind5s: "Rewind 5s", shortcutLabel_forward5s: "Forward 5s",
                shortcutLabel_rewind1s: "Rewind 1s", shortcutLabel_forward1s: "Forward 1s",
                shortcutLabel_rewind1frame: "Rewind 1 frame", shortcutLabel_forward1frame: "Forward 1 frame",
                shortcutLabel_speedUp: "Speed Up", shortcutLabel_speedDown: "Speed Down",
                shortcutLabel_insertTimecode: "Insert timecode", shortcutLabel_insertRecurringText: "Insert recurring text",
                unsavedChangesTitle: "Unsaved Changes", unsavedChangesMessage: "You have unsaved changes in the shortcuts. Do you want to close without saving?",
                continueAndClose: "Continue and Close", goBack: "Go Back",
                undo: "Undo (Alt+Z)", redo: "Redo (Alt+Y)",
                confirmDeleteAdLine: "Are you sure you want to delete this line?"
            },
            es: {
                appTitle: "PandaScript", openMediaFile: "Abrir vídeo/audio", insertTimecode: "Insertar código de tiempo", timecodeFormat: "Formato TCR", setInitialTimecode: "TCR Inicial", recurringTextHeader: "Texto recurrente", fileMenu: "Archivo", settingsMenu: "Ajustes", newTranscription: "Nueva transcripción", openProject: "Abrir proyecto", saveProject: "Guardar proyecto", importText: "Importar .txt", export: "Exportar transcripción", exportAd: "Exportar audiodescripción", backup: "Copia de seguridad", shortcutsButton: "Atajos de teclado", darkMode: "Modo oscuro", lightMode: "Modo claro", changeLanguageButton: "Cambiar idioma", editorPlaceholder: "Abre un archivo de vídeo o audio y empieza a transcribir aquí. Utiliza los diferentes comandos y atajos de teclado para transcribir de manera productiva.",
                findPlaceholder: "Buscar...", caseSensitive: "Distinguir mayúsculas", replace: "Reemplazar", replaceAll: "Reemplazar todos", shortcutLabel_bold: "Negrita", shortcutLabel_italic: "Cursiva", shortcutLabel_uppercase: "Mayúsculas", shortcutLabel_lowercase: "Minúsculas", tooltip_add_recurring: "Añadir texto al editor", tooltip_delete_recurring: "Eliminar campo", shortcutLabel_find: "Buscar", shortcutLabel_replace: "Reemplazar", tooltip_find_previous: "Buscar anterior", tooltip_find_next: "Buscar siguiente", tooltip_toggle_replace: "Habilitar buscar y reemplazar", tooltip_close_find_bar: "Cerrar", languageModalTitle: "Cambiar idioma", save: "Guardar", cancel: "Cancelar", openProjectTitle: "Abrir proyecto", recentProjects: "Proyectos recientes", openFromFile: "Abrir desde archivo...", noRecentProjects: "No se encontraron proyectos recientes.",
                adMode: "Modo audiodescripción", cpsSettings: "Ajustes de CPS", addAdLine: "Añadir línea (Alt+W)", setAdIn: "Fijar entrada (Alt+E)", setAdOut: "Fijar salida (Alt+R)", deleteAdLine: "Eliminar línea (Alt+D)",
                adColIn: "Entrada", adColOut: "Salida", adColDur: "Dur.", adColCps: "CPS", adColText: "Texto", adColNotes: "Notas",
                cpsSettingsTitle: "Ajustes Límite de CPS", cpsSettingsMessage: "Define el límite de CPS. Las celdas que superen este límite se marcarán en rojo.", cpsLimitLabel: "Límite de CPS:",
                exportAdModalTitle: "Exportar audiodescripción", exportFormatSrt: ".srt (SubRip)", exportFormatTxt: ".txt (Texto Plano)", exportFormatHtml: ".html (Tabla)", exportFormatPdf: ".pdf (Tabla)",
                exportModalTitle: "Exportar Transcripción", filenameLabel: "Nombre del archivo:", formatLabel: "Formato:", exportBtnText: "Exportar",
                newTranscriptionConfirm: "¿Seguro que quieres empezar una nueva transcripción? Se perderá todo el progreso no guardado.",
                backupFoundTitle: "Copia de seguridad encontrada", backupFoundMessage: "Se encontró una copia de seguridad automática. ¿Quieres restaurarla?",
                restore: "Restaurar", discard: "Descartar", noBackup: "No hay ninguna copia de seguridad disponible.",
                shortcutsModalTitle: "Personalizar atajos de teclado", shortcutsModalMessage: "Haz clic en un botón para asignar un nuevo atajo.",
                resetShortcuts: "Restaurar", pressNewShortcut: "Pulsa las nuevas teclas...", saveShortcuts: "Guardar",
                importShortcuts: "Importar", exportShortcuts: "Exportar", shortcutsImported: "Atajos importados correctamente.",
                shortcutsImportError: "Error al importar atajos. Formato de archivo no válido.",
                shortcutLabel_playPause: "Reproducir/Pausar", shortcutLabel_rewind5s: "Retroceder 5s", shortcutLabel_forward5s: "Avanzar 5s",
                shortcutLabel_rewind1s: "Retroceder 1s", shortcutLabel_forward1s: "Avanzar 1s",
                shortcutLabel_rewind1frame: "Retroceder 1 fotograma", shortcutLabel_forward1frame: "Avanzar 1 fotograma",
                shortcutLabel_speedUp: "Acelerar", shortcutLabel_speedDown: "Ralentizar",
                shortcutLabel_insertTimecode: "Insertar código de tiempo", shortcutLabel_insertRecurringText: "Insertar texto recurrente",
                unsavedChangesTitle: "Cambios no guardados", unsavedChangesMessage: "Tienes cambios sin guardar en los atajos. ¿Quieres cerrar sin guardar?",
                continueAndClose: "Continuar y cerrar", goBack: "Volver",
                undo: "Deshacer (Alt+Z)", redo: "Rehacer (Alt+Y)",
                confirmDeleteAdLine: "¿Seguro que quieres eliminar esta línea?"
            }
        };

        const availableLanguages = {
            en: 'English',
            es: 'Español'
        };

        // --- Definición de Temas ---
        const themeClasses = {
            dark: { bodyBg: 'bg-gray-950', bodyText: 'text-gray-200', panelBg: 'bg-gray-800', border: 'border-gray-700', editorBg: 'bg-gray-900', editorText: 'text-gray-200', btnNeutral: 'bg-gray-600 hover:bg-gray-500 text-white', menuBtnBg: 'bg-gray-700', menuBtnText: 'text-gray-200', menuBtnHoverBg: 'hover:bg-gray-600', waveformContainerBg: 'bg-gray-900', waveColor: '#373737', progressColor: '#FF4853', cursorColor: '#FF4853', dropdownBg: 'bg-gray-800', modalContentBg: 'bg-gray-800', modalContentText: 'text-gray-200', findBarBg: 'bg-gray-800', findBarBorder: 'border-gray-700', findBarInputBg: 'bg-gray-700', findBarInputBorder: 'border-gray-600', adTableBg: 'bg-gray-900', adTableBorder: 'border-gray-700', adTableHeaderBg: 'bg-gray-800', adTableRowHover: 'hover:bg-gray-700', adTableInputBg: 'bg-gray-700', adTableInputBorder: 'border-gray-600' },
            light: { bodyBg: 'bg-gray-50', bodyText: 'text-gray-900', panelBg: 'bg-white', border: 'border-gray-300', editorBg: 'bg-white', editorText: 'text-black', btnNeutral: 'bg-gray-200 hover:bg-gray-300 text-black', menuBtnBg: 'bg-white', menuBtnText: 'text-gray-700', menuBtnHoverBg: 'hover:bg-gray-50', waveformContainerBg: 'bg-gray-200', waveColor: '#CBD5E0', progressColor: '#FF4853', cursorColor: '#FF4853', dropdownBg: 'bg-white', modalContentBg: 'bg-white', modalContentText: 'text-gray-900', findBarBg: 'bg-gray-100', findBarBorder: 'border-gray-300', findBarInputBg: 'bg-white', findBarInputBorder: 'border-gray-400', adTableBg: 'bg-white', adTableBorder: 'border-gray-300', adTableHeaderBg: 'bg-gray-100', adTableRowHover: 'hover:bg-gray-50', adTableInputBg: 'bg-white', adTableInputBorder: 'border-gray-400' }
        };

        // --- Formatos de TCR ---
        const pad = (num, len = 2) => String(num).padStart(len, '0');
        const tcrFormats = [
            { name: "HH:MM:SS,MSS", format: (t) => { if(isNaN(t)) return '--:--:--,---'; const h=Math.floor(t/3600),m=Math.floor(t%3600/60),s=Math.floor(t%60),ms=Math.floor(t%1*1000); return `${pad(h)}:${pad(m)}:${pad(s)},${pad(ms,3)}`; }},
            { name: "HH:MM:SS:FF", format: (t, fr) => { if(isNaN(t)) return '--:--:--:--'; const tf=Math.floor(t*fr),h=Math.floor(tf/(3600*fr)),m=Math.floor(tf/(60*fr)%60),s=Math.floor(tf/fr%60),f=tf%fr; return `${pad(h)}:${pad(m)}:${pad(s)}:${pad(f)}`; }},
            { name: "MM:SS,MSS", format: (t) => { if(isNaN(t)) return '--:--,---'; const m=Math.floor(t/60),s=Math.floor(t%60),ms=Math.floor(t%1*1000); return `${pad(m)}:${pad(s)},${pad(ms,3)}`; }},
            { name: "MM:SS", format: (t) => { if(isNaN(t)) return '--:--'; const m=Math.floor(t/60),s=Math.floor(t%60); return `${pad(m)}:${pad(s)}`; }},
            { name: "MM:SS:FF", format: (t, fr) => { if(isNaN(t)) return '--:--:--'; const tf=Math.floor(t*fr),m=Math.floor(tf/(60*fr)),s=Math.floor(tf/fr%60),f=tf%fr; return `${pad(m)}:${pad(s)}:${pad(f)}`; }},
        ];
        let currentTCRFormatIndex = 0;
        
        // --- Funciones de Timecode (Usaremos la de milisegundos para AD) ---
        const formatSrtTime = (seconds) => {
            if (isNaN(seconds)) return '00:00:00,000';
            // Usar Math.floor para asegurar que trabajamos con milisegundos enteros
            const totalMs = Math.floor(seconds * 1000); 
            const h = Math.floor(totalMs / 3600000);
            const m = Math.floor((totalMs % 3600000) / 60000);
            const s = Math.floor((totalMs % 60000) / 1000);
            const ms = totalMs % 1000;
            
            // Usa la función 'pad' que ya tienes definida (en la línea 581)
            return `${pad(h)}:${pad(m)}:${pad(s)},${pad(ms, 3)}`;
        };
        
        const parseSrtTime = (timeStr) => {
            const parts = timeStr.split(/[:,]/);
            if (parts.length === 4) {
                const h = parseInt(parts[0], 10) || 0;
                const m = parseInt(parts[1], 10) || 0;
                const s = parseInt(parts[2], 10) || 0;
                const ms = parseInt(parts[3], 10) || 0;
                return (h * 3600) + (m * 60) + s + (ms / 1000);
            }
            return 0;
        };


        // --- Funciones de Base de Datos ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("PandaScriptDB", 1);
                request.onerror = (event) => reject("Database error: " + event.target.errorCode);
                request.onsuccess = (event) => {
                    projectDB = event.target.result;
                    resolve(projectDB);
                };
                request.onupgradeneeded = (event) => {
                    let db = event.target.result;
                    let store = db.createObjectStore("projects", { keyPath: "id", autoIncrement: true });
                    store.createIndex("lastModified", "lastModified", { unique: false });
                };
            });
        }
        
        function saveProjectToDB(projectData) {
            return new Promise((resolve, reject) => {
                if (!projectDB) reject("DB not initialized");
                const transaction = projectDB.transaction(["projects"], "readwrite");
                const store = transaction.objectStore("projects");
                
                // Si el proyecto ya tiene un ID (p.ej. de abrir un .pscript), usamos put para actualizar
                // Si no tiene ID (proyecto nuevo), usamos add para crear uno.
                // Para simplificar, podemos usar siempre 'put' si asignamos un ID temporal o fijo a los proyectos guardados en DB.
                // Por ahora, asumamos que un proyecto guardado puede no tener ID de DB.
                
                // Vamos a usar un ID fijo para el autoguardado, por ejemplo.
                // Pero para "Save Project", deberíamos añadirlo como nuevo.
                // Por ahora, la lógica original de 'add' está bien.
                const request = store.add(projectData);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject("Error saving project: " + event.target.error);
            });
        }

        function getRecentProjects(limit = 3) {
            return new Promise((resolve, reject) => {
                if (!projectDB) reject("DB not initialized");
                const transaction = projectDB.transaction(["projects"], "readonly");
                const store = transaction.objectStore("projects");
                const index = store.index("lastModified");
                const request = index.getAll(null, limit); // Note: This gets all and we sort/slice after
                
                request.onsuccess = () => {
                    // IndexedDB getAll con índice no garantiza orden en todos los navegadores, así que re-ordenamos.
                    const sorted = request.result.sort((a, b) => b.lastModified - a.lastModified);
                    resolve(sorted.slice(0, limit));
                };
                request.onerror = (event) => reject("Error fetching recent projects: " + event.target.error);
            });
        }
        
        function getProjectFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!projectDB) reject("DB not initialized");
                const transaction = projectDB.transaction(["projects"], "readonly");
                const store = transaction.objectStore("projects");
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject("Error fetching project: " + event.target.error);
            });
        }


        // --- Funciones Principales ---
        function applyLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            // Update text content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const target = el.querySelector('span') || el;
                if (translations[lang] && translations[lang][key]) {
                    target.textContent = translations[lang][key];
                }
            });
             // Update titles
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (translations[lang] && translations[lang][key]) {
                    el.title = translations[lang][key];
                }
            });
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            if (isEditorPristine) {
                editor.querySelector('p').textContent = translations[currentLanguage].editorPlaceholder;
            }
            updateTooltips();
            applyTheme(isDarkMode ? 'dark' : 'light');
            
            // Re-renderizar tabla AD si está activa
            if(isAdMode) {
                renderAdTable();
            }
        }

        function applyTheme(themeName) {
            const theme = themeClasses[themeName];
            isDarkMode = (themeName === 'dark');
            document.body.className = `flex flex-row h-screen overflow-hidden ${theme.bodyBg} ${theme.bodyText}`;
            leftPanel.className = `p-4 flex flex-col relative ${theme.panelBg}`;
            rightPanel.className = `p-4 flex flex-col relative ${theme.panelBg}`;
            resizer.className = `cursor-col-resize ${isDarkMode ? 'bg-gray-700' : 'bg-gray-300'}`;
            importVideoAudioBtn.className = `w-full font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out mb-4 ${theme.btnNeutral}`;
            document.querySelectorAll('#left > .flex-wrap > button').forEach(btn => {
                btn.className = `flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm ${theme.btnNeutral}`;
            });
            addRecurringTextBtn.className = `font-bold p-1 rounded-lg shadow-md transition duration-200 ease-in-out text-sm ${theme.btnNeutral}`;
            document.querySelectorAll('#controls .relative button, #controls .editor-button-group button, #controls .editor-button-group select, #undoBtn, #redoBtn').forEach(el => {
                el.classList.remove('bg-gray-700', 'text-gray-200', 'hover:bg-gray-600', 'bg-white', 'text-gray-700', 'hover:bg-gray-50');
                el.classList.add(theme.menuBtnBg, theme.menuBtnText, theme.menuBtnHoverBg);
                el.classList.add(theme.border); // Añadir borde de tema
            });
            [fileMenuDropdown, settingsMenuDropdown].forEach(dd => {
                dd.classList.remove('bg-gray-800', 'bg-white');
                dd.classList.add(theme.dropdownBg, theme.border);
            });
editor.className = `flex-1 rounded-lg p-4 text-sm overflow-y-auto outline-none shadow-inner ${theme.editorBg} ${theme.editorText} ${theme.border} focus:ring-2 focus:ring-gray-800`; 
           if (wavesurfer) {
                wavesurfer.setOptions({ waveColor: theme.waveColor, progressColor: theme.progressColor, cursorColor: theme.cursorColor });
            }
            waveformContainer.classList.remove('bg-gray-900', 'bg-gray-200');
            waveformContainer.classList.add(theme.waveformContainerBg);
            document.querySelector('.modal-content').classList.remove('bg-white', 'text-gray-900', 'bg-gray-800', 'text-gray-200');
            document.querySelector('.modal-content').classList.add(theme.modalContentBg, theme.modalContentText);

            // Theme for Find/Replace bar
            findReplaceBar.classList.remove('bg-gray-100', 'border-gray-300', 'bg-gray-800', 'border-gray-700');
            findReplaceBar.classList.add(theme.findBarBg, theme.findBarBorder);
            [findInput, replaceInput].forEach(input => {
                input.classList.remove('bg-white', 'border-gray-400', 'bg-gray-700', 'border-gray-600');
                input.classList.add(theme.findBarInputBg, theme.findBarInputBorder, theme.editorText);
            });
            document.querySelectorAll('#find-replace-bar button').forEach(btn => {
                 btn.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'bg-gray-600', 'hover:bg-gray-500', 'text-white', 'text-black');
                 btn.classList.add(...theme.btnNeutral.split(' '));
            });
            
            // --- Aplicar tema a AD ---
adView.classList.remove('bg-gray-800', 'bg-white');
            adView.classList.add(theme.panelBg);
            
            adTableContainer.classList.remove('border-gray-700', 'border-gray-300');
            adTableContainer.classList.add(theme.adTableBorder);

            document.querySelectorAll('#ad-controls button').forEach(btn => {
                btn.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-black', 'bg-gray-600', 'hover:bg-gray-500', 'text-white');
                btn.classList.add(...theme.btnNeutral.split(' '));
            });

          document.querySelectorAll('#ad-table th').forEach(th => {
                th.classList.remove('bg-gray-800', 'bg-gray-100', 'border-gray-700', 'border-gray-300', 'text-gray-200', 'text-gray-900');
                th.classList.add(theme.adTableHeaderBg, theme.adTableBorder, theme.bodyText);
            });
            
            renderAdTable(); // Re-renderizar tabla para aplicar clases de inputs
            // --- Fin tema AD ---
            
            const themeText = document.getElementById('themeText');
            const themeIcon = document.getElementById('themeIcon');
            themeText.textContent = isDarkMode ? translations[currentLanguage].lightMode : translations[currentLanguage].darkMode;
            themeIcon.className = `fas ${isDarkMode ? 'fa-sun' : 'fa-moon'} mr-3`;
        }
        
        // --- NUEVAS FUNCIONES MODO AD ---

        /**
         * Alterna entre el editor de texto principal y la tabla de AD.
         */
        function toggleAdMode() {
            isAdMode = !isAdMode;
            clearHistory(); // Limpiar historial al cambiar de modo
            
            if (isAdMode) {
                // Cambiar a Modo AD
                editorContainer.style.display = 'none';
                findReplaceBar.style.display = 'none'; // También ocultar find/replace
                editorButtonGroup.style.display = 'none';
                
                adView.style.display = 'flex'; // Usar flex
                
                toggleAdModeBtn.classList.add('bg-red-200', 'dark:bg-red-800');
                
                renderAdTable();
                renderAdRegions();
            } else {
                // Volver a Modo Transcripción
                editorContainer.style.display = 'flex'; // Usar flex
                editorButtonGroup.style.display = 'flex';
                // findReplaceBar se gestiona por su propio botón
                
                adView.style.display = 'none';
                
                toggleAdModeBtn.classList.remove('bg-red-200', 'dark:bg-red-800');
                
                clearAdRegions();
            }
        }

        /**
         * Renderiza la tabla de AD completa desde el array `adEntries`.
         */
        function renderAdTable() {
            if (!isAdMode) return;
            adTableBody.innerHTML = '';
            adEntries.forEach(entry => {
                adTableBody.appendChild(createAdTableRow(entry));
            });
        }
        
        /**
         * Crea y devuelve un elemento <tr> para una entrada de AD.
         */
        function createAdTableRow(entry) {
            const tr = document.createElement('tr');
            tr.id = entry.id;
            tr.dataset.id = entry.id;
            
            if (entry.id === selectedAdRowId) {
                tr.classList.add('selected-row');
            }
            
            const theme = themeClasses[isDarkMode ? 'dark' : 'light'];
            tr.classList.add(theme.adTableRowHover);
            
            tr.addEventListener('click', () => {
                selectedAdRowId = entry.id;
                
                // Actualizar tabla
                document.querySelectorAll('#ad-table-body tr').forEach(row => row.classList.remove('selected-row'));
                tr.classList.add('selected-row');
                
                // Actualizar regiones
                if (wsRegions) {
                    wsRegions.getRegions().forEach(r => {
                        r.element.classList.remove('selected-region');
                    });
                    const region = wsRegions.getRegions().find(r => r.id === entry.id);
                    if (region) {
                        region.element.classList.add('selected-region');
                    }
                }
            });
            
            // 1. Time In
            const tdIn = document.createElement('td');
            tdIn.className = 'col-time';
            tdIn.classList.add(theme.adTableBorder); // Aplicar borde temático
            const inInput = document.createElement('input');
            inInput.type = 'text';
            inInput.value = formatSrtTime(entry.startTimeMs / 1000);
            inInput.className = `${theme.adTableInputBg} ${theme.adTableInputBorder} ${theme.editorText}`;
            inInput.dataset.field = 'startTimeMs';
            inInput.onchange = (e) => handleAdTimecodeChange(entry.id, true, e.target);
            inInput.onfocus = () => saveHistoryState(entry.id, 'time', { startTimeMs: entry.startTimeMs, endTimeMs: entry.endTimeMs });
            inInput.onblur = (e) => pushHistoryState(entry.id, 'time', { startTimeMs: parseSrtTime(e.target.value) * 1000, endTimeMs: entry.endTimeMs });
            tdIn.appendChild(inInput);

            // 2. Time Out
            const tdOut = document.createElement('td');
            tdOut.className = 'col-time';
            tdOut.classList.add(theme.adTableBorder); // Aplicar borde temático
            const outInput = document.createElement('input');
            outInput.type = 'text';
            outInput.value = formatSrtTime(entry.endTimeMs / 1000);
            outInput.className = `${theme.adTableInputBg} ${theme.adTableInputBorder} ${theme.editorText}`;
            outInput.dataset.field = 'endTimeMs';
            outInput.onchange = (e) => handleAdTimecodeChange(entry.id, false, e.target);
            outInput.onfocus = () => saveHistoryState(entry.id, 'time', { startTimeMs: entry.startTimeMs, endTimeMs: entry.endTimeMs });
            outInput.onblur = (e) => pushHistoryState(entry.id, 'time', { startTimeMs: entry.startTimeMs, endTimeMs: parseSrtTime(e.target.value) * 1000 });
            tdOut.appendChild(outInput);

            // 3. Duration
            const tdDur = document.createElement('td');
            tdDur.className = 'col-dur';
            tdDur.classList.add(theme.adTableBorder); // Aplicar borde temático
            const durationMs = entry.endTimeMs - entry.startTimeMs;
            const durationSec = durationMs > 0 ? (durationMs / 1000).toFixed(2) : '0.00';
            tdDur.textContent = `${durationSec}s`;

            // 4. CPS
            const tdCps = document.createElement('td');
            tdCps.className = 'col-cps';
            tdCps.classList.add(theme.adTableBorder); // Aplicar borde temático
            const cps = calculateAdCps(entry.text, durationMs);
            tdCps.textContent = cps.toFixed(1);
            if (cps > adCpsLimit) {
                tdCps.classList.add('cps-warning');
            }

            // 5. Text
            const tdText = document.createElement('td');
            tdText.className = 'col-text';
            tdText.classList.add(theme.adTableBorder); // Aplicar borde temático
            const textInput = document.createElement('textarea');
            textInput.value = entry.text;
            textInput.className = `${theme.adTableInputBg} ${theme.adTableInputBorder} ${theme.editorText}`;
            textInput.dataset.field = 'text';
            textInput.oninput = (e) => handleAdTextChange(entry.id, 'text', e.target);
            textInput.onfocus = (e) => saveHistoryState(entry.id, 'text', e.target.value);
            textInput.onblur = (e) => pushHistoryState(entry.id, 'text', e.target.value);
            tdText.appendChild(textInput);

            // 6. Notes
            const tdNotes = document.createElement('td');
            tdNotes.className = 'col-notes';
            tdNotes.classList.add(theme.adTableBorder); // Aplicar borde temático
            const notesInput = document.createElement('textarea');
            notesInput.value = entry.notes;
            notesInput.className = `${theme.adTableInputBg} ${theme.adTableInputBorder} ${theme.editorText}`;
            notesInput.dataset.field = 'notes';
            notesInput.oninput = (e) => handleAdTextChange(entry.id, 'notes', e.target);
            notesInput.onfocus = (e) => saveHistoryState(entry.id, 'notes', e.target.value);
            notesInput.onblur = (e) => pushHistoryState(entry.id, 'notes', e.target.value);
            tdNotes.appendChild(notesInput);
            
            tr.append(tdIn, tdOut, tdDur, tdCps, tdText, tdNotes);
            return tr;
        }

        /**
         * Actualiza una fila de la tabla de AD cuando cambian los datos.
         */
        function updateAdTableRow(entry) {
            const tr = document.getElementById(entry.id);
            if (!tr) return;

            // Actualizar campos
            tr.querySelector('td:nth-child(1) input').value = formatSrtTime(entry.startTimeMs / 1000);
            tr.querySelector('td:nth-child(2) input').value = formatSrtTime(entry.endTimeMs / 1000);

            const durationMs = entry.endTimeMs - entry.startTimeMs;
            const durationSec = durationMs > 0 ? (durationMs / 1000).toFixed(2) : '0.00';
            tr.querySelector('td:nth-child(3)').textContent = `${durationSec}s`;

            const cps = calculateAdCps(entry.text, durationMs);
            const tdCps = tr.querySelector('td:nth-child(4)');
            tdCps.textContent = cps.toFixed(1);
            tdCps.classList.toggle('cps-warning', cps > adCpsLimit);
            
            tr.querySelector('td:nth-child(5) textarea').value = entry.text;
            tr.querySelector('td:nth-child(6) textarea').value = entry.notes;
        }

        /**
         * Calcula CPS para la tabla de AD.
         */
        function calculateAdCps(text, durationMs) {
            if (!text || durationMs <= 0) {
                return 0;
            }
            return (text.length / (durationMs / 1000));
        }

        /**
         * Añade una nueva línea de AD.
         */
        function handleAddAdLine() {
            if (!video.src) return;
            
            const currentTimeMs = video.currentTime * 1000;
            const newEntry = {
                id: 'ad-' + Date.now(),
                startTimeMs: currentTimeMs,
                endTimeMs: currentTimeMs + 3000, // Duración por defecto de 3s
                text: '',
                notes: ''
            };
            
            adEntries.push(newEntry);
            
            // Guardar historial
            saveHistory({
                type: 'add',
                entry: newEntry
            });
            
            // Añadir fila a la tabla
            const newRow = createAdTableRow(newEntry);
            adTableBody.appendChild(newRow);
            
            // Seleccionar nueva fila
            selectedAdRowId = newEntry.id;
            document.querySelectorAll('#ad-table-body tr').forEach(row => row.classList.remove('selected-row'));
            newRow.classList.add('selected-row');
            newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Añadir región a wavesurfer
            addAdRegion(newEntry);
        }

        /**
         * Fija el tiempo de entrada o salida de la fila seleccionada.
         */
        function handleSetAdTime(isStartTime) {
            if (!selectedAdRowId || !video.src) return;
            
            const entry = adEntries.find(e => e.id === selectedAdRowId);
            if (!entry) return;

            const oldState = { startTimeMs: entry.startTimeMs, endTimeMs: entry.endTimeMs };
            
            const currentTimeMs = video.currentTime * 1000;
            
            if (isStartTime) {
                entry.startTimeMs = currentTimeMs;
                // Asegurar que la salida sea después de la entrada
                if (entry.endTimeMs <= entry.startTimeMs) {
                    entry.endTimeMs = entry.startTimeMs + 1000; // 1s de duración mínima
                }
            } else {
                entry.endTimeMs = currentTimeMs;
                // Asegurar que la entrada sea antes de la salida
                if (entry.startTimeMs >= entry.endTimeMs) {
                    entry.startTimeMs = entry.endTimeMs - 1000; // 1s de duración mínima
                }
            }
            
            const newState = { startTimeMs: entry.startTimeMs, endTimeMs: entry.endTimeMs };

            // Guardar historial
            saveHistory({
                type: 'time',
                id: entry.id,
                old: oldState,
                new: newState
            });

            updateAdTableRow(entry);
            updateAdRegion(entry);
        }
        
        /**
         * Maneja el cambio manual de tiempo en un input.
         */
        function handleAdTimecodeChange(id, isStartTime, inputElement) {
            const entry = adEntries.find(e => e.id === id);
            if (!entry) return;
            
            // El guardado de historial se maneja en onfocus/onblur
            
            try {
                const newTimeSec = parseSrtTime(inputElement.value);
                const newTimeMs = newTimeSec * 1000;
                
                if (isStartTime) {
                    entry.startTimeMs = newTimeMs;
                } else {
                    entry.endTimeMs = newTimeMs;
                }
                
                // Validar tiempos
                if (entry.endTimeMs <= entry.startTimeMs) {
                    if(isStartTime) {
                        entry.endTimeMs = entry.startTimeMs + 1000;
                    } else {
                        entry.startTimeMs = entry.endTimeMs - 1000;
                    }
                }
                
                updateAdTableRow(entry);
                updateAdRegion(entry);

            } catch (e) {
                // Revertir a valor anterior si es inválido
                inputElement.value = formatSrtTime((isStartTime ? entry.startTimeMs : entry.endTimeMs) / 1000);
            }
        }
        
        /**
         * Maneja el cambio de texto o notas.
         */
        function handleAdTextChange(id, fieldName, textareaElement) {
            const entry = adEntries.find(e => e.id === id);
            if (!entry) return;

            // El guardado de historial se maneja en onfocus/onblur
            
            entry[fieldName] = textareaElement.value;
            
            // Si el texto cambió, recalcular CPS
            if (fieldName === 'text') {
                const durationMs = entry.endTimeMs - entry.startTimeMs;
                const cps = calculateAdCps(entry.text, durationMs);
                const tdCps = textareaElement.closest('tr').querySelector('td:nth-child(4)');
                tdCps.textContent = cps.toFixed(1);
                tdCps.classList.toggle('cps-warning', cps > adCpsLimit);
                
                // Actualizar región
                if (wsRegions) {
                    const region = wsRegions.getRegions().find(r => r.id === id);
                    updateRegionContent(region, entry); // <-- AÑADIDO
                }
            }
        }

        /**
         * Elimina la línea de AD seleccionada.
         */
        function handleDeleteAdLine() {
            if (!selectedAdRowId) return;
            
            const t = translations[currentLanguage];
            if (!confirm(t.confirmDeleteAdLine)) return;

            const index = adEntries.findIndex(e => e.id === selectedAdRowId);
            if (index === -1) return;

            const entryToDelete = { ...adEntries[index] }; // Copia para el historial
            
            // Eliminar del array
            adEntries.splice(index, 1);
            
            // Guardar historial
            saveHistory({
                type: 'delete',
                entry: entryToDelete,
                index: index // Guardar el índice original
            });

            // Eliminar región
            if (wsRegions) {
                const region = wsRegions.getRegions().find(r => r.id === selectedAdRowId); // <-- FIX
                if (region) {
                    region.remove();
                }
            }
            
            // Eliminar fila de la tabla
            document.getElementById(selectedAdRowId).remove();
            selectedAdRowId = null;
        }
        
        /**
         * Muestra el modal de ajustes de CPS.
         */
        function showCpsSettingsModal() {
            const t = translations[currentLanguage];
            const body = `
                <label for="cpsLimitInput" class="block mb-2">${t.cpsLimitLabel}</label>
                <input type="number" id="cpsLimitInput" class="w-full p-2 border rounded" value="${adCpsLimit}">
            `;
            const buttons = [
                { text: t.cancel },
                { text: t.save, handler: () => {
                    const newLimit = parseInt(document.getElementById('cpsLimitInput').value, 10);
                    if (newLimit > 0) {
                        adCpsLimit = newLimit;
                        renderAdTable(); // Re-renderizar para actualizar avisos
                    }
                }}
            ];
            showModal(t.cpsSettingsTitle, t.cpsSettingsMessage, buttons, body);
        }

        // --- Funciones de Regiones de Wavesurfer para AD ---

        /**
         * Limpia todas las regiones de AD del wavesurfer.
         */
       function clearAdRegions() {
            if (wsRegions) {
                wsRegions.clearRegions(); // FIX: La función es clearRegions()
            }
        }
        
        /**
         * Renderiza todas las regiones de AD desde el array `adEntries`.
         */
        function renderAdRegions() {
            if (!wsRegions || !isWavesurferReady) return;
            clearAdRegions();
            adEntries.forEach(addAdRegion);
        }

        /**
         * Añade una región única para una entrada de AD.
         */
        function addAdRegion(entry) {
            if (!wsRegions || !isWavesurferReady) return;
            
            const region = wsRegions.addRegion({
                id: entry.id,
                start: entry.startTimeMs / 1000,
                end: entry.endTimeMs / 1000,
                drag: true,
                resize: true,
                color: 'rgba(255, 72, 83, 0.2)'
            });
            
            // Añadir contenido visual a la región
            updateRegionContent(region, entry);
            
            // Resaltar si está seleccionada
            if (entry.id === selectedAdRowId) {
                region.element.classList.add('selected-region');
            }
        }

        /**
         * Actualiza el contenido visual de una región de wavesurfer.
         */
        function updateRegionContent(region, entry) {
            if (!region || !region.element) return;

            const lineIndex = adEntries.findIndex(e => e.id === entry.id) + 1;
            const textPreview = entry.text.substring(0, 20) + (entry.text.length > 20 ? '...' : '');
            
            // Limpiar contenido anterior
            const oldContent = region.element.querySelector('.ad-region-content');
            if (oldContent) {
                oldContent.remove();
            }
            
            // Crear nuevo contenido
            const content = document.createElement('div');
            content.className = 'ad-region-content';
            content.innerHTML = `<strong>${lineIndex}:</strong> ${textPreview}`;
            
            region.element.appendChild(content);
        }
        
        /**
         * Actualiza una región existente en wavesurfer.
         */
        function updateAdRegion(entry) {
            if (!wsRegions || !isWavesurferReady) return;
            
            const region = wsRegions.getRegions().find(r => r.id === entry.id); // Usar API pública
            if (region) {
                // Usar setOptions para evitar bucles de eventos
                region.setOptions({
                    start: entry.startTimeMs / 1000,
                    end: entry.endTimeMs / 1000
                });
                updateRegionContent(region, entry); // Actualizar texto
            } else {
                addAdRegion(entry); // Si no existe por alguna razón, la crea
            }
        }
        
        // --- Funciones de Exportación de AD ---

        /**
         * Muestra el modal de exportación para AD.
         */
        function showAdExportModal() {
            const t = translations[currentLanguage];
            const body = `
                <div>
                    <label for="filenameInput" class="block mb-2">${t.filenameLabel}</label>
                    <input type="text" id="filenameInput" class="w-full p-2 border rounded mb-4" value="audiodescripcion">
                    <label class="block mb-2">${t.formatLabel}</label>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="srt" class="form-radio" checked><span class="ml-2">${t.exportFormatSrt}</span></label>
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="txt" class="form-radio"><span class="ml-2">${t.exportFormatTxt}</span></label>
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="html" class="form-radio"><span class="ml-2">${t.exportFormatHtml}</span></label>
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="pdf" class="form-radio"><span class="ml-2">${t.exportFormatPdf}</span></label>
                    </div>
                </div>
            `;
            const buttons = [{ text: t.cancel }, { text: t.exportBtnText, handler: () => {
                const filename = document.getElementById('filenameInput').value || 'audiodescripcion';
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                exportAdContent(format, filename);
            }}];
            showModal(t.exportAdModalTitle, '', buttons, body);
        }

        /**
         * Genera y descarga el archivo de AD.
         */
       /**
         * Genera y descarga el archivo de AD.
         */
        function exportAdContent(format, filename) {
            console.log('Exporting AD as:', format, filename);
            let content, mimeType, fileExtension;
            const t = translations[currentLanguage];

            if (format === 'srt' || format === 'txt') {
                content = '';
                adEntries.sort((a, b) => a.startTimeMs - b.startTimeMs).forEach((entry, index) => {
                    const inTime = formatSrtTime(entry.startTimeMs / 1000);
                    const outTime = formatSrtTime(entry.endTimeMs / 1000);
                    content += `${index + 1}\n`;
                    content += `${inTime} --> ${outTime}\n`;
                    content += `${entry.text}\n\n`;
                });
                mimeType = 'text/plain';
                fileExtension = format === 'srt' ? '.srt' : '.txt';
            
            } else if (format === 'html') {
                let tableHtml = `<style>
                    body { font-family: sans-serif; }
                    table { border-collapse: collapse; width: 100%; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    .col-time { width: 100px; } .col-dur { width: 70px; } .col-cps { width: 70px; }
                </style>`;
                tableHtml += `<h1>${filename}</h1><table><thead><tr>
                    <th class="col-time">${t.adColIn}</th>
                    <th class="col-time">${t.adColOut}</th>
                    <th class="col-dur">${t.adColDur}</th>
                    <th class="col-cps">${t.adColCps}</th>
                    <th>${t.adColText}</th>
                    <th>${t.adColNotes}</th>
                </tr></thead><tbody>`;
                
                adEntries.sort((a, b) => a.startTimeMs - b.startTimeMs).forEach(entry => {
                    const inTime = formatSrtTime(entry.startTimeMs / 1000);
                    const outTime = formatSrtTime(entry.endTimeMs / 1000);
                    const durationMs = entry.endTimeMs - entry.startTimeMs;
                    const durationSec = durationMs > 0 ? (durationMs / 1000).toFixed(2) : '0.00';
                    const cps = calculateAdCps(entry.text, durationMs).toFixed(1);
                    tableHtml += `<tr>
                        <td>${inTime}</td>
                        <td>${outTime}</td>
                        <td>${durationSec}s</td>
                        <td>${cps}</td>
                        <td>${entry.text.replace(/\n/g, '<br>')}</td>
                        <td>${entry.notes.replace(/\n/g, '<br>')}</td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${tableHtml}</body></html>`;
                mimeType = 'text/html';
                fileExtension = '.html';
            
            } else if (format === 'pdf') {
                
                // --- INICIO DEL FIX DEFINITIVO ---

                // 1. Comprobar que las dos librerías globales existan
                if (!window.jspdf || !window.jspdfAutoTable) {
                    console.error("Error fatal: jspdf (main) o jspdfAutoTable (plugin) no están cargados.");
                    alert("Error: Las librerías PDF no se cargaron correctamente. Intenta recargar la página (Ctrl+Shift+R).");
                    return;
                }

                // 2. Aplicar manualmente el plugin (jspdfAutoTable) al constructor (jsPDF)
                // Esta es la "magia" que faltaba.
                try {
                    window.jspdfAutoTable(window.jspdf.jsPDF);
                } catch (e) {
                    console.error("Error al aplicar el plugin autoTable:", e);
                    alert("Error al inicializar el plugin de PDF.");
                    return;
                }

                // 3. Comprobar que la función está ahora en el prototipo
                if (!window.jspdf.jsPDF.prototype.autoTable) {
                    console.error("El plugin se aplicó, pero la función autoTable sigue sin estar disponible.");
                    alert("Error: El plugin de PDF falló al inicializarse.");
                    return;
                }

                // 4. Si llegamos aquí, es seguro continuar.
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const head = [[t.adColIn, t.adColOut, t.adColDur, t.adColCps, t.adColText, t.adColNotes]];
                const body = adEntries.sort((a, b) => a.startTimeMs - b.startTimeMs).map(entry => {
                    const inTime = formatSrtTime(entry.startTimeMs / 1000);
                    const outTime = formatSrtTime(entry.endTimeMs / 1000);
                    const durationMs = entry.endTimeMs - entry.startTimeMs;
                    const durationSec = durationMs > 0 ? (durationMs / 1000).toFixed(2) : '0.00';
                    const cps = calculateAdCps(entry.text, durationMs).toFixed(1);
                    return [inTime, outTime, `${durationSec}s`, cps, entry.text, entry.notes];
                });

                doc.autoTable({
                    head: head,
                    body: body,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] },
                });
                
                doc.save(`${filename}.pdf`);
                return;
                
                // --- FIN DEL FIX DEFINITIVO ---
            }

            // Este código es para srt, txt y html
            if (content) {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${filename}${fileExtension}`;
                link.click();
                URL.revokeObjectURL(link.href);
            }
        }
        
        // --- Funciones de Deshacer/Rehacer ---
        let tempHistoryState = null; // Para guardar el estado 'old' en focus

        function saveHistoryState(id, field, oldValue) {
            if (isUndoingOrRedoing) return;
            tempHistoryState = { id, field, old: oldValue };
        }

        function pushHistoryState(id, field, newValue) {
            if (isUndoingOrRedoing) return;
            if (!tempHistoryState || tempHistoryState.id !== id || tempHistoryState.field !== field) {
                return; // No hay un estado 'old' guardado
            }
            
            // Comparar 'old' y 'new'
            if (JSON.stringify(tempHistoryState.old) === JSON.stringify(newValue)) {
                tempHistoryState = null; // No hay cambios
                return;
            }

            saveHistory({
                type: field, // 'text', 'notes', 'time'
                id: id,
                old: tempHistoryState.old,
                new: newValue
            });
            tempHistoryState = null;
        }

        function saveHistory(action) {
            if (isUndoingOrRedoing) return;
            historyStack.push(action);
            redoStack = []; // Limpiar rehacer
            updateUndoRedoButtons();
        }
        
        function clearHistory() {
            historyStack = [];
            redoStack = [];
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            undoBtn.disabled = historyStack.length === 0;
            redoBtn.disabled = redoStack.length === 0;
        }

        function undo() {
            if (historyStack.length === 0) return;
            isUndoingOrRedoing = true;
            
            const action = historyStack.pop();
            redoStack.push(action);
            
            applyHistoryAction(action, 'old'); // Aplicar el estado 'old'
            
            isUndoingOrRedoing = false;
            updateUndoRedoButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;
            isUndoingOrRedoing = true;

            const action = redoStack.pop();
            historyStack.push(action);
            
            applyHistoryAction(action, 'new'); // Aplicar el estado 'new'
            
            isUndoingOrRedoing = false;
            updateUndoRedoButtons();
        }
        
        function applyHistoryAction(action, stateToApply) { // stateToApply es 'old' o 'new'
            
            let currentSelectedId = selectedAdRowId;
            
            switch (action.type) {
                case 'text':
                case 'notes':
                    if (stateToApply === 'old') {
                        const entry = adEntries.find(e => e.id === action.id);
                        if (entry) {
                            entry[action.type] = action.old;
                            updateAdTableRow(entry);
                            updateAdRegion(entry);
                        }
                    } else {
                        const entry = adEntries.find(e => e.id === action.id);
                        if (entry) {
                            entry[action.type] = action.new;
                            updateAdTableRow(entry);
                            updateAdRegion(entry);
                        }
                    }
                    currentSelectedId = action.id;
                    break;
                case 'time':
                     if (stateToApply === 'old') {
                        const entry = adEntries.find(e => e.id === action.id);
                        if (entry) {
                            entry.startTimeMs = action.old.startTimeMs;
                            entry.endTimeMs = action.old.endTimeMs;
                            updateAdTableRow(entry);
                            updateAdRegion(entry);
                        }
                    } else {
                        const entry = adEntries.find(e => e.id === action.id);
                        if (entry) {
                            entry.startTimeMs = action.new.startTimeMs;
                            entry.endTimeMs = action.new.endTimeMs;
                            updateAdTableRow(entry);
                            updateAdRegion(entry);
                        }
                    }
                    currentSelectedId = action.id;
                    break;
                case 'add':
                    if (stateToApply === 'old') { // Deshacer 'add' es 'delete'
                        const index = adEntries.findIndex(e => e.id === action.entry.id);
                        if (index > -1) adEntries.splice(index, 1);
                        document.getElementById(action.entry.id)?.remove();
                        wsRegions.getRegions().find(r => r.id === action.entry.id)?.remove();
                        currentSelectedId = null;
                    } else { // Rehacer 'add' es 'add'
                        adEntries.push(action.entry);
                        adTableBody.appendChild(createAdTableRow(action.entry));
                        addAdRegion(action.entry);
                        currentSelectedId = action.entry.id;
                    }
                    break;
                case 'delete':
                    if (stateToApply === 'old') { // Deshacer 'delete' es 'add'
                        adEntries.splice(action.index, 0, action.entry);
                        currentSelectedId = action.entry.id;
                        // No simple way to re-insert at index, so re-render
                        renderAdTable();
                        renderAdRegions();
                    } else { // Rehacer 'delete' es 'delete'
                        const index = adEntries.findIndex(e => e.id === action.entry.id);
                        if (index > -1) adEntries.splice(index, 1);
                        document.getElementById(action.entry.id)?.remove();
                        wsRegions.getRegions().find(r => r.id === action.entry.id)?.remove();
                        currentSelectedId = null;
                    }
                    break;
            }
            
            // Reselect row and region
            selectedAdRowId = currentSelectedId;
            if (selectedAdRowId) {
                document.querySelectorAll('#ad-table-body tr').forEach(row => row.classList.remove('selected-row'));
                document.getElementById(selectedAdRowId)?.classList.add('selected-row');
                
                if (wsRegions) {
                    wsRegions.getRegions().forEach(r => r.element.classList.remove('selected-region'));
                    wsRegions.getRegions().find(r => r.id === selectedAdRowId)?.element.classList.add('selected-region');
                }
            }
        }

        // --- Modificaciones a funciones existentes ---

        function togglePlaybackControls(disabled) {
            const controls = [playPauseBtn, rewind5sBtn, rewind1sBtn, rewind1fBtn, forward1fBtn, forward1sBtn, forward5sBtn, speedDownBtn, speedUpBtn, muteBtn, volumeSlider];
            controls.forEach(btn => btn.disabled = disabled);
            // Deshabilitar botones AD también
            addAdLineBtn.disabled = disabled;
            setAdInBtn.disabled = disabled;
            setAdOutBtn.disabled = disabled;
            deleteAdLineBtn.disabled = disabled;
        }

        function seekMedia(seconds) {
            if (video.src) {
                video.currentTime = Math.max(0, video.currentTime + seconds);
            }
        }

        function executeShortcut(action) {
            const actions = {
                'playPause': () => {
                    if (video.paused) {
                        video.play().catch(e => console.error("Error al reproducir:", e));
                    } else {
                        video.pause();
                    }
                },
                'rewind5s': () => seekMedia(-5), 'rewind1s': () => seekMedia(-1),
                'rewind1frame': () => seekMedia(-1 / DEFAULT_FRAMERATE), 'forward1frame': () => seekMedia(1 / DEFAULT_FRAMERATE),
                'forward1s': () => seekMedia(1), 'forward5s': () => seekMedia(5),
                'speedUp': () => { video.playbackRate = Math.min(4, video.playbackRate + 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; },
                'speedDown': () => { video.playbackRate = Math.max(0.5, video.playbackRate - 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; },
                'insertTimecode': insertTimecode,
                'bold': () => document.execCommand('bold'),
                'italic': () => document.execCommand('italic'),
                'find': () => showFindReplaceBar(false),
                'replace': () => showFindReplaceBar(true),
                'undo': undo, // Añadido
                'redo': redo  // Añadido
            };
            if (action.startsWith('insertRecurringText')) {
                const index = parseInt(action.replace('insertRecurringText', ''));
                const inputs = recurringTextContainer.querySelectorAll('input');
                if (inputs[index - 1] && inputs[index - 1].value) {
                    document.execCommand('insertText', false, inputs[index - 1].value + ' ');
                }
            } else if (actions[action]) {
                actions[action]();
            }
        }

        function updateTCRDisplay() {
            if (video.src) {
                tcrDisplay.textContent = tcrFormats[currentTCRFormatIndex].format(video.currentTime + tcrOffsetSeconds, DEFAULT_FRAMERATE);
            }
        }
        
        function addRecurringTextField(value = '') {
            const container = document.createElement('div');
            container.className = 'flex items-center gap-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.value = value;
            input.className = 'flex-1 min-w-[120px] p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-red-500 border'; // Se aplicará borde por tema
            const addBtn = document.createElement('button');
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.className = 'recurring-btn font-bold p-1 px-2 rounded-lg shadow-md transition duration-200 ease-in-out text-sm';
            addBtn.onclick = () => {
                if(input.value) {
                    if (isEditorPristine) {
                        editor.innerHTML = '<div><br></div>';
                        isEditorPristine = false;
                    }
                    document.execCommand('insertText', false, input.value + ' ');
                }
            };
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
            removeBtn.className = 'recurring-btn font-bold p-1 px-2 rounded-lg shadow-md transition duration-200 ease-in-out text-sm';
            removeBtn.onclick = () => container.remove();
            
            container.appendChild(input);
            container.appendChild(addBtn);
            container.appendChild(removeBtn);
            recurringTextContainer.appendChild(container);
            
            const theme = themeClasses[isDarkMode ? 'dark' : 'light'];
            [addBtn, removeBtn].forEach(btn => btn.classList.add(...theme.btnNeutral.split(' ').filter(c => !c.startsWith('hover:'))));
            input.classList.add(theme.adTableInputBg, theme.adTableInputBorder, theme.editorText);
            updateTooltips();
        }

        function showModal(title, message, buttons, bodyContent = '', onClose = null) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalBody').innerHTML = bodyContent;
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';
            
            const theme = themeClasses[isDarkMode ? 'dark' : 'light'];
            
            buttons.forEach(buttonConfig => {
                const button = document.createElement('button');
                button.textContent = buttonConfig.text;
                button.className = `font-bold py-1.5 px-2.5 rounded-lg shadow-md transition ${theme.btnNeutral}`;
                button.onclick = () => {
                    if (buttonConfig.handler) buttonConfig.handler();
                    if (!buttonConfig.preventClose) modal.classList.remove('show');
                };
                modalButtons.appendChild(button);
            });
            const closeBtn = modal.querySelector('.modal-close-btn');
            closeBtn.onclick = onClose ? onClose : () => modal.classList.remove('show');
            
            // Aplicar tema al modal
            modal.querySelector('.modal-content').className = `modal-content ${theme.modalContentBg} ${theme.modalContentText}`;
            modal.querySelectorAll('#modalBody input, #modalBody select').forEach(el => {
                el.classList.add(theme.adTableInputBg, theme.adTableInputBorder, theme.editorText);
            });

            modal.classList.add('show');
        }

        function insertTimecode() {
            if (!video.src) return;
            const timecode = tcrDisplay.textContent;
            const seconds = video.currentTime + tcrOffsetSeconds;
            const html = `<span class="timestamp" data-seconds="${seconds}" contenteditable="false">[${timecode}]</span>&nbsp;`;
            document.execCommand('insertHTML', false, html);
        }

        function parseTimeCodeToSeconds(timeCodeString) {
            let match = timeCodeString.match(/(\d{2}):(\d{2}):(\d{2})[,:](\d{2,3})/);
            if(match) return parseInt(match[1])*3600 + parseInt(match[2])*60 + parseInt(match[3]) + parseInt(match[4])/(match[4].length === 3 ? 1000 : DEFAULT_FRAMERATE);
            match = timeCodeString.match(/(\d{2}):(\d{2})[,:](\d{2,3})/);
            if(match) return parseInt(match[1])*60 + parseInt(match[2]) + parseInt(match[3])/(match[3].length === 3 ? 1000 : DEFAULT_FRAMERATE);
            match = timeCodeString.match(/(\d{2}):(\d{2})/);
            if(match) return parseInt(match[1])*60 + parseInt(match[2]);
            return null;
        }
        function showSetInitialTCRModal() {
            const body = `<input type="text" id="initialTCRInput" class="w-full p-2 border rounded" placeholder="HH:MM:SS,MMM or HH:MM:SS:FF">`;
            const buttons = [{ text: 'Cancel' }, { text: 'Set', handler: () => {
                const inputVal = document.getElementById('initialTCRInput').value;
                const desiredSeconds = parseTimeCodeToSeconds(inputVal);
                if (desiredSeconds !== null) {
                    tcrOffsetSeconds = desiredSeconds - video.currentTime;
                    updateTCRDisplay();
                } else {
                    alert('Invalid timecode format');
                }
            }}];
            showModal('Set Initial Timecode', '', buttons, body);
        }
        function showTCRFormatModal() {
            let optionsHtml = '<div class="space-y-2">';
            tcrFormats.forEach((format, index) => {
                optionsHtml += `<label class="flex items-center cursor-pointer"><input type="radio" name="tcrFormat" value="${index}" class="form-radio" ${index === currentTCRFormatIndex ? 'checked' : ''}><span class="ml-2">${format.name}</span></label>`;
            });
            optionsHtml += '</div>';
            const buttons = [{ text: 'Cancel' }, { text: 'Save', handler: () => {
                const selected = document.querySelector('input[name="tcrFormat"]:checked');
                if (selected) {
                    currentTCRFormatIndex = parseInt(selected.value);
                    updateTCRDisplay();
                    updateAllTimestampsInEditor();
                }
            }}];
            showModal('Select Timecode Format', '', buttons, optionsHtml);
        }
        
        function updateAllTimestampsInEditor() {
            editor.querySelectorAll('.timestamp').forEach(span => {
                const seconds = parseFloat(span.dataset.seconds);
                if (!isNaN(seconds)) {
                    span.textContent = `[${tcrFormats[currentTCRFormatIndex].format(seconds, DEFAULT_FRAMERATE)}]`;
                }
            });
        }

        /**
         * Modal de exportación original (renombrado).
         */
        function showTranscriptionExportModal() {
            const t = translations[currentLanguage];
            const body = `
                <div>
                    <label for="filenameInput" class="block mb-2">${t.filenameLabel}</label>
                    <input type="text" id="filenameInput" class="w-full p-2 border rounded mb-4" value="transcription">
                    <label class="block mb-2">${t.formatLabel}</label>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="txt" class="form-radio" checked><span class="ml-2">.txt (Plain Text)</span></label>
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="html" class="form-radio"><span class="ml-2">.html (Formatted)</span></label>
                        <label class="flex items-center"><input type="radio" name="exportFormat" value="pdf" class="form-radio"><span class="ml-2">.pdf (Document)</span></label>
                    </div>
                </div>
            `;
            const buttons = [{ text: t.cancel }, { text: t.exportBtnText, handler: () => {
                const filename = document.getElementById('filenameInput').value || 'transcription';
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                exportContent(format, filename);
            }}];
            showModal(t.exportModalTitle, '', buttons, body);
        }

        /**
         * Función de exportación original (sin cambios).
         */
        function exportContent(format, filename) {
            let content, mimeType, fileExtension;
            if (format === 'txt') {
                content = editor.innerText;
                mimeType = 'text/plain';
                fileExtension = '.txt';
            } else if (format === 'html') {
                content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${editor.innerHTML}</body></html>`;
                mimeType = 'text/html';
                fileExtension = '.html';
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont('Arial', 'normal'); // Asegurarse que la fuente soporta los caracteres
                doc.setFontSize(11);
                // Usar 'splitTextToSize' y 'text' para mejor compatibilidad
                const lines = doc.splitTextToSize(editor.innerText, 180); // 180mm de ancho
                doc.text(lines, 10, 10);
                doc.save(`${filename}.pdf`);
                return;
            }

            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}${fileExtension}`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function saveBackup() {
            if (!isEditorPristine) {
                localStorage.setItem('pandascript_backup', editor.innerHTML);
            }
            // Guardar también AD
            if(adEntries.length > 0) {
                 localStorage.setItem('pandascript_ad_backup', JSON.stringify({
                     entries: adEntries,
                     cpsLimit: adCpsLimit
                 }));
            }
        }

        function loadBackup() {
            const backup = localStorage.getItem('pandascript_backup');
            const adBackupRaw = localStorage.getItem('pandascript_ad_backup');
            
            if (backup || adBackupRaw) {
                const buttons = [
                    { text: translations[currentLanguage].discard, handler: () => {
                        localStorage.removeItem('pandascript_backup');
                        localStorage.removeItem('pandascript_ad_backup');
                    }},
                    { text: translations[currentLanguage].restore, handler: () => {
                        if (backup) {
                            editor.innerHTML = backup;
                            isEditorPristine = false;
                            localStorage.removeItem('pandascript_backup');
                        }
                        if (adBackupRaw) {
                            const adBackup = JSON.parse(adBackupRaw);
                            adEntries = adBackup.entries || [];
                            adCpsLimit = adBackup.cpsLimit || 15;
                            localStorage.removeItem('pandascript_ad_backup');
                        }
                    }}
                ];
                showModal(translations[currentLanguage].backupFoundTitle, translations[currentLanguage].backupFoundMessage, buttons, '');
            }
        }
        
        function showBackupModal() {
            const backup = localStorage.getItem('pandascript_backup');
            const adBackupRaw = localStorage.getItem('pandascript_ad_backup');
            let body = '';

            if (backup) {
                body += `<h4 class="font-bold mt-2">Transcripción:</h4><div class="p-2 border rounded max-h-32 overflow-y-auto">${backup}</div>`;
            }
            if (adBackupRaw) {
                 const adBackup = JSON.parse(adBackupRaw);
                 body += `<h4 class="font-bold mt-2">Audiodescripción:</h4><div class="p-2 border rounded max-h-32 overflow-y-auto">${(adBackup.entries || []).length} entradas</div>`;
            }

            if (body) {
                const buttons = [
                    { text: 'Close' },
                    { text: translations[currentLanguage].restore, handler: () => {
                        if (backup) {
                            editor.innerHTML = backup;
                            isEditorPristine = false;
                        }
                        if(adBackupRaw) {
                            const adBackup = JSON.parse(adBackupRaw);
                            adEntries = adBackup.entries || [];
                            adCpsLimit = adBackup.cpsLimit || 15;
                            if(isAdMode) renderAdTable(); // Actualizar si ya estamos en modo AD
                        }
                    }}
                ];
                showModal(translations[currentLanguage].backup, '', buttons, body);
            } else {
                showModal(translations[currentLanguage].backup, translations[currentLanguage].noBackup, [{ text: 'OK' }]);
            }
        }

        function showLanguageModal() {
            let optionsHtml = '<div class="space-y-2">';
            for (const [code, name] of Object.entries(availableLanguages)) {
                optionsHtml += `<label class="flex items-center cursor-pointer">
                    <input type="radio" name="language" value="${code}" class="form-radio" ${code === currentLanguage ? 'checked' : ''}>
                    <span class="ml-2">${name}</span>
                </label>`;
            }
            optionsHtml += '</div>';

            const buttons = [
                { text: translations[currentLanguage].cancel },
                { text: translations[currentLanguage].save, handler: () => {
                    const selectedLang = document.querySelector('input[name="language"]:checked').value;
                    if (selectedLang) {
                        localStorage.setItem('pandascript_language', selectedLang);
                        applyLanguage(selectedLang);
                    }
                }}
            ];
            showModal(translations[currentLanguage].languageModalTitle, '', buttons, optionsHtml);
        }


        function resetApplication() {
            video.src = '';
            currentMediaFile = null;
            if(wavesurfer) wavesurfer.empty();
            if(wsRegions) wsRegions.clearRegions(); // Limpiar regiones
            waveformContainer.classList.add('hidden');
            emptyPlayerOverlay.classList.remove('hidden');
            video.style.visibility = 'hidden';
            editor.innerHTML = `<p data-i18n="editorPlaceholder">${translations[currentLanguage].editorPlaceholder}</p>`;
            isEditorPristine = true;
            tcrOffsetSeconds = 0;
            updateTCRDisplay();
            togglePlaybackControls(true);
            
            // Reset AD
            adEntries = [];
            selectedAdRowId = null;
            adCpsLimit = 15;
            if (isAdMode) {
                renderAdTable();
            }
            
            localStorage.removeItem('pandascript_backup');
            localStorage.removeItem('pandascript_ad_backup');
            clearHistory();
        }

        function showNewTranscriptionConfirm() {
            const t = translations[currentLanguage];
            const buttons = [
                { text: t.cancel },
                { text: 'OK', handler: resetApplication }
            ];
            showModal(t.newTranscription, t.newTranscriptionConfirm, buttons, '');
        }
        
        // --- Lógica de Atajos de Teclado ---
        const defaultShortcuts = {
            'playPause': 'Alt+P', 'rewind5s': 'Shift+ArrowLeft', 'forward5s': 'Shift+ArrowRight', 'rewind1s': 'Control+ArrowLeft', 'forward1s': 'Control+ArrowRight', 'rewind1frame': 'Alt+ArrowLeft', 'forward1frame': 'Alt+ArrowRight', 'speedUp': 'Alt+ArrowUp', 'speedDown': 'Alt+ArrowDown', 'insertTimecode': 'Alt+Q',
            'bold': 'Control+B', 'italic': 'Control+I', 'find': 'Control+F', 'replace': 'Control+H',
            // Nuevos atajos AD (no necesitan estar en el modal, pero sí en el listener)
            'adAddLine': 'Alt+W', 'adSetIn': 'Alt+E', 'adSetOut': 'Alt+R', 'adDeleteLine': 'Alt+D',
            'undo': 'Alt+Z', 'redo': 'Alt+Y'
        };

        function loadShortcuts() {
            const saved = JSON.parse(localStorage.getItem('pandascript_shortcuts'));
            shortcuts = { ...defaultShortcuts, ...saved };
            for(let i = 1; i <= 9; i++) {
                if (!shortcuts[`insertRecurringText${i}`]) {
                    shortcuts[`insertRecurringText${i}`] = `Alt+${i}`;
                }
            }
            updateTooltips();
        }
        function saveShortcutsToStorage() {
            localStorage.setItem('pandascript_shortcuts', JSON.stringify(shortcuts));
            updateTooltips();
        }
        function updateTooltips() {
            const t = translations[currentLanguage];
            boldBtn.title = `${t.shortcutLabel_bold} (${shortcuts.bold || ''})`;
            italicBtn.title = `${t.shortcutLabel_italic} (${shortcuts.italic || ''})`;
            uppercaseBtn.title = t.shortcutLabel_uppercase;
            lowercaseBtn.title = t.shortcutLabel_lowercase;
            document.querySelectorAll('.recurring-btn[title]').forEach((btn, i) => {
                btn.title = `${t.tooltip_add_recurring} (${shortcuts[`insertRecurringText${i+1}`] || ''})`;
            });
            undoBtn.title = t.undo;
            redoBtn.title = t.redo;
        }
        function keyEventToString(e) {
            let parts = [];
            if (e.ctrlKey) parts.push('Control');
            if (e.altKey) parts.push('Alt');
            if (e.shiftKey) parts.push('Shift');
            if (e.metaKey) parts.push('Meta');
            if (!['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) {
                parts.push(e.key.length === 1 ? e.key.toUpperCase() : e.key);
            }
            return parts.join('+');
        }
        
        function showShortcutsModal() { 
            tempShortcuts = JSON.parse(JSON.stringify(shortcuts));
            
            const renderShortcuts = () => {
                let bodyHtml = '<div class="space-y-2">';
                const actions = [ // Omitir atajos AD de aquí
                    'playPause', 'rewind5s', 'forward5s', 'rewind1s', 'forward1s', 'rewind1frame', 'forward1frame', 'speedUp', 'speedDown', 'insertTimecode', 'bold', 'italic', 'find', 'replace', 'undo', 'redo'
                ];
                actions.forEach(action => {
                    let label = translations[currentLanguage][`shortcutLabel_${action}`] || action;
                    bodyHtml += `<div class="flex justify-between items-center"><span>${label}</span><button class="shortcut-button font-mono p-1 px-2 border-2 rounded" data-action="${action}">${tempShortcuts[action] || 'Not set'}</button></div>`;
                });
                for (let i = 1; i <= recurringTextContainer.children.length; i++) {
                    const action = `insertRecurringText${i}`;
                    let label = `${translations[currentLanguage]['shortcutLabel_insertRecurringText']} ${i}`;
                    bodyHtml += `<div class="flex justify-between items-center"><span>${label}</span><button class="shortcut-button font-mono p-1 px-2 border-2 rounded" data-action="${action}">${tempShortcuts[action] || 'Not set'}</button></div>`;
                }
                bodyHtml += '</div>';
                return bodyHtml;
            }
            const buttons = [
                { text: translations[currentLanguage].importShortcuts, handler: () => shortcutImportInput.click(), preventClose: true },
                { text: translations[currentLanguage].exportShortcuts, handler: () => {
                    const blob = new Blob([JSON.stringify(shortcuts, null, 2)], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'pandascript_shortcuts.json';
                    link.click();
                }, preventClose: true },
                { text: translations[currentLanguage].resetShortcuts, handler: () => {
                    tempShortcuts = { ...defaultShortcuts };
                    document.getElementById('modalBody').innerHTML = renderShortcuts();
                    addShortcutButtonListeners();
                }, preventClose: true },
                { text: translations[currentLanguage].saveShortcuts, handler: () => {
                    shortcuts = { ...tempShortcuts };
                    saveShortcutsToStorage();
                }}
            ];

            showModal(translations[currentLanguage].shortcutsModalTitle, translations[currentLanguage].shortcutsModalMessage, buttons, renderShortcuts(), confirmCloseShortcutsModal);
            addShortcutButtonListeners();
        }
        function addShortcutButtonListeners() { /* ... (sin cambios) ... */ }
        function confirmCloseShortcutsModal() { /* ... (sin cambios) ... */ }
        
        // --- Lógica de Búsqueda y Reemplazo ---
        function showFindReplaceBar(showReplace) {
            findReplaceBar.style.display = 'flex'; // Usar flex
            if (showReplace) {
                replaceControls.classList.remove('hidden');
                replaceControls.classList.add('flex');
                toggleReplaceBtn.classList.add('rotate-90');
            } else {
                replaceControls.classList.add('hidden');
                replaceControls.classList.remove('flex');
                toggleReplaceBtn.classList.remove('rotate-90');
            }
            findInput.focus();
            findInput.select();
            updateFindResults();
        }

        function hideFindReplaceBar() {
            findReplaceBar.style.display = 'none';
            if (isAdMode) {
                clearAdTableHighlights();
            } else {
                window.getSelection()?.removeAllRanges(); // Clear selection
                editor.focus();
            }
        }

        function findInEditor(backwards = false) { /* ... (sin cambios) ... */ }
        
        function updateFindResults() {
            if (isAdMode) {
                updateAdFindResults();
            } else {
                updateEditorFindResults();
            }
        }

        function updateEditorFindResults() {
            const query = findInput.value;
            if (!query) {
                findResultsCount.textContent = '0/0';
                return;
            }
            // ... (lógica original)
        }
        
        function replaceCurrent() {
            if (isAdMode) {
                replaceCurrentInAdTable();
            } else {
                replaceCurrentInEditor();
            }
        }
        
        function replaceCurrentInEditor() { /* ... (lógica original) ... */ }

        function replaceAll() {
             if (isAdMode) {
                replaceAllInAdTable();
            } else {
                replaceAllInEditor();
            }
        }

        function replaceAllInEditor() { /* ... (lógica original) ... */ }
        
        // --- Nuevas funciones de Find/Replace para AD ---
        let adFindState = { query: '', results: [], currentIndex: -1 };

        function updateAdFindResults() {
            const query = findInput.value;
            clearAdTableHighlights();
            if (!query) {
                adFindState = { query: '', results: [], currentIndex: -1 };
                findResultsCount.textContent = '0/0';
                return;
            }
            
            adFindState.query = query;
            adFindState.results = [];
            adFindState.currentIndex = -1;
            
            const flags = matchCaseCheckbox.checked ? 'g' : 'gi';
            const regex = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), flags);
            
            adEntries.forEach((entry, index) => {
                const textMatches = [...entry.text.matchAll(regex)];
                const notesMatches = [...entry.notes.matchAll(regex)];
                
                textMatches.forEach(match => adFindState.results.push({ entryId: entry.id, field: 'text', match }));
                notesMatches.forEach(match => adFindState.results.push({ entryId: entry.id, field: 'notes', match }));
            });
            
            findResultsCount.textContent = `0/${adFindState.results.length}`;
            if (adFindState.results.length > 0) {
                findInAdTable(false); // Ir al primero
            }
        }

        function findInAdTable(backwards = false) {
            if (adFindState.results.length === 0) return;
            
            if (backwards) {
                adFindState.currentIndex--;
                if (adFindState.currentIndex < 0) {
                    adFindState.currentIndex = adFindState.results.length - 1;
                }
            } else {
                adFindState.currentIndex++;
                if (adFindState.currentIndex >= adFindState.results.length) {
                    adFindState.currentIndex = 0;
                }
            }
            
            highlightAdFindResult(true);
        }
        
        function highlightAdFindResult(scrollTo) {
            clearAdTableHighlights();
            if (adFindState.currentIndex === -1) return;
            
            const result = adFindState.results[adFindState.currentIndex];
            const tr = document.getElementById(result.entryId);
            if (!tr) return;
            
            const textarea = tr.querySelector(`textarea[data-field="${result.field}"]`);
            if (!textarea) return;
            
            const originalText = textarea.value;
            const match = result.match;
            
            textarea.innerHTML = originalText.substring(0, match.index) +
                                 `<span class="highlight-find">${match[0]}</span>` +
                                 originalText.substring(match.index + match[0].length);
            
            if (scrollTo) {
                tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
                textarea.focus();
                textarea.setSelectionRange(match.index, match.index + match[0].length);
            }
            
            findResultsCount.textContent = `${adFindState.currentIndex + 1}/${adFindState.results.length}`;
        }
        
        function clearAdTableHighlights() {
             document.querySelectorAll('#ad-table textarea').forEach(ta => {
                if (ta.value !== ta.innerHTML) { // Solo revertir si tiene highligh
                    ta.innerHTML = ta.value;
                }
            });
        }
        
        function replaceCurrentInAdTable() {
            if (adFindState.currentIndex === -1 || adFindState.results.length === 0) return;
            
            const result = adFindState.results[adFindState.currentIndex];
            const entry = adEntries.find(e => e.id === result.entryId);
            if (!entry) return;
            
            const field = result.field;
            const originalText = entry[field];
            const replaceWith = replaceInput.value;
            const match = result.match;
            
            const oldText = entry[field]; // Para historial
            
            entry[field] = originalText.substring(0, match.index) +
                           replaceWith +
                           originalText.substring(match.index + match[0].length);
            
            // Guardar historial
            saveHistory({
                type: field, // 'text' o 'notes'
                id: entry.id,
                old: oldText,
                new: entry[field]
            });

            updateAdTableRow(entry);
            updateAdFindResults(); // Recalcular todo
        }
        
        function replaceAllInAdTable() {
            const query = findInput.value;
            const replaceWith = replaceInput.value;
            if (!query) return;
            
            const flags = matchCaseCheckbox.checked ? 'g' : 'gi';
            const regex = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), flags);
            let replacedCount = 0;
            
            adEntries.forEach(entry => {
                const oldText = entry.text;
                const oldNotes = entry.notes;

                const newText = entry.text.replace(regex, replaceWith);
                const newNotes = entry.notes.replace(regex, replaceWith);
                
                if (oldText !== newText) {
                    replacedCount += (entry.text.match(regex) || []).length;
                    saveHistory({ type: 'text', id: entry.id, old: oldText, new: newText });
                    entry.text = newText;
                }
                if (oldNotes !== newNotes) {
                    replacedCount += (entry.notes.match(regex) || []).length;
                    saveHistory({ type: 'notes', id: entry.id, old: oldNotes, new: newNotes });
                    entry.notes = newNotes;
                }
            });
            
            renderAdTable();
            updateAdFindResults();
            alert(`${replacedCount} replacements made.`);
        }

        
        // --- Lógica de Proyecto ---
        function showSaveProjectModal() {
             if (!currentMediaFile) {
                alert("No media file is loaded to save in the project.");
                return;
            }
            const defaultName = (currentMediaFile.name.split('.')[0] || 'project');
            const body = `<div>
                <label for="projectNameInput" class="block mb-2">${translations[currentLanguage].filenameLabel}</label>
                <input type="text" id="projectNameInput" class="w-full p-2 border rounded" value="${defaultName}">
            </div>`;
            const buttons = [
                { text: translations[currentLanguage].cancel },
                { text: translations[currentLanguage].save, handler: () => {
                    const projectName = document.getElementById('projectNameInput').value || defaultName;
                    saveProject(projectName);
                }}
            ];
            showModal(translations[currentLanguage].saveProject, '', buttons, body);
        }
        
        async function showOpenProjectModal() {
            const recentProjects = await getRecentProjects(3);
            let recentProjectsHtml = '';
            if (recentProjects.length > 0) {
                recentProjectsHtml = recentProjects.map(p => `
                    <button data-project-id="${p.id}" class="recent-project-btn w-full text-left p-2 border-b hover:bg-gray-100 dark:hover:bg-gray-700">
                        <div class="font-bold">${p.name}</div>
                        <div class="text-xs text-gray-500">${new Date(p.lastModified).toLocaleString()}</div>
                    </button>
                `).join('');
            } else {
                recentProjectsHtml = `<p class="text-sm text-gray-500">${translations[currentLanguage].noRecentProjects}</p>`;
            }

            const body = `
                <h4 class="text-lg font-semibold mb-2">${translations[currentLanguage].recentProjects}</h4>
                <div class="mb-4">${recentProjectsHtml}</div>
                <button id="open-from-file-btn" class="w-full font-bold py-2 px-4 rounded-lg shadow-md">${translations[currentLanguage].openFromFile}</button>
            `;

            showModal(translations[currentLanguage].openProjectTitle, '', [], body);
            
            document.getElementById('open-from-file-btn').addEventListener('click', () => {
                document.getElementById('customModal').classList.remove('show');
                projectFileInput.click();
            });

            document.querySelectorAll('.recent-project-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const projectId = parseInt(e.currentTarget.dataset.projectId);
                    const projectData = await getProjectFromDB(projectId);
                    if (projectData) {
                        await restoreProjectState(projectData);
                        document.getElementById('customModal').classList.remove('show');
                    }
                });
            });
        }

        function saveProject(projectName) {
            const recurringTexts = Array.from(recurringTextContainer.querySelectorAll('input')).map(input => input.value);
            const projectData = {
                name: projectName,
                mediaBlob: currentMediaFile,
                lastModified: Date.now(),
                editorContent: editor.innerHTML,
                videoState: {
                    currentTime: video.currentTime,
                    playbackRate: video.playbackRate,
                    volume: video.volume,
                    muted: video.muted
                },
                appState: {
                    tcrOffsetSeconds: tcrOffsetSeconds,
                    recurringTexts: recurringTexts,
                    theme: isDarkMode ? 'dark' : 'light',
                    language: currentLanguage,
                    tcrFormatIndex: currentTCRFormatIndex
                },
                // Guardar datos de AD
                adData: {
                    entries: adEntries,
                    cpsLimit: adCpsLimit
                }
            };

            // Save to IndexedDB for recent projects list
            saveProjectToDB(projectData).catch(err => console.error("Could not save project to DB", err));
            
            // Also save as a .pscript file
            const dataToExport = { ...projectData };
            const reader = new FileReader();
            reader.onload = (e) => {
                dataToExport.mediaFile = {
                    name: currentMediaFile.name,
                    type: currentMediaFile.type,
                    data: e.target.result
                };
                delete dataToExport.mediaBlob; // Don't include blob in JSON file

                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${projectName}.pscript`;
                link.click();
                URL.revokeObjectURL(link.href);
            };
            reader.readAsDataURL(currentMediaFile);
        }

        async function restoreProjectState(data) {
            resetApplication();

            editor.innerHTML = data.editorContent;
            isEditorPristine = false;
            tcrOffsetSeconds = data.appState.tcrOffsetSeconds || 0;
            currentTCRFormatIndex = data.appState.tcrFormatIndex || 0;
            
            recurringTextContainer.innerHTML = '';
            (data.appState.recurringTexts || []).forEach(text => addRecurringTextField(text));

            applyLanguage(data.appState.language || 'en');
            applyTheme(data.appState.theme || 'light');
            
            // Restaurar datos de AD
            if (data.adData) {
                adEntries = data.adData.entries || [];
                adCpsLimit = data.adData.cpsLimit || 15;
            }
            
            let mediaBlob;
            if (data.mediaBlob) { // From IndexedDB
                mediaBlob = data.mediaBlob;
                currentMediaFile = new File([mediaBlob], data.name, { type: mediaBlob.type });
            } else { // From .pscript file
                const res = await fetch(data.mediaFile.data);
                mediaBlob = await res.blob();
                currentMediaFile = new File([mediaBlob], data.mediaFile.name, { type: data.mediaFile.type });
                
                // Also save this opened project to IndexedDB
                const dbData = { ...data, mediaBlob: mediaBlob, lastModified: Date.now() };
                delete dbData.mediaFile;
                saveProjectToDB(dbData);
            }
            
            const url = URL.createObjectURL(mediaBlob);
            video.src = url;
            wavesurfer.load(url);

            video.addEventListener('canplay', () => {
                const vs = data.videoState;
                video.currentTime = vs.currentTime || 0;
                video.playbackRate = vs.playbackRate || 1;
                video.volume = vs.volume || 1;
                video.muted = vs.muted || false;
                
                speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`;
                volumeSlider.value = video.volume;
                muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';

            }, { once: true });
        }

        // --- Inicialización ---
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        isDarkMode = (savedTheme === 'dark');
        
        // Modificación de la inicialización de Wavesurfer
        wavesurfer = WaveSurfer.create({
            container: '#waveform-container',
            media: video,
            barWidth: 3, barRadius: 3, barGap: 2, height: 80, responsive: true,
            waveColor: themeClasses[savedTheme].waveColor, progressColor: themeClasses[savedTheme].progressColor, cursorColor: themeClasses[savedTheme].cursorColor, cursorWidth: 2,
            scrollParent: true, autoCenter: true, minPxPerSec: 100,
            plugins: [
                WaveSurfer.Regions.create() // Cargar el plugin
            ]
        });
        
        // Listener 'ready' para inicializar el plugin de regiones
        wavesurfer.on('ready', () => {
            isWavesurferReady = true;
            wsRegions = wavesurfer.plugins[0];
            
            // Listeners para eventos de regiones
            wsRegions.on('region-updated', (region) => {
                if (isUndoingOrRedoing) return; // No hacer nada si es por deshacer
                
                const entry = adEntries.find(e => e.id === region.id);
                if (entry) {
                    const newStartMs = Math.round(region.start * 1000);
                    const newEndMs = Math.round(region.end * 1000);
                    
                    // Solo actualizar si los tiempos han cambiado
                    if (entry.startTimeMs !== newStartMs || entry.endTimeMs !== newEndMs) {
                        const oldState = { startTimeMs: entry.startTimeMs, endTimeMs: entry.endTimeMs };
                        entry.startTimeMs = newStartMs;
                        entry.endTimeMs = newEndMs;
                        const newState = { startTimeMs: newStartMs, endTimeMs: newEndMs };

                        // Guardar historial
                        saveHistory({
                            type: 'time',
                            id: entry.id,
                            old: oldState,
                            new: newState
                        });
                        
                        updateAdTableRow(entry);
                    }
                }
            });
            
            wsRegions.on('region-click', (region, e) => {
                e.stopPropagation();
                const row = document.getElementById(region.id);
                if (row) {
                    selectedAdRowId = region.id;
                    
                    // Actualizar tabla
                    document.querySelectorAll('#ad-table-body tr').forEach(r => r.classList.remove('selected-row'));
                    row.classList.add('selected-row');
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Actualizar regiones
                    wsRegions.getRegions().forEach(r => {
                        r.element.classList.remove('selected-region');
                    });
                    region.element.classList.add('selected-region');
                }
            });

            // Si estamos en modo AD, renderizar las regiones que ya existan
            if (isAdMode) {
                renderAdRegions();
            }
        });

        wavesurfer.on('error', (e) => {
            console.warn('Wavesurfer error:', e);
            waveformContainer.classList.add('hidden');
        });

        initDB().then(() => {
            applyLanguage(currentLanguage);
            applyTheme(isDarkMode ? 'dark' : 'light');
            togglePlaybackControls(true);
            for(let i = 0; i < 4; i++) addRecurringTextField();
            loadBackup();
            loadShortcuts();
            setInterval(saveBackup, 30000); // Guardar cada 30 segundos
        }).catch(err => console.error(err));


        const fonts = ['Arial', 'Verdana', 'Georgia', 'Times New Roman', 'Courier New', 'monospace'];
        fonts.forEach(font => {
            const option = document.createElement('option');
            option.value = font; option.textContent = font;
            fontFamilySelect.appendChild(option);
        });
        const fontSizes = ['8px', '10px', '12px', '14px', '16px', '18px', '20px', '24px', '32px', '48px'];
        fontSizes.forEach(size => {
            const option = document.createElement('option');
            option.value = size; option.textContent = size;
            fontSizeSelect.appendChild(option);
        });
        fontSizeSelect.value = '14px';

        // --- Event Listeners ---

        importVideoAudioBtn.addEventListener('click', () => videoFileInput.click());
        videoFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          currentMediaFile = file; // Store file object
          togglePlaybackControls(true);
          waveformContainer.classList.remove('hidden');
          const url = URL.createObjectURL(file);
          video.src = url;
          video.load();
          isWavesurferReady = false; // Resetear flag
          wavesurfer.load(url);
        });

        projectFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const projectData = JSON.parse(event.target.result);
                    restoreProjectState(projectData);
                } catch (err) {
                    console.error("Error loading project file:", err);
                    alert("Failed to load project file. It may be invalid or corrupted.");
                }
            };
            reader.readAsText(file);
        });

        video.addEventListener('canplay', () => {
            togglePlaybackControls(false);
            emptyPlayerOverlay.classList.add('hidden');
            video.style.visibility = 'visible';
            updateTCRDisplay();
        });

        video.addEventListener('play', () => playPauseBtn.classList.add('playing'));
        video.addEventListener('pause', () => playPauseBtn.classList.remove('playing'));
        video.addEventListener('timeupdate', () => {
            updateTCRDisplay();
            if (video.duration) {
                const progress = (video.currentTime / video.duration) * 100;
                progressBar.style.width = `${progress}%`;
            }
        });

        playPauseBtn.addEventListener('click', () => executeShortcut('playPause'));
        // ... (resto de listeners de control de video sin cambios)
        rewind5sBtn.addEventListener('click', () => seekMedia(-5));
        rewind1sBtn.addEventListener('click', () => seekMedia(-1));
        rewind1fBtn.addEventListener('click', () => seekMedia(-1 / DEFAULT_FRAMERATE));
        forward1fBtn.addEventListener('click', () => seekMedia(1 / DEFAULT_FRAMERATE));
        forward1sBtn.addEventListener('click', () => seekMedia(1));
        forward5sBtn.addEventListener('click', () => seekMedia(5));
        speedDownBtn.addEventListener('click', () => { video.playbackRate = Math.max(0.5, video.playbackRate - 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; });
        speedUpBtn.addEventListener('click', () => { video.playbackRate = Math.min(4, video.playbackRate + 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; });
        
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            video.volume = volume;
            lastVolume = volume;
            muteBtn.innerHTML = volume > 0 ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
        });
        muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
            volumeSlider.value = video.muted ? 0 : lastVolume;
            muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        });
        
        progressBarContainer.addEventListener('click', (e) => {
            if (!video.duration) return;
            const rect = progressBarContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const progress = clickX / rect.width;
            video.currentTime = video.duration * progress;
        });
        insertTimecodeBtn.addEventListener('click', insertTimecode);
        timecodeFormatBtn.addEventListener('click', showTCRFormatModal);
        setInitialTimecodeBtn.addEventListener('click', showSetInitialTCRModal);
        addRecurringTextBtn.addEventListener('click', () => addRecurringTextField());
        boldBtn.addEventListener('click', () => document.execCommand('bold'));
        italicBtn.addEventListener('click', () => document.execCommand('italic'));
        uppercaseBtn.addEventListener('click', () => { /* ... (sin cambios) ... */ });
        lowercaseBtn.addEventListener('click', () => { /* ... (sin cambios) ... */ });
        fontFamilySelect.addEventListener('change', (e) => document.execCommand('fontName', false, e.target.value));
        fontSizeSelect.addEventListener('change', (e) => { /* ... (sin cambios) ... */ });
        
        function setupDropdown(button, dropdown) {
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                const isHidden = dropdown.classList.contains('hidden');
                document.querySelectorAll('.origin-top-left').forEach(d => d.classList.add('hidden'));
                if (isHidden) dropdown.classList.remove('hidden');
            });
        }
        setupDropdown(fileMenuBtn, fileMenuDropdown);
        setupDropdown(settingsMenuBtn, settingsMenuDropdown);
        window.addEventListener('click', () => {
            fileMenuDropdown.classList.add('hidden');
            settingsMenuDropdown.classList.add('hidden');
        });

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp, { once: true });
        });

        function handleMouseMove(e) {
            const totalWidth = document.body.offsetWidth;
            const leftWidth = e.clientX;
            const rightWidth = totalWidth - e.clientX - resizer.offsetWidth;
            if (leftWidth > 300 && rightWidth > 300) { // Mínimo 300px
                leftPanel.style.flexBasis = `${leftWidth}px`;
                rightPanel.style.flexBasis = `${rightWidth}px`;
            }
        }
        function handleMouseUp() {
            document.removeEventListener('mousemove', handleMouseMove);
        }


        editor.addEventListener('focus', () => {
            if (isEditorPristine) {
                editor.innerHTML = ''; // Limpia el placeholder
                isEditorPristine = false;
            }
        });
        editor.addEventListener('click', (e) => { /* ... (sin cambios) ... */ });

        newTranscriptionBtn.addEventListener('click', (e) => { e.preventDefault(); showNewTranscriptionConfirm(); });
        openProjectBtn.addEventListener('click', (e) => { e.preventDefault(); showOpenProjectModal(); });
        saveProjectBtn.addEventListener('click', (e) => { e.preventDefault(); showSaveProjectModal(); });
        importTextBtn.addEventListener('click', (e) => { e.preventDefault(); textFileInput.click(); });
        
        textFileInput.addEventListener('change', (e) => { /* ... (sin cambios) ... */ });

        // --- Listeners de Exportación Modificados ---
        exportTranscriptionBtn.addEventListener('click', (e) => { e.preventDefault(); showTranscriptionExportModal(); });
        exportAdBtn.addEventListener('click', (e) => { e.preventDefault(); showAdExportModal(); });
        // --- Fin Listeners de Exportación ---

        backupBtn.addEventListener('click', (e) => { e.preventDefault(); showBackupModal(); });
        shortcutsBtn.addEventListener('click', (e) => { e.preventDefault(); showShortcutsModal(); });
        languageToggleBtn.addEventListener('click', (e) => { e.preventDefault(); showLanguageModal(); });
        
        // --- Nuevos Listeners AD ---
        toggleAdModeBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAdMode(); });
        cpsSettingsBtn.addEventListener('click', (e) => { e.preventDefault(); showCpsSettingsModal(); });
        addAdLineBtn.addEventListener('click', handleAddAdLine);
        setAdInBtn.addEventListener('click', () => handleSetAdTime(true));
        setAdOutBtn.addEventListener('click', () => handleSetAdTime(false));
        deleteAdLineBtn.addEventListener('click', handleDeleteAdLine);
        // --- Fin Nuevos Listeners AD ---
        
        // --- Listeners Deshacer/Rehacer ---
        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);

        themeToggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const newTheme = isDarkMode ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });

        document.addEventListener('keydown', (e) => {
            if (listeningForShortcut) {
                e.preventDefault(); e.stopPropagation();
                if (['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) return;
                const newShortcutStr = keyEventToString(e);
                tempShortcuts[listeningForShortcut] = newShortcutStr;
                const button = document.querySelector(`.shortcut-button[data-action="${listeningForShortcut}"]`);
                if (button) {
                    button.textContent = newShortcutStr;
                    button.classList.remove('is-listening');
                }
                listeningForShortcut = null;
                return;
            }
            
            if (!findReplaceBar.classList.contains('hidden') && (document.activeElement === findInput || document.activeElement === replaceInput)) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (isAdMode) {
                        findInAdTable(e.shiftKey);
                    } else {
                        findInEditor(e.shiftKey);
                    }
                    return;
                }
                if (e.key === 'Escape') {
                    e.preventDefault(); hideFindReplaceBar(); return;
                }
                // Permitir que el input maneje otras teclas
                return; 
            }

            const pressedShortcut = keyEventToString(e).replace('Meta', 'Control');
            
            // Manejar atajos de AD primero si el modo está activo
            if (isAdMode) {
                if (pressedShortcut === shortcuts.adAddLine) {
                    e.preventDefault(); handleAddAdLine(); return;
                }
                if (pressedShortcut === shortcuts.adSetIn) {
                    e.preventDefault(); handleSetAdTime(true); return;
                }
                if (pressedShortcut === shortcuts.adSetOut) {
                    e.preventDefault(); handleSetAdTime(false); return;
                }
                if (pressedShortcut === shortcuts.adDeleteLine) {
                    e.preventDefault(); handleDeleteAdLine(); return;
                }
            }
            
            // Atajos estándar
            for (const action in shortcuts) {
                if (shortcuts[action] && shortcuts[action].replace('Meta', 'Control') === pressedShortcut) {
                    const activeEl = document.activeElement;
                    
                    // Permitir atajos si el foco está en la tabla de AD (pero no de texto)
                    if (isAdMode && activeEl.closest('#ad-table')) {
                        if (action === 'bold' || action === 'italic') continue;
                    } 
                    // Lógica original de no ejecutar en inputs (excepto find/replace)
                    else if (activeEl.tagName === 'INPUT' && action !== 'find' && action !== 'replace') return;
                    else if (activeEl.isContentEditable && activeEl !== editor && action !== 'find' && action !== 'replace') return;
                    
                    if (action === 'find' || action === 'replace') {
                         e.preventDefault(); executeShortcut(action); break;
                    }
                    
                    e.preventDefault();
                    executeShortcut(action);
                    break;
                }
            }
        });

        shortcutImportInput.addEventListener('change', (e) => { /* ... (sin cambios) ... */ });
        
        // Find & Replace Event Listeners
        findInput.addEventListener('input', updateFindResults);
        matchCaseCheckbox.addEventListener('change', updateFindResults);
        findNextBtn.addEventListener('click', () => isAdMode ? findInAdTable(false) : findInEditor(false));
        findPrevBtn.addEventListener('click', () => isAdMode ? findInAdTable(true) : findInEditor(true));
        replaceBtn.addEventListener('click', replaceCurrent);
        replaceAllBtn.addEventListener('click', replaceAll);
        toggleReplaceBtn.addEventListener('click', () => {
             replaceControls.classList.toggle('hidden');
             replaceControls.classList.toggle('flex');
             toggleReplaceBtn.classList.toggle('rotate-90');
        });
        document.addEventListener('selectionchange', () => {
            if (!findReplaceBar.classList.contains('hidden') && !isAdMode) {
                updateEditorFindResults();
            }
        });

  </script>
</body>
</html>

