<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="appTitle">PandaScript</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; overflow: hidden; }
    #left, #right { overflow: auto; }
    #left::-webkit-scrollbar, #right::-webkit-scrollbar { width: 0px; background: transparent; }
    #resizer { flex-basis: 2px; flex-shrink: 0; cursor: col-resize; transition: background-color 0.2s ease-in-out; }
    #resizer:hover { background-color: #3b82f6; }
    .timestamp { color: #93c5fd !important; text-decoration: underline !important; cursor: pointer; background: none !important; }
    #video { width: 100%; height: 100%; object-fit: contain; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content { background-color: #f3f4f6; color: #1f2937; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); max-width: 500px; width: 90%; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    #tcrDisplay { font-family: 'Courier New', monospace; }
    .highlighted-match { background-color: yellow; color: black; }
    .current-match { background-color: orange; color: black; }
    #editor { min-height: 200px; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; }
    #volumeSlider { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 100%; height: 8px; }
    #volumeSlider::-webkit-slider-runnable-track { background: #ccc; border-radius: 5px; height: 8px; }
    #volumeSlider::-moz-range-track { background: #ccc; border-radius: 5px; height: 8px; }
    #volumeSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #007bff; border: 1px solid #0056b3; margin-top: -4px; }
    #volumeSlider::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: #007bff; border: 1px solid #0056b3; }
    body.dark #volumeSlider::-webkit-slider-runnable-track { background: #555; }
    body.dark #volumeSlider::-webkit-slider-thumb { background: #63b3ed; border-color: #4299e1; }
    body.dark #volumeSlider::-moz-range-track { background: #555; }
    body.dark #volumeSlider::-moz-range-thumb { background: #63b3ed; border-color: #4299e1; }
    .shortcut-button.is-listening { border-color: #3b82f6; color: #3b82f6; }
  </style>
</head>
<body class="flex flex-row h-screen">

  <!-- Panel Izquierdo -->
  <div id="left" class="p-4 flex flex-col relative" style="flex-basis: 40%;">
    <!-- Contenedor del reproductor de vídeo -->
    <div class="relative w-full overflow-hidden rounded-lg mb-2 shadow-md" style="padding-top: 56.25%;">
        <div id="videoDisplayContainer" class="absolute inset-0 bg-black flex items-center justify-center">
            <video id="video" controls class="w-full h-full object-contain hidden"></video> 
            <div id="emptyPlayerOverlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black text-gray-400">
                <img src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/pandascript-logo.png" alt="PandaScript Logo" class="h-24 mb-2"> 
                <span class="text-xl font-bold">PandaScript</span>
            </div>
        </div>
    </div>
    <p id="noMediaMessage" class="text-sm text-center italic mb-4 hidden" data-i18n="noMediaMessage">No media file loaded.</p>
    
    <!-- Controles de Reproducción -->
    <div class="playback-controls flex flex-col gap-2 mb-4">
      <div class="flex flex-wrap justify-center items-center gap-2 w-full">
        <input type="file" id="videoFileInput" accept="video/*,audio/*" class="hidden" />
        <button id="importVideoAudioBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out w-auto" data-i18n="openMediaFile" data-i18n-title="openMediaFileTitle"><i class="fas fa-file-video mr-2"></i>Open Video/Audio File</button>
        <button id="playPauseBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="playPauseTitle"><i class="fas fa-play"></i></button>
        <button id="speedDownBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="slowDownTitle">-0.25x</button>
        <span id="speedDisplay" class="text-sm font-semibold flex items-center px-2">1.0x</span>
        <button id="speedUpBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="speedUpTitle">+0.25x</button>
        <div class="flex-grow max-w-[75px] px-2">
            <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1" class="w-full h-2 rounded-lg appearance-none cursor-pointer range-lg" data-i18n-title="volumeControlTitle" />
        </div>
        <button id="muteBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="muteUnmuteTitle"><i class="fas fa-volume-up"></i></button>
      </div>
      <div class="flex flex-wrap justify-center items-center gap-2 w-full mt-2">
        <button onclick="seekMedia(-5)" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="rewind5sTitle">-5s</button>
        <button onclick="seekMedia(-3)" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="rewind3sTitle">-3s</button>
        <button onclick="seekMedia(-1)" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="rewind1sTitle">-1s</button>
        <button onclick="seekMedia(1)" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="forward1sTitle">+1s</button>
        <button onclick="seekMedia(3)" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="forward3sTitle">+3s</button>
        <button onclick="seekMedia(5)" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto" data-i18n-title="forward5sTitle">+5s</button>
      </div>
    </div>
    
    <!-- Visualización de TCR -->
    <div id="tcrDisplay" class="font-mono text-4xl p-4 text-center rounded-lg mb-4 shadow-md w-full">--:--:--,---</div>

    <!-- Botones de TCR -->
    <div class="flex flex-wrap gap-2 mb-4 w-full">
      <button onclick="executeShortcut('insertTimecode')" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><i class="fas fa-clock mr-2"></i><span data-i18n="insertTimecode">Insert Timecode</span></button>
      <button onclick="showTCRFormatSelection()" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm" data-i18n="timecodeFormat"><i class="fas fa-gear mr-2"></i>Timecode Format</button>
      <button onclick="showSetInitialTCRModal()" class="flex-1 font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm" data-i18n="setInitialTimecode"><i class="fas fa-play mr-2"></i>Set Initial Timecode</button>
    </div>
    
    <!-- Campos de Texto Recurrente -->
    <div id="recurringTextSection" class="mt-4 mb-6 w-full">
      <div class="flex items-center justify-between mb-3 border-b pb-2">
        <h4 class="text-lg font-semibold" data-i18n="recurringTextHeader">Recurring Text</h4>
        <button id="addRecurringTextBtn" class="font-bold py-1 px-2 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><i class="fas fa-plus"></i></button>
      </div>
      <div id="recurringTextContainer" class="flex flex-col gap-2 justify-center">
        <!-- Los campos se añadirán aquí dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Divisor Flexible -->
  <div id="resizer"></div>

  <!-- Panel Derecho -->
  <div id="right" class="p-4 flex flex-col" style="flex-basis: 60%;">
    <!-- Controles con Menús -->
    <div id="controls" class="mb-4 flex flex-wrap items-center gap-2">
        <!-- Menú File -->
        <div class="relative inline-block text-left">
            <button id="fileMenuBtn" type="button" class="inline-flex justify-center w-full rounded-md border shadow-sm px-4 py-2 text-sm font-medium focus:outline-none">
                <span data-i18n="fileMenu">File</span>
                <i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5"></i>
            </button>
            <div id="fileMenuDropdown" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                <div class="py-1" role="menu" aria-orientation="vertical">
                    <a href="#" id="importTextBtn" class="dropdown-item" role="menuitem"><i class="fas fa-file-alt mr-3"></i><span data-i18n="importText">Import .txt</span></a>
                    <a href="#" id="exportBtn" class="dropdown-item" role="menuitem"><i class="fas fa-download mr-3"></i><span data-i18n="export">Export</span></a>
                </div>
            </div>
        </div>
        <!-- Menú Settings -->
        <div class="relative inline-block text-left">
            <button id="settingsMenuBtn" type="button" class="inline-flex justify-center w-full rounded-md border shadow-sm px-4 py-2 text-sm font-medium focus:outline-none">
                <span data-i18n="settingsMenu">Settings</span>
                <i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5"></i>
            </button>
            <div id="settingsMenuDropdown" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                <div class="py-1" role="menu" aria-orientation="vertical">
                    <a href="#" id="shortcutsBtn" class="dropdown-item" role="menuitem"><i class="fas fa-keyboard mr-3"></i><span data-i18n="shortcutsButton">Keyboard Shortcuts</span></a>
                    <a href="#" id="themeToggleBtn" class="dropdown-item" role="menuitem"><i id="themeIcon" class="fas fa-moon mr-3"></i><span id="themeText" data-i18n="darkMode">Dark Mode</span></a>
                    <a href="#" id="languageToggleBtn" class="dropdown-item" role="menuitem"><i class="fas fa-language mr-3"></i><span id="languageText" data-i18n="changeLanguageButton">Change Language</span></a>
                </div>
            </div>
        </div>
        <!-- Separador -->
        <div class="border-l h-6 mx-2" id="controlsSeparator"></div>
        <!-- Botones restantes -->
        <input type="file" id="textFileInput" accept=".txt" class="hidden" />
        <button id="boldBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><i class="fas fa-bold"></i></button>
        <button id="italicBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><i class="fas fa-italic"></i></button>
        <button id="findBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><i class="fas fa-search"></i></button>
        <button id="replaceBtn" class="font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm"><i class="fas fa-exchange-alt"></i></button>
    </div>
    <!-- Editor de Texto -->
    <div id="editor" contenteditable="true" spellcheck="true" aria-label="Text editor" class="flex-1 rounded-lg p-4 font-mono text-sm overflow-y-auto outline-none shadow-inner min-h-[200px]">
      <p data-i18n="editorPlaceholder">Start transcribing here...</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="customModal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
      <p id="modalMessage" class="mb-4"></p>
      <div id="modalBody" class="mb-4"></div>
      <div id="modalButtons" class="modal-buttons"></div>
    </div>
  </div>

  <script type="module">
    // Módulo de Firebase (sin cambios)
  </script>
  <script>
    // --- Selectores de Elementos DOM ---
    const video = document.getElementById('video');
    const videoFileInput = document.getElementById('videoFileInput');
    const importVideoAudioBtn = document.getElementById('importVideoAudioBtn');
    const textFileInput = document.getElementById('textFileInput');
    const editor = document.getElementById('editor');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const speedDisplay = document.getElementById('speedDisplay');
    const volumeSlider = document.getElementById('volumeSlider');
    const muteBtn = document.getElementById('muteBtn');
    const tcrDisplay = document.getElementById('tcrDisplay');
    const emptyPlayerOverlay = document.getElementById('emptyPlayerOverlay');
    const recurringTextContainer = document.getElementById('recurringTextContainer');
    const addRecurringTextBtn = document.getElementById('addRecurringTextBtn');
    
    const boldBtn = document.getElementById('boldBtn');
    const italicBtn = document.getElementById('italicBtn');
    const findBtn = document.getElementById('findBtn');
    const replaceBtn = document.getElementById('replaceBtn');

    const fileMenuBtn = document.getElementById('fileMenuBtn');
    const fileMenuDropdown = document.getElementById('fileMenuDropdown');
    const settingsMenuBtn = document.getElementById('settingsMenuBtn');
    const settingsMenuDropdown = document.getElementById('settingsMenuDropdown');
    const importTextBtn = document.getElementById('importTextBtn');
    const exportBtn = document.getElementById('exportBtn');
    const shortcutsBtn = document.getElementById('shortcutsBtn');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const languageToggleBtn = document.getElementById('languageToggleBtn');
    const themeText = document.getElementById('themeText');
    const themeIcon = document.getElementById('themeIcon');
    
    const resizer = document.getElementById('resizer');
    const leftPanel = document.getElementById('left');
    const rightPanel = document.getElementById('right');

    // --- Estado de la Aplicación ---
    const DEFAULT_FRAMERATE = 30;
    let tcrOffsetSeconds = 0;
    let lastVolume = 1;
    let findReplaceState = { query: '', replacement: '', caseSensitive: false, matches: [], currentIndex: -1, isFinding: false };
    let isDarkMode = false; 
    let currentLanguage = 'en';
    let listeningForShortcut = null;

    // --- Traducciones ---
    const translations = {
      en: {
        appTitle: "PandaScript",
        openMediaFile: "Open Video/Audio File",
        noMediaMessage: "No media file loaded.",
        playPauseTitle: "Play/Pause",
        slowDownTitle: "Slow down", speedUpTitle: "Speed up",
        volumeControlTitle: "Volume", muteUnmuteTitle: "Mute/Unmute",
        rewind5sTitle: "Rewind 5s", rewind3sTitle: "Rewind 3s", rewind1sTitle: "Rewind 1s",
        forward1sTitle: "Forward 1s", forward3sTitle: "Forward 3s", forward5sTitle: "Forward 5s",
        recurringTextHeader: "Recurring Text (keyboard shortcuts)",
        recurringTextPlaceholder: "Recurring text {0}",
        insertTimecode: "Insert Timecode", timecodeFormat: "Timecode Format", setInitialTimecode: "Set Initial Timecode",
        importText: "Import .txt", export: "Export",
        bold: "Bold", italic: "Italic", findButton: "Find", replaceButton: "Replace",
        darkMode: "Dark Mode", lightMode: "Light Mode",
        shortcutsButton: "Keyboard Shortcuts", 
        editorPlaceholder: "Start transcribing here, or import a text file. Load a video/audio in the left panel to begin.",
        fileMenu: "File", settingsMenu: "Settings",
        modalAttention: "Attention", modalConfirmAction: "Confirm Action",
        modalAccept: "Accept", modalCancel: "Cancel", modalConfirm: "Confirm", modalClose: "Close",
        tcrFormatModalTitle: "Select Timecode Format", tcrFormatModalMessage: "Choose the format:", tcrFormatModalSave: "Save",
        setInitialTCRModalTitle: "Set Initial Timecode", setInitialTCRModalMessage: "Enter the starting timecode:",
        setInitialTCRModalPlaceholder: "Ex: 00:00:00,000 or 00:00:00:00", setInitialTCRModalSet: "Set",
        setTCRSuccess: "Initial timecode set to {0}.", invalidTCRFormat: "Invalid timecode format.",
        mediaLoadErrorWithFileProtocolHint: "Error loading media file. It could be an unsupported format.",
        noMediaWarning: "Load a video or audio first to {0}.",
        insertTimecodeError: "Load a video or audio first to insert a timecode.",
        textLoadError: "Error loading text file.",
        findModalTitle: "Find Text", findQueryLabel: "Text to find:", caseSensitiveLabel: "Match case",
        findPrevious: "Previous", findNext: "Next", noMatchesFound: "No matches found.",
        replaceModalTitle: "Replace Text", replaceWithLabel: "Replace with:",
        replaceButtonInModal: "Replace", replaceAllButton: "Replace All",
        noMatchSelectedForReplace: "No match selected.", replacementComplete: "All occurrences of \"{0}\" replaced.",
        changeLanguageButton: "Change Language", chooseLanguageMessage: "Choose a language:",
        exportFileModalTitle: "Export File", exportFileMessage: "Enter filename:", exportFilenamePlaceholder: "transcription",
        exportFormatLabel: "Select format:", exportFormatTxt: "Plain Text (.txt)", exportFormatHtml: "Formatted Text (.html)",
        exportButton: "Export", 
        languageEnglish: "English", languageSpanish: "Spanish",
        shortcutLabel_insertTimecode: "Insert Timecode",
        shortcutLabel_playPause: "Play/Pause",
        shortcutLabel_rewind5s: "Rewind 5s",
        shortcutLabel_forward5s: "Forward 5s",
        shortcutLabel_rewind1s: "Rewind 1s",
        shortcutLabel_forward1s: "Forward 1s",
        shortcutLabel_rewind1frame: "Rewind 1 Frame",
        shortcutLabel_forward1frame: "Forward 1 Frame",
        shortcutLabel_insertRecurringText: "Insert Recurring Text {0}",
        shortcutsModalTitle: "Customize Keyboard Shortcuts",
        shortcutsModalMessage: "Click on a button to set a new shortcut.",
        resetShortcuts: "Reset to Defaults",
        pressNewShortcut: "Press new keys...",
      },
      es: {
        appTitle: "PandaScript",
        openMediaFile: "Abrir Vídeo/Audio",
        noMediaMessage: "No hay archivo multimedia cargado.",
        playPauseTitle: "Reproducir/Pausar",
        slowDownTitle: "Ralentizar", speedUpTitle: "Acelerar",
        volumeControlTitle: "Volumen", muteUnmuteTitle: "Silenciar/Activar",
        rewind5sTitle: "Retroceder 5s", rewind3sTitle: "Retroceder 3s", rewind1sTitle: "Retroceder 1s",
        forward1sTitle: "Avanzar 1s", forward3sTitle: "Avanzar 3s", forward5sTitle: "Avanzar 5s",
        recurringTextHeader: "Texto recurrente (atajos de teclado)",
        recurringTextPlaceholder: "Texto recurrente {0}",
        insertTimecode: "Insertar TCR", timecodeFormat: "Formato TCR", setInitialTimecode: "TCR Inicial",
        importText: "Importar .txt", export: "Exportar",
        bold: "Negrita", italic: "Cursiva", findButton: "Buscar", replaceButton: "Reemplazar",
        darkMode: "Modo oscuro", lightMode: "Modo claro",
        shortcutsButton: "Atajos de teclado", 
        editorPlaceholder: "Empieza a transcribir aquí o importa un archivo de texto. Carga un vídeo/audio para empezar.",
        fileMenu: "Archivo", settingsMenu: "Ajustes",
        modalAttention: "Atención", modalConfirmAction: "Confirmar Acción",
        modalAccept: "Aceptar", modalCancel: "Cancelar", modalConfirm: "Confirmar", modalClose: "Cerrar",
        tcrFormatModalTitle: "Seleccionar Formato de TCR", tcrFormatModalMessage: "Elige el formato:", tcrFormatModalSave: "Guardar",
        setInitialTCRModalTitle: "Establecer TCR Inicial", setInitialTCRModalMessage: "Introduce el TCR de inicio:",
        setInitialTCRModalPlaceholder: "Ej: 00:00:00,000 o 00:00:00:00", setInitialTCRModalSet: "Establecer",
        setTCRSuccess: "TCR inicial establecido en {0}.", invalidTCRFormat: "Formato de TCR no válido.",
        mediaLoadErrorWithFileProtocolHint: "Error al cargar el archivo. Puede ser un formato no compatible.",
        noMediaWarning: "Carga primero un vídeo o audio para {0}.",
        insertTimecodeError: "Carga primero un vídeo o audio para insertar un TCR.",
        textLoadError: "Error al cargar el archivo de texto.",
        findModalTitle: "Buscar Texto", findQueryLabel: "Texto a buscar:", caseSensitiveLabel: "Distinguir mayúsculas",
        findPrevious: "Anterior", findNext: "Siguiente", noMatchesFound: "No se encontraron coincidencias.",
        replaceModalTitle: "Reemplazar Texto", replaceWithLabel: "Reemplazar con:",
        replaceButtonInModal: "Reemplazar", replaceAllButton: "Reemplazar Todo",
        noMatchSelectedForReplace: "No hay coincidencia seleccionada.", replacementComplete: "Todas las apariciones de \"{0}\" han sido reemplazadas.",
        changeLanguageButton: "Cambiar Idioma", chooseLanguageMessage: "Elige un idioma:",
        exportFileModalTitle: "Exportar Archivo", exportFileMessage: "Introduce el nombre del archivo:", exportFilenamePlaceholder: "transcripcion",
        exportFormatLabel: "Seleccionar formato:", exportFormatTxt: "Texto Plano (.txt)", exportFormatHtml: "Texto con Formato (.html)",
        exportButton: "Exportar", 
        languageEnglish: "Inglés", languageSpanish: "Español",
        shortcutLabel_insertTimecode: "Insertar TCR",
        shortcutLabel_playPause: "Reproducir/Pausar",
        shortcutLabel_rewind5s: "Retroceder 5s",
        shortcutLabel_forward5s: "Avanzar 5s",
        shortcutLabel_rewind1s: "Retroceder 1s",
        shortcutLabel_forward1s: "Avanzar 1s",
        shortcutLabel_rewind1frame: "Retroceder 1 Fotograma",
        shortcutLabel_forward1frame: "Avanzar 1 Fotograma",
        shortcutLabel_insertRecurringText: "Insertar Texto Recurrente {0}",
        shortcutsModalTitle: "Personalizar Atajos de Teclado",
        shortcutsModalMessage: "Haz clic en un botón para asignar un nuevo atajo.",
        resetShortcuts: "Restaurar por Defecto",
        pressNewShortcut: "Pulsa las nuevas teclas...",
      }
    };
    
    // --- Definición de Temas ---
    const themeClasses = {
      dark: {
        bodyBg: 'bg-gray-950', bodyText: 'text-gray-200', panelBg: 'bg-gray-800', border: 'border-gray-700',
        inputBg: 'bg-gray-700', inputBorder: 'border-gray-600', inputText: 'text-gray-200',
        editorBg: 'bg-gray-900', editorBorder: 'border-gray-700', editorText: 'text-gray-200',
        timestampColor: '#93c5fd', modalBg: 'bg-gray-800', modalText: 'text-gray-200',
        btnPrimary: 'bg-blue-600 hover:bg-blue-700 text-white', btnDanger: 'bg-red-600 hover:bg-red-700 text-white',
        btnNeutral: 'bg-gray-600 hover:bg-gray-500 text-white', btnSimple: 'bg-gray-700 hover:bg-gray-600 text-gray-200',
        menuBtnBg: 'bg-gray-700', menuBtnText: 'text-gray-200', menuBtnHoverBg: 'hover:bg-gray-600', menuBtnBorder: 'border-gray-600',
        menuDropdownBg: 'bg-gray-800', menuDropdownBorder: 'border-gray-700',
        menuItemText: 'text-gray-300', menuItemHoverBg: 'hover:bg-gray-700', menuItemHoverText: 'hover:text-white',
        textColorPrimary: 'text-gray-300', textColorSecondary: 'text-gray-400', resizerBg: 'bg-gray-700'
      },
      light: {
        bodyBg: 'bg-gray-50', bodyText: 'text-gray-900', panelBg: 'bg-white', border: 'border-gray-300',
        inputBg: 'bg-gray-200', inputBorder: 'border-gray-300', inputText: 'text-gray-800',
        editorBg: 'bg-white', editorBorder: 'border-gray-300', editorText: 'text-black',
        timestampColor: '#1d4ed8', modalBg: 'bg-white', modalText: 'text-gray-900',
        btnPrimary: 'bg-blue-600 hover:bg-blue-700 text-white', btnDanger: 'bg-red-600 hover:bg-red-700 text-white',
        btnNeutral: 'bg-gray-200 hover:bg-gray-300 text-black', btnSimple: 'bg-white hover:bg-gray-100 text-gray-800',
        menuBtnBg: 'bg-white', menuBtnText: 'text-gray-700', menuBtnHoverBg: 'hover:bg-gray-50', menuBtnBorder: 'border-gray-300',
        menuDropdownBg: 'bg-white', menuDropdownBorder: 'border-gray-200',
        menuItemText: 'text-gray-700', menuItemHoverBg: 'hover:bg-gray-100', menuItemHoverText: 'hover:text-gray-900',
        textColorPrimary: 'text-gray-700', textColorSecondary: 'text-gray-500', resizerBg: 'bg-gray-300'
      }
    };

    // --- Definición de Atajos ---
    let shortcuts = {};
    const defaultShortcuts = {
        'insertTimecode': 'Alt+Q',
        'playPause': 'Control+Space',
        'rewind5s': 'Shift+ArrowLeft',
        'forward5s': 'Shift+ArrowRight',
        'rewind1s': 'Control+ArrowLeft',
        'forward1s': 'Control+ArrowRight',
        'rewind1frame': 'Alt+ArrowLeft',
        'forward1frame': 'Alt+ArrowRight',
    };

    // --- Definiciones de Formatos de TCR ---
    const pad = (num, len = 2) => String(num).padStart(len, '0');
    const tcrFormats = [
        { name: "HH:MM:SS,MMM", format: (t) => { if(isNaN(t)) return '--:--:--,---'; const h=Math.floor(t/3600),m=Math.floor(t%3600/60),s=Math.floor(t%60),ms=Math.floor(t%1*1000); return `${pad(h)}:${pad(m)}:${pad(s)},${pad(ms,3)}`; }},
        { name: "HH:MM:SS:FF", format: (t, fr) => { if(isNaN(t)) return '--:--:--:--'; const tf=Math.floor(t*fr),h=Math.floor(tf/(3600*fr)),m=Math.floor(tf/(60*fr)%60),s=Math.floor(tf/fr%60),f=tf%fr; return `${pad(h)}:${pad(m)}:${pad(s)}:${pad(f)}`; }},
    ];
    let currentTCRFormatIndex = 0; 


    // --- Definiciones de Funciones ---

    function applyLanguage(lang) {
      currentLanguage = lang;
      document.documentElement.lang = lang; 
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        let text = translations[currentLanguage][key] || key;
        el.textContent = text;
      });
      updateRecurringTextPlaceholders();
      applyTheme(isDarkMode ? 'dark' : 'light');
    }

    function applyTheme(themeName) {
      const theme = themeClasses[themeName];
      isDarkMode = (themeName === 'dark');
      document.body.className = `flex flex-row h-screen overflow-hidden ${theme.bodyBg} ${theme.bodyText}`;
      leftPanel.className = `p-4 flex flex-col relative ${theme.panelBg}`;
      rightPanel.className = `p-4 flex flex-col ${theme.panelBg}`;
      resizer.className = `cursor-col-resize ${theme.resizerBg}`;
      
      document.querySelectorAll('.playback-controls button, #left > .flex-wrap > button, #addRecurringTextBtn').forEach(btn => {
        btn.className = `${btn.className.includes('flex-1') ? 'flex-1' : ''} font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out text-sm flex items-center justify-center w-auto ${theme.btnNeutral}`;
      });
      
      recurringTextContainer.querySelectorAll('button').forEach(btn => {
         btn.className = `font-bold py-1 px-2 rounded-lg shadow-md transition duration-200 ease-in-out text-sm ${theme.btnNeutral}`;
      });

      document.querySelectorAll('#recurringTextContainer input[type="text"]').forEach(input => {
        input.className = `flex-1 min-w-[120px] p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${theme.inputBg} ${theme.inputText} ${theme.inputBorder}`;
      });

      editor.className = `flex-1 rounded-lg p-4 font-mono text-sm overflow-y-auto outline-none shadow-inner min-h-[200px] ${theme.editorBg} ${theme.editorBorder} ${theme.editorText}`;
      if (editor.querySelector('p')) { editor.querySelector('p').className = `${theme.textColorSecondary}`; }
      tcrDisplay.className = `font-mono text-4xl p-4 text-center rounded-lg mb-4 shadow-md w-full ${isDarkMode ? 'bg-black text-white' : 'bg-gray-200 text-black'}`;
      [fileMenuBtn, settingsMenuBtn].forEach(btn => { btn.className = `inline-flex justify-center w-full rounded-md shadow-sm px-4 py-2 text-sm font-medium focus:outline-none ${theme.menuBtnBg} ${theme.menuBtnText} ${theme.menuBtnHoverBg} ${theme.menuBtnBorder}`; });
      [fileMenuDropdown, settingsMenuDropdown].forEach(dropdown => { dropdown.className = `origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10 ${theme.menuDropdownBg} ${theme.menuDropdownBorder}`; });
      document.querySelectorAll('.dropdown-item').forEach(item => { item.className = `dropdown-item block px-4 py-2 text-sm w-full text-left flex items-center ${theme.menuItemText} ${theme.menuItemHoverBg} ${theme.menuItemHoverText}`; });
      document.getElementById('controlsSeparator').className = `border-l h-6 mx-2 ${theme.border}`;
      [boldBtn, italicBtn, findBtn, replaceBtn].forEach(btn => { btn.className = `font-bold p-2 rounded-lg shadow-md transition duration-200 ease-in-out text-sm ${theme.btnSimple} ${theme.border}`; });
      themeText.textContent = isDarkMode ? translations[currentLanguage].lightMode : translations[currentLanguage].darkMode;
      themeIcon.className = `fas ${isDarkMode ? 'fa-sun' : 'fa-moon'} mr-3`;
      const styleEl = document.querySelector('style');
      let styleContent = styleEl.innerHTML; 
      styleContent = styleContent.replace(/(\.timestamp \{\s*color:\s*)#[a-fA-F0-9]+\s*!important;/, `$1${theme.timestampColor} !important;`);
      styleEl.innerHTML = styleContent;
    }

    function loadShortcuts() {
        const savedShortcuts = JSON.parse(localStorage.getItem('pandascript_shortcuts'));
        shortcuts = { ...defaultShortcuts, ...savedShortcuts };
        for (let i = 1; i <= 10; i++) {
             const action = `insertRecurringText${i}`;
             if (!shortcuts[action]) shortcuts[action] = `Alt+${i}`;
        }
    }

    function saveShortcuts() {
        localStorage.setItem('pandascript_shortcuts', JSON.stringify(shortcuts));
    }

    function keyEventToString(e) {
        let parts = [];
        if (e.ctrlKey || e.metaKey) parts.push('Control');
        if (e.altKey) parts.push('Alt');
        if (e.shiftKey) parts.push('Shift');
        let key = e.key;
        if (key.length > 1 && !['Space', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) {} 
        else if (key === ' ') parts.push('Space');
        else parts.push(key);
        return parts.join('+');
    }

    function executeShortcut(action) {
        const actions = {
            'insertTimecode': () => {
                if (!video.src || video.src === window.location.href) return customAlert('insertTimecodeError');
                const timeCode = tcrFormats[currentTCRFormatIndex].format(video.currentTime + tcrOffsetSeconds, DEFAULT_FRAMERATE); 
                insertHtmlAtCursor(`<span class="timestamp">[${timeCode}]</span> `);
            },
            'playPause': () => {
                if (!video.src || video.src === window.location.href) return;
                video.paused ? video.play() : video.pause();
                playPauseBtn.innerHTML = `<i class="fas ${video.paused ? 'fa-play' : 'fa-pause'}"></i>`;
            },
            'rewind5s': () => seekMedia(-5),
            'forward5s': () => seekMedia(5),
            'rewind1s': () => seekMedia(-1),
            'forward1s': () => seekMedia(1),
            'rewind1frame': () => seekMedia(-1/DEFAULT_FRAMERATE),
            'forward1frame': () => seekMedia(1/DEFAULT_FRAMERATE),
            'insertRecurringText': (index) => {
                const inputs = recurringTextContainer.querySelectorAll('input');
                if (inputs[index-1] && inputs[index-1].value) {
                    insertHtmlAtCursor(inputs[index-1].value + ' ');
                }
            }
        };
        if (action.startsWith('insertRecurringText')) {
            const index = parseInt(action.replace('insertRecurringText', ''));
            actions['insertRecurringText'](index);
        } else if (actions[action]) {
            actions[action]();
        }
    }
    
    function addRecurringTextField(value = '') {
        const count = recurringTextContainer.children.length;
        if (count >= 9) addRecurringTextBtn.disabled = true;
        const container = document.createElement('div');
        container.className = 'flex items-center gap-2';
        const input = document.createElement('input');
        input.type = 'text';
        input.value = value;
        input.addEventListener('input', saveRecurringTexts);
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
        removeBtn.onclick = () => {
            container.remove();
            updateRecurringTextPlaceholders();
            saveRecurringTexts();
            addRecurringTextBtn.disabled = false;
        };
        container.appendChild(input);
        container.appendChild(removeBtn);
        recurringTextContainer.appendChild(container);
        updateRecurringTextPlaceholders();
        applyTheme(isDarkMode ? 'dark' : 'light');
    }

    function updateRecurringTextPlaceholders() {
        const inputs = recurringTextContainer.querySelectorAll('input');
        inputs.forEach((input, index) => {
            const placeholderText = translations[currentLanguage].recurringTextPlaceholder.replace('{0}', index + 1);
            input.placeholder = placeholderText;
        });
    }

    function saveRecurringTexts() {
        const values = Array.from(recurringTextContainer.querySelectorAll('input')).map(input => input.value);
        localStorage.setItem('pandascript_recurring_texts', JSON.stringify(values));
    }

    function loadRecurringTexts() {
        const savedTexts = JSON.parse(localStorage.getItem('pandascript_recurring_texts'));
        if (savedTexts && savedTexts.length > 0) {
            savedTexts.forEach(text => addRecurringTextField(text));
        } else {
            for(let i = 0; i < 4; i++) addRecurringTextField();
        }
    }

    function showModal(title, message, buttons, bodyContent = '') {
        const theme = themeClasses[isDarkMode ? 'dark' : 'light'];
        const modalContentEl = document.getElementById('customModal').querySelector('.modal-content');
        modalContentEl.className = `modal-content ${theme.modalBg} ${theme.modalText}`;
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').innerHTML = message;
        document.getElementById('modalBody').innerHTML = bodyContent;
        const modalButtons = document.getElementById('modalButtons');
        modalButtons.innerHTML = '';
        buttons.forEach(buttonConfig => {
            const button = document.createElement('button');
            button.textContent = buttonConfig.text;
            const btnClass = buttonConfig.type === 'danger' ? theme.btnDanger : (buttonConfig.type === 'primary' ? theme.btnPrimary : theme.btnNeutral);
            button.className = `font-bold py-1.5 px-2.5 rounded-lg shadow-md transition duration-200 ease-in-out ${btnClass}`;
            button.onclick = () => { if(!buttonConfig.preventClose) hideModal(); if (buttonConfig.handler) buttonConfig.handler(); };
            modalButtons.appendChild(button);
        });
        document.getElementById('customModal').classList.add('show');
    }

    function hideModal() { 
        document.getElementById('customModal').classList.remove('show');
        if (listeningForShortcut) {
            const button = document.querySelector(`.shortcut-button[data-action="${listeningForShortcut}"]`);
            if(button) button.classList.remove('is-listening');
            listeningForShortcut = null;
        }
    }

    function customAlert(messageKey, titleKey = 'modalAttention', args = []) {
        let msg = translations[currentLanguage][messageKey] || messageKey;
        if(args.length > 0) msg = msg.replace('{0}', args[0]);
        showModal(translations[currentLanguage][titleKey], msg, [{ text: translations[currentLanguage].modalAccept, type: 'primary' }]);
    }
    
    function showShortcutsModal() {
        const theme = themeClasses[isDarkMode ? 'dark' : 'light'];
        let bodyHtml = '<div class="space-y-2">';
        const shortcutActions = Object.keys(defaultShortcuts);
        const recurringCount = recurringTextContainer.children.length;
        for(let i = 1; i <= recurringCount; i++) {
            shortcutActions.push(`insertRecurringText${i}`);
        }
        shortcutActions.forEach(action => {
            let labelKey = `shortcutLabel_${action.replace(/\d/g, '')}`;
            let label = translations[currentLanguage][labelKey] || action;
            if (action.includes('insertRecurringText')) {
                label = label.replace('{0}', action.replace('insertRecurringText', ''));
            }
            bodyHtml += `
                <div class="flex justify-between items-center">
                    <span>${label}</span>
                    <button class="shortcut-button font-mono p-1 px-2 border-2 rounded ${theme.btnSimple} ${theme.border}" data-action="${action}">
                        ${shortcuts[action] || 'Not set'}
                    </button>
                </div>
            `;
        });
        bodyHtml += '</div>';
        const buttons = [
            { text: translations[currentLanguage].resetShortcuts, handler: () => {
                shortcuts = { ...defaultShortcuts };
                saveShortcuts();
                hideModal();
                showShortcutsModal();
            }, type: 'danger', preventClose: true },
            { text: translations[currentLanguage].modalClose, handler: hideModal, type: 'neutral' }
        ];
        showModal(translations[currentLanguage].shortcutsModalTitle, translations[currentLanguage].shortcutsModalMessage, buttons, bodyHtml);
        document.querySelectorAll('.shortcut-button').forEach(button => {
            button.addEventListener('click', (e) => {
                if (listeningForShortcut) {
                    const prevButton = document.querySelector(`.shortcut-button[data-action="${listeningForShortcut}"]`);
                    if (prevButton) {
                      prevButton.textContent = shortcuts[listeningForShortcut];
                      prevButton.classList.remove('is-listening');
                    }
                }
                listeningForShortcut = e.target.dataset.action;
                e.target.textContent = translations[currentLanguage].pressNewShortcut;
                e.target.classList.add('is-listening');
            });
        });
    }

    function updateEmptyPlayerState() {
        const hasMedia = video.src && video.src !== window.location.href;
        emptyPlayerOverlay.classList.toggle('hidden', hasMedia);
        document.getElementById('noMediaMessage').classList.toggle('hidden', hasMedia);
        video.classList.toggle('hidden', !hasMedia);
        if(!hasMedia) tcrDisplay.textContent = '--:--:--,---';
    }

    function seekMedia(seconds) {
        if (!video.src || video.src === window.location.href) return;
        video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + seconds));
    }

    function insertHtmlAtCursor(html) { editor.focus(); document.execCommand('insertHTML', false, html); }
    
    function showTCRFormatSelection() {
        let optionsHtml = '<div class="space-y-2">';
        tcrFormats.forEach((format, index) => {
            optionsHtml += `<label class="inline-flex items-center cursor-pointer"><input type="radio" name="tcrFormat" value="${index}" class="form-radio" ${index === currentTCRFormatIndex ? 'checked' : ''}><span class="ml-2">${format.name}</span></label><br>`;
        });
        optionsHtml += '</div>';
        showModal(translations[currentLanguage].tcrFormatModalTitle, translations[currentLanguage].tcrFormatModalMessage,
            [{ text: translations[currentLanguage].tcrFormatModalSave, handler: () => { const sel = document.querySelector('input[name="tcrFormat"]:checked'); if (sel) currentTCRFormatIndex = parseInt(sel.value); updateTCRDisplay(); }, type: 'primary' },
             { text: translations[currentLanguage].modalCancel, type: 'neutral' }], optionsHtml);
    }
    
    function updateTCRDisplay() {
        if (video.src && !isNaN(video.currentTime)) {
            tcrDisplay.textContent = tcrFormats[currentTCRFormatIndex].format(video.currentTime + tcrOffsetSeconds, DEFAULT_FRAMERATE);
        }
    }

    function showSetInitialTCRModal() {
        const theme = themeClasses[isDarkMode ? 'dark' : 'light'];
        const inputClasses = `w-full p-2 mb-3 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${theme.inputBg} ${theme.inputText} ${theme.inputBorder}`;
        let html = `<div><label for="modalInitialTCRInput" class="text-sm font-medium mb-1 block">TCR</label><input type="text" id="modalInitialTCRInput" placeholder="${translations[currentLanguage].setInitialTCRModalPlaceholder}" class="${inputClasses}" /></div>`;
        showModal(translations[currentLanguage].setInitialTCRModalTitle, translations[currentLanguage].setInitialTCRModalMessage,
            [{ text: translations[currentLanguage].setInitialTCRModalSet, handler: () => { const input = document.getElementById('modalInitialTCRInput'); if (input) setInitialTCR(input.value.trim()); }, type: 'primary' },
             { text: translations[currentLanguage].modalCancel, type: 'neutral' }], html);
    }

    function parseTimeCodeToSeconds(timeCodeString, frameRate = DEFAULT_FRAMERATE) {
        let matchMs = timeCodeString.match(/(\d{1,2}):(\d{2}):(\d{2}),(\d{3})/);
        if (matchMs) return parseInt(matchMs[1])*3600 + parseInt(matchMs[2])*60 + parseInt(matchMs[3]) + parseInt(matchMs[4])/1000;
        let matchFrames = timeCodeString.match(/(\d{1,2}):(\d{2}):(\d{2}):(\d{2})/);
        if (matchFrames) return (parseInt(matchFrames[1])*3600 + parseInt(matchFrames[2])*60 + parseInt(matchFrames[3])) + (parseInt(matchFrames[4])/frameRate);
        return null;
    }

    function setInitialTCR(timeCodeString) {
        if (!video.src || video.src === window.location.href) return customAlert('noMediaWarning', 'modalAttention', [translations[currentLanguage].setInitialTimecode.toLowerCase()]);
        const desiredTCRSeconds = parseTimeCodeToSeconds(timeCodeString);
        if (desiredTCRSeconds === null) return customAlert('invalidTCRFormat');
        tcrOffsetSeconds = desiredTCRSeconds - video.currentTime;
        updateTCRDisplay();
        customAlert('setTCRSuccess', 'modalConfirmAction', [timeCodeString]);
    }

    // --- Lógica de Inicialización y Eventos ---
    
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        isDarkMode = (savedTheme === 'dark');
        loadShortcuts();
        loadRecurringTexts();
        const savedLanguage = localStorage.getItem('language') || 'en';
        applyLanguage(savedLanguage);
        updateEmptyPlayerState();

        // Asignar todos los eventos aquí
        importVideoAudioBtn.addEventListener('click', () => videoFileInput.click());
        videoFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          video.src = URL.createObjectURL(file);
          video.load();
          video.onloadedmetadata = () => { updateEmptyPlayerState(); tcrOffsetSeconds = 0; updateTCRDisplay(); video.playbackRate = 1.0; speedDisplay.textContent = '1.0x'; };
          video.onerror = () => customAlert('mediaLoadErrorWithFileProtocolHint');
        });

        playPauseBtn.addEventListener('click', () => executeShortcut('playPause'));
        document.getElementById('speedUpBtn').addEventListener('click', () => { if(video.src) video.playbackRate = Math.min(4.0, video.playbackRate + 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; });
        document.getElementById('speedDownBtn').addEventListener('click', () => { if(video.src) video.playbackRate = Math.max(0.5, video.playbackRate - 0.25); speedDisplay.textContent = `${video.playbackRate.toFixed(2)}x`; });
        volumeSlider.addEventListener('input', () => { if(video.src) { video.volume = volumeSlider.value; video.muted = video.volume === 0; muteBtn.innerHTML = `<i class="fas ${video.muted ? 'fa-volume-mute' : 'fa-volume-up'}"></i>`; if(!video.muted) lastVolume = video.volume; }});
        muteBtn.addEventListener('click', () => { if(video.src) { video.muted = !video.muted; volumeSlider.value = video.muted ? 0 : lastVolume; video.volume = video.muted ? 0 : lastVolume; muteBtn.innerHTML = `<i class="fas ${video.muted ? 'fa-volume-mute' : 'fa-volume-up'}"></i>`; }});
        video.addEventListener('timeupdate', () => updateTCRDisplay());
        
        addRecurringTextBtn.addEventListener('click', () => addRecurringTextField());
        
        // Menús
        function setupDropdown(button, dropdown) {
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                [fileMenuDropdown, settingsMenuDropdown].forEach(dd => {
                    if (dd !== dropdown) dd.classList.add('hidden');
                });
                dropdown.classList.toggle('hidden');
            });
        }
        setupDropdown(fileMenuBtn, fileMenuDropdown);
        setupDropdown(settingsMenuBtn, settingsMenuDropdown);
        window.addEventListener('click', () => {
            fileMenuDropdown.classList.add('hidden');
            settingsMenuDropdown.classList.add('hidden');
        });

        importTextBtn.addEventListener('click', (e) => { e.preventDefault(); textFileInput.click(); });
        exportBtn.addEventListener('click', (e) => { e.preventDefault(); /* showExportFormatModal(); */ });
        shortcutsBtn.addEventListener('click', (e) => { e.preventDefault(); showShortcutsModal(); });
        themeToggleBtn.addEventListener('click', (e) => { e.preventDefault(); applyTheme(isDarkMode ? 'light' : 'dark'); localStorage.setItem('theme', isDarkMode ? 'dark' : 'light'); });
        languageToggleBtn.addEventListener('click', (e) => { e.preventDefault(); /* showLanguageSelectionModal(); */ });

        boldBtn.addEventListener('click', () => document.execCommand('bold'));
        italicBtn.addEventListener('click', () => document.execCommand('italic'));
        findBtn.addEventListener('click', () => { /* showFindModal(); */ });
        replaceBtn.addEventListener('click', () => { /* showReplaceModal(); */ });

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        });
    });

    document.addEventListener('keydown', (e) => {
        if (listeningForShortcut) {
            e.preventDefault();
            const newShortcutStr = keyEventToString(e);
            shortcuts[listeningForShortcut] = newShortcutStr;
            saveShortcuts();
            const button = document.querySelector(`.shortcut-button[data-action="${listeningForShortcut}"]`);
            if (button) {
                button.textContent = newShortcutStr;
                button.classList.remove('is-listening');
            }
            listeningForShortcut = null;
            return;
        }
        if (document.activeElement.tagName === 'INPUT' || (document.activeElement.isContentEditable && document.activeElement !== editor)) return;
        const pressedShortcut = keyEventToString(e);
        for (const action in shortcuts) {
            if (shortcuts[action] === pressedShortcut) {
                e.preventDefault();
                executeShortcut(action);
                break; 
            }
        }
    });

    function handleMouseMove(e) {
        const totalWidth = document.body.offsetWidth;
        const leftWidth = e.clientX;
        const rightWidth = totalWidth - e.clientX - resizer.offsetWidth;
        if (leftWidth > 320 && rightWidth > 320) {
            leftPanel.style.flexBasis = `${leftWidth}px`;
            rightPanel.style.flexBasis = `${rightWidth}px`;
        }
    }
    function handleMouseUp() {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
    }
  </script>
</body>
</html>
