<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubpandaASS</title>

 <!-- Metaetiquetas para ffmpe -->
<meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- WaveSurfer.js y los plugins de Regiones y Minimapa -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/7.7.5/wavesurfer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/7.7.5/plugins/regions.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/7.7.5/plugins/minimap.min.js"></script>



    <!-- Llamamos a ffmpeg para resolver los cambios de plano -->

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.min.js"></script>

    

    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #075BA2;
            --dark-gray: #1E1E1E;
            --medium-gray: #2D2D2D;
            --light-gray: #373737;
            --text-primary: #EAEAEA;
            --text-secondary: #A0A0A0;
            --subtitle-font-size: 2.5vh; /* Tama√±o de fuente adaptable */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-gray);
            color: var(--text-primary);
            overflow: hidden; /* Evitar scroll en el body */
            user-select: none;
        }

        /* Estilos de WaveSurfer */
        #waveform-wrapper ::-webkit-scrollbar { height: 6px; }
        #waveform-wrapper ::-webkit-scrollbar-track { background: var(--medium-gray); }
        #waveform-wrapper ::-webkit-scrollbar-thumb { background: var(--light-gray); border-radius: 3px; }
        #waveform-wrapper ::-webkit-scrollbar-thumb:hover { background: #4F4F4F; }

        ::part(region) { 
            z-index: 20; 
            overflow: visible !important;
        }

::part(region)[data-id="temp-selection"] {
    z-index: 999 !important;
}

        ::part(region-handle-left), ::part(region-handle-right) { 
            background-color: rgba(255, 255, 255, 0.4); 
            width: 8px;
        }
        
        .region-content {
            position: absolute;
            top: -60px;
            left: 5px;
            font-size: 10px;
            line-height: 1.3;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 5px 8px;
            border-radius: 4px;
            pointer-events: none;
            max-width: 200px;
        }
        .region-content .region-text-line {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .region-content .region-id { font-weight: bold; color: #a4cafe; }
       .region-content .region-stats { color: #facc15; }

::part(region)[data-shot-change] { z-index: 22 !important; cursor: default !important; box-shadow: none !important; }
        
        #tooltip {
            position: absolute; display: none; background-color: #111; color: white; padding: 6px 12px;
            border-radius: 6px; font-size: 0.875rem; z-index: 1000; pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0;
            transform: scale(0.95) translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            white-space: pre-wrap;
        }

        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center;
        }
        #pdf-name-modal { z-index: 101; } /* Z-index m√°s alto para que aparezca encima */
#alert-modal { z-index: 102; }
        .modal-content {
            background-color: var(--medium-gray); margin: auto; padding: 24px; border: 1px solid var(--light-gray);
            width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-height: 90vh; display: flex; flex-direction: column;
        }
        
        /* Estilos para la tabla de subt√≠tulos */
        #subtitle-grid-container { flex-grow: 1; overflow: auto; background-color: var(--medium-gray); border-radius: 8px; }
        #subtitle-grid { table-layout: fixed; }
        #subtitle-grid th { 
            background-color: var(--light-gray); 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            overflow: visible; /* <--- ESTO ES CLAVE para que se vea el borde */
}
        #subtitle-grid td { border-bottom: 1px solid var(--light-gray); word-break: break-word; }
        #subtitle-grid tr:last-child td { border-bottom: none; }
        .subtitle-row.active { background-color: rgba(7, 91, 162, 0.3); }
        .subtitle-row.selected { background-color: rgba(164, 202, 254, 0.2); border-left: 3px solid #A4CAFE; }
        .table-text-preview {
            white-space: pre; /* Respeta los saltos de l√≠nea y evita el auto-ajuste */
            min-width: 45ch;  /* Ancho m√≠nimo de aprox. 45 caracteres */
}
        .style-select {
            background-color: var(--dark-gray);
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            padding: 2px 4px;
            width: 100%;
            font-size: 12px;
        }
        
        .subtitle-row.has-error {
            background-color: rgba(185, 28, 28, 0.1);
            border-left: 3px solid #ef4444;
        }

        .subtitle-row.has-error.active {
    background-color: rgba(7, 91, 162, 0.3); /* Fuerza el fondo azul de "activo" */
}

        .qa-alert-icon {
            color: #f87171; /* red-400 */
            cursor: help;
        }

      /* --- CSS MEJORADO (V2) PARA REDIMENSIONAR COLUMNAS --- */
.th-resizer {
    position: absolute;
    right: -5px; /* Centramos el √°rea de agarre (10px) justo en el borde derecho */
    top: 0;
    height: 100%;
    width: 10px; 
    cursor: col-resize;
    z-index: 20;
    display: flex;
    justify-content: center; /* Centra la l√≠nea visual dentro del √°rea invisible */
}

/* Esta es la l√≠nea visual real */
.th-resizer::after {
    content: '';
    display: block;
    width: 1px;
    height: 100%;
    background-color: #9ca3af; /* Gris claro (m√°s visible que el #666 anterior) */
    transition: all 0.2s;
}

/* Efecto al pasar el rat√≥n */
.th-resizer:hover::after {
    background-color: var(--primary-blue);
    width: 2px; /* Se engrosa ligeramente */
    box-shadow: 0 0 4px rgba(164, 202, 254, 0.6); /* A√±ade un brillo sutil */
}
        
        .time-col-item { display: flex; align-items: center; gap: 8px; }
        .time-col-item .icon { width: 16px; text-align: center; }

        #video-container { position: relative; }
        
        /* --- IN-VIDEO EDITOR & PREVIEW STYLES --- */
     #subtitle-preview {
    position: absolute;
    bottom: 8%;
    left: 10%;
    right: 10%;
    width: 80%;
    z-index: 25;
    text-align: center;
    line-height: 1.4;
    padding: 0.2em 0.4em;
    pointer-events: none;
}

#in-video-editor {
    width: fit-content;      /* El ancho se adapta al contenido */
    max-width: 80%;          /* Pero nunca ser√° m√°s ancho que el 80% del v√≠deo */
    white-space: pre;        /* Respeta los saltos de l√≠nea y no auto-ajusta el texto */
min-width: 25ch;
    background-color: rgba(0, 0, 0, 0.6);
    border: 2px solid transparent; 
    border-radius: 6px;
    resize: none;
    overflow: hidden;
    pointer-events: auto;
    min-height: 1.5em;
}
        
        #in-video-editor {
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid transparent; /* El borde se colorear√° con JS */
            border-radius: 6px;
            resize: none;
            overflow: hidden;
            pointer-events: auto;
            min-height: 1.5em; /* Asegura una altura m√≠nima */
        }
        #in-video-editor:focus {
            outline: none;
            background-color: rgba(0, 0, 0, 0.75);
        }

        #in-video-editor-container { position: absolute; bottom: 8%; left: 10%; right: 10%; z-index: 30; pointer-events: none; }
        
        
        .stats-label { background-color: rgba(0,0,0,0.7); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .stats-label.warning { background-color: #B91C1C; }
        
        #resizer { background-color: var(--light-gray); width: 6px; cursor: col-resize; flex-shrink: 0; transition: background-color 0.2s ease; }
        #resizer:hover { background-color: var(--primary-blue); }

#in-video-original-text-preview {
    white-space: pre-wrap; /* Esta es la propiedad m√°gica */
    text-align: center;
    line-height: 1.3;
}
   
        #context-menu {
            position: absolute; z-index: 1000; width: 220px; background-color: var(--medium-gray);
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 8px;
            border: 1px solid var(--light-gray);
        }
        .context-menu-item {
            display: flex; align-items: center; gap: 8px; padding: 8px 12px; color: var(--text-primary);
            border-radius: 6px; cursor: pointer; font-size: 14px;
        }
        .context-menu-item:hover { background-color: var(--primary-blue); }
        .context-menu-item.danger:hover { background-color: #B91C1C; }
        .context-menu-divider { height: 1px; background-color: var(--light-gray); margin: 6px 0; }
        .qa-input.dark-text, .text-import-input, .ass-style-input { color: #373737 !important; background-color: #EAEAEA !important; }
        .table-stats { color: var(--text-primary); }

        /* Dropdown Menu */
        .menu-wrapper { position: relative; }
        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            padding-top: 8px;
            z-index: 50;
        }
        .menu-dropdown .menu-item-container {
            padding: 8px;
            background-color: var(--medium-gray);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--light-gray);
            min-width: 220px;
        }
        .menu-wrapper:hover .menu-dropdown { display: block; }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        .menu-item:hover { background-color: var(--primary-blue); }
        .menu-item:disabled { opacity: 0.5; cursor: not-allowed; background-color: transparent; }
        
        .slider-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
        }
        .slider-control label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            width: 80px;
        }
        .horizontal-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--dark-gray);
            outline: none;
            border-radius: 3px;
        }
        .horizontal-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #A4CAFE;
            cursor: pointer;
            border-radius: 50%;
        }
        .horizontal-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #A4CAFE;
            cursor: pointer;
            border-radius: 50%;
        }
        /* Drag and Drop Overlay */
        #drag-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(7, 91, 162, 0.7); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            border: 4px dashed #A4CAFE;
            pointer-events: none;
        }
        #drag-overlay.visible { display: flex; }
        
        /* QA Modal Styling */
        .qa-input-group { display: flex; align-items: center; gap: 8px; }
        .qa-input-group input { max-width: 80px; }
        .qa-unit-select { background-color: var(--dark-gray); border: 1px solid var(--light-gray); border-radius: 6px; padding: 4px; font-size: 12px; }
        .qa-group { border: 1px solid var(--light-gray); border-radius: 8px; padding: 12px; margin-top: 16px; }
        .qa-group-title { font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9rem; }
        .qa-rule-description { font-size: 12px; color: var(--text-secondary); margin-top: 4px; padding-left: 4px; }

        /* Toggle Switch Styles */
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--light-gray); transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(18px); }
        
        /* Shortcut Input Style */
        .shortcut-input { background-color: var(--dark-gray); border: 1px solid var(--light-gray); color: var(--text-primary); padding: 6px 10px; border-radius: 6px; text-align: center; cursor: pointer; width: 150px; }
        .shortcut-input:focus { outline: 2px solid var(--primary-blue); border-color: var(--primary-blue); }

        /* Text Import Modal Styles */
        #import-text-modal .modal-content { max-width: 90vw; width: 1200px; height: 90vh; }
        #text-import-main-area { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        #text-import-textarea { flex-grow: 1; resize: none; background-color: var(--dark-gray); color: var(--text-primary); border: 1px solid var(--light-gray); border-radius: 8px; padding: 12px; font-family: monospace; height: 400px; }
        #text-import-preview-container { flex-shrink: 0; overflow-y: auto; background-color: var(--dark-gray); border: 1px solid var(--light-gray); border-radius: 8px; }
        #text-import-resizer { background-color: var(--light-gray); height: 8px; cursor: row-resize; flex-shrink: 0; margin: 4px 0; border-radius: 4px; }
        #text-import-resizer:hover { background-color: var(--primary-blue); }
        .compact-btn { padding: 0.25rem 0.75rem !important; height: 36px !important; font-size: 0.875rem !important; }
        .compact-icon-btn { padding: 0 !important; width: 36px !important; height: 36px !important; }
        
       /* --- INICIO: ESTILOS CORREGIDOS DEL EDITOR ASS --- */

/* --- Estilos base del modal y layout --- */
#ass-style-editor-modal .modal-content { max-width: 1000px; }
.style-editor-layout { display: grid; grid-template-columns: 200px 1fr; gap: 20px; }

/* --- Columna Izquierda (Lista de estilos) --- */
#style-list-container { 
    border-right: 1px solid var(--light-gray); 
    padding-right: 20px; 
}
#style-list { 
    list-style: none; padding: 0; margin: 0; 
    max-height: 75vh; /* Aumentado para coincidir con el form */
    overflow-y: auto; 
}
#style-list li { 
    padding: 8px 12px; border-radius: 6px; 
    cursor: pointer; margin-bottom: 4px; 
}
#style-list li:hover { background-color: var(--light-gray); }
#style-list li.active { background-color: var(--primary-blue); font-weight: bold; }

/* --- Columna Derecha (Formulario) --- */
#style-form-container {
    display: flex;
    flex-direction: column;
    max-height: 75vh; /* Altura m√°xima para el contenedor del form */
}

/* 1. Vista Previa (Arriba) */
#style-preview-wrapper {
    flex-shrink: 0; /* Evita que se encoja */
    position: relative;
    background-color: #1a1a1a;
    border: 1px solid var(--light-gray);
    min-height: 140px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    overflow: hidden; 
}
#style-preview-text {
    font-size: 28px;
    color: white;
    text-align: center;
    line-height: 1.3;
    position: relative; 
}

/* 2. Opciones (Centro, con scroll) */
#style-options-scroller {
    flex-grow: 1; /* Ocupa el espacio restante */
    overflow-y: auto;
    min-height: 0; /* Clave para que flex-grow funcione */
    padding-right: 8px; /* Espacio para la barra de scroll */
}

/* 3. Botones (Abajo) */
/* (El div de botones ya tiene 'flex-shrink-0' en el HTML, lo que es correcto) */

/* --- Grupos de Opciones Internos --- */
.style-group {
    border: 1px solid var(--light-gray);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
}
.style-group-title {
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 12px;
    font-size: 0.9rem;
}
details.style-group { padding: 0; }
details.style-group summary { padding: 12px 16px; cursor: pointer; }
details.style-group .style-group-grid { padding: 0 16px 12px 16px; }

/* --- Rejillas de Campos --- */
.style-group-grid {
    display: grid;
    gap: 12px 16px;
}
/* Esto reemplaza al viejo .style-form-grid */
.style-group-grid.two-cols { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
.style-group-grid.three-cols { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }

/* --- Componentes Espec√≠ficos --- */

/* Pickers de Color */
.color-input-wrapper { display: flex; align-items: center; gap: 8px; }
.color-input-wrapper input[type="color"] {
    -webkit-appearance: none; -moz-appearance: none; appearance: none;
    width: 32px; height: 32px; padding: 0; border: none; 
    background: none; border-radius: 6px; cursor: pointer;
}
.color-input-wrapper input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
.color-input-wrapper input[type="color"]::-webkit-color-swatch { 
    border: 1px solid var(--light-gray); border-radius: 6px; 
}

/* Grid de Alineaci√≥n (Numpad) */
.alignment-grid-wrapper { flex-shrink: 0; } /* Evita que se encoja */
.alignment-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    max-width: 120px;
}
.alignment-grid button {
    width: 36px;
    height: 36px;
    background-color: var(--dark-gray);
    border: 1px solid var(--light-gray);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}
.alignment-grid button:hover { background-color: var(--light-gray); }
.alignment-grid button.active {
    background-color: var(--primary-blue);
    border-color: var(--primary-blue);
    box-shadow: 0 0 8px rgba(164, 202, 254, 0.5);
}
/* --- FIN: ESTILOS CORREGIDOS DEL EDITOR ASS --- */

/* --- ESTILOS PARA LA NUEVA BARRA DE PROGRESO --- */
#custom-progress-bar-container {
    position: relative; /* Necesario para la l√≠nea de apoyo */
    height: 30px;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#progress-bar {
    padding: 8px 0; /* Aumenta el √°rea clicable */
}
#progress-bar-background, #progress-bar-played {
    height: 6px;
    transition: height 0.2s ease;
}
#progress-bar-handle {
    background-color: var(--light-gray); /* Color discreto por defecto */
    transition: all 0.2s ease;
    opacity: 1; /* Siempre visible */
}
#progress-hover-line {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    left: 0; right: 0;
    height: 1px;
    background-color: var(--light-gray); /* Color discreto por defecto */
    pointer-events: none;
    transition: background-color 0.2s ease;
    z-index: 1;
}
/* Efecto de "encendido" al pasar el rat√≥n */
#custom-progress-bar-container:hover #progress-bar-background,
#custom-progress-bar-container:hover #progress-bar-played {
    height: 8px;
}
#custom-progress-bar-container:hover #progress-bar-handle,
#custom-progress-bar-container:hover #progress-hover-line {
    background-color: var(--primary-blue); /* Se ilumina con el color del logo */
}
#custom-progress-bar-container:hover #progress-bar-handle {
     transform: translate(-50%, -50%) scale(1.1);
}

#find-replace-toolbar input[type="text"] {
    height: 36px;           /* Misma altura que los botones compactos */
    border-radius: 8px;     /* Mismas esquinas redondeadas (rounded-lg) */
    border: none;           /* Quitamos el borde por defecto */
    padding-left: 0.75rem;   /* A√±adimos un poco de padding interno */
    padding-right: 0.75rem;
}

#waveform-wrapper {
    background-color: #2A2A2A;
}

.onda-progreso-azul-principal ::part(progress) {
    background-color: #202020;
}

        .icon-btn {
            background-color: var(--light-gray); color: var(--text-primary); border: none; border-radius: 8px;
            padding: 0; width: 44px; height: 44px; cursor: pointer; transition: all 0.2s ease-in-out;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .text-btn {
            background-color: var(--light-gray); color: var(--text-primary); border: none; border-radius: 8px;
            padding: 0.5rem 1rem; height: 44px; cursor: pointer; transition: all 0.2s ease-in-out;
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: 600;
        }
        .text-btn:hover, .icon-btn:hover { background-color: #4F4F4F; transform: translateY(-1px); }
        .text-btn:disabled, .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: translateY(0); }
        #waveform ::part(wave) {
            background: linear-gradient(to right, #A4CAFE, #CDB4DB);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
       

/* --- NUEVO ESTILO PARA EL MEN√ö DEL HEADER --- */
        .header-menu-btn {
            background-color: var(--light-gray); 
            color: var(--text-primary); 
            border: none; 
            border-radius: 6px; /* Un poco m√°s peque√±o que 8px */
            padding: 0.25rem 0.75rem; /* 4px vertical, 12px horizontal */
            height: auto; /* La altura la define el padding */
            cursor: pointer; 
            transition: all 0.2s ease-in-out;
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            font-weight: 500; /* Un poco m√°s fino que 600 */
            font-size: 14px; /* Texto m√°s peque√±o */
        }
        .header-menu-btn:hover { background-color: #4F4F4F; transform: translateY(-1px); }
        .header-menu-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: translateY(0); }
        /* --- FIN DEL NUEVO ESTILO --- */
.compact-icon-btn { padding: 0 !important; width: 32px !important; height: 32px !important; }

 #waveform-minimap ::part(minimap-overlay) {
            background-color: rgba(7, 91, 162, 0.25);
            border: 1px solid var(--primary-blue);
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(164, 202, 254, 0.5);
        }

/* --- ESTILOS PARA LA BARRA DE BUSCAR Y REEMPLAZAR --- */
#find-replace-toolbar {
    opacity: 0;
    transform: translateY(100%);
    transition: opacity 0.3s ease, transform 0.3s ease;
    pointer-events: none;
    z-index: 20; /* Para que est√© por encima de la tabla */
background-color: #202020;
}
#find-replace-toolbar.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}
#find-replace-toolbar input {
    width: 150px; /* Ancho base para los inputs */
    flex-grow: 1; /* Permite que crezcan */
}
#fr-bar-close-btn {
    font-size: 24px;
    line-height: 1;
}

.symbol-button {
    /* NOTA: Nuevos estilos para hacer los botones peque√±os y cuadrados */
    width: 36px;
    height: 36px;
    font-size: 14px; /* Tama√±o de fuente similar a 10pt */
    border-radius: 6px;
    cursor: pointer;
    background-color: var(--dark-gray);
    transition: background-color 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.symbol-button:hover {
    background-color: var(--primary-blue);
}

.category-button {
    display: block;
    width: 100%;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    text-align: left;
    font-size: 14px;
    margin-bottom: 4px;
}
.category-button:hover {
    background-color: var(--light-gray);
}
.category-button.active {
    background-color: var(--primary-blue);
    font-weight: bold;
}

/* NOTA: Estilo para los elementos de la lista en la ventana de Cargar Proyecto */
.recent-project-item {
    display: block;
    width: 100%;
    padding: 10px 14px;
    border-radius: 6px;
    cursor: pointer;
    text-align: left;
    font-size: 14px;
    background-color: var(--dark-gray);
    transition: background-color 0.2s ease;
    border: 1px solid var(--light-gray);
}
.recent-project-item:hover {
    background-color: var(--primary-blue);
}
.recent-project-item-name {
    font-style: italic;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.no-recent-projects {
    font-size: 14px;
    color: var(--text-secondary);
    text-align: center;
    padding: 16px;
}

/* --- Estilos para el Panel de QA Flotante (V2) --- */
.floating-pane {
    position: absolute;
    top: 100px;
    right: 20px;
    width: 450px;
    min-width: 350px;
    min-height: 200px;
    max-height: 80vh;
    background-color: #252525;
    border: 1px solid #4a4a4a;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 101;
    display: flex; /* Clave para la estructura */
    flex-direction: column; /* Organiza header y content verticalmente */
}

.hidden {
    display: none !important;
}

.floating-pane-header {
    display: flex; /* ¬°NUEVO! Activa Flexbox */
    justify-content: space-between; /* ¬°NUEVO! Empuja t√≠tulo y botones a los extremos */
    align-items: center; /* ¬°NUEVO! Centra verticalmente los elementos */
    padding: 8px 12px; /* ¬°NUEVO! A√±ade espaciado interno */
    background-color: #333333;
    border-bottom: 1px solid #4a4a4a; /* A√±ade un separador sutil */
    cursor: move;
}

.floating-pane-header h2 {
    color: var(--text-primary);
    margin: 0; /* Quita m√°rgenes por defecto del h2 */
    font-size: 1.1rem; /* Ajusta el tama√±o de la fuente */
}

.floating-pane-content {
    flex-grow: 1; /* ¬°NUEVO! Hace que el contenido ocupe el espacio disponible */
    overflow-y: auto; /* ¬°NUEVO! A√ëADE EL SCROLL VERTICAL AUTOM√ÅTICO */
    padding: 8px 12px;
    min-height: 0; /* Necesario para que flex-grow funcione correctamente */
}


.qa-review-item {
    background-color: #3D3D3D;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid transparent;
    transition: border-color 0.2s;
}
.qa-review-item:hover {
    border-color: #4a4a4a;
}

/* ¬°NUEVO! Este es el estilo para el error "encendido" o activo */
.qa-review-item.active {
    background-color: #1e1e1e;
    border-color: #4f4f4f;
    box-shadow: 0 0 8px rgba(7, 91, 162, 0.5);
}

/* Tambi√©n cambiamos el color del texto del header para que sea legible */
.qa-review-item.active .qa-review-item-header {
    color: white;
    font-weight: bold;
}

.qa-review-item-header {
    width: 100%;
    padding: 10px 12px;
    background-color: #111;
    border: none;
    border-radius: 8px 8px 0 0;
    text-align: left;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.9rem;
}


.qa-review-item-errors {
    color: #cccccc;
    font-size: 14px;
margin: 10px;
}


.qa-item-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 0 12px 10px 12px;
}

.qa-action-btn {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid #4a4a4a;
    cursor: pointer;
    background-color: var(--light-gray);
    color: var(--text-secondary);
    transition: all 0.2s;
}

.qa-action-btn:hover {
    color: var(--text-primary);
    border-color: var(--primary-blue);
    background-color: var(--primary-blue);
}


.resizer {
    position: absolute;
    width: 10px;
    height: 10px;
    background: transparent;
    z-index: 102;
}

.resizer.top-left { top: -5px; left: -5px; cursor: nwse-resize; }
.resizer.top-right { top: -5px; right: -5px; cursor: nesw-resize; }
.resizer.bottom-left { bottom: -5px; left: -5px; cursor: nesw-resize; }
.resizer.bottom-right { bottom: -5px; right: -5px; cursor: nwse-resize; }
.resizer.top { top: -5px; left: 5px; right: 5px; height: 10px; cursor: ns-resize; }
.resizer.bottom { bottom: -5px; left: 5px; right: 5px; height: 10px; cursor: ns-resize; }
.resizer.left { top: 5px; bottom: 5px; left: -5px; width: 10px; cursor: ew-resize; }
.resizer.right { top: 5px; bottom: 5px; right: -5px; width: 10px; cursor: ew-resize; }

.qa-panel-tabs {
    display: flex;
    padding: 8px 12px 0 12px;
    background-color: #252525;
    gap: 4px;
}

.qa-tab-btn {
    padding: 8px 16px;
    border: 1px solid transparent;
    border-bottom: 1px solid #4a4a4a;
    background-color: transparent;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 6px 6px 0 0;
}

.qa-tab-btn:hover {
    color: var(--text-primary);
    background-color: var(--light-gray);
}

.qa-tab-btn.active {
    color: var(--text-primary);
    background-color: var(--medium-gray);
    border-color: #4a4a4a;
    border-bottom-color: var(--medium-gray);
}

/* --- Estilos para los nuevos botones del header --- */

.header-button-group {
    display: flex;
    gap: 6px;
}

.header-icon-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--dark-gray);
    color: var(--text-secondary);
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid var(--light-gray);
    transition: all 0.2s;
}

.header-icon-btn:hover {
    background-color: var(--primary-blue);
    color: var(--text-primary);
    border-color: var(--primary-blue);
}

.header-icon-btn.close-btn {
    background-color: transparent;
    border: none;
    font-size: 24px;
    font-weight: bold;
}

.header-icon-btn.close-btn:hover {
    color: #ef4444; /* Rojo para el bot√≥n de cerrar */
    background: none;
}

#export-qa-report-modal {
    z-index: 102; /* M√°s alto que el z-index: 101 del panel flotante */
}

.resizer.top { top: -5px; left: 5px; right: 5px; height: 10px; cursor: ns-resize; }
.resizer.bottom { bottom: -5px; left: 5px; right: 5px; height: 10px; cursor: ns-resize; }
.resizer.left { top: 5px; bottom: 5px; left: -5px; width: 10px; cursor: ew-resize; }
.resizer.right { top: 5px; bottom: 5px; right: -5px; width: 10px; cursor: ew-resize; }

    </style>

</head>
<body class="flex flex-col h-screen p-3 md:p-4 gap-4">

    <header class="relative w-full flex justify-center items-center bg-transparent flex-shrink-0 z-50">

        <div class="flex items-center gap-2">
            
            <div class="menu-wrapper">
                <button class="header-menu-btn" data-i18n="menu_file">Archivo</button>
                <div class="menu-dropdown">
                    <div class="menu-item-container">
                        <div id="new-project-btn" class="menu-item"><span data-i18n="new_project">Nuevo proyecto</span></div>
                        <div id="open-load-project-modal-btn" class="menu-item"><span data-i18n="load_project">Cargar proyecto...</span></div>
                        
                        <div id="export-project" class="menu-item"><span data-i18n="save_project">Guardar proyecto...</span></div>
                        <div class="context-menu-divider"></div>
                        <label for="srt-loader" class="menu-item"><span data-i18n="open_srt">Abrir .srt</span></label>
                        <label for="ass-loader" class="menu-item"><span data-i18n="open_ass">Abrir .ass</span></label>
                        <label for="translation-loader" class="menu-item"><span data-i18n="translate_subs">Traducir subt√≠tulos...</span></label>

                        <div class="context-menu-divider"></div>
                        <div id="export-srt" class="menu-item"><span data-i18n="save_srt">Guardar .srt</span></div>
                        <div id="export-ass" class="menu-item"><span data-i18n="save_ass">Guardar .ass</span></div>
                        <div class="context-menu-divider"></div>
                        <div id="open-backup-modal-btn" class="menu-item"><span data-i18n="backup">Copia de seguridad</span></div>
                        <div class="context-menu-divider"></div>
                        <div id="open-text-import-modal-btn" class="menu-item"><span data-i18n="import_text">Crear subt√≠tulos desde texto</span></div>
                        <div class="context-menu-divider"></div>
                        <label for="video-loader" class="menu-item"><span data-i18n="load_video">Cargar v√≠deo</span></label>
                        <div class="context-menu-divider"></div>
                        <label for="shot-change-loader" class="menu-item"><span data-i18n="import_shot_changes">Importar cambios de plano (.txt)</span></label>
                    </div>
                </div>
            </div>

            <div class="menu-wrapper">
                <button class="header-menu-btn" data-i18n="menu_edit">Editar</button>
                <div class="menu-dropdown">
                    <div class="menu-item-container">
                        <button id="undo-btn" class="menu-item w-full" disabled><span data-i18n="undo">Deshacer (Ctrl+Z)</span></button>
                        <button id="redo-btn" class="menu-item w-full" disabled><span data-i18n="redo">Rehacer (Ctrl+Y)</span></button>
                        <div class="context-menu-divider"></div>
                        <button id="edit-menu-bold-btn" class="menu-item w-full"><span data-i18n="bold">Negrita (Ctrl+B)</span></button>
                        <button id="edit-menu-italic-btn" class="menu-item w-full"><span data-i18n="italic">Cursiva (Ctrl+I)</span></button>
                        <div class="context-menu-divider"></div>
                        <button id="open-symbol-modal-btn" class="menu-item w-full"><span data-i18n="add_symbol">A√±adir s√≠mbolo</span></button>
                        <div class="context-menu-divider"></div>
                        <button id="open-find-replace-modal-btn" class="menu-item w-full"><span data-i18n="find_replace">Buscar y reemplazar</span></button>
                        <div class="context-menu-divider"></div>
                        <button id="open-ass-style-editor-btn" class="menu-item w-full"><span data-i18n="ass_style_editor">Editor de estilos ASS</span></button>
                    </div>
                </div>
            </div>

            <div class="menu-wrapper">
                <button class="header-menu-btn" data-i18n="menu_tools">Herramientas</button>
                <div class="menu-dropdown">
                    <div class="menu-item-container">
                        <div id="tool-shot-change-btn" class="menu-item">
                            <span data-i18n="tool_shot_changes">Detector de cambios de plano</span>
                        </div>
                        <div class="context-menu-divider"></div>
                        <div id="tool-auto-transcription-btn" class="menu-item">
                            <span data-i18n="tool_auto_transcription">Subt√≠tulos autom√°ticos con transcripci√≥n</span>
                        </div>
                        <div id="tool-auto-spotting-btn" class="menu-item">
                            <span data-i18n="tool_auto_spotting">Prepautado (spotting)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu-wrapper">
                <button class="header-menu-btn" data-i18n="menu_mode">Modo de trabajo</button>
                <div class="menu-dropdown">
                    <div class="menu-item-container">
                        <button id="mode-edit-btn" class="menu-item w-full"><span data-i18n="mode_edit">Modo Edici√≥n</span></button>
                        <button id="mode-sync-btn" class="menu-item w-full"><span data-i18n="mode_sync">Modo Sincronizaci√≥n</span></button>
                        <button id="mode-preview-btn" class="menu-item w-full"><span data-i18n="mode_preview">Modo Vista Previa</span></button>
                    </div>
                </div>
            </div>

            <input type="file" id="video-loader" class="hidden" accept="video/*">
            <input type="file" id="srt-loader" class="hidden" accept=".srt">
            <input type="file" id="ass-loader" class="hidden" accept=".ass">
            <input type="file" id="translation-loader" class="hidden" accept=".srt,.ass">
            <input type="file" id="txt-loader" class="hidden" accept=".txt,text/plain">
            <input type="file" id="project-loader" class="hidden" accept=".json,application/json">
            <input type="file" id="shortcuts-loader" class="hidden" accept=".json,application/json">
            <input type="file" id="qa-profile-loader" class="hidden" accept=".json,application/json">
            <input type="file" id="shot-change-loader" class="hidden" accept=".txt,text/plain">

            <button id="qa-review-modal-btn" class="header-menu-btn" data-i18n="qa_review">Revisi√≥n de QA</button>
            <button id="qa-settings-modal-btn" class="header-menu-btn" data-i18n="qa_settings">Ajustes de QA</button>
            <button id="open-shortcuts-modal" class="header-menu-btn" data-i18n="shortcuts">Atajos</button>
        </div>

        <div class="absolute right-4 top-1/2 -translate-y-1/2">
            <div class="menu-wrapper">
                <button id="lang-selector-btn" class="header-menu-btn">
                    <span class="text-lg mr-1">üåê</span> <span id="current-lang-label">ES</span>
                </button>
                <div class="menu-dropdown">
                    <div class="menu-item-container">
                        <div class="menu-item" onclick="changeLanguage('es')"><span>ES - Espa√±ol</span></div>
                        <div class="menu-item" onclick="changeLanguage('en')"><span>EN - English</span></div>
                    </div>
                </div>
            </div>
        </div>

    </header>

    <div class="flex-grow flex flex-col md:flex-row gap-4 min-h-0">
        <main id="left-panel" class="w-full md:w-1/2 lg:w-1/2 flex flex-col gap-4">
            <div id="video-wrapper" class="flex-grow min-h-0 relative">
                <div id="video-container" class="w-full h-full bg-black rounded-lg overflow-hidden shadow-lg">
                    <video id="video-player" class="w-full h-full" crossOrigin="anonymous"></video>
                    <div id="subtitle-preview"></div>
                    <div id="in-video-editor-container" class="absolute bottom-[8%] left-[10%] right-[10%] z-30 pointer-events-none hidden items-center justify-center gap-2">
                        <div id="in-video-stats-left" class="flex flex-col gap-1 items-start pointer-events-auto"></div>
                        
                        <div class="flex flex-col items-center w-full">
                            <div id="in-video-original-text-preview" class="text-sm text-yellow-300 bg-black/50 px-2 py-1 rounded-md mb-1 hidden"></div>
                            <div id="in-video-editor" contenteditable="true" spellcheck="false"></div>
                        </div>

                        <div id="in-video-stats-right" class="flex flex-col gap-1 items-end pointer-events-auto"></div>
                    </div>                </div>
            </div>

            <div id="custom-progress-bar-container" class="flex items-center gap-3 w-full px-1 flex-shrink-0">
                <span id="progress-time-current" class="font-mono text-sm text-gray-400">00:00:00,000</span>
                <div id="progress-bar" class="relative w-full h-2 cursor-pointer">
                    <div id="progress-bar-background" class="absolute w-full h-full bg-light-gray rounded-full top-0 left-0"></div>
                    <div id="progress-hover-line"></div><div id="progress-bar-played" class="absolute h-full bg-primary-blue rounded-full top-0 left-0"></div>
                    <div id="progress-bar-handle" class="absolute w-4 h-4 bg-white rounded-full top-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity"></div>
                </div>
                <span id="progress-time-duration" class="font-mono text-sm text-gray-400">00:00:00,000</span>
            </div>
            <div id="waveform-minimap" class="w-full h-20 bg-medium-gray rounded-lg shadow-inner mt-2"></div>

            <div id="waveform-wrapper" class="w-full h-40 bg-medium-gray rounded-lg p-2 shadow-inner relative flex-shrink-0">
                <div id="waveform" class="h-full onda-progreso-azul-principal"></div>
                <div id="loading-indicator" class="absolute inset-0 flex flex-col items-center justify-center h-full text-gray-300 bg-medium-gray/80 rounded-lg gap-4">
                    <img src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/subpanda-ass-logo-v1.png" alt="SubpandaASS Logo" class="h-20 opacity-100" style="filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));">
                    <label for="video-loader" class="bg-black/70 px-4 py-2 rounded-lg cursor-pointer hover:bg-black/90 transition-colors"><span data-i18n="load_video">Cargar v√≠deo</span></label>
                </div>
            </div>


            
             <div id="secondary-controls" class="flex items-center justify-between gap-4 bg-medium-gray p-2 rounded-lg flex-shrink-0">
                <div class="slider-control w-1/4">
                    <label for="volume-slider-h" data-i18n="slider_vol">Volumen</label>
                    <input type="range" id="volume-slider-h" class="horizontal-slider" min="0" max="1" step="0.01" value="1">
                    <span id="volume-value" class="w-12 text-center text-xs">100%</span>
                </div>
                <div class="slider-control w-1/4">
                    <label for="zoom-slider-h" data-i18n="slider_zoom">Zoom</label>
                    <input type="range" id="zoom-slider-h" class="horizontal-slider" min="10" max="500" step="1" value="50">
                    <span id="zoom-value" class="w-12 text-center text-xs">50</span>
                </div>
                <div class="slider-control w-1/4">
                    <label for="speed-slider-h" data-i18n="slider_speed">Velocidad</label>
                    <input type="range" id="speed-slider-h" class="horizontal-slider" min="0" max="5" step="1" value="2">
                    <span id="speed-value" class="w-12 text-center text-xs">1x</span>
                </div>
 
                <div id="work-mode-display" class="text-xs text-gray-400 font-semibold w-1/4 text-center" data-i18n="mode_edit">Modo Edici√≥n</div>
        </div> 
             <div id="controls-bar" class="flex items-center justify-between gap-4 bg-medium-gray p-2 rounded-lg flex-shrink-0">
                <div class="flex items-center gap-2">
                    <button id="play-pause-btn" class="icon-btn" data-tooltip="Reproducir/Pausa (Alt+P)" data-i18n-tooltip="btn_play_pause">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.648c1.295.742 1.295 2.545 0 3.286L7.279 20.99c-1.25.717-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" /></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden"><path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1-.75-.75V5.25Z" clip-rule="evenodd" /></svg>
                    </button>
                    <button id="set-in-btn" class="icon-btn" data-tooltip="Marcar Inicio (Alt+Q)" data-i18n-tooltip="btn_set_in">
                        <span class="font-bold text-lg -mt-0.5">[</span>
                    </button>
                    <button id="set-out-btn" class="icon-btn" data-tooltip="Marcar Fin (Alt+W)" data-i18n-tooltip="btn_set_out">
                        <span class="font-bold text-lg -mt-0.5">]</span>
                    </button>
                    <button id="press-and-hold-btn" class="icon-btn" data-tooltip="Crea un subt√≠tulo al pulsar, ci√©rralo al soltar" data-i18n-tooltip="sc_desc_createAndHold">
                        <span class="text-2xl">üêº</span>
                    </button>
                </div>
                <div class="flex-grow"></div>
                <div class="flex items-center gap-2">
                <button id="detect-shots-btn" class="text-btn disabled:opacity-50" disabled data-i18n="btn_detect_shots">Cambios de plano</button>
                    <div id="timecode-display" class="text-lg font-mono bg-dark-gray px-3 py-1 rounded-md">00:00:00,000</div>
                    <button id="time-format-toggle" class="icon-btn" data-tooltip="Cambiar formato de tiempo" data-i18n-tooltip="btn_toggle_time">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                    </button>
                    <label for="fps-input" class="text-xs font-semibold text-gray-400" data-i18n="label_fps">FPS</label>
                    <select id="fps-input" class="bg-dark-gray w-20 text-center rounded-md p-1 h-11 qa-input dark-text">
                        <option value="23.976">23.976</option>
                        <option value="24">24</option>
                        <option value="25" selected>25</option>
                        <option value="29.97">29.97</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                        <option value="59.94">59.94</option>
                        <option value="60">60</option>
                    </select>
                </div>
            </div>
        </main>

        <div id="resizer"></div>

        <aside id="right-panel" class="w-full md:w-1/2 lg:w-1/2 flex flex-col gap-2">
            <div class="flex justify-between items-center flex-shrink-0">
                <h2 class="text-lg font-semibold" data-i18n="header_subs">Subt√≠tulos</h2>
                
                <div class="menu-wrapper">
                    <button id="toggle-columns-btn" class="icon-btn compact-icon-btn" data-tooltip="Mostrar/Ocultar Columnas">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.438 1.001v.192c0 .387.145.76.438 1.001l1.003.827c.48.398.664 1.03.26 1.431l-1.296 2.247a1.125 1.125 0 0 1-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 0 1-.22.127c-.332.183-.582.495-.645.87l-.213 1.281c-.09.543-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.437-1.001v-.192c0-.387-.145-.76-.437-1.001l-1.004-.827a1.125 1.125 0 0 1-.26-1.431l1.296-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.075-.124.072-.044.146-.087.22-.127.332-.183.582-.495.645-.87l.213-1.281Z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                    </button>
                    <div class="menu-dropdown">
                        <div id="columns-menu-container" class="menu-item-container">
                            </div>
                    </div>
                </div>
            </div>
            <div id="subtitle-grid-container" class="min-h-0">
                <table id="subtitle-grid" class="w-full text-left text-sm">
                    <thead class="text-xs text-gray-400 uppercase">
                        <tr>
                            <th id="qa-header" class="p-2 relative text-center col-qa" style="width: 4ch;" data-i18n="col_qa">!</th>
                            <th id="id-header" class="p-2 relative col-id" style="width: 4ch;" data-i18n="col_id">#</th>
                            <th id="times-header" class="p-2 relative col-times" style="width: 15ch;" data-i18n="col_times">Tiempos</th>
                            <th id="original-text-header" class="p-2 relative col-original-text" style="width: 26%;" data-i18n="col_original">Original</th>
                            <th id="text-header" class="p-2 relative col-text" style="width: 26%;" data-i18n="col_translation">Traducci√≥n</th>
                            <th id="cps-header" class="p-2 relative text-center col-cps" style="width: 6ch;">CPS</th>
                            <th id="wpm-header" class="p-2 relative text-center col-wpm" style="width: 10%;">PPM</th>
                            <th id="lines-header" class="p-2 relative col-lines" style="width: 8ch;" data-i18n="col_lines">L√≠neas</th>
                            <th id="style-header" class="p-2 relative col-style" style="width: 8ch;" data-i18n="col_style">Estilo ASS</th>
                        </tr>
                    </thead>
                    <tbody id="subtitle-body"></tbody>
                </table>
                <div id="find-replace-toolbar" class="sticky bottom-0 left-0 w-full p-2 border-t border-light-gray bg-medium-gray flex items-center gap-2 text-sm">
                    <input type="text" id="fr-bar-find-input" placeholder="Buscar..." data-i18n-placeholder="fr_find_ph" class="ass-style-input flex-grow">
                    <button id="fr-bar-prev-btn" class="icon-btn compact-icon-btn" data-tooltip="Anterior">‚óÄ</button>
                    <span id="fr-bar-search-count" class="font-mono text-xs w-16 text-center">0 / 0</span>
                    <button id="fr-bar-next-btn" class="icon-btn compact-icon-btn" data-tooltip="Siguiente">‚ñ∂</button>
                    <div class="border-l h-6 border-light-gray mx-2"></div>
                    <input type="text" id="fr-bar-replace-input" placeholder="Reemplazar con..." data-i18n-placeholder="fr_replace_ph" class="ass-style-input flex-grow">
                    <button id="fr-bar-replace-btn" data-i18n="fr_btn_replace" class="text-btn compact-btn">Reemplazar</button>
                    <button id="fr-bar-replace-all-btn" data-i18n="fr_btn_replace_all" class="text-btn compact-btn">Todo</button>
                    <div class="border-l h-6 border-light-gray mx-2"></div>
                    <button id="fr-bar-close-btn" class="icon-btn compact-icon-btn" data-tooltip="Cerrar"data-i18n-tooltip="btn_close">&times;</button>
                </div>
            </div>
        </aside>
    </div>

    <div id="context-menu" class="hidden">
        <div id="ctx-menu-split" class="context-menu-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9.75 16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0 0 20.25 18V5.75A2.25 2.25 0 0 0 18 3.5H6A2.25 2.25 0 0 0 3.75 5.75v12.25A2.25 2.25 0 0 0 6 20.25Z" /></svg>
            <span data-i18n="ctx_split">Dividir Subt√≠tulo</span>
        </div>
        <div class="context-menu-divider"></div>
        <div id="ctx-menu-merge-prev" class="context-menu-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5" /></svg>
            <span data-i18n="ctx_merge_prev">Unir con anterior</span>
        </div>
        <div id="ctx-menu-merge-next" class="context-menu-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m5.25 4.5 7.5 7.5-7.5 7.5m6-15 7.5 7.5-7.5 7.5" /></svg>
            <span data-i18n="ctx_merge_next">Unir con siguiente</span>
        </div>
        <div class="context-menu-divider"></div>
        <div id="ctx-menu-change-style" class="context-menu-item">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.475 2.118A2.25 2.25 0 0 1 1.5 18.5v-1.128a2.25 2.25 0 0 1 2.475-2.118A3 3 0 0 0 9.53 16.122ZM12.25 18.75a4.5 4.5 0 0 0 4.5-4.5v-1.5a3.75 3.75 0 0 0-3.75-3.75h-1.5a.75.75 0 1 1 0-1.5h1.5a5.25 5.25 0 0 1 5.25 5.25v1.5a2.25 2.25 0 0 1-2.25 2.25a2.25 2.25 0 0 1-2.25-2.25V17.25a.75.75 0 0 0-1.5 0v1.5a4.5 4.5 0 0 0 4.5 4.5Z" /></svg>
            <span data-i18n="ctx_change_style">Cambiar estilo</span>
            <div class="menu-dropdown" id="ctx-style-submenu" style="position: absolute; left: 100%; top: 0; display: none;">
                <div class="menu-item-container"></div>
            </div>
        </div>
        <div class="context-menu-divider"></div>
        <div id="ctx-menu-delete" class="context-menu-item danger">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
            <span data-i18n="ctx_delete">Eliminar Subt√≠tulo</span>
        </div>
    </div>

    <div id="shortcuts-modal" class="modal"><div class="modal-content"></div></div>
    <div id="alert-modal" class="modal"><div class="modal-content"></div></div>
    <div id="confirmation-modal" class="modal"><div class="modal-content"></div></div>
    <div id="pdf-name-modal" class="modal"><div class="modal-content"></div></div>
    <div id="progress-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4" data-i18n="msg_analyzing">Analizando...</h2>
            <div class="w-full bg-gray-600 rounded-full h-4 mb-2">
                <div id="shot-detection-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="shot-detection-progress-text" class="text-center text-sm mb-4">0%</div>
            <button id="cancel-detection-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" data-i18n="btn_cancel">Cancelar</button>
        </div>
    </div>
    <div id="qa-settings-modal" class="modal"><div class="modal-content"></div></div>
    <div id="qa-review-panel" class="floating-pane hidden"></div>
    <div id="backup-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" data-i18n="backup">Copia de seguridad</h2>
                <button class="close-backup-modal text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div class="space-y-4">
                <p id="last-backup-time" data-i18n="backup_empty" class="text-sm text-center text-gray-400 mb-4">A√∫n no hay copias de seguridad.</p>
                <button id="restore-backup-btn" data-i18n="backup_restore_btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Restaurar copia de seguridad</button>
                <div class="grid grid-cols-2 gap-4">
                    <button id="export-backup-json-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" data-i18n="btn_export">Exportar .json</button>
                    <button id="export-backup-srt-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" data-i18n="save_srt">Exportar .srt</button>
                </div>
            </div>
        </div>
    </div>
    <div id="find-replace-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" data-i18n="find_replace">Buscar y reemplazar</h2>
                <button class="close-modal text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="flex items-end gap-2">
                    <div class="flex-grow">
                        <label for="fr-find-input" class="text-sm font-medium text-gray-300">Buscar</label>
                        <input type="text" id="fr-find-input" class="text-import-input w-full mt-1 p-2 rounded-lg" style="width: 250px;">
                    </div>
                    <button id="fr-search-btn" class="text-btn compact-btn">Buscar</button>
                </div>
                <div class="flex items-end gap-2">
                    <div class="flex-grow">
                        <label for="fr-replace-input" class="text-sm font-medium text-gray-300">Reemplazar con</label>
                        <input type="text" id="fr-replace-input" class="text-import-input w-full mt-1 p-2 rounded-lg" style="width: 250px;">
                    </div>
                    <button id="fr-replace-btn" class="text-btn compact-btn">Reemplazar</button>
                    <button id="fr-replace-all-btn" class="text-btn compact-btn">Reemplazar todo</button>
                </div>

                <div class="flex items-center justify-between mt-2">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center">
                            <input id="fr-case-sensitive" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                            <label for="fr-case-sensitive" data-i18n="fr_chk_case" class="ml-2 text-sm font-medium text-gray-300">Distinguir may√∫sculas</label>
                        </div>
                        <div class="flex items-center">
                            <input id="fr-use-regex" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                            <label for="fr-use-regex" data-i18n="fr_chk_regex" class="ml-2 text-sm font-medium text-gray-300">Usar expresiones regulares</label>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="fr-prev-btn" class="icon-btn compact-icon-btn">‚óÄ</button>
                        <span id="fr-search-count" class="text-sm px-2">0 / 0</span>
                        <button id="fr-next-btn" class="icon-btn compact-icon-btn">‚ñ∂</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="import-text-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" data-i18n="import_text">Crear subt√≠tulos desde texto</h2>
                <button class="close-text-import-modal text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div id="text-import-main-area">
                <div class="flex-shrink-0 bg-dark-gray p-2 rounded-lg mb-4">
                     <div class="flex flex-wrap items-end gap-x-6 gap-y-3">
                        <label for="txt-loader" data-i18n="txt_btn_import" class="text-btn compact-btn cursor-pointer">Importar .txt</label>
                        
                        <div class="flex items-end gap-4">
                            <div class="flex flex-col gap-1">
                                <label data-i18n="txt_label_separator" class="text-xs font-medium text-gray-400">Divisor de subt√≠tulos</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="text-import-separator" value="|" class="text-import-input border border-gray-600 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-12 p-2 text-center h-9">
                                    <div class="flex items-center">
                                        <input id="text-import-double-break" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 ring-offset-gray-800 focus:ring-2">
                                        <label for="text-import-double-break" data-i18n="txt_chk_double_break" class="ml-2 text-sm font-medium text-gray-300">o doble salto</label>
                                    </div>
                                </div>
                            </div>
                            <button id="text-import-autosplit-btn" data-i18n="txt_btn_autosplit" class="text-btn compact-btn">Autodividir</button>
                        </div>
                        
                        <div class="border-l border-gray-600 h-10"></div>

                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-medium text-gray-400" data-i18n="lbl_find_replace_group">Buscar y reemplazar</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="text-import-find" placeholder="Buscar..." class="text-import-input border border-gray-600 text-sm rounded-lg block w-48 p-2 h-9">
                                <button id="text-import-search-btn" class="text-btn compact-btn">Buscar</button>
                                <button id="text-import-prev-btn" class="icon-btn compact-icon-btn">‚óÄ</button>
                                <span id="text-import-search-count" class="text-sm px-1">0/0</span>
                                <button id="text-import-next-btn" class="icon-btn compact-icon-btn">‚ñ∂</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="text" id="text-import-replace" placeholder="Reemplazar con..." class="text-import-input border border-gray-600 text-sm rounded-lg block w-48 p-2 h-9">
                                <button id="text-import-replace-btn" class="text-btn compact-btn">Reemplazar</button>
                                <button id="text-import-replace-all-btn" class="text-btn compact-btn">Todo</button>
                            </div>
                        </div>
                    </div>
                </div>
                <textarea id="text-import-textarea" placeholder="Pega aqu√≠ tu guion..."data-i18n-placeholder="txt_ph_area"></textarea>></textarea>
                <div id="text-import-resizer"></div>
                <div id="text-import-preview-container">
                    <table class="w-full text-left text-sm">
                        <thead class="text-xs text-gray-400 uppercase">
                            <tr>
                                <th class="p-2" style="width: 5%;">#</th>
                                <th class="p-2" data-i18n="txt_header_text" style="width: 75%;">Texto</th>
                                <th class="p-2 text-center" data-i18n="txt_header_lines" style="width: 10%;">L√≠neas</th>
                                <th class="p-2 text-center" style="width: 10%;">CPL</th>
                            </tr>
                        </thead>
                        <tbody id="text-import-preview-body"></tbody>
                    </table>

                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-light-gray flex justify-end">
                <button id="create-subs-from-text-btn" data-i18n="txt_btn_create" class="text-btn bg-blue-600 hover:bg-blue-700">Crear subt√≠tulos en la l√≠nea de tiempo</button>
            </div>
        </div>
    </div>
    
    <div id="ass-style-editor-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" data-i18n="ass_style_editor">Editor de estilos ASS</h2>
                <button class="close-ass-style-editor-modal text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            
            <div class="style-editor-layout">
                <div id="style-list-container">
                    <ul id="style-list"></ul>
                    <div class="mt-4 flex gap-2">
                        <button id="add-new-style-btn" class="w-full text-btn compact-btn" data-i18n="ass_btn_new">Nuevo</button>
                        <button id="delete-style-btn" class="w-full text-btn compact-btn bg-red-800 hover:bg-red-700" data-i18n="ass_btn_delete">Borrar</button>
                    </div>
                </div>
                
                <div id="style-form-container">
                    
                    <div id="style-preview-wrapper">
                        <div id="style-preview-text">Texto de ejemplo<br>Segunda l√≠nea</div>
                    </div>

                    <div id="style-options-scroller">
                        
                        <div class="style-group">
                            <h3 class="style-group-title" data-i18n="ass_title_main">Principal</h3>
                            <div class="style-group-grid two-cols">
                                <div><label for="style-name" data-i18n="ass_lbl_name">Nombre</label><input type="text" id="style-name" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                                <div>
                                    <label for="style-fontname" data-i18n="ass_lbl_font">Fuente</label>
                                    <select id="style-fontname" class="ass-style-input w-full p-2 rounded-lg mt-1">
                                        <option value="Arial">Arial</option>
                                        <option value="Arial Black">Arial Black</option>
                                        <option value="Verdana">Verdana</option>
                                        <option value="Tahoma">Tahoma</option>
                                        <option value="Trebuchet MS">Trebuchet MS</option>
                                        <option value="Impact">Impact</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Comic Sans MS">Comic Sans MS</option>
                                        </select>
                                </div>
                                <div><label for="style-fontsize" data-i18n="ass_lbl_size">Tama√±o</label><input type="number" id="style-fontsize" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                            </div>
                        </div>

                        <div class="style-group">
                            <h3 class="style-group-title" data-i18n="ass_title_colors">Colores</h3>
                            <div class="style-group-grid two-cols">
                                <div><label for="style-primarycolour" data-i18n="ass_lbl_primary">Primario</label><div class="color-input-wrapper"><input type="text" id="style-primarycolour" class="ass-style-input w-full p-2 rounded-lg mt-1"><input type="color" id="style-primarycolour-picker"></div></div>
                                <div><label for="style-secondarycolour" data-i18n="ass_lbl_secondary">Secundario (Karaoke)</label><div class="color-input-wrapper"><input type="text" id="style-secondarycolour" class="ass-style-input w-full p-2 rounded-lg mt-1"><input type="color" id="style-secondarycolour-picker"></div></div>
                                <div><label for="style-outlinecolour" data-i18n="ass_lbl_outline_color">Contorno</label><div class="color-input-wrapper"><input type="text" id="style-outlinecolour" class="ass-style-input w-full p-2 rounded-lg mt-1"><input type="color" id="style-outlinecolour-picker"></div></div>
                                <div><label for="style-backcolour" data-i18n="ass_lbl_shadow_color">Sombra</label><div class="color-input-wrapper"><input type="text" id="style-backcolour" class="ass-style-input w-full p-2 rounded-lg mt-1"><input type="color" id="style-backcolour-picker"></div></div>
                            </div>
                        </div>

                        <div class="style-group">
                            <h3 class="style-group-title" data-i18n="ass_title_border">Borde y Estilo</h3>
                            <div class="style-group-grid three-cols">
                                <div><label for="style-outline" data-i18n="ass_lbl_outline_width">Grosor Contorno</label><input type="number" id="style-outline" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                                <div><label for="style-shadow" data-i18n="ass_lbl_shadow_width">Grosor Sombra</label><input type="number" id="style-shadow" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                                <div><label for="style-borderstyle" data-i18n="ass_lbl_border_style">Estilo Borde</label><select id="style-borderstyle" class="ass-style-input w-full p-2 rounded-lg mt-1"><option value="1" data-i18n="ass_opt_outline_shadow">Contorno + Sombra</option><option value="3" data-i18n="ass_opt_opaque_box">Caja Opaca</option></select></div>
                            </div>
                            <div class="style-group-grid three-cols mt-4">
                                <div><label for="style-bold" data-i18n="ass_lbl_bold">Negrita</label><select id="style-bold" class="ass-style-input w-full p-2 rounded-lg mt-1"><option value="0" data-i18n="ass_opt_no">No</option><option value="-1" data-i18n="ass_opt_yes">S√≠</option></select></div>
                                <div><label for="style-italic" data-i18n="ass_lbl_italic">Cursiva</label><select id="style-italic" class="ass-style-input w-full p-2 rounded-lg mt-1"><option value="0" data-i18n="ass_opt_no">No</option><option value="-1" data-i18n="ass_opt_yes">S√≠</option></select></div>
                                <div><label for="style-underline" data-i18n="ass_lbl_underline">Subrayado</label><select id="style-underline" class="ass-style-input w-full p-2 rounded-lg mt-1"><option value="0" data-i18n="ass_opt_no">No</option><option value="-1" data-i18n="ass_opt_yes">S√≠</option></select></div>
                            </div>
                        </div>

                        <div class="style-group">
                            <h3 class="style-group-title" data-i18n="ass_title_pos">Posicionamiento</h3>
                            <div class="flex gap-6">
                                <div class="alignment-grid-wrapper">
                                    <label data-i18n="ass_lbl_align">Alineaci√≥n (Numpad)</label>
                                    <div class="alignment-grid">
                                        <button data-align="7"></button><button data-align="8"></button><button data-align="9"></button>
                                        <button data-align="4"></button><button data-align="5"></button><button data-align="6"></button>
                                        <button data-align="1"></button><button data-align="2" class="active"></button><button data-align="3"></button>
                                    </div>
                                    <input type="hidden" id="style-alignment" value="2">
                                </div>
                                <div class="flex-grow">
                                    <label data-i18n="ass_lbl_margins">M√°rgenes</label>
                                    <div class="grid grid-cols-3 gap-2 mt-2">
                                        <div>
                                            <label for="style-marginl" class="text-xs" data-i18n="ass_lbl_margin_l">Izquierda</label>
                                            <input type="number" id="style-marginl" class="ass-style-input w-full p-2 rounded-lg">
                                        </div>
                                        <div>
                                            <label for="style-marginr" class="text-xs" data-i18n="ass_lbl_margin_r">Derecha</label>
                                            <input type="number" id="style-marginr" class="ass-style-input w-full p-2 rounded-lg">
                                        </div>
                                        <div>
                                            <label for="style-marginv" class="text-xs" data-i18n="ass_lbl_margin_v">Vertical</label>
                                            <input type="number" id="style-marginv" class="ass-style-input w-full p-2 rounded-lg">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <details class="style-group">
                            <summary class="style-group-title cursor-pointer" data-i18n="ass_title_adv">Avanzado</summary>
                            <div class="style-group-grid three-cols mt-2">
                                <div><label for="style-scalex" data-i18n="ass_lbl_scale_x">Escala X (%)</label><input type="number" id="style-scalex" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                                <div><label for="style-scaley" data-i18n="ass_lbl_scale_y">Escala Y (%)</label><input type="number" id="style-scaley" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                                <div><label for="style-spacing" data-i18n="ass_lbl_spacing">Espaciado</label><input type="number" id="style-spacing" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                                <div><label for="style-angle" data-i18n="ass_lbl_angle">√Ångulo</label><input type="number" id="style-angle" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                                <div><label for="style-strikeout" data-i18n="ass_lbl_strikeout">Tachado</label><select id="style-strikeout" class="ass-style-input w-full p-2 rounded-lg mt-1"><option value="0" data-i18n="ass_opt_no">No</option><option value="-1" data-i18n="ass_opt_yes">S√≠</option></select></div>
                                <div><label for="style-encoding" data-i18n="ass_lbl_encoding">Codificaci√≥n</label><input type="number" id="style-encoding" class="ass-style-input w-full p-2 rounded-lg mt-1"></div>
                            </div>
                        </details>
                    </div> 
                    
                    <div class="mt-4 pt-4 border-t border-light-gray flex justify-between items-center flex-shrink-0">
                        <div>
                            <button id="update-preview-btn" class="text-btn compact-btn" data-i18n="ass_btn_update_preview">Actualizar vista</button>
                        </div>

                        <div class="flex items-center gap-4">
                            <span id="apply-style-feedback" data-i18n="msg_applied" class="text-xs text-green-400 opacity-0 transition-opacity duration-300">¬°Aplicado!</span>
                            <button id="apply-style-to-all-btn" class="text-btn" data-i18n="ass_btn_apply">Aplicar a todos</button>

                            <span id="save-style-feedback" data-i18n="msg_saved" class="text-xs text-green-400 opacity-0 transition-opacity duration-300">¬°Guardado!</span>
                            <button id="save-style-changes-btn" class="text-btn bg-blue-600 hover:bg-blue-700" data-i18n="ass_btn_save">Guardar cambios</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="export-qa-report-modal" class="modal"></div>
    <div id="symbol-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" data-i18n="add_symbol">A√±adir s√≠mbolo</h2>
                <button class="close-symbol-modal text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div class="flex gap-4 items-start" style="min-height: 50vh;">
                <div id="symbol-categories" class="flex-shrink-0 w-56 border-r border-light-gray pr-4 overflow-y-auto">
                </div>
                <div id="symbol-grid" class="grid grid-cols-10 gap-x-2 gap-y-1 text-center overflow-y-auto flex-grow">
                </div>
            </div>
        </div>
    </div>

    <div id="load-project-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" data-i18n="load_project">Cargar Proyecto</h2>
                <button class="close-load-project-modal text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div class="space-y-4">
                <h3 class="text-sm font-semibold text-gray-400 border-b border-light-gray pb-2">Proyectos Recientes</h3>
                <div id="modal-recent-projects-list" class="space-y-2">
                </div>
                <div class="border-t border-light-gray pt-4">
                    <label for="project-loader" class="w-full text-btn bg-blue-600 hover:bg-blue-700 cursor-pointer text-center">
                        Cargar desde archivo...
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div id="save-project-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" data-i18n="save_project">Guardar proyecto</h2>
                <button class="close-save-project-modal text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div class="space-y-4">
                <label for="save-project-filename-input" class="text-sm font-medium text-gray-300" data-i18n="lbl_filename">Nombre del archivo</label>
                <input type="text" id="save-project-filename-input" class="text-import-input w-full mt-1 p-2 rounded-lg">
                <div class="flex justify-end gap-4 mt-4 pt-4 border-t border-light-gray">
                    <button id="cancel-save-project-btn" class="text-btn" data-i18n="btn_cancel">Cancelar</button>
                    <button id="confirm-save-project-btn" class="text-btn bg-blue-600 hover:bg-blue-700" data-i18n="btn_save">Guardar</button>
                </div>
            </div>
        </div>
    </div>


    <div id="tooltip"></div>

    <div id="drag-overlay">
        <h2 data-i18n="drag_overlay_text" class="text-3xl font-bold text-white text-center">Suelta el v√≠deo para cargarlo</h2>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

// ==========================================
// --- SISTEMA DE TRADUCCI√ìN (i18n) ---
// ==========================================

    let currentLang = 'es'; // Idioma por defecto

    const translations = {
        es: {
            // --- MEN√ö PRINCIPAL ---
            menu_file: "Archivo",
            menu_edit: "Editar",
            menu_mode: "Modo de trabajo",
            qa_review: "Revisi√≥n de QA",
            qa_settings: "Ajustes de QA",
            shortcuts: "Atajos",

            // --- SUBMEN√ö ARCHIVO ---
            new_project: "Nuevo proyecto",
            load_project: "Cargar proyecto...",
            save_project: "Guardar proyecto...",
            open_srt: "Abrir .srt",
            open_ass: "Abrir .ass",
            translate_subs: "Traducir subt√≠tulos...",
            save_srt: "Guardar .srt",
            save_ass: "Guardar .ass",
            backup: "Copia de seguridad",
            import_text: "Crear subt√≠tulos desde texto",
            load_video: "Cargar v√≠deo",
            import_shot_changes: "Importar cambios de plano (.txt)",

            // --- SUBMEN√ö EDITAR ---
            undo: "Deshacer (Ctrl+Z)",
            redo: "Rehacer (Ctrl+Y)",
            bold: "Negrita (Ctrl+B)",
            italic: "Cursiva (Ctrl+I)",
            add_symbol: "A√±adir s√≠mbolo",
            find_replace: "Buscar y reemplazar",
            ass_style_editor: "Editor de estilos ASS",

            // --- SUBMEN√ö MODO ---
            mode_edit: "Modo Edici√≥n",
            mode_sync: "Modo Sincronizaci√≥n",
            mode_preview: "Modo Vista Previa",

            // --- COLUMNAS TABLA ---
            col_qa: "!",
            col_id: "#",
            col_times: "Tiempos",
            col_original: "Original",
            col_translation: "Traducci√≥n",
            col_lines: "L√≠neas",
            col_style: "Estilo ASS",

            // --- INTERFAZ GENERAL ---
            btn_play_pause: "Reproducir/Pausa (Alt+P)",
            btn_set_in: "Marcar Inicio (Alt+Q)",
            btn_set_out: "Marcar Fin (Alt+W)",
            btn_detect_shots: "Cambios de plano",
            label_fps: "FPS",
            header_subs: "Subt√≠tulos",
            
            // --- MODALES Y ALERTAS (JS) ---
            msg_new_project: "Nuevo proyecto creado.",
            msg_load_video_first: "Primero carga un v√≠deo desde tu equipo.",
            msg_nothing_save: "No hay nada que guardar.",
            msg_saved: "¬°Guardado!",
            msg_applied: "¬°Aplicado!",
            msg_backup_restored: "Copia de seguridad restaurada.",
            msg_confirm_new: "Est√°s a punto de crear un nuevo proyecto y perder√°s todo el progreso no guardado. ¬øDeseas continuar?",
            msg_confirm_load: "Est√°s a punto de cargar un proyecto. Perder√°s el progreso no guardado.",
            modal_title_shortcuts: "Atajos de teclado",
            modal_title_qa: "Ajustes de QA",
            msg_shortcuts_saved: "Atajos guardados correctamente.",
            msg_shortcuts_imported: "Atajos importados correctamente.",
            msg_shortcuts_error: "Error al leer el archivo de atajos.",
            msg_json_error: "El nombre del archivo debe terminar en .json",
            msg_style_delete_error: "No se puede eliminar el estilo 'Default' o no hay selecci√≥n.",
            msg_style_exists: "¬°Ese nombre ya existe!",
            msg_shot_analysis: "Analizando...",
            msg_ready: "Listo",
            msg_processing: "Procesando...",
            label_change_video: "Cambiar v√≠deo",
            label_load_video: "Cargar v√≠deo",

            // --- HERRAMIENTA BUSCAR Y REEMPLAZAR ---
        fr_find_ph: "Buscar...",
        fr_replace_ph: "Reemplazar con...",
        fr_btn_find: "Buscar",
        fr_btn_replace: "Reemplazar",
        fr_btn_replace_all: "Todo", // O "Reemplazar todo"
        fr_chk_case: "Distinguir may√∫sculas",
        fr_chk_regex: "Usar expresiones regulares",
        msg_replacements_count: "reemplazos realizados.",

        // --- IMPORTADOR DE TEXTO ---
        txt_btn_import: "Importar .txt",
        txt_label_separator: "Divisor de subt√≠tulos",
        txt_chk_double_break: "o doble salto",
        txt_btn_autosplit: "Autodividir",
        txt_header_text: "Texto",
        txt_header_lines: "L√≠neas",
        txt_header_cpl: "CPL",
        txt_btn_create: "Crear subt√≠tulos en la l√≠nea de tiempo",
        msg_no_preview_subs: "No hay subt√≠tulos en la vista previa para crear.",
        msg_subs_created: "subt√≠tulos creados. Ahora puedes sincronizarlos.",

        // --- EDITOR DE ESTILOS ASS ---
        ass_title_main: "Principal",
        ass_lbl_name: "Nombre",
        ass_lbl_font: "Fuente",
        ass_lbl_size: "Tama√±o",
        ass_title_colors: "Colores",
        ass_lbl_primary: "Primario",
        ass_lbl_secondary: "Secundario (Karaoke)",
        ass_lbl_outline_color: "Contorno",
        ass_lbl_shadow_color: "Sombra",
        ass_title_border: "Borde y Estilo",
        ass_lbl_outline_width: "Grosor Contorno",
        ass_lbl_shadow_width: "Grosor Sombra",
        ass_lbl_border_style: "Estilo Borde",
        ass_opt_outline_shadow: "Contorno + Sombra",
        ass_opt_opaque_box: "Caja Opaca",
        ass_lbl_bold: "Negrita",
        ass_lbl_italic: "Cursiva",
        ass_lbl_underline: "Subrayado",
        ass_opt_no: "No",
        ass_opt_yes: "S√≠",
        ass_title_pos: "Posicionamiento",
        ass_lbl_align: "Alineaci√≥n (Numpad)",
        ass_lbl_margins: "M√°rgenes",
        ass_lbl_margin_l: "Izquierda",
        ass_lbl_margin_r: "Derecha",
        ass_lbl_margin_v: "Vertical",
        ass_title_adv: "Avanzado",
        ass_lbl_scale_x: "Escala X (%)",
        ass_lbl_scale_y: "Escala Y (%)",
        ass_lbl_spacing: "Espaciado",
        ass_lbl_angle: "√Ångulo",
        ass_lbl_strikeout: "Tachado",
        ass_lbl_encoding: "Codificaci√≥n",
        ass_btn_new: "Nuevo",
        ass_btn_delete: "Borrar",
        ass_btn_update_preview: "Actualizar vista",
        ass_btn_apply: "Aplicar a todos",
        ass_btn_save: "Guardar cambios",
        
        // --- MENSAJES DE ERROR QA (GENERADOS POR JS) ---
        qa_err_cps: "Error de CPS",
        qa_err_wpm: "Error de PPM",
        qa_err_cpl: "Error de CPL",
        qa_err_lines: "Demasiadas l√≠neas",
        qa_err_empty: "Subt√≠tulo vac√≠o",
        qa_err_min_dur: "Duraci√≥n demasiado corta",
        qa_err_max_dur: "Duraci√≥n demasiado larga",
        qa_err_overlap_prev: "Solapamiento con anterior",
        qa_err_overlap_next: "Solapamiento con siguiente",
        qa_err_gap: "Gap demasiado corto",
        qa_limit: "l√≠mite",
        qa_min: "m√≠n.",
        qa_max: "m√°x.",
        
        // --- INFORMES Y OTROS ---
        rep_title: "Informe de Quality Assurance",
        rep_summary: "RESUMEN",
        rep_pending: "Errores Pendientes",
        rep_reviewed: "Errores Revisados",
        rep_ignored: "Errores Ignorados",
        rep_no_errors: "No hay errores en esta categor√≠a.",
        rep_generated: "Generado el",
        drag_overlay_text: "Suelta el v√≠deo para cargarlo",
        backup_empty: "A√∫n no hay copias de seguridad.",
        backup_restore_btn: "Restaurar copia de seguridad",
        
        // --- S√çMBOLOS ---
        sym_cat_common: "M√°s comunes",
        sym_cat_currency: "Moneda y legal",
        sym_cat_punct: "Puntuaci√≥n y diacr√≠ticos",
        sym_cat_accents_1: "Letras con acento (A-G)",
        sym_cat_accents_2: "Letras con acento (H-Z)",
        sym_cat_math: "Matem√°ticas y fracciones",

// --- ESTAD√çSTICAS EN V√çDEO ---
        stats_orig: "Orig",
        
        // --- ONDA DE AUDIO ---
        wfm_generating: "Generando onda...",

        // --- COPIA DE SEGURIDAD (JS) ---
        backup_saved_at: "√öltima copia guardada a las",

        // --- ATAJOS (NOMBRES Y DESCRIPCIONES) ---
        // Grupo: Reproducci√≥n
        sc_name_playPause: "Reproducir / pausar",
        sc_desc_playPause: "Inicia o detiene la reproducci√≥n del v√≠deo.",
        sc_name_playSelectedSub: "Reproducir subt√≠tulo seleccionado",
        sc_desc_playSelectedSub: "Reproduce el rango del subt√≠tulo activo.",
        sc_name_spottingSetIn: "Sincro: marcar entrada",
        sc_desc_spottingSetIn: "Establece el tiempo de entrada del subt√≠tulo actual.",
        sc_name_spottingSetOutAndNext: "Sincro: marcar salida y siguiente",
        sc_desc_spottingSetOutAndNext: "Establece salida y salta al pr√≥ximo sin sincronizar.",
        sc_name_spottingHold: "Sincro r√°pida",
        sc_desc_spottingHold: "Marca entrada al pulsar y salida al soltar.",
        
        // Grupo: Creaci√≥n
        sc_name_setInTime: "Creaci√≥n: marcar inicio",
        sc_desc_setInTime: "Crea un nuevo subt√≠tulo en la posici√≥n actual.",
        sc_name_setOutTime: "Creaci√≥n: marcar fin",
        sc_desc_setOutTime: "Cierra el subt√≠tulo que se est√° creando.",
        sc_name_createAndHold: "Crear al pulsar, cerrar al soltar",
        sc_desc_createAndHold: "Crea al pulsar la tecla y cierra al soltarla.",
        sc_name_createFromSelection: "Crear desde selecci√≥n",
        sc_desc_createFromSelection: "Convierte la selecci√≥n de la onda en subt√≠tulo.",
        sc_name_splitSub: "Edici√≥n: dividir subt√≠tulo",
        sc_desc_splitSub: "Divide el subt√≠tulo actual en dos.",
        sc_name_mergePrev: "Edici√≥n: unir con anterior",
        sc_desc_mergePrev: "Combina con el subt√≠tulo anterior.",
        sc_name_mergeNext: "Edici√≥n: unir con siguiente",
        sc_desc_mergeNext: "Combina con el subt√≠tulo siguiente.",

        // Grupo: Navegaci√≥n
        sc_name_goToNextSub: "Navegaci√≥n: siguiente",
        sc_desc_goToNextSub: "Selecciona el siguiente subt√≠tulo.",
        sc_name_goToPrevSub: "Navegaci√≥n: anterior",
        sc_desc_goToPrevSub: "Selecciona el subt√≠tulo anterior.",
        sc_name_goToNextUntimed: "Navegaci√≥n: siguiente sin sincro",
        sc_desc_goToNextUntimed: "Busca el pr√≥ximo subt√≠tulo sin tiempos.",
        sc_name_goToLastTimed: "Navegaci√≥n: √∫ltimo sincronizado",
        sc_desc_goToLastTimed: "Salta al √∫ltimo subt√≠tulo con tiempos.",
        sc_name_seekForwardMedium: "Avanzar medio segundo",
        sc_desc_seekForwardMedium: "Mueve el cabezal 0.5s adelante.",
        sc_name_seekBackwardMedium: "Retroceder medio segundo",
        sc_desc_seekBackwardMedium: "Mueve el cabezal 0.5s atr√°s.",
        sc_name_seekForwardFrame: "Avanzar un fotograma",
        sc_desc_seekForwardFrame: "Mueve el cabezal 1 frame adelante.",
        sc_name_seekBackwardFrame: "Retroceder un fotograma",
        sc_desc_seekBackwardFrame: "Mueve el cabezal 1 frame atr√°s.",
        sc_name_nudgeForward: "Ajuste: ampliar cierre",
        sc_desc_nudgeForward: "Extiende el cierre un fotograma.",
        sc_name_nudgeBackward: "Ajuste: reducir cierre",
        sc_desc_nudgeBackward: "Reduce el cierre un fotograma.",
        sc_name_nudgeStartBackward: "Ajuste: mover inicio atr√°s",
        sc_desc_nudgeStartBackward: "Mueve el inicio un fotograma antes.",
        sc_name_nudgeStartForward: "Ajuste: mover inicio adelante",
        sc_desc_nudgeStartForward: "Mueve el inicio un fotograma despu√©s.",
        sc_name_correctInTime: "Ajuste: corregir entrada",
        sc_desc_correctInTime: "Ajusta la entrada a la posici√≥n actual.",
        sc_name_correctOutTime: "Ajuste: corregir salida",
        sc_desc_correctOutTime: "Ajusta la salida a la posici√≥n actual.",

                // Grupo: Otros
        msg_colab_instructions: `<p class="mb-4">Vas a abrir una ventana nueva para generar los cambios de plano. Sigue estos pasos:</p><ol class="list-decimal list-inside space-y-2"><li>En la ventana nueva, pulsa el bot√≥n de <b>Play (‚ñ∂Ô∏è)</b>.</li><li>Sube tu v√≠deo cuando te lo pida.</li><li>Espera a que termine el an√°lisis (puede tardar minutos).</li><li>Se descargar√° un archivo llamado <b>codigos_de_tiempo.txt</b>.</li><li>Cierra la ventana de Colab y vuelve aqu√≠.</li><li>Usa <b>Archivo > Importar cambios de plano (.txt)</b> para cargar ese archivo.</li></ol>`,
        txt_ph_area: "Pega aqu√≠ tu guion...",
        ctx_split: "Dividir subt√≠tulo",
        ctx_merge_prev: "Unir con anterior",
        ctx_merge_next: "Unir con siguiente",
        ctx_change_style: "Cambiar estilo",
        ctx_delete: "Eliminar subt√≠tulo",

// --- NUEVAS CLAVES (FIX) ---
        btn_export: "Exportar",
        btn_close: "Cerrar",
        btn_toggle_time: "Cambiar formato de tiempo",
        
        // Sliders
        slider_vol: "Volumen",
        slider_zoom: "Zoom",
        slider_speed: "Velocidad",
        
        // QA Settings (Categor√≠as)
        qa_cat_timing: "Tiempos y sincronizaci√≥n",
        qa_cat_speed: "Velocidad y longitud",
        qa_cat_format: "Formato y puntuaci√≥n",
        qa_cat_style: "Estilo y redacci√≥n",
        
        // QA Report (Botones flotantes)
        qa_tip_restore: "Restablecer errores",
        qa_tip_export: "Exportar informe",
        qa_tip_reset: "Restablecer posici√≥n",
        
        // Load Project
        lbl_recent_projects: "Proyectos Recientes",
        msg_no_recent: "No hay proyectos recientes.",
        btn_load_file: "Cargar desde archivo...",
        
        // Save Project & Text Import
        lbl_filename: "Nombre del archivo",
        lbl_find_replace_group: "Buscar y reemplazar",
        
        // Notificaciones
        modal_title_notification: "Notificaci√≥n",
        
        // Columnas (Nombres para el men√∫ desplegable)
        col_name_qa: "Alertas QA",
        col_name_id: "ID #",
        col_name_times: "Tiempos",
        col_name_text: "Texto",
        col_name_cps: "CPS",
        col_name_wpm: "PPM",
        col_name_lines: "L√≠neas/CPL",
        col_name_style: "Estilo ASS",

        // Stats en video (Correcci√≥n)
        lbl_wpm: "PPM", // Para evitar que salga col_wpm

        btn_cancel: "Cancelar",
        btn_confirm: "Confirmar",
        btn_save: "Guardar",
        btn_export: "Exportar",
        btn_restore: "Restaurar",
        btn_back: "Volver",
        msg_loading_video: "Cargando v√≠deo...",
        msg_import_video_prompt: "Importa un v√≠deo para empezar (o arr√°stralo aqu√≠)",
        msg_preparing_file: "Preparando archivo...",
        msg_analyzing: "An√°lisis en curso...",
        alert_select_area: "Primero, haz clic y arrastra sobre la onda para crear una selecci√≥n.",
        alert_ffmpeg_error: "Error al detectar cambios de plano. Consulta la consola.",
        alert_shots_detected: "cambios de plano detectados.",
        alert_no_subs_export: "No hay subt√≠tulos para exportar.",
        alert_project_imported: "Proyecto importado.",
        alert_project_error: "Error al cargar el proyecto.",
        alert_head_inside_sub: "El cabezal debe estar dentro del subt√≠tulo para dividirlo.",
        alert_no_more_untimed: "No hay m√°s subt√≠tulos sin sincronizar.",
        alert_drag_valid_video: "Por favor, arrastra un archivo de v√≠deo v√°lido.",
        lbl_no_recent: "No hay proyectos recientes.",
        modal_title_qa_export: "Exportar Informe de QA",
        lbl_format: "Formato",
        qa_lbl_min_dur: "Duraci√≥n m√≠nima", qa_desc_min_dur: "M√≠nimo (ms/frames)",
        qa_lbl_max_dur: "Duraci√≥n m√°xima", qa_desc_max_dur: "M√°ximo (ms/frames)",
        qa_lbl_min_gap: "Gap m√≠nimo (frames)", qa_desc_min_gap: "M√≠nimo espacio entre subs",
        qa_lbl_overlap: "Solapamientos", qa_desc_overlap: "Detectar solapamientos de tiempo",
        qa_lbl_max_cps: "L√≠mite CPS", qa_desc_max_cps: "Caracteres por segundo",
        qa_lbl_max_wpm: "L√≠mite PPM", qa_desc_max_wpm: "Palabras por minuto",
        qa_lbl_max_cpl: "L√≠mite CPL", qa_desc_max_cpl: "Caracteres por l√≠nea",
        qa_lbl_max_lines: "L√≠neas m√°x", qa_desc_max_lines: "L√≠neas m√°ximas permitidas",
        input_press_key: "Presiona una tecla...",
        msg_shortcuts_invalid: "El archivo de atajos no es v√°lido.",
        modal_title_confirmation: "Confirmaci√≥n",
        qa_btn_ignore: "Ignorar",
        qa_btn_mark_reviewed: "Marcar Revisado",
        rep_errors_label: "Errores:",
        lbl_subtitle_num: "Subt√≠tulo #",
        col_name_qa: "Alertas QA",
        col_name_id: "ID #",
        col_name_times: "Tiempos",
        col_name_text: "Texto",
        col_name_cps: "CPS",
        col_name_wpm: "PPM", // Clave espec√≠fica para el nombre de columna
        col_name_lines: "L√≠neas/CPL",
        col_name_style: "Estilo ASS",
        btn_export_shortcuts: "Exportar",
        btn_import_shortcuts: "Importar",
        tooltip_qa_restore: "Restablecer errores",
        tooltip_qa_export: "Exportar informe",
        tooltip_qa_reset_pos: "Restablecer posici√≥n",
        tooltip_toggle_cols: "Mostrar/Ocultar Columnas",
        btn_restore_defaults: "Restaurar",
        msg_confirm_restore: "¬øEst√°s seguro de que quieres restaurar los atajos por defecto?",
        qa_lbl_tag_errors: "Errores de etiquetas", qa_desc_tag_errors: "Detecta etiquetas sin cerrar o mal anidadas.",
        qa_lbl_double_spaces: "Dobles espacios", qa_desc_double_spaces: "Avisa si hay dos o m√°s espacios seguidos.",
        qa_lbl_space_dash: "Espacio tras guion", qa_desc_space_dash: "Detecta di√°logos sin espacio tras guion.",
        qa_lbl_punct_pairs: "Signos ¬ø¬°!?", qa_desc_punct_pairs: "Avisa si falta apertura (¬ø¬°) o cierre (?!)",
        qa_lbl_low_period: "Min√∫scula tras punto", qa_desc_low_period: "Detecta frase que empieza por min√∫scula tras punto.",
        qa_lbl_space_period: "Espacio tras punto", qa_desc_space_period: "Detecta si falta un espacio tras un punto.",
        qa_lbl_quote_period: "Punto y comillas", qa_desc_quote_period: "Avisa si el punto queda dentro de las comillas.",
        qa_lbl_ellipsis: "Car√°cter elipsis (...)", qa_desc_ellipsis: "Avisa si se usan 3 puntos en vez del car√°cter ‚Ä¶",
        qa_lbl_ellipsis_link: "Elipsis de enlace", qa_desc_ellipsis_link: "Marca subt√≠tulos que terminan en ... para revisar.",
        qa_lbl_dash_cons: "Coherencia guiones", qa_desc_dash_cons: "Avisa incoherencia en guiones de di√°logo.",
        qa_lbl_cardinals: "N√∫meros (1-10)", qa_desc_cardinals: "Avisa si los n√∫meros 1-10 est√°n en cifras.",
        qa_lbl_semicolon: "Uso punto y coma", qa_desc_semicolon: "Marca el uso de ; para revisi√≥n.",
        qa_lbl_brackets: "Uso corchetes", qa_desc_brackets: "Marca el uso de [ ] para revisi√≥n.",
        qa_lbl_empty_subs: "Subt√≠tulos vac√≠os", qa_desc_empty_subs: "Detecta subt√≠tulos sin texto.",
        // --- MEN√ö HERRAMIENTAS ---
            menu_tools: "Herramientas",
            tool_shot_changes: "Detector de cambios de plano",
            tool_auto_transcription: "Subt√≠tulos autom√°ticos",
            tool_auto_spotting: "Prepautado (Spotting vac√≠o)",

            // --- INSTRUCCIONES COLAB ---
            msg_colab_shots: `<p class="mb-4">Se abrir√° una ventana nueva para detectar los cambios de plano.</p><ol class="list-decimal list-inside space-y-2 text-sm"><li>Pulsa el bot√≥n <b>Play (‚ñ∂Ô∏è)</b>.</li><li>Sube tu v√≠deo cuando se solicite.</li><li>Espera al an√°lisis.</li><li>Se descargar√° <b>codigos_de_tiempo.txt</b>.</li><li>Cierra la ventana y usa <b>Archivo > Importar cambios de plano</b>.</li></ol>`,
            
            msg_colab_transcription: `<p class="mb-4">Se abrir√° una ventana nueva para transcribir el audio autom√°ticamente.</p><ol class="list-decimal list-inside space-y-2 text-sm"><li>Pulsa el bot√≥n <b>Play (‚ñ∂Ô∏è)</b>.</li><li>Sube tu v√≠deo.</li><li>Whisper generar√° los subt√≠tulos.</li><li>Se descargar√° un archivo <b>.srt</b>.</li><li>Cierra la ventana y usa <b>Archivo > Abrir .srt</b> para cargarlo.</li></ol>`,
            
            msg_colab_spotting: `<p class="mb-4">Se abrir√° una ventana nueva para crear la estructura de tiempos (vac√≠a).</p><ol class="list-decimal list-inside space-y-2 text-sm"><li>Pulsa el bot√≥n <b>Play (‚ñ∂Ô∏è)</b>.</li><li>Sube tu v√≠deo.</li><li>El sistema calcular√° los tiempos √≥ptimos.</li><li>Se descargar√° <b>_spotting.srt</b>.</li><li>Cierra la ventana y usa <b>Archivo > Abrir .srt</b>.</li></ol>`,

        },

        en: {
            // --- MAIN MENU ---
            menu_file: "File",
            menu_edit: "Edit",
            menu_mode: "Work Mode",
            qa_review: "QA Review",
            qa_settings: "QA Settings",
            shortcuts: "Shortcuts",

            // --- FILE SUBMENU ---
            new_project: "New Project",
            load_project: "Load Project...",
            save_project: "Save Project...",
            open_srt: "Open .srt",
            open_ass: "Open .ass",
            translate_subs: "Translate Subtitles...",
            save_srt: "Save .srt",
            save_ass: "Save .ass",
            backup: "Backup",
            import_text: "Create subtitles from text",
            load_video: "Load Video",
            import_shot_changes: "Import shot changes (.txt)",

            // --- EDIT SUBMENU ---
            undo: "Undo (Ctrl+Z)",
            redo: "Redo (Ctrl+Y)",
            bold: "Bold (Ctrl+B)",
            italic: "Italic (Ctrl+I)",
            add_symbol: "Add Symbol",
            find_replace: "Find and Replace",
            ass_style_editor: "ASS Style Editor",

            // --- MODE SUBMENU ---
            mode_edit: "Edit Mode",
            mode_sync: "Timing Mode",
            mode_preview: "Preview Mode",

            // --- TABLE COLUMNS ---
            col_qa: "!",
            col_id: "#",
            col_times: "Times",
            col_original: "Original",
            col_translation: "Translation",
            col_lines: "Lines",
            col_style: "ASS Style",

            // --- GENERAL INTERFACE ---
            btn_play_pause: "Play/Pause (Alt+P)",
            btn_set_in: "Set Start (Alt+Q)",
            btn_set_out: "Set End (Alt+W)",
            btn_detect_shots: "Shot Changes",
            label_fps: "FPS",
            header_subs: "Subtitles",

            // --- MODALS & ALERTS (JS) ---
            msg_new_project: "New project created.",
            msg_load_video_first: "Please load a video file first.",
            msg_nothing_save: "Nothing to save.",
            msg_saved: "Saved!",
            msg_applied: "Applied!",
            msg_backup_restored: "Backup restored.",
            msg_confirm_new: "You are about to create a new project and will lose unsaved progress. Continue?",
            msg_confirm_load: "You are about to load a project. Unsaved progress will be lost.",
            modal_title_shortcuts: "Keyboard Shortcuts",
            modal_title_qa: "QA Settings",
            msg_shortcuts_saved: "Shortcuts saved successfully.",
            msg_shortcuts_imported: "Shortcuts imported successfully.",
            msg_shortcuts_error: "Error reading shortcuts file.",
            msg_json_error: "Filename must end with .json",
            msg_style_delete_error: "Cannot delete 'Default' style or no selection.",
            msg_style_exists: "That name already exists!",
            msg_shot_analysis: "Analyzing...",
            msg_ready: "Ready",
            msg_processing: "Processing...",
            label_change_video: "Change Video",
            label_load_video: "Load Video",
            // --- FIND AND REPLACE TOOL ---
        fr_find_ph: "Find...",
        fr_replace_ph: "Replace with...",
        fr_btn_find: "Find",
        fr_btn_replace: "Replace",
        fr_btn_replace_all: "All",
        fr_chk_case: "Match case",
        fr_chk_regex: "Use regular expressions",
        msg_replacements_count: "replacements made.",

        // --- TEXT IMPORT ---
        txt_btn_import: "Import .txt",
        txt_label_separator: "Subtitle separator",
        txt_chk_double_break: "or double break",
        txt_btn_autosplit: "Autosplit",
        txt_header_text: "Text",
        txt_header_lines: "Lines",
        txt_header_cpl: "CPL",
        txt_btn_create: "Create subtitles on timeline",
        msg_no_preview_subs: "No subtitles in preview to create.",
        msg_subs_created: "subtitles created. You can now sync them.",

        // --- ASS STYLE EDITOR ---
        ass_title_main: "Main",
        ass_lbl_name: "Name",
        ass_lbl_font: "Font",
        ass_lbl_size: "Size",
        ass_title_colors: "Colors",
        ass_lbl_primary: "Primary",
        ass_lbl_secondary: "Secondary (Karaoke)",
        ass_lbl_outline_color: "Outline",
        ass_lbl_shadow_color: "Shadow",
        ass_title_border: "Border & Style",
        ass_lbl_outline_width: "Outline Width",
        ass_lbl_shadow_width: "Shadow Depth",
        ass_lbl_border_style: "Border Style",
        ass_opt_outline_shadow: "Outline + Shadow",
        ass_opt_opaque_box: "Opaque Box",
        ass_lbl_bold: "Bold",
        ass_lbl_italic: "Italic",
        ass_lbl_underline: "Underline",
        ass_opt_no: "No",
        ass_opt_yes: "Yes",
        ass_title_pos: "Positioning",
        ass_lbl_align: "Alignment (Numpad)",
        ass_lbl_margins: "Margins",
        ass_lbl_margin_l: "Left",
        ass_lbl_margin_r: "Right",
        ass_lbl_margin_v: "Vertical",
        ass_title_adv: "Advanced",
        ass_lbl_scale_x: "Scale X (%)",
        ass_lbl_scale_y: "Scale Y (%)",
        ass_lbl_spacing: "Spacing",
        ass_lbl_angle: "Angle",
        ass_lbl_strikeout: "Strikeout",
        ass_lbl_encoding: "Encoding",
        ass_btn_new: "New",
        ass_btn_delete: "Delete",
        ass_btn_update_preview: "Update Preview",
        ass_btn_apply: "Apply to All",
        ass_btn_save: "Save Changes",
        
        // --- QA ERROR MESSAGES (JS GENERATED) ---
        qa_err_cps: "CPS Error",
        qa_err_wpm: "WPM Error",
        qa_err_cpl: "CPL Error",
        qa_err_lines: "Too many lines",
        qa_err_empty: "Empty subtitle",
        qa_err_min_dur: "Duration too short",
        qa_err_max_dur: "Duration too long",
        qa_err_overlap_prev: "Overlap with previous",
        qa_err_overlap_next: "Overlap with next",
        qa_err_gap: "Gap too short",
        qa_limit: "limit",
        qa_min: "min",
        qa_max: "max",

        // --- REPORTS & OTHERS ---
        rep_title: "Quality Assurance Report",
        rep_summary: "SUMMARY",
        rep_pending: "Pending Errors",
        rep_reviewed: "Reviewed Errors",
        rep_ignored: "Ignored Errors",
        rep_no_errors: "No errors in this category.",
        rep_generated: "Generated on",
        drag_overlay_text: "Drop video here to load",
        backup_empty: "No backups found.",
        backup_restore_btn: "Restore Backup",
        
        // --- SYMBOLS ---
        sym_cat_common: "Most Common",
        sym_cat_currency: "Currency & Legal",
        sym_cat_punct: "Punctuation & Diacritics",
        sym_cat_accents_1: "Accented Letters (A-G)",
        sym_cat_accents_2: "Accented Letters (H-Z)",
        sym_cat_math: "Math & Fractions",

        // --- VIDEO STATS ---
        stats_orig: "Orig",

        // --- WAVEFORM ---
        wfm_generating: "Generating waveform...",

        // --- BACKUP (JS) ---
        backup_saved_at: "Last backup saved at",

        // --- SHORTCUTS (NAMES & DESCS) ---
        // Group: Playback
        sc_name_playPause: "Play / Pause",
        sc_desc_playPause: "Starts or stops video playback.",
        sc_name_playSelectedSub: "Play selected subtitle",
        sc_desc_playSelectedSub: "Plays the range of the active subtitle.",
        sc_name_spottingSetIn: "Sync: set start",
        sc_desc_spottingSetIn: "Sets the start time of the current subtitle.",
        sc_name_spottingSetOutAndNext: "Sync: set end & next",
        sc_desc_spottingSetOutAndNext: "Sets end time and jumps to next unsynced.",
        sc_name_spottingHold: "Quick sync",
        sc_desc_spottingHold: "Set start on press, end on release.",
        
        // Group: Creation
        sc_name_setInTime: "Creation: set start",
        sc_desc_setInTime: "Creates a new subtitle at current position.",
        sc_name_setOutTime: "Creation: set end",
        sc_desc_setOutTime: "Closes the subtitle currently being created.",
        sc_name_createAndHold: "Create on press, close on release",
        sc_desc_createAndHold: "Creates on key press, closes on release.",
        sc_name_createFromSelection: "Create from selection",
        sc_desc_createFromSelection: "Converts waveform selection to subtitle.",
        sc_name_splitSub: "Edit: split subtitle",
        sc_desc_splitSub: "Splits current subtitle at cursor position.",
        sc_name_mergePrev: "Edit: merge with previous",
        sc_desc_mergePrev: "Combines with the previous subtitle.",
        sc_name_mergeNext: "Edit: merge with next",
        sc_desc_mergeNext: "Combines with the next subtitle.",

        // Group: Navigation
        sc_name_goToNextSub: "Nav: next subtitle",
        sc_desc_goToNextSub: "Selects the next subtitle.",
        sc_name_goToPrevSub: "Nav: previous subtitle",
        sc_desc_goToPrevSub: "Selects the previous subtitle.",
        sc_name_goToNextUntimed: "Nav: next unsynced",
        sc_desc_goToNextUntimed: "Jumps to the next subtitle without timing.",
        sc_name_goToLastTimed: "Nav: last synced",
        sc_desc_goToLastTimed: "Jumps to the last subtitle with timing.",
        sc_name_seekForwardMedium: "Seek forward 0.5s",
        sc_desc_seekForwardMedium: "Moves playhead 500ms forward.",
        sc_name_seekBackwardMedium: "Seek backward 0.5s",
        sc_desc_seekBackwardMedium: "Moves playhead 500ms backward.",
        sc_name_seekForwardFrame: "Seek forward 1 frame",
        sc_desc_seekForwardFrame: "Moves playhead 1 frame forward.",
        sc_name_seekBackwardFrame: "Seek backward 1 frame",
        sc_desc_seekBackwardFrame: "Moves playhead 1 frame backward.",
        sc_name_nudgeForward: "Nudge: extend end",
        sc_desc_nudgeForward: "Extends end time by 1 frame.",
        sc_name_nudgeBackward: "Nudge: reduce end",
        sc_desc_nudgeBackward: "Reduces end time by 1 frame.",
        sc_name_nudgeStartBackward: "Nudge: move start back",
        sc_desc_nudgeStartBackward: "Moves start time 1 frame back.",
        sc_name_nudgeStartForward: "Nudge: move start forward",
        sc_desc_nudgeStartForward: "Moves start time 1 frame forward.",
        sc_name_correctInTime: "Nudge: snap start",
        sc_desc_correctInTime: "Sets start time to current playhead.",
        sc_name_correctOutTime: "Nudge: snap end",
        sc_desc_correctOutTime: "Sets end time to current playhead.",

        // Group: Others
        msg_colab_instructions: `<p class="mb-4">A new window will open to generate shot changes. Follow these steps:</p><ol class="list-decimal list-inside space-y-2"><li>In the new window, press the <b>Play (‚ñ∂Ô∏è)</b> button.</li><li>Upload your video when asked.</li><li>Wait for the analysis to finish (it may take minutes).</li><li>A file named <b>codigos_de_tiempo.txt</b> will be downloaded.</li><li>Close the Colab window and come back here.</li><li>Use <b>File > Import shot changes (.txt)</b> to load that file.</li></ol>`,
        txt_ph_area: "Paste your script here...",
        ctx_split: "Split Subtitle",
        ctx_merge_prev: "Merge with Previous",
        ctx_merge_next: "Merge with Next",
        ctx_change_style: "Change Style",
        ctx_delete: "Delete Subtitle",

       // --- NEW KEYS (FIX) ---
        btn_export: "Export",
        btn_close: "Close",
        btn_toggle_time: "Change time format",
        
        // Sliders
        slider_vol: "Volume",
        slider_zoom: "Zoom",
        slider_speed: "Speed",
        
        // QA Settings (Categories)
        qa_cat_timing: "Timing & Sync",
        qa_cat_speed: "Speed & Length",
        qa_cat_format: "Format & Punctuation",
        qa_cat_style: "Style & Phrasing",
        
        // QA Report (Floating buttons)
        qa_tip_restore: "Restore errors",
        qa_tip_export: "Export report",
        qa_tip_reset: "Reset position",
        
        // Load Project
        lbl_recent_projects: "Recent Projects",
        msg_no_recent: "No recent projects.",
        btn_load_file: "Load from file...",
        
        // Save Project & Text Import
        lbl_filename: "Filename",
        lbl_find_replace_group: "Find and replace",
        
        // Notifications
        modal_title_notification: "Notification",

        // Column Names (Dropdown)
        col_name_qa: "QA Alerts",
        col_name_id: "ID #",
        col_name_times: "Times",
        col_name_text: "Text",
        col_name_cps: "CPS",
        col_name_wpm: "WPM",
        col_name_lines: "Lines/CPL",
        col_name_style: "ASS Style",

        // Stats in video
        lbl_wpm: "WPM",

        btn_cancel: "Cancel",
        btn_confirm: "Confirm",
        btn_save: "Save",
        btn_export: "Export",
        btn_restore: "Restore",
        btn_back: "Back",
        msg_loading_video: "Loading video...",
        msg_import_video_prompt: "Import a video to start (or drop it here)",
        msg_preparing_file: "Preparing file...",
        msg_analyzing: "Analysis in progress...",
        alert_select_area: "First, click and drag on the waveform to create a selection.",
        alert_ffmpeg_error: "Error detecting shot changes. Check console.",
        alert_shots_detected: "shot changes detected.",
        alert_no_subs_export: "No subtitles to export.",
        alert_project_imported: "Project imported.",
        alert_project_error: "Error loading project.",
        alert_head_inside_sub: "Playhead must be inside the subtitle to split it.",
        alert_no_more_untimed: "No more unsynced subtitles.",
        alert_drag_valid_video: "Please drag a valid video file.",
        lbl_no_recent: "No recent projects.",
        modal_title_qa_export: "Export QA Report",
        lbl_format: "Format",
        qa_lbl_min_dur: "Min Duration", qa_desc_min_dur: "Minimum (ms/frames)",
        qa_lbl_max_dur: "Max Duration", qa_desc_max_dur: "Maximum (ms/frames)",
        qa_lbl_min_gap: "Min Gap (frames)", qa_desc_min_gap: "Minimum space between subs",
        qa_lbl_overlap: "Overlaps", qa_desc_overlap: "Detect timing overlaps",
        qa_lbl_max_cps: "CPS Limit", qa_desc_max_cps: "Characters per second",
        qa_lbl_max_wpm: "WPM Limit", qa_desc_max_wpm: "Words per minute",
        qa_lbl_max_cpl: "CPL Limit", qa_desc_max_cpl: "Characters per line",
        qa_lbl_max_lines: "Max Lines", qa_desc_max_lines: "Maximum lines allowed",
        input_press_key: "Press a key...",
        msg_shortcuts_invalid: "Shortcuts file is invalid.",
        modal_title_confirmation: "Confirmation",
        qa_btn_ignore: "Ignore",
        qa_btn_mark_reviewed: "Mark Reviewed",
        rep_errors_label: "Errors:",
        lbl_subtitle_num: "Subtitle #",
        col_name_qa: "QA Alerts",
        col_name_id: "ID #",
        col_name_times: "Times",
        col_name_text: "Text",
        col_name_cps: "CPS",
        col_name_wpm: "WPM", // Specific key for column name
        col_name_lines: "Lines/CPL",
        col_name_style: "ASS Style",
        btn_export_shortcuts: "Export",
        btn_import_shortcuts: "Import",
        tooltip_qa_restore: "Restore errors",
        tooltip_qa_export: "Export report",
        tooltip_qa_reset_pos: "Reset position",
        tooltip_toggle_cols: "Show/Hide Columns",
        btn_restore_defaults: "Restore Defaults",
        msg_confirm_restore: "Are you sure you want to restore default shortcuts?",
        qa_lbl_tag_errors: "Tag Errors", qa_desc_tag_errors: "Detects unclosed or nested tags.",
        qa_lbl_double_spaces: "Double Spaces", qa_desc_double_spaces: "Warns if two or more spaces are found.",
        qa_lbl_space_dash: "Space after dash", qa_desc_space_dash: "Detects dialogues missing space after dash.",
        qa_lbl_punct_pairs: "Punctuation pairs", qa_desc_punct_pairs: "Warns if opening (¬ø¬°) or closing (?!) is missing.",
        qa_lbl_low_period: "Lowercase after dot", qa_desc_low_period: "Detects lowercase start after a period.",
        qa_lbl_space_period: "Space after dot", qa_desc_space_period: "Detects missing space after a period.",
        qa_lbl_quote_period: "Dot and quotes", qa_desc_quote_period: "Warns if dot is inside quotes.",
        qa_lbl_ellipsis: "Ellipsis char (...)", qa_desc_ellipsis: "Warns if 3 dots are used instead of ‚Ä¶ char.",
        qa_lbl_ellipsis_link: "Linking ellipsis", qa_desc_ellipsis_link: "Marks subtitles ending in ... for review.",
        qa_lbl_dash_cons: "Dash consistency", qa_desc_dash_cons: "Warns inconsistency in dialogue dashes.",
        qa_lbl_cardinals: "Numbers (1-10)", qa_desc_cardinals: "Warns if numbers 1-10 are digits.",
        qa_lbl_semicolon: "Semicolon use", qa_desc_semicolon: "Marks ; usage for review.",
        qa_lbl_brackets: "Brackets use", qa_desc_brackets: "Marks [ ] usage for review.",
        qa_lbl_empty_subs: "Empty subtitles", qa_desc_empty_subs: "Detects subtitles with no text.",
        // --- TOOLS MENU ---
            menu_tools: "Tools",
            tool_shot_changes: "Shot Change Detector",
            tool_auto_transcription: "Auto Subtitles (Transcription)",
            tool_auto_spotting: "Auto Spotting (Empty)",

            // --- COLAB INSTRUCTIONS ---
            msg_colab_shots: `<p class="mb-4">A new window will open to detect shot changes.</p><ol class="list-decimal list-inside space-y-2 text-sm"><li>Press the <b>Play (‚ñ∂Ô∏è)</b> button.</li><li>Upload your video.</li><li>Wait for analysis.</li><li>A file named <b>codigos_de_tiempo.txt</b> will download.</li><li>Close window and use <b>File > Import shot changes</b>.</li></ol>`,
            
            msg_colab_transcription: `<p class="mb-4">A new window will open to transcribe audio automatically.</p><ol class="list-decimal list-inside space-y-2 text-sm"><li>Press the <b>Play (‚ñ∂Ô∏è)</b> button.</li><li>Upload your video.</li><li>Whisper will generate subtitles.</li><li>An <b>.srt</b> file will download.</li><li>Close window and use <b>File > Open .srt</b>.</li></ol>`,
            
            msg_colab_spotting: `<p class="mb-4">A new window will open to create timing structure (empty).</p><ol class="list-decimal list-inside space-y-2 text-sm"><li>Press the <b>Play (‚ñ∂Ô∏è)</b> button.</li><li>Upload your video.</li><li>System will calculate optimal timing.</li><li>A <b>_spotting.srt</b> file will download.</li><li>Close window and use <b>File > Open .srt</b>.</li></ol>`,

        }
    };

    // Funci√≥n global para traducir cadenas en JS (alertas, etc.)
    // Uso: t('msg_saved') -> Devuelve "¬°Guardado!" o "Saved!"
    window.t = function(key) {
        return translations[currentLang][key] || key;
    };

    // Funci√≥n principal para cambiar el idioma
    window.changeLanguage = function(lang) {
        if (!translations[lang]) return;
        currentLang = lang;
        
        // 1. Actualizar etiqueta del bot√≥n del men√∫
        const langLabel = document.getElementById('current-lang-label');
        if(langLabel) langLabel.textContent = lang.toUpperCase();

        // 2. Actualizar textos simples (data-i18n)
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if (translations[lang][key]) {
                // Si es un input button, cambiamos value, si no, textContent
                if (el.tagName === 'INPUT' && el.type === 'button') {
                    el.value = translations[lang][key];
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });

        // 3. Actualizar Tooltips (data-i18n-tooltip)
        document.querySelectorAll('[data-i18n-tooltip]').forEach(el => {
            const key = el.dataset.i18nTooltip; // Nota: dataset convierte camelCase
            if (translations[lang][key]) {
                el.dataset.tooltip = translations[lang][key];
            }
        });

        // 4. Actualizar Placeholders (data-i18n-placeholder)
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            if (translations[lang][key]) {
                el.placeholder = translations[lang][key];
            }
        });
        
        console.log("Idioma cambiado a:", lang);
    };

// ==========================================        

let ffmpeg = null;
        // --- ELEMENTOS DEL DOM ---
        const videoPlayer = document.getElementById('video-player');
        const videoLoader = document.getElementById('video-loader');
        const srtLoader = document.getElementById('srt-loader');
        const assLoader = document.getElementById('ass-loader');
        const txtLoader = document.getElementById('txt-loader');
        const projectLoader = document.getElementById('project-loader');
        const shortcutsLoader = document.getElementById('shortcuts-loader');
        const waveformContainer = document.getElementById('waveform');
        const loadingIndicator = document.getElementById('loading-indicator');
        const subtitleBody = document.getElementById('subtitle-body');
        const exportSrtBtn = document.getElementById('export-srt');
        const exportAssBtn = document.getElementById('export-ass');
        const exportProjectBtn = document.getElementById('export-project');
        const subtitlePreview = document.getElementById('subtitle-preview');
        const inVideoEditorContainer = document.getElementById('in-video-editor-container');
        const inVideoEditor = document.getElementById('in-video-editor');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const setInBtn = document.getElementById('set-in-btn');
        const setOutBtn = document.getElementById('set-out-btn');
        const pressAndHoldBtn = document.getElementById('press-and-hold-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const fpsInput = document.getElementById('fps-input');
        const timeFormatToggle = document.getElementById('time-format-toggle');
        const timecodeDisplay = document.getElementById('timecode-display');
        const detectShotsBtn = document.getElementById('detect-shots-btn');
        const tooltip = document.getElementById('tooltip');
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('left-panel');
        const rightPanel = document.getElementById('right-panel');
        const contextMenu = document.getElementById('context-menu');
        const dragOverlay = document.getElementById('drag-overlay');
        const volumeSliderH = document.getElementById('volume-slider-h');
        const volumeValue = document.getElementById('volume-value');
        const zoomSliderH = document.getElementById('zoom-slider-h');
        const zoomValue = document.getElementById('zoom-value');
        const speedSliderH = document.getElementById('speed-slider-h');
        const speedValue = document.getElementById('speed-value');
        const newProjectBtn = document.getElementById('new-project-btn');
const toggleColumnsBtn = document.getElementById('toggle-columns-btn');
const modePreviewBtn = document.getElementById('mode-preview-btn');
const customProgressBarContainer = document.getElementById('custom-progress-bar-container');
const progressBar = document.getElementById('progress-bar'); // NOTA: Esta es la l√≠nea que a√±adimos
const shotDetectionProgressBar = document.getElementById('shot-detection-progress-bar');
const progressBarPlayed = document.getElementById('progress-bar-played');
const progressBarHandle = document.getElementById('progress-bar-handle');
const progressTimeCurrent = document.getElementById('progress-time-current');
const progressTimeDuration = document.getElementById('progress-time-duration');
const shotChangeLoader = document.getElementById('shot-change-loader');

        // Modales
        const shortcutsModal = document.getElementById('shortcuts-modal');
        const alertModal = document.getElementById('alert-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const pdfNameModal = document.getElementById('pdf-name-modal');
        const progressModal = document.getElementById('progress-modal');     
const shotDetectionProgressText = document.getElementById('shot-detection-progress-text');
        const cancelDetectionBtn = document.getElementById('cancel-detection-btn');
        const qaSettingsModal = document.getElementById('qa-settings-modal');
const qaSettingsModalBtn = document.getElementById('qa-settings-modal-btn');
// CAMBIO: Ahora apunta al nuevo ID 'qa-review-panel'
const qaReviewPanel = document.getElementById('qa-review-panel');
const qaReviewModalBtn = document.getElementById('qa-review-modal-btn');

// CAMBIO: La l√≥gica ahora abre o cierra el panel
qaReviewModalBtn.addEventListener('click', () => {
    if (qaReviewPanel.classList.contains('hidden')) {
        openQaReviewModal(); // La funci√≥n ahora mostrar√° el panel y refrescar√° su contenido
    } else {
        qaReviewPanel.classList.add('hidden');
    }
});        
        const openShortcutsModal = document.getElementById('open-shortcuts-modal');
        const backupModal = document.getElementById('backup-modal');
        const openBackupModalBtn = document.getElementById('open-backup-modal-btn');
        const lastBackupTimeEl = document.getElementById('last-backup-time');
        const restoreBackupBtn = document.getElementById('restore-backup-btn');
        const exportBackupJsonBtn = document.getElementById('export-backup-json-btn');
        const exportBackupSrtBtn = document.getElementById('export-backup-srt-btn');
        // Text Import Modal Elements
        const importTextModal = document.getElementById('import-text-modal');
        const openTextImportModalBtn = document.getElementById('open-text-import-modal-btn');
        const textImportTextarea = document.getElementById('text-import-textarea');
        const textImportPreviewContainer = document.getElementById('text-import-preview-container');
        const textImportResizer = document.getElementById('text-import-resizer');
        const textImportPreviewBody = document.getElementById('text-import-preview-body');
        const textImportSeparator = document.getElementById('text-import-separator');
        const textImportDoubleBreak = document.getElementById('text-import-double-break');
        const textImportFind = document.getElementById('text-import-find');
        const textImportReplace = document.getElementById('text-import-replace');
        const textImportSearchBtn = document.getElementById('text-import-search-btn');
        const textImportPrevBtn = document.getElementById('text-import-prev-btn');
        const textImportNextBtn = document.getElementById('text-import-next-btn');
        const textImportSearchCount = document.getElementById('text-import-search-count');
        const textImportReplaceBtn = document.getElementById('text-import-replace-btn');
        const textImportReplaceAllBtn = document.getElementById('text-import-replace-all-btn');
        const textImportAutosplitBtn = document.getElementById('text-import-autosplit-btn');
        const createSubsFromTextBtn = document.getElementById('create-subs-from-text-btn');
        // Work Mode Elements
        const modeEditBtn = document.getElementById('mode-edit-btn');
        const modeSyncBtn = document.getElementById('mode-sync-btn');
        const workModeDisplay = document.getElementById('work-mode-display');
        // Find and Replace Modal Elements
        const findReplaceModal = document.getElementById('find-replace-modal');
        const openFindReplaceModalBtn = document.getElementById('open-find-replace-modal-btn');
        // ASS Style Editor Elements
        const assStyleEditorModal = document.getElementById('ass-style-editor-modal');
        const openAssStyleEditorBtn = document.getElementById('open-ass-style-editor-btn');
        const styleList = document.getElementById('style-list');

// --- INICIO: Variables para visibilidad de columnas ---
const columnConfig = [
    { id: 'qa', headerId: 'qa-header', colClass: 'qa-col', name: 'Alertas QA' },
    { id: 'id', headerId: 'id-header', colClass: 'id-col', name: 'ID #' },
    { id: 'times', headerId: 'times-header', colClass: 'times-col', name: 'Tiempos' },
    { id: 'text', headerId: 'text-header', colClass: 'text-col', name: 'Texto' },
    { id: 'cps', headerId: 'cps-header', colClass: 'cps-col', name: 'CPS' },
    { id: 'wpm', headerId: 'wpm-header', colClass: 'wpm-col', name: 'PPM' },
    { id: 'lines', headerId: 'lines-header', colClass: 'lines-col', name: 'L√≠neas/CPL' },
    { id: 'style', headerId: 'style-header', colClass: 'style-col', name: 'Estilo ASS' }, 
];

let columnVisibility = {};
// --- FIN: Variables para visibilidad de columnas ---        

const updateProgressBar = (currentTime, duration) => {
    if (isNaN(currentTime) || isNaN(duration) || duration <= 0) return;
    
    const progressPercent = (currentTime / duration) * 100;
    progressBarPlayed.style.width = `${progressPercent}%`;
    progressBarHandle.style.left = `${progressPercent}%`;
    progressTimeCurrent.textContent = formatSrtTime(currentTime);
};

const focusContentEditable = (element, putCursorAtEnd) => {
    element.focus();
    if (putCursorAtEnd && window.getSelection && document.createRange) {
        const range = document.createRange();
        range.selectNodeContents(element);
        range.collapse(false); // false para ir al final
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }
};

const showFeedbackMessage = (elementId, duration = 2000) => {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.style.opacity = '1';
    setTimeout(() => {
        el.style.opacity = '0';
    }, duration);
};

// --- ESTADO DE LA APLICACI√ìN ---

        // CAMBIO: Funci√≥n movida al principio para evitar errores de referencia
        const createDefaultAssStyle = () => ({
            "Name": "Default", "Fontname": "Arial", "Fontsize": "28",
            "PrimaryColour": "&H00FFFFFF", "SecondaryColour": "&H000000FF", "OutlineColour": "&H00000000", "BackColour": "&H00000000",
            "Bold": "0", "Italic": "0", "Underline": "0", "StrikeOut": "0",
            "ScaleX": "100", "ScaleY": "100", "Spacing": "0", "Angle": "0",
            "BorderStyle": "1", "Outline": "2", "Shadow": "2",
            "Alignment": "2", "MarginL": "10", "MarginR": "10", "MarginV": "10", "Encoding": "1"
        });

        let wavesurfer = null;
        let wsRegions = null;
        let subtitles = [];
 let isTranslationMode = false;
        let selectedSubtitleIndices = new Set();
        // CAMBIO: Inicializaci√≥n de estilos con el valor por defecto
        let assStyles = [createDefaultAssStyle()];
        let shotChanges = [];
        let historyStack = [];
        let redoStack = [];
        let activeSubtitleIndex = -1;
        let contextMenuIndex = -1;
        let timeFormat = 'ms';
        let frameRate = 25;
        let isPressAndHoldCreating = false;
        let isDetectionCancelled = false;
        let isUserEditing = false;
        let isSpottingHoldActive = false;
let isCreatingSubtitle = false;
let lastActiveSubtitleIndex = -1;
        let workMode = 'edit'; // 'edit' or 'sync'
let selectionRegion = null; // Guardar√° la regi√≥n creada al arrastrar
let regionJustCreated = false; // Bandera para evitar el conflicto de seek al crear regi√≥n
       let currentQaIssues = []; // Guardar√° los errores para poder exportarlos

let activeQaStatus = 'visible'; // 'visible' son los pendientes. 


        let qaSettings = { 
            maxCps: 20, maxCpsEnabled: true, maxWpm: 180, maxWpmEnabled: false,
            maxCpl: 42, maxCplEnabled: true, maxLines: 2, maxLinesEnabled: true,
            minDuration: 1000, minDurationEnabled: true, maxDuration: 7000, maxDurationEnabled: true,
            minDurationUnit: 'ms', maxDurationUnit: 'ms',
            minGapFrames: 2, minGapFramesEnabled: true, minGapMs: 100, minGapMsEnabled: false,
            tagErrorsEnabled: true, spaceAfterDashEnabled: true, doubleSpacesEnabled: true,
            emptySubsEnabled: false, punctuationPairsEnabled: true, lowercaseAfterPeriodEnabled: true,
            spaceAfterPeriodEnabled: true, quotesAndPeriodEnabled: true, ellipsisLinkEnabled: true,
            ellipsisCharEnabled: true, dialogueDashConsistencyEnabled: true, cardinalNumbersEnabled: true,
            semicolonEnabled: true, bracketsEnabled: true, overlapEnabled: true
        };
        const speedLevels = [0.5, 0.75, 1, 1.25, 1.5, 2];
        const snapThreshold = 0.1; 
        
        // --- L√≥gica de Atajos Personalizables ---
        let shortcuts = {}; 
        let tempShortcuts = {}; 
        
        const defaultShortcuts = {
            playPause: { code: 'KeyP', altKey: true, ctrlKey: false, shiftKey: false },
            setInTime: { code: 'KeyQ', altKey: true, ctrlKey: false, shiftKey: false },
            setOutTime: { code: 'KeyW', altKey: true, ctrlKey: false, shiftKey: false },
            createAndHold: { code: 'IntlBackslash', altKey: false, ctrlKey: false, shiftKey: false },
            seekBackwardMedium: { code: 'ArrowLeft', altKey: true, ctrlKey: false, shiftKey: false },
            seekForwardMedium: { code: 'ArrowRight', altKey: true, ctrlKey: false, shiftKey: false },
            seekBackwardFrame: { code: 'ArrowLeft', altKey: false, ctrlKey: false, shiftKey: true },
            seekForwardFrame: { code: 'ArrowRight', altKey: false, ctrlKey: false, shiftKey: true },
            spottingSetIn: { code: 'KeyZ', altKey: true, ctrlKey: false, shiftKey: false },
            spottingSetOutAndNext: { code: 'KeyX', altKey: true, ctrlKey: false, shiftKey: false },
            spottingHold: { code: 'Backquote', altKey: false, ctrlKey: false, shiftKey: false },
 spottingHold: { code: 'Backquote', altKey: false, ctrlKey: false, shiftKey: false },
            createFromSelection: { code: 'KeyN', altKey: true, ctrlKey: false, shiftKey: false },
            nudgeForward: { code: 'KeyV', altKey: true, ctrlKey: false, shiftKey: false },
            nudgeBackward: { code: 'KeyC', altKey: true, ctrlKey: false, shiftKey: false },
 nudgeStartBackward: { code: 'KeyZ', altKey: true, ctrlKey: false, shiftKey: false },
            nudgeStartForward: { code: 'KeyX', altKey: true, ctrlKey: false, shiftKey: false },
            goToNextSub: { code: 'ArrowDown', altKey: true, ctrlKey: false, shiftKey: false },
            goToPrevSub: { code: 'ArrowUp', altKey: true, ctrlKey: false, shiftKey: false },
            goToNextUntimed: { code: 'ArrowDown', altKey: false, ctrlKey: false, shiftKey: true },
            goToLastTimed: { code: 'ArrowUp', altKey: false, ctrlKey: false, shiftKey: true },
            correctInTime: { code: 'KeyD', altKey: true, ctrlKey: false, shiftKey: false },
            correctOutTime: { code: 'KeyF', altKey: true, ctrlKey: false, shiftKey: false },
            playSelectedSub: { code: 'KeyO', altKey: true, ctrlKey: false, shiftKey: false },
            splitSub: { code: 'KeyX', altKey: false, ctrlKey: true, shiftKey: true },
            mergePrev: { code: 'ArrowUp', altKey: false, ctrlKey: true, shiftKey: true },
            mergeNext: { code: 'ArrowDown', altKey: false, ctrlKey: true, shiftKey: true },
        };

        const shortcutGroups = {
            'Reproducci√≥n y sincronizaci√≥n': {
                playPause: { name: 'Reproducir / pausar', desc: 'Inicia o detiene la reproducci√≥n del v√≠deo.' },
                playSelectedSub: { name: 'Reproducir subt√≠tulo seleccionado', desc: 'Reproduce el rango del subt√≠tulo activo.' },
                spottingSetIn: { name: 'Sincro: marcar entrada', desc: 'Establece el tiempo de entrada del subt√≠tulo actual.' },
                spottingSetOutAndNext: { name: 'Sincro: marcar salida y siguiente', desc: 'Establece el tiempo de salida y salta al pr√≥ximo subt√≠tulo sin sincronizar.' },
                spottingHold: { name: 'Sincro r√°pida', desc: 'Marca la entrada al pulsar y la salida al soltar.' },
            },
            'Creaci√≥n y edici√≥n': {
                setInTime: { name: 'Creaci√≥n: marcar inicio', desc: 'Crea un nuevo subt√≠tulo en la posici√≥n actual.' },
                setOutTime: { name: 'Creaci√≥n: marcar fin', desc: 'Cierra el subt√≠tulo que se est√° creando.' },
                createAndHold: { name: 'Crear al pulsar, cerrar al soltar', desc: 'Crea un subt√≠tulo al pulsar la tecla y cierra al soltarla.' },
                createFromSelection: { name: 'Crear desde selecci√≥n', desc: 'Convierte la selecci√≥n actual de la onda en un subt√≠tulo.' },
                splitSub: { name: 'Edici√≥n: dividir subt√≠tulo', desc: 'Divide el subt√≠tulo actual en dos en la posici√≥n del cursor.' },
                mergePrev: { name: 'Edici√≥n: unir con anterior', desc: 'Combina el subt√≠tulo actual con el anterior.' },
                mergeNext: { name: 'Edici√≥n: unir con siguiente', desc: 'Combina el subt√≠tulo actual con el siguiente.' },
            },
            'Navegaci√≥n y ajuste fino': {
                goToNextSub: { name: 'Navegaci√≥n: subt√≠tulo siguiente', desc: 'Selecciona el siguiente subt√≠tulo de la lista.' },
                goToPrevSub: { name: 'Navegaci√≥n: subt√≠tulo anterior', desc: 'Selecciona el subt√≠tulo anterior de la lista.' },
                goToNextUntimed: { name: 'Navegaci√≥n: siguiente sin sincronizar', desc: 'Busca y selecciona el pr√≥ximo subt√≠tulo sin tiempos asignados.' },
                goToLastTimed: { name: 'Navegaci√≥n: √∫ltimo sincronizado', desc: 'Salta al √∫ltimo subt√≠tulo que tiene tiempos asignados.' },
                seekForwardMedium: { name: 'Avanzar medio segundo', desc: 'Mueve el cabezal de reproducci√≥n 500 milisegundos hacia adelante.' },
                seekBackwardMedium: { name: 'Retroceder medio segundo', desc: 'Mueve el cabezal de reproducci√≥n 500 milisegundos hacia atr√°s.' },
                seekForwardFrame: { name: 'Avanzar un fotograma', desc: 'Mueve el cabezal de reproducci√≥n un fotograma hacia adelante.' },
                seekBackwardFrame: { name: 'Retroceder un fotograma', desc: 'Mueve el cabezal de reproducci√≥n un fotograma hacia atr√°s.' },
                nudgeForward: { name: 'Ajuste: ampliar cierre un fotograma', desc: 'Extiende el cierre del subt√≠tulo un fotograma.' },
                nudgeBackward: { name: 'Ajuste: reducir final un fotograma', desc: 'Reduce el cierre del subt√≠tulo un fotograma.' },
 nudgeStartBackward: { name: 'Ajuste: mover inicio hacia atr√°s', desc: 'Mueve el inicio del subt√≠tulo un fotograma antes.' },
                nudgeStartForward: { name: 'Ajuste: mover inicio hacia adelante', desc: 'Mueve el inicio del subt√≠tulo un fotograma despu√©s.' },
                correctInTime: { name: 'Ajuste: corregir entrada', desc: 'Ajusta el tiempo de entrada a la posici√≥n actual del cabezal.' },
                correctOutTime: { name: 'Ajuste: corregir fin', desc: 'Ajusta el tiempo de salida a la posici√≥n actual del cabezal.' },
            }
        };

        const loadShortcuts = () => {
            try {
                const savedShortcuts = localStorage.getItem('subpanda-shortcuts');
                if (savedShortcuts) {
                    shortcuts = JSON.parse(savedShortcuts);
                    for (const key in defaultShortcuts) {
                        if (!shortcuts[key]) shortcuts[key] = defaultShortcuts[key];
                    }
                } else {
                    shortcuts = { ...defaultShortcuts };
                }
            } catch (e) {
                console.error("Error loading shortcuts, reverting to default.", e);
                shortcuts = { ...defaultShortcuts };
            }
        };

        // --- L√ìGICA DE DESHACER/REHACER ---
        const saveState = () => {
            const state = {
                subtitles: JSON.parse(JSON.stringify(subtitles)),
                assStyles: JSON.parse(JSON.stringify(assStyles))
            };
            historyStack.push(JSON.stringify(state));
            redoStack = []; 
            if (historyStack.length > 30) historyStack.shift();
            updateUndoRedoButtons();
        };

        const restoreState = (stateString) => {
            const state = JSON.parse(stateString);
            subtitles = state.subtitles;
            assStyles = state.assStyles;
            renderSubtitles(true);
            updateUndoRedoButtons();
        };

        const undo = () => {
            if (historyStack.length === 0) return;
            const currentState = {
                subtitles: JSON.parse(JSON.stringify(subtitles)),
                assStyles: JSON.parse(JSON.stringify(assStyles))
            };
            redoStack.push(JSON.stringify(currentState));
            restoreState(historyStack.pop());
        };

        const redo = () => {
            if (redoStack.length === 0) return;
            const currentState = {
                subtitles: JSON.parse(JSON.stringify(subtitles)),
                assStyles: JSON.parse(JSON.stringify(assStyles))
            };
            historyStack.push(JSON.stringify(currentState));
            restoreState(redoStack.pop());
        };

        const updateUndoRedoButtons = () => {
            undoBtn.disabled = historyStack.length === 0;
            redoBtn.disabled = redoStack.length === 0;
        };
        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);

        // --- L√ìGICA DE COMANDOS ---
           const handlePlayPause = () => {
            // Si el usuario estaba editando texto (focus en editor), salimos del modo edici√≥n
            // pero mantenemos el subt√≠tulo seleccionado para poder usar atajos de sincro.
            if (isUserEditing) {
                isUserEditing = false;
                inVideoEditor.blur(); // Quitamos foco del texto
                document.body.focus(); // Devolvemos el foco al cuerpo para que funcionen los atajos
            }
            
            if (wavesurfer) {
                wavesurfer.playPause();
            }
        };
        const handleSetInTime = () => {
            isCreatingSubtitle = true;
            if (activeSubtitleIndex !== -1 || !wsRegions) return;
            saveState();
            const currentTime = videoPlayer.currentTime;
            const newSubtitle = { id: String(getNextAvailableId()), start: currentTime, end: currentTime + 0.1, text: '', style: 'Default' };
            subtitles.push(newSubtitle);
            setActiveSubtitle(subtitles.length - 1);
            renderSubtitles();
        };
        const handleSetOutTime = () => {
            if (activeSubtitleIndex === -1) return;
            saveState();
            const currentTime = videoPlayer.currentTime;
            const sub = subtitles[activeSubtitleIndex];
            sub.end = currentTime > sub.start ? currentTime : sub.start + 0.1;
            if (wsRegions) {
                const region = wsRegions.getRegions().find(r => r.id == sub.id);
                if (region) region.setOptions({ end: sub.end, color: 'rgba(7, 91, 162, 0.5)' });
            }
            setActiveSubtitle(-1);
isCreatingSubtitle = false; 
            renderSubtitles(false);
        };

const handleCreateSubtitleFromSelection = () => {
            // 1. Comprueba que existe una selecci√≥n activa.
            if (!selectionRegion) {
                showModalAlert('Primero, haz clic y arrastra sobre la onda para crear una selecci√≥n.');
                return;
            }
    
            // 2. Guarda el estado para poder deshacer la acci√≥n.
            saveState();
    
            // 3. Crea el nuevo objeto de subt√≠tulo usando los tiempos de la selecci√≥n.
            const newSubtitle = {
                id: String(getNextAvailableId()),
                start: selectionRegion.start,
                end: selectionRegion.end,
                text: '', // El texto empieza vac√≠o para que el usuario lo escriba.
                style: 'Default'
            };
    
            // 4. A√±ade el nuevo subt√≠tulo al array principal.
            subtitles.push(newSubtitle);
    
            // 5. Elimina la regi√≥n de selecci√≥n temporal de la vista.
            selectionRegion.remove();
            selectionRegion = null;
    
            // 6. Refresca la tabla y las regiones de subt√≠tulos.
            renderSubtitles(true);
    
            // 7. Activa el nuevo subt√≠tulo para que se pueda editar inmediatamente.
            setActiveSubtitle(subtitles.length - 1);
        };

   const setupRightClickDrag = (wavesurferInstance, regionsPlugin) => {
            const waveElement = wavesurferInstance.getWrapper();
            let isRightDragging = false;
            let dragStartTime = 0;

            waveElement.addEventListener('contextmenu', (e) => e.preventDefault());

            waveElement.addEventListener('mousedown', (e) => {
                // Solo actuar con el bot√≥n derecho (e.button === 2)
                if (e.button !== 2) return;

                isRightDragging = true;
                
                // Usamos el m√©todo interno de WaveSurfer para obtener el tiempo exacto del clic
                const clickTime = wavesurferInstance.getInteractionData(e).time;
                dragStartTime = clickTime;

                // Si ya existe una selecci√≥n temporal, la borramos
                if (selectionRegion) {
                    selectionRegion.remove();
                }

                // Creamos la nueva regi√≥n con la ID especial
                selectionRegion = regionsPlugin.addRegion({
                    id: 'temp-selection',
                    start: dragStartTime,
                    end: dragStartTime,
                    color: 'rgba(45, 212, 191, 0.4)',
                    drag: false,
                    resize: false,
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!isRightDragging) return;
                
                const hoverTime = wavesurferInstance.getInteractionData(e)?.time;
                if (hoverTime === null || hoverTime === undefined) return;
                
                // Actualizamos el inicio y el fin de la regi√≥n para permitir arrastrar en ambas direcciones
                if (selectionRegion) {
                    selectionRegion.setOptions({
                        start: Math.min(hoverTime, dragStartTime),
                        end: Math.max(hoverTime, dragStartTime)
                    });
                }
            });

            document.addEventListener('mouseup', (e) => {
                if (e.button !== 2 || !isRightDragging) return;

                // Si la regi√≥n es muy peque√±a (un simple clic derecho), la eliminamos
                if (selectionRegion && (selectionRegion.end - selectionRegion.start) < 0.05) {
                    selectionRegion.remove();
                    selectionRegion = null;
                }
                isRightDragging = false;
            });
        };

        // --- INICIALIZACI√ìN Y EVENTOS DE WAVESURFER ---
const initializeWaveSurfer = () => {
            // 1. Limpieza previa
            if (wavesurfer) {
                wavesurfer.destroy();
                wavesurfer = null;
            }
            shotChanges = [];
            document.getElementById('waveform-minimap').innerHTML = '';
            customProgressBarContainer.style.opacity = '0';
            progressTimeCurrent.textContent = formatSrtTime(0);
            progressTimeDuration.textContent = formatSrtTime(0);

            // 2. Crear instancia
            wavesurfer = WaveSurfer.create({
                container: waveformContainer, 
                waveColor: 'rgb(107, 114, 128)', 
                progressColor: '#A4CAFE',
                media: videoPlayer, 
                cursorWidth: 2, 
                cursorColor: '#F59E0B', 
                barWidth: 3, 
                barRadius: 3, 
                height: 'auto',
                // IMPORTANTE: dragToSeek en false permite que el plugin de regiones capture el arrastre
                dragToSeek: false, 
                plugins: [ 
                    // Creamos el plugin SIN configuraci√≥n aqu√≠ para evitar conflictos
                    WaveSurfer.Regions.create(), 
                    WaveSurfer.Minimap.create({
                        container: '#waveform-minimap',
                        waveColor: 'rgb(156, 163, 175)',
                        progressColor: 'rgb(7, 91, 162)',
                        height: 60
                    })
                ]
            });

            // Obtenemos la referencia al plugin
            wsRegions = wavesurfer.plugins[0];

            // 3. ACTIVACI√ìN EXPL√çCITA DE LA SELECCI√ìN (La clave para que funcione)
            wsRegions.enableDragSelection({
                color: 'rgba(34, 197, 94, 0.4)', // Verde Matrix üü¢
                slop: 5 // Tolerancia de p√≠xeles para empezar a arrastrar
            });

            // 4. L√≥gica de limpieza de regiones (igual que antes)
            wsRegions.on('region-created', (region) => {
                if (region.id.startsWith('shot_')) return;
                if (region.id === 'temp-selection') return;

                const isExistingSubtitle = subtitles.some(s => s.id === region.id);
                if (isExistingSubtitle) return;

                // Borramos la selecci√≥n anterior para que solo haya una verde activa
                if (selectionRegion && selectionRegion !== region) {
                    try { selectionRegion.remove(); } catch(e){}
                }
                selectionRegion = region;
            });

            wsRegions.on('region-clicked', (region, e) => {
                 e.stopPropagation();
                 if (!subtitles.some(s => s.id === region.id)) {
                     selectionRegion = region;
                 }
            });

            setupRightClickDrag(wavesurfer, wsRegions);

            // Eventos est√°ndar
            wavesurfer.on('ready', () => {
                loadingIndicator.style.display = 'none';
                detectShotsBtn.disabled = false;
                wavesurfer.zoom(Number(zoomSliderH.value));
                renderSubtitles(true);
                renderShotChanges();
                
                const duration = wavesurfer.getDuration();
                progressTimeDuration.textContent = formatSrtTime(duration);
                customProgressBarContainer.style.opacity = '1';
                updateProgressBar(0, duration);
            });

            wavesurfer.on('loading', (p) => { loadingIndicator.innerHTML = `<p class="bg-black/70 px-4 py-2 rounded-lg">${t('wfm_generating')} ${p}%</p>`; });
            wavesurfer.on('play', () => { playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); });
            wavesurfer.on('pause', () => { playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); });
            wavesurfer.on('timeupdate', (t) => { timecodeDisplay.textContent = formatSrtTime(t); updateProgressBar(t, wavesurfer.getDuration()); });

            // Eventos de edici√≥n de regiones
            wsRegions.on('region-updated', (region) => {
                if (region.id.startsWith('shot_')) return;
                saveState();
                let { start, end } = region;
                shotChanges.forEach(shotTime => {
                    if (Math.abs(start - shotTime) < snapThreshold) start = shotTime;
                    if (Math.abs(end - shotTime) < snapThreshold) end = shotTime;
                });
                if (start !== region.start || end !== region.end) region.setOptions({ start, end });
                const subIndex = subtitles.findIndex(s => s.id == region.id);
                if (subIndex > -1) {
                    subtitles[subIndex].start = start;
                    subtitles[subIndex].end = end;
                    renderSubtitles(false);
                }
            });

            wsRegions.on('region-in', (region) => {
                if (region.id.startsWith('shot_')) return;
                const sub = subtitles.find(s => s.id == region.id);
                if (sub) {
                    const styleDefinition = assStyles.find(style => style.Name === sub.style) || assStyles.find(style => style.Name === 'Default');
                    applyAssStyleToElement(subtitlePreview, styleDefinition);
                    subtitlePreview.innerHTML = `<span>${sub.text.replace(/\n/g, '<br>')}</span>`;

                    if (!isUserEditing) {
                        setActiveSubtitle(subtitles.findIndex(s => s.id === region.id), { fromPlayback: true });
                    }
                }
            });
           
            wsRegions.on('region-out', (region) => {
                if (region.id.startsWith('shot_')) return;
                subtitlePreview.innerHTML = '';
                subtitlePreview.style.cssText = '';
                const subIndex = subtitles.findIndex(s => s.id === region.id);
                if (!isUserEditing && workMode !== 'sync' && activeSubtitleIndex === subIndex) {
                    setActiveSubtitle(-1, { fromPlayback: true });
                }
            });

            wsRegions.on('region-clicked', (region, e) => {
                if (region.id.startsWith('shot_')) return;
                e.stopPropagation();
                wavesurfer.seekTo(region.start / wavesurfer.getDuration());
                handleRowClick(e, subtitles.findIndex(s => s.id == region.id));
            });
        };

 waveformContainer.addEventListener('click', (e) => {
                // Esto solo se activa si el clic es fuera de una regi√≥n,
                // ya que 'region-clicked' detiene la propagaci√≥n del evento.
                if (workMode === 'sync' && activeSubtitleIndex !== -1) {
                    setActiveSubtitle(-1);
                }
            });
        
const createNewProject = () => {
    isTranslationMode = false;
    if (wavesurfer) { wavesurfer.destroy(); wavesurfer = null; }
    subtitles = []; assStyles = [createDefaultAssStyle()]; shotChanges = [];
    historyStack = []; redoStack = []; activeSubtitleIndex = -1; nextSubtitleId = 1;

    updateUndoRedoButtons();
    setActiveSubtitle(-1); 
    inVideoEditor.innerHTML = ''; 
    inVideoEditorContainer.style.display = 'none';
    renderSubtitles(false); 
    
    videoPlayer.src = '';
    loadingIndicator.style.display = 'flex';
    loadingIndicator.innerHTML = `
        <img src="https://raw.githubusercontent.com/rlstradu/httrans/refs/heads/main/subpanda-logo.png" alt="Subpanda Logo" class="h-20 opacity-70" style="filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));">
        <label for="video-loader" class="bg-black/70 px-4 py-2 rounded-lg cursor-pointer hover:bg-black/90 transition-colors">${t('msg_import_video_prompt')}</label>
    `;
    detectShotsBtn.disabled = true;
    timecodeDisplay.textContent = '00:00:00,000';
    customProgressBarContainer.style.opacity = '0';
    progressTimeCurrent.textContent = '00:00:00,000';
    progressTimeDuration.textContent = '00:00:00,000';
    updateProgressBar(0, 1);

    const videoLoaderLabel = document.querySelector('label[for="video-loader"]');
    if (videoLoaderLabel) { videoLoaderLabel.querySelector('span').textContent = t('label_load_video'); }

    showModalAlert(t('msg_new_project'));
};        


        // --- MANEJO DE ARCHIVOS Y V√çDEO ---
    const loadVideoFile = (file) => {
    const videoURL = URL.createObjectURL(file);
    videoPlayer.src = videoURL;
    loadingIndicator.style.display = 'flex';
    loadingIndicator.innerHTML = `<p class="bg-black/70 px-4 py-2 rounded-lg">${t('msg_loading_video')}</p>`;
    detectShotsBtn.disabled = true;

    videoPlayer.addEventListener('loadeddata', initializeWaveSurfer, { once: true });

    const videoLoaderLabel = document.querySelector('label[for="video-loader"]');
    if (videoLoaderLabel) {
        videoLoaderLabel.querySelector('span').textContent = t('label_change_video');
    }
};

videoLoader.addEventListener('change', (e) => { 
    if (e.target.files[0]) {
        loadVideoFile(e.target.files[0]);
    }
    // A√ëADIDO: Resetea el input para poder cargar el mismo v√≠deo otra vez.
    e.target.value = null; 
});
        // --- QA CHECKS ---
        const runSingleSubQaCheck = (index) => {
            const issues = [];
            const sub = subtitles[index];
            if (!sub) return issues;
            const stats = calculateSubtitleStats(sub);
            const text = sub.text;
            const lines = text.split('\n');

            if (qaSettings.maxCpsEnabled && stats.cps > qaSettings.maxCps) 
                issues.push(`${t('qa_err_cps')}: ${stats.cps.toFixed(1)} (${t('qa_limit')} ${qaSettings.maxCps})`);
            
            if (qaSettings.maxWpmEnabled && stats.wpm > qaSettings.maxWpm) 
                issues.push(`${t('qa_err_wpm')}: ${stats.wpm.toFixed(0)}`);
            
            if (qaSettings.maxCplEnabled) stats.cpl.forEach((len, i) => { 
                if (len > qaSettings.maxCpl) 
                    issues.push(`${t('qa_err_cpl')} (L${i + 1}): ${len} (${t('qa_limit')} ${qaSettings.maxCpl})`); 
            });

            if (qaSettings.maxLinesEnabled && lines.length > qaSettings.maxLines) 
                issues.push(`${t('qa_err_lines')}: ${lines.length} (${t('qa_limit')} ${qaSettings.maxLines})`);
            
            if (qaSettings.emptySubsEnabled && text.trim() === '') 
                issues.push(t('qa_err_empty'));
            
            if (qaSettings.minDurationEnabled) {
                const dur = qaSettings.minDurationUnit === 'ms' ? stats.duration * 1000 : Math.round(stats.duration * frameRate);
                if (dur < qaSettings.minDuration) 
                    issues.push(`${t('qa_err_min_dur')}: ${dur.toFixed(0)} ${qaSettings.minDurationUnit} (${t('qa_min')} ${qaSettings.minDuration} ${qaSettings.minDurationUnit})`);
            }
            if (qaSettings.maxDurationEnabled) {
                const dur = qaSettings.maxDurationUnit === 'ms' ? stats.duration * 1000 : Math.round(stats.duration * frameRate);
                if (dur > qaSettings.maxDuration) 
                    issues.push(`${t('qa_err_max_dur')}: ${dur.toFixed(0)} ${qaSettings.maxDurationUnit} (${t('qa_max')} ${qaSettings.maxDuration} ${qaSettings.maxDurationUnit})`);
            }
            if (qaSettings.overlapEnabled) {
                 if (index > 0 && sub.start < subtitles[index - 1].end) issues.push(t('qa_err_overlap_prev'));
                 if (index < subtitles.length - 1 && sub.end > subtitles[index + 1].start) issues.push(t('qa_err_overlap_next'));
            }
            if (index > 0) {
                const gap = sub.start - subtitles[index - 1].end;
                if (gap >= 0) {
                    if (qaSettings.minGapMsEnabled && Math.round(gap * 1000) < qaSettings.minGapMs) 
                        issues.push(`${t('qa_err_gap')}: ${Math.round(gap * 1000)}ms (${t('qa_min')} ${qaSettings.minGapMs}ms)`);
                    if (qaSettings.minGapFramesEnabled && Math.round(gap * frameRate) < qaSettings.minGapFrames) 
                        issues.push(`${t('qa_err_gap')}: ${Math.round(gap*frameRate)} frames (${t('qa_min')} ${qaSettings.minGapFrames} frames)`);
                }
            }
            return issues;
        };

// ========================================================================
// === INICIO: L√ìGICA COMPLETA DEL PANEL DE REVISI√ìN DE QA (V3.1 - CORREGIDA) ===
// ========================================================================

const openQaReviewModal = () => {
    // NUEVA L√ìGICA PARA MANTENER EL ESTADO DE LOS ERRORES
    
    // 1. Generamos una lista fresca con los errores que existen AHORA MISMO.
    const freshIssues = [];
    subtitles.forEach((sub, index) => {
        const issues = runSingleSubQaCheck(index);
        if (issues.length > 0) {
            freshIssues.push({
                id: sub.id,
                index: index,
                issues: issues,
                text: sub.text,
                start: sub.start,
                end: sub.end,
                status: 'visible' // Estado por defecto para los errores nuevos
            });
        }
    });

    // 2. Creamos la lista actualizada, preservando los estados antiguos.
    const updatedQaIssues = freshIssues.map(freshItem => {
        // Buscamos si este error (por su ID de subt√≠tulo) ya exist√≠a en la lista anterior.
        const existingItem = currentQaIssues.find(oldItem => oldItem.id === freshItem.id);

        if (existingItem) {
            // Si exist√≠a, mantenemos su estado anterior (revisado o ignorado).
            freshItem.status = existingItem.status;
        }
        // Si no exist√≠a, se queda con el estado 'visible' por defecto.
        return freshItem;
    });

    // 3. Reemplazamos la lista antigua por la nueva lista actualizada.
    currentQaIssues = updatedQaIssues;

    // 4. Renderizamos el panel con la informaci√≥n actualizada.
    renderQaReviewPanel();
    qaReviewPanel.classList.remove('hidden');
};

const renderQaReviewPanel = () => {
    // NUEVO: Calculamos los contadores para cada estado.
    const counts = {
        visible: currentQaIssues.filter(item => item.status === 'visible').length,
        reviewed: currentQaIssues.filter(item => item.status === 'reviewed').length,
        ignored: currentQaIssues.filter(item => item.status === 'ignored').length,
    };

    // MODIFICADO: Ahora el t√≠tulo principal es fijo.
    let html = `
        <div class="floating-pane-header">
            <h2>${t('rep_title')}</h2>
            <div class="header-button-group">
                <button class="header-icon-btn" id="restore-qa-list-btn" title="${t('tooltip_qa_restore')}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 11.25H6.375m3.438 0a2.25 2.25 0 1 1 4.5 0a2.25 2.25 0 0 1-4.5 0Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7.875 9.75 6.375 11.25l1.5 1.5" />
                    </svg>
                </button>
                <button class="header-icon-btn" id="export-qa-btn" title="${t('tooltip_qa_export')}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                </button>
                <button class="header-icon-btn" id="reset-qa-panel-btn" title="${t('tooltip_qa_reset_pos')}">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg>
                </button>
                <button class="header-icon-btn close-btn" title="${t('btn_close')}">&times;</button>
            </div>
        </div>

        <div class="qa-panel-tabs">
            <button class="qa-tab-btn ${activeQaStatus === 'visible' ? 'active' : ''}" data-status="visible">${t('rep_pending')} (${counts.visible})</button>
            <button class="qa-tab-btn ${activeQaStatus === 'reviewed' ? 'active' : ''}" data-status="reviewed">${t('rep_reviewed')} (${counts.reviewed})</button>
            <button class="qa-tab-btn ${activeQaStatus === 'ignored' ? 'active' : ''}" data-status="ignored">${t('rep_ignored')} (${counts.ignored})</button>
        </div>

        <div class="floating-pane-content">`;

    // MODIFICADO: Filtramos los errores bas√°ndonos en la pesta√±a activa.
    const issuesToShow = currentQaIssues.filter(item => item.status === activeQaStatus);

    if (issuesToShow.length === 0) {
        html += `<p class="text-center text-gray-400 py-8">${t('rep_no_errors')}</p>`;
    } else {
        issuesToShow.forEach(item => {
            const originalItemIndex = currentQaIssues.findIndex(i => i.id === item.id);
            // AQUI ESTABAN LOS TEXTOS FIJOS. AHORA USAN t()
            html += `
                <div class="qa-review-item">
                    <button class="qa-review-item-header" data-index="${item.index}">
                        ${t('lbl_subtitle_num')}${item.id} (${item.issues.length} ${t('rep_errors_label').replace(':','').toLowerCase()})
                    </button>
                    <ul class="qa-review-item-errors">
                        ${item.issues.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                    <div class="qa-item-actions">
                        <button class="qa-action-btn" data-item-index="${originalItemIndex}" data-action="ignore">${t('qa_btn_ignore')}</button>
                        <button class="qa-action-btn" data-item-index="${originalItemIndex}" data-action="review">${t('qa_btn_mark_reviewed')}</button>
                    </div>
                </div>`;
        });
    }

    html += `</div>
        <div class="resizer top-left"></div><div class="resizer top-right"></div><div class="resizer bottom-left"></div><div class="resizer bottom-right"></div>
        <div class="resizer top"></div><div class="resizer bottom"></div><div class="resizer left"></div><div class="resizer right"></div>`;

    qaReviewPanel.innerHTML = html;
    makePanelInteractive(qaReviewPanel);

    const updateItemStatus = (itemIndex, status) => {
        currentQaIssues[itemIndex].status = status;
        renderQaReviewPanel();
    };

    qaReviewPanel.querySelectorAll('.qa-action-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const itemIndex = parseInt(e.currentTarget.dataset.itemIndex, 10);
            const action = e.currentTarget.dataset.action;
            updateItemStatus(itemIndex, action === 'ignore' ? 'ignored' : 'reviewed');
        });
    });

    qaReviewPanel.querySelectorAll('.qa-tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            activeQaStatus = e.currentTarget.dataset.status;
            renderQaReviewPanel();
        });
    });

    qaReviewPanel.querySelector('#restore-qa-list-btn').addEventListener('click', () => {
        currentQaIssues.forEach(item => item.status = 'visible');
        activeQaStatus = 'visible';
        renderQaReviewPanel();
    });
    qaReviewPanel.querySelector('.close-btn').addEventListener('click', () => qaReviewPanel.classList.add('hidden'));
    qaReviewPanel.querySelector('#reset-qa-panel-btn').addEventListener('click', () => resetQaPanel());
    qaReviewPanel.querySelector('#export-qa-btn').addEventListener('click', () => openExportQaModal());
    const allQaItems = qaReviewPanel.querySelectorAll('.qa-review-item');
    qaReviewPanel.querySelectorAll('.qa-review-item-header').forEach(button => {
        button.addEventListener('click', (e) => {
            allQaItems.forEach(item => item.classList.remove('active'));
            const parentItem = e.currentTarget.closest('.qa-review-item');
            if (parentItem) {
                parentItem.classList.add('active');
            }
            setActiveSubtitle(parseInt(e.currentTarget.dataset.index, 10));
        });
    });
};



const makePanelInteractive = (panel) => {
    const header = panel.querySelector('.floating-pane-header');
    let dragInfo = { active: false, type: null, initialX: 0, initialY: 0, initialLeft: 0, initialTop: 0, initialWidth: 0, initialHeight: 0 };

    const onMouseDown = (e, type) => {
        dragInfo.active = true;
        dragInfo.type = type;
        dragInfo.initialX = e.clientX;
        dragInfo.initialY = e.clientY;
        dragInfo.initialLeft = panel.offsetLeft;
        dragInfo.initialTop = panel.offsetTop;
        dragInfo.initialWidth = panel.offsetWidth;
        dragInfo.initialHeight = panel.offsetHeight;
        document.body.style.userSelect = 'none';
        e.preventDefault();
    };

    header.addEventListener('mousedown', (e) => {
        if (e.target.closest('button')) { return; }
        onMouseDown(e, 'drag');
    });

    panel.querySelectorAll('.resizer').forEach(resizer => {
        resizer.addEventListener('mousedown', (e) => onMouseDown(e, resizer.className.replace('resizer ', '')));
    });

    const onMouseMove = (e) => {
        if (!dragInfo.active) return;
        const dx = e.clientX - dragInfo.initialX;
        const dy = e.clientY - dragInfo.initialY;

        if (dragInfo.type === 'drag') {
            panel.style.left = `${dragInfo.initialLeft + dx}px`;
            panel.style.top = `${dragInfo.initialTop + dy}px`;
        } else {
            if (dragInfo.type.includes('right')) panel.style.width = `${dragInfo.initialWidth + dx}px`;
            if (dragInfo.type.includes('bottom')) panel.style.height = `${dragInfo.initialHeight + dy}px`;
            if (dragInfo.type.includes('left')) {
                panel.style.width = `${dragInfo.initialWidth - dx}px`;
                panel.style.left = `${dragInfo.initialLeft + dx}px`;
            }
            if (dragInfo.type.includes('top')) {
                panel.style.height = `${dragInfo.initialHeight - dy}px`;
                panel.style.top = `${dragInfo.initialTop + dy}px`;
            }
        }
    };
    
    const onMouseUp = () => {
        dragInfo.active = false;
        document.body.style.userSelect = '';
    };

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
};

const resetQaPanel = () => {
    qaReviewPanel.style.top = '100px';
    qaReviewPanel.style.left = '';
    qaReviewPanel.style.right = '20px';
    qaReviewPanel.style.width = '450px';
    qaReviewPanel.style.height = '';
};

const openExportQaModal = () => {
    const modal = document.getElementById('export-qa-report-modal');
    const defaultFilename = `Informe_QA_${new Date().toISOString().slice(0,10)}`;
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">${t('modal_title_qa_export')}</h2>
                <button id="close-export-qa-modal" class="text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="qa-export-filename" class="text-sm font-medium text-gray-300">${t('lbl_filename')}</label>
                    <input type="text" id="qa-export-filename" class="text-import-input w-full mt-1 p-2 rounded-lg" value="${defaultFilename}">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-300">${t('lbl_format')}</label>
                    <div class="flex justify-around mt-2">
                        <label><input type="radio" name="qa-export-format" value="pdf" checked> PDF</label>
                        <label><input type="radio" name="qa-export-format" value="html"> HTML</label>
                        <label><input type="radio" name="qa-export-format" value="word"> Word (.doc)</label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6 pt-4 border-t border-light-gray">
                <button id="cancel-export-qa" class="text-btn">${t('btn_cancel')}</button>
                <button id="confirm-export-qa" class="text-btn bg-blue-600 hover:bg-blue-700">${t('btn_export')}</button>
            </div>
        </div>`;
        
    modal.style.display = 'flex';
    modal.querySelector('#close-export-qa-modal').addEventListener('click', () => modal.style.display = 'none');
    modal.querySelector('#cancel-export-qa').addEventListener('click', () => modal.style.display = 'none');
    modal.querySelector('#confirm-export-qa').addEventListener('click', () => {
        const filename = document.getElementById('qa-export-filename').value;
        const format = document.querySelector('input[name="qa-export-format"]:checked').value;
        switch(format) {
            case 'pdf': exportQaToPdf(filename); break;
            case 'html': exportQaToHtml(filename); break;
            case 'word': exportQaToWord(filename); break;
        }
        modal.style.display = 'none';
    });
};

const generateReportContent = () => {
    // 1. Separamos los problemas en tres listas
    const pendingIssues = currentQaIssues.filter(item => item.status === 'visible');
    const reviewedIssues = currentQaIssues.filter(item => item.status === 'reviewed');
    const ignoredIssues = currentQaIssues.filter(item => item.status === 'ignored');

    // 2. Construimos el contenido usando t()
    let content = `${t('rep_title')} - ${new Date().toLocaleString()}\n\n`;
    content += `${t('rep_summary')}\n`;
    content += `- ${t('rep_pending')}: ${pendingIssues.length}\n`;
    content += `- ${t('rep_reviewed')}: ${reviewedIssues.length}\n`; // Corregido
    content += `- ${t('rep_ignored')}: ${ignoredIssues.length}\n\n`;   // Corregido

    // 3. Funci√≥n auxiliar
    const appendIssuesToContent = (title, issues) => {
        content += `========================================\n`;
        content += ` ${title.toUpperCase()} (${issues.length})\n`;
        content += `========================================\n\n`;

        if (issues.length === 0) {
            content += `${t('rep_no_errors')}\n\n`; // Corregido para usar t()
        } else {
            issues.forEach(item => {
                content += `${t('lbl_subtitle_num')}${item.id} (${formatSrtTime(item.start)} --> ${formatSrtTime(item.end)})\n`;
                content += `\n${item.text}\n\n`;
                content += `${t('rep_errors_label')}\n`; // Corregido
                item.issues.forEach(issue => {
                    content += `  - ${issue}\n`;
                });
                content += `\n`;
            });
        }
    };

    // 4. A√±adimos cada secci√≥n
    appendIssuesToContent(t('rep_pending'), pendingIssues);
    appendIssuesToContent(t('rep_reviewed'), reviewedIssues);
    appendIssuesToContent(t('rep_ignored'), ignoredIssues);

    return content;
};


const exportQaToPdf = (filename) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const pageHeight = doc.internal.pageSize.height;
    const pageWidth = doc.internal.pageSize.width;
    const margin = 15;
    const lineHeight = 7;
    let currentY = margin; 

    const pendingIssues = currentQaIssues.filter(item => item.status === 'visible');
    const reviewedIssues = currentQaIssues.filter(item => item.status === 'reviewed');
    const ignoredIssues = currentQaIssues.filter(item => item.status === 'ignored');

    const checkPageBreak = (neededHeight) => {
        if (currentY + neededHeight > pageHeight - margin) {
            doc.addPage();
            currentY = margin;
        }
    };

    const renderSection = (title, issues) => {
        checkPageBreak(20);
        doc.setFont('helvetica', 'bold');
        doc.text(title.toUpperCase(), margin, currentY);
        currentY += lineHeight * 1.5;
        doc.setFont('helvetica', 'normal');

        if (issues.length === 0) {
            doc.setTextColor(150);
            // CAMBIO: Usamos t()
            doc.text(t('rep_no_errors'), margin, currentY);
            doc.setTextColor(0);
            currentY += lineHeight * 2;
            return;
        }

        issues.forEach(item => {
            const itemHeight = (4 + item.issues.length) * lineHeight + 10;
            checkPageBreak(itemHeight);

            doc.text(`${t('header_subs')} #${item.id} (${formatSrtTime(item.start)} --> ${formatSrtTime(item.end)})`, margin, currentY);
            currentY += lineHeight;
            doc.text(item.text.replace(/\n/g, ' / '), margin, currentY);
            currentY += lineHeight;
            // CAMBIO: "Errores:" a ingl√©s si corresponde. (A√±adiremos 'rep_errors_label' al diccionario abajo)
            doc.text(currentLang === 'es' ? 'Errores:' : 'Errors:', margin, currentY);
            currentY += lineHeight;

            doc.setTextColor(255, 0, 0);
            item.issues.forEach(issue => {
                doc.text(`  - ${issue}`, margin, currentY);
                currentY += lineHeight;
            });
            doc.setTextColor(0, 0, 0); 

            currentY += 3;
            doc.setDrawColor(200);
            doc.line(margin, currentY, pageWidth - margin, currentY);
            currentY += lineHeight;
        });
    };

    doc.setFontSize(16);
    // CAMBIO: Usamos t()
    doc.text(t('rep_title'), pageWidth / 2, currentY, { align: 'center' });
    currentY += lineHeight * 2;
    doc.setFontSize(10);
    
    renderSection(`${t('rep_pending')} (${pendingIssues.length})`, pendingIssues);
    renderSection(`${t('rep_reviewed')} (${reviewedIssues.length})`, reviewedIssues);
    renderSection(`${t('rep_ignored')} (${ignoredIssues.length})`, ignoredIssues);

    doc.save(`${filename}.pdf`);
};


const exportQaToHtml = (filename) => {
    // MODIFICADO: Ahora llamamos a nuestra nueva funci√≥n generadora de informes.
    const htmlContent = generateRichHtmlReport();
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${filename}.html`;
    a.click();
    URL.revokeObjectURL(a.href);
};

const generateRichHtmlReport = () => {
    // 1. Separamos los errores en las tres categor√≠as
    const pendingIssues = currentQaIssues.filter(item => item.status === 'visible');
    const reviewedIssues = currentQaIssues.filter(item => item.status === 'reviewed');
    const ignoredIssues = currentQaIssues.filter(item => item.status === 'ignored');

    // 2. Funci√≥n auxiliar para crear la tabla de cada secci√≥n
    const createSectionTable = (issues) => {
        if (issues.length === 0) {
            return `<p class="empty-section">${t('rep_no_errors')}</p>`;
        }
        let tableHtml = '<table class="error-table">';
        issues.forEach(item => {
            tableHtml += `
                <tr class="error-card">
                    <td class="error-meta">
                        <strong>${t('header_subs')} #${item.id}</strong><br>
                        <span class="monospace">${formatSrtTime(item.start)}</span><br>
                        <span class="monospace">${formatSrtTime(item.end)}</span>
                    </td>
                    <td class="error-details">
                        <p class="subtitle-text monospace">${item.text.replace(/\n/g, '<br>')}</p>
                        <ul class="error-list">
                            ${item.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </td>
                </tr>
            `;
        });
        tableHtml += '</table>';
        return tableHtml;
    };

    // 3. Construimos el documento HTML completo con estilos CSS incrustados
    return `
        <!DOCTYPE html>
        <html lang="${currentLang}">
        <head>
            <meta charset="UTF-8">
            <title>${t('rep_title')}</title>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
            <style>
                body {
                    font-family: 'Inter', sans-serif;
                    background-color: #1E1E1E;
                    color: #EAEAEA;
                    margin: 0;
                    padding: 40px;
                }
                .report-container {
                    max-width: 900px;
                    margin: auto;
                    background-color: #2D2D2D;
                    border-radius: 12px;
                    padding: 30px 40px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                }
                .report-header h1 {
                    color: #A4CAFE;
                    margin: 0 0 10px 0;
                }
                .report-header p {
                    margin: 0 0 30px 0;
                    color: #A0A0A0;
                    border-bottom: 1px solid #373737;
                    padding-bottom: 20px;
                }
                .report-summary {
                    background-color: #252525;
                    border: 1px solid #373737;
                    border-radius: 8px;
                    padding: 15px 20px;
                    margin-bottom: 30px;
                    display: flex;
                    justify-content: space-around;
                }
                .summary-item { text-align: center; }
                .summary-item strong { font-size: 1.5rem; color: #EAEAEA; }
                .summary-item span { font-size: 0.9rem; color: #A0A0A0; }
                
                .report-section h2 {
                    margin-top: 40px;
                    border-bottom: 2px solid #A4CAFE;
                    padding-bottom: 10px;
                    color: #EAEAEA;
                }
                .error-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                }
                .error-card {
                    border-bottom: 1px solid #373737;
                }
                .error-card td {
                    padding: 15px 10px;
                    vertical-align: top;
                }
                .error-meta {
                    width: 25%;
                    color: #A0A0A0;
                    font-size: 0.9rem;
                }
                .error-meta strong { color: #EAEAEA; font-size: 1rem; }
                .error-details .subtitle-text {
                    background-color: #252525;
                    padding: 10px;
                    border-radius: 6px;
                    white-space: pre-wrap;
                    margin-top: 0;
                }
                .error-list {
                    padding-left: 20px;
                    margin: 15px 0 0 0;
                }
                .error-list li {
                    color: #ef4444; /* Rojo para los errores */
                    margin-bottom: 8px;
                }
                .empty-section {
                    color: #A0A0A0;
                    padding: 20px;
                    text-align: center;
                    background-color: #252525;
                    border-radius: 8px;
                }
                .monospace { font-family: monospace; }

            </style>
        </head>
        <body>
            <div class="report-container">
                <header class="report-header">
                    <h1>${t('rep_title')}</h1>
                    <p>${t('rep_generated')} ${new Date().toLocaleString()}</p>
                </header>

                <div class="report-summary">
                    <div class="summary-item"><strong>${pendingIssues.length}</strong><br><span>${t('rep_pending')}</span></div>
                    <div class="summary-item"><strong>${reviewedIssues.length}</strong><br><span>${t('rep_reviewed')}</span></div>
                    <div class="summary-item"><strong>${ignoredIssues.length}</strong><br><span>${t('rep_ignored')}</span></div>
                </div>

                <section class="report-section">
                    <h2>${t('rep_pending')}</h2>
                    ${createSectionTable(pendingIssues)}
                </section>

                <section class="report-section">
                    <h2>${t('rep_reviewed')}</h2>
                    ${createSectionTable(reviewedIssues)}
                </section>

                <section class="report-section">
                    <h2>${t('rep_ignored')}</h2>
                    ${createSectionTable(ignoredIssues)}
                </section>
            </div>
        </body>
        </html>
    `;
};

const exportQaToWord = (filename) => {
    const reportText = generateReportContent();
    const htmlContent = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Informe QA</title></head><body><pre>${reportText}</pre></body></html>`;
    const blob = new Blob([htmlContent], { type: 'application/msword' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${filename}.doc`;
    a.click();
    URL.revokeObjectURL(a.href);
};

// ========================================================================
// === FIN: L√ìGICA COMPLETA DEL PANEL DE REVISI√ìN DE QA (V3.1 - CORREGIDA) ===
// ========================================================================

        // --- RENDERIZADO DE SUBT√çTULOS ---
        const stripHtml = (html) => html.replace(/<[^>]*>?/gm, '');
        const countWords = (text) => text.trim().split(/\s+/).filter(Boolean).length;
        const calculateSubtitleStats = (sub) => {
            const duration = sub.end - sub.start;
            if (duration <= 0) return { duration: 0, cps: 0, wpm: 0, cpl: sub.text.split('\n').map(l => l.length), lineCounts: sub.text.split('\n').map((l, i) => `L${i+1}: ${l.length}`).join(' / ') };
            const plainText = stripHtml(sub.text.replace(/\{[^\}]+\}/g, '')); // Strip ASS tags for stats
            const charCount = plainText.length;
            const wordCount = countWords(plainText);
            const cps = duration > 0 ? (charCount / duration) : 0;
            const wpm = duration > 0 ? (wordCount / duration) * 60 : 0;
            const lines = plainText.split('\n');
            const cpl = lines.map(line => line.length);
            const lineCounts = lines.map((line, i) => `L${i + 1}: ${line.length}`).join('<br>');
            return { duration, cps, wpm, cpl, lineCounts };
        };

        const getNextAvailableId = () => {
            if (subtitles.length === 0) {
                // Si no hay subt√≠tulos, empezamos desde 1
                return 1;
            }
            // Encontramos el ID num√©rico m√°s alto en la lista actual
            // Usamos Math.max(0, ...) para evitar errores si todos los IDs fueran inv√°lidos
            const maxId = Math.max(0, ...subtitles.map(s => parseInt(s.id, 10) || 0));
            // El nuevo ID ser√° el m√°s alto + 1
            return maxId + 1;
        };

        const formatSrtTime = (time) => {
            if (isNaN(time) || time < 0) return '--:--:--,---';
            const date = new Date(0);
            date.setSeconds(time);
            const timeStr = date.toISOString().substr(11, 8);
            if (timeFormat === 'frames') {
                const frame = Math.round((time * frameRate) % frameRate);
                return `${timeStr}:${String(frame).padStart(2, '0')}`;
            }
            return `${timeStr},${String(Math.round((time % 1) * 1000)).padStart(3, '0')}`;
        };
        const renderSubtitles = (renderRegions = true) => {
            subtitleBody.innerHTML = '';
            
            subtitles.sort((a, b) => {
                if (a.start < 0 && b.start < 0) return 0;
                if (a.start < 0) return 1;
                if (b.start < 0) return -1;
                return a.start - b.start;
            });

            if (renderRegions && wsRegions?.getRegions) wsRegions.getRegions().filter(r => !r.id.startsWith('shot_') && r.id !== 'temp-selection').forEach(r => r.remove());

            document.getElementById('original-text-header').style.display = isTranslationMode ? '' : 'none';


            subtitles.forEach((sub, index) => {
                if (renderRegions && wsRegions && sub.end > sub.start) addSubtitleRegion(sub);
                const stats = calculateSubtitleStats(sub);
                const qaIssues = runSingleSubQaCheck(index);
                const row = document.createElement('tr');
                row.className = 'subtitle-row';
                row.classList.toggle('active', index === activeSubtitleIndex);
                row.classList.toggle('selected', selectedSubtitleIndices.has(index));
                row.classList.toggle('has-error', qaIssues.length > 0);
                row.dataset.index = index;

             

                const styleOptions = assStyles.map(style => `<option value="${style.Name}" ${sub.style === style.Name ? 'selected' : ''}>${style.Name}</option>`).join('');

row.innerHTML = `
    <td class="p-2 align-top text-center col-qa">${qaIssues.length > 0 ? `<div data-tooltip="${qaIssues.join('\n')}"><svg class="w-5 h-5 qa-alert-icon mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg></div>` : ''}</td>
    <td class="p-2 text-gray-400 align-top col-id">${sub.id}</td>
    <td class="p-2 font-mono text-sm align-top col-times">
        <div class="time-col-item text-cyan-300"><span>[</span><span>${formatSrtTime(sub.start)}</span></div>
        <div class="time-col-item text-fuchsia-300"><span>]</span><span>${formatSrtTime(sub.end)}</span></div>
        <div class="time-col-item text-yellow-400"><span>üïí</span><span>${stats.duration.toFixed(3)}s</span></div>
    </td>
    
    <td class="p-2 align-top col-original-text" style="display: ${isTranslationMode ? '' : 'none'};">
        <div class="table-text-preview">${sub.originalText ? sub.originalText.replace(/\n/g, '<br>') : ''}</div>
    </td>

    <td class="p-2 align-top col-text"><div class="table-text-preview">${sub.text.replace(/\n/g, '<br>')}</div></td>
    <td class="p-2 text-center font-mono align-top table-stats col-cps ${qaIssues.some(i => i.includes('CPS')) ? 'text-red-400' : ''}">${stats.cps.toFixed(1)}</td>
    <td class="p-2 text-center font-mono align-top table-stats col-wpm ${qaIssues.some(i => i.includes('PPM')) ? 'text-red-400' : ''}">${stats.wpm.toFixed(0)}</td>
    <td class="p-2 text-xs font-mono align-top table-stats col-lines ${qaIssues.some(i => i.includes('CPL')) ? 'text-red-400' : ''}">${stats.lineCounts}</td>
    <td class="p-2 align-top col-style"><select class="style-select" data-index="${index}">${styleOptions}</select></td>
`;
                subtitleBody.appendChild(row);
            });

            addTableListeners();
            initializeTooltips();
            updateColumnVisibility();
applyColumnVisibility();

        };

        let lastClickedIndex = -1;
        const handleRowClick = (e, index) => {
            if (e.target.closest('select, [data-tooltip]')) return;
            
            if (e.shiftKey && lastClickedIndex !== -1) {
                selectedSubtitleIndices.clear();
                const start = Math.min(index, lastClickedIndex);
                const end = Math.max(index, lastClickedIndex);
                for (let i = start; i <= end; i++) {
                    selectedSubtitleIndices.add(i);
                }
            } else if (e.ctrlKey || e.metaKey) {
                if (selectedSubtitleIndices.has(index)) {
                    selectedSubtitleIndices.delete(index);
                } else {
                    selectedSubtitleIndices.add(index);
                }
            } else {
                selectedSubtitleIndices.clear();
                selectedSubtitleIndices.add(index);
                setActiveSubtitle(index);
            }
            
            lastClickedIndex = index;
            renderSubtitles(false);
        };

const handleRowDoubleClick = (index) => {
    // Nos aseguramos de que el wavesurfer est√© listo
    if (!wavesurfer) return;

    const sub = subtitles[index];

    // Comprobamos que el subt√≠tulo existe y tiene un tiempo de inicio v√°lido
    if (sub && sub.start >= 0) {
        // Le decimos a wavesurfer (y al v√≠deo) que vaya a ese segundo exacto
        wavesurfer.setTime(sub.start);
        
        // Opcional: Pausamos el v√≠deo para que el usuario pueda ver el frame exacto
        wavesurfer.pause();
    }
};

        const addTableListeners = () => {
            document.querySelectorAll('.subtitle-row').forEach(row => {
                const index = parseInt(row.dataset.index);
                row.addEventListener('click', (e) => handleRowClick(e, index));
    row.addEventListener('dblclick', () => handleRowDoubleClick(index));
                row.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    contextMenuIndex = index;
                    if (!selectedSubtitleIndices.has(index)) {
                         selectedSubtitleIndices.clear();
                         selectedSubtitleIndices.add(index);
                         renderSubtitles(false);
                    }
                    contextMenu.style.top = `${e.clientY}px`;
                    contextMenu.style.left = `${e.clientX}px`;
                    contextMenu.classList.remove('hidden');
                    document.getElementById('ctx-menu-merge-prev').style.display = index > 0 ? 'flex' : 'none';
                    document.getElementById('ctx-menu-merge-next').style.display = index < subtitles.length - 1 ? 'flex' : 'none';
                });
            });

            document.querySelectorAll('.style-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    saveState();
                    const index = parseInt(e.target.dataset.index);
                    subtitles[index].style = e.target.value;
                });
            });
        };
        const addSubtitleRegion = (sub) => {
            if (!wsRegions) return;
            const isCreating = activeSubtitleIndex > -1 && subtitles[activeSubtitleIndex]?.id === sub.id;
            const stats = calculateSubtitleStats(sub);
            const region = wsRegions.addRegion({
                id: sub.id, start: sub.start, end: sub.end, color: 'rgba(55, 55, 55, 0.7)', drag: true, resize: true,
            });
            const content = document.createElement('div');
            content.className = 'region-content';
            content.innerHTML = `<div><span class="region-id">${sub.id}</span></div><div class="region-text-line">${stripHtml(sub.text)}</div><div class="region-stats">CPS: ${stats.cps.toFixed(1)} | PPM: ${stats.wpm.toFixed(0)}</div><div class="region-stats text-xs">${stats.lineCounts}</div>`;
            if(region.element) region.element.appendChild(content);
        };
        
   const setActiveSubtitle = (index, options = {}) => {
    if (workMode === 'preview' && index !== -1) return;
    const { fromPlayback = false, focusEditor = workMode === 'edit' } = options;

    if (activeSubtitleIndex > -1 && activeSubtitleIndex !== index) {
        const oldSub = subtitles[activeSubtitleIndex];
        if (oldSub && wsRegions) {
            const oldRegion = wsRegions.getRegions().find(r => r.id == oldSub.id);
            if (oldRegion) oldRegion.setOptions({ color: 'rgba(55, 55, 55, 0.7)' });
        }
    }

    if (activeSubtitleIndex === index && !fromPlayback) return;

    lastActiveSubtitleIndex = activeSubtitleIndex;
    activeSubtitleIndex = index;

    document.querySelectorAll('.subtitle-row').forEach((row) => row.classList.toggle('active', parseInt(row.dataset.index) === index));

    const originalPreview = document.getElementById('in-video-original-text-preview');

    if (index === -1) {
        inVideoEditorContainer.classList.add('hidden');
        inVideoEditorContainer.classList.remove('flex');
        inVideoEditor.style.cssText = '';
        document.body.focus();
        if (originalPreview) originalPreview.classList.add('hidden');
    } else {
        const sub = subtitles[index];
        if (wsRegions) wsRegions.getRegions().find(r => r.id == sub.id)?.setOptions({ color: 'rgba(7, 91, 162, 0.8)' });
        subtitlePreview.innerHTML = '';

        if (isTranslationMode && sub.originalText) {
            originalPreview.textContent = sub.originalText;
            originalPreview.classList.remove('hidden');
        } else {
            originalPreview.classList.add('hidden');
        }

        inVideoEditor.innerHTML = sub.text.replace(/\n/g, '<br>');
        const styleDefinition = assStyles.find(style => style.Name === sub.style) || assStyles.find(style => style.Name === 'Default');
        applyAssStyleToElement(inVideoEditor, styleDefinition, 'basic');

        inVideoEditorContainer.classList.remove('hidden');
        inVideoEditorContainer.classList.add('flex');
        updateInVideoStats(sub);

        if (focusEditor && !fromPlayback) {
            setTimeout(() => {
                focusContentEditable(inVideoEditor, true);
            }, 0);
        } else {
            document.body.focus();
        }

        const row = subtitleBody.querySelector(`tr[data-index="${index}"]`);
        if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
};

const updateInVideoStats = (sub) => {
    const left = document.getElementById('in-video-stats-left');
    const right = document.getElementById('in-video-stats-right');
    const translatedStats = calculateSubtitleStats(sub);
    const origLabel = t('stats_orig'); 
    const wpmLabel = t('col_name_wpm'); // CORREGIDO: Usa la clave correcta "PPM/WPM"

    if (isTranslationMode) {
        const originalSub = { ...sub, text: sub.originalText };
        const originalStats = calculateSubtitleStats(originalSub);
        left.innerHTML = `<div class="stats-label ${translatedStats.cps > qaSettings.maxCps ? 'warning' : ''}">CPS: ${translatedStats.cps.toFixed(1)} (${origLabel}: ${originalStats.cps.toFixed(1)})</div><div class="stats-label ${translatedStats.wpm > qaSettings.maxWpm ? 'warning' : ''}">${wpmLabel}: ${translatedStats.wpm.toFixed(0)} (${origLabel}: ${originalStats.wpm.toFixed(0)})</div>`;
        right.innerHTML = translatedStats.cpl.map((len, i) => `<div class="stats-label ${len > qaSettings.maxCpl ? 'warning' : ''}">L${i + 1}: ${len} (${origLabel}: ${originalStats.cpl[i] || 0})</div>`).join('');
    } else {
        left.innerHTML = `<div class="stats-label ${translatedStats.cps > qaSettings.maxCps ? 'warning' : ''}">CPS: ${translatedStats.cps.toFixed(1)}</div><div class="stats-label ${translatedStats.wpm > qaSettings.maxWpm ? 'warning' : ''}">${wpmLabel}: ${translatedStats.wpm.toFixed(0)}</div>`;
        right.innerHTML = translatedStats.cpl.map((len, i) => `<div class="stats-label ${len > qaSettings.maxCpl ? 'warning' : ''}">L${i + 1}: ${len}</div>`).join('');
    }
};

const updateTableRow = (index) => {
    const row = subtitleBody.querySelector(`tr[data-index="${index}"]`);
    if (!row) return;
    const sub = subtitles[index];
    if (!sub) return;
    const stats = calculateSubtitleStats(sub);
    const qaIssues = runSingleSubQaCheck(index);

    const textCell = row.querySelector('.col-text .table-text-preview');
    if (textCell) textCell.innerHTML = sub.text.replace(/\n/g, '<br>');

    const cpsCell = row.querySelector('.col-cps');
    if (cpsCell) {
        cpsCell.textContent = stats.cps.toFixed(1);
        cpsCell.classList.toggle('text-red-400', qaIssues.some(i => i.includes('CPS')));
    }

    const wpmCell = row.querySelector('.col-wpm');
    if (wpmCell) {
        wpmCell.textContent = stats.wpm.toFixed(0);
        wpmCell.classList.toggle('text-red-400', qaIssues.some(i => i.includes('PPM')));
    }

    const linesCell = row.querySelector('.col-lines');
    if (linesCell) {
        linesCell.innerHTML = stats.lineCounts;
        linesCell.classList.toggle('text-red-400', qaIssues.some(i => i.includes('CPL')));
    }

    const qaCell = row.querySelector('.col-qa');
    if (qaCell) {
        if (qaIssues.length > 0) {
            qaCell.innerHTML = `<div data-tooltip="${qaIssues.join('\n')}"><svg class="w-5 h-5 qa-alert-icon mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg></div>`;
            initializeTooltips();
        } else {
            qaCell.innerHTML = '';
        }
    }
    row.classList.toggle('has-error', qaIssues.length > 0);
};

inVideoEditor.addEventListener('input', () => {
    if (activeSubtitleIndex === -1) return;
    const sub = subtitles[activeSubtitleIndex];
    sub.text = inVideoEditor.innerText.replace(/\r/g, '');
    updateInVideoStats(sub);
    updateTableRow(activeSubtitleIndex);
});

inVideoEditor.addEventListener('blur', () => {
    if (activeSubtitleIndex > -1) {
        saveState();
    }
});

        inVideoEditor.addEventListener('focus', () => { isUserEditing = true; });

        // --- MANEJO DE EVENTOS GENERAL ---
        playPauseBtn.addEventListener('click', handlePlayPause);
        setInBtn.addEventListener('click', handleSetInTime);
        setOutBtn.addEventListener('click', handleSetOutTime);
        pressAndHoldBtn.addEventListener('mousedown', () => {
            // A√±adimos '!' para forzar el color sobre el gris del hover
            pressAndHoldBtn.classList.add('!bg-green-500', '!text-white');
            isPressAndHoldCreating = true;
            handleSetInTime();
        });
        const releasePressAndHold = () => {
             if (isPressAndHoldCreating) {
                // Importante: quitar las mismas clases con '!' que a√±adimos antes
                pressAndHoldBtn.classList.remove('!bg-green-500', '!text-white');
                isPressAndHoldCreating = false;
                handleSetOutTime();
            }
        };
        document.body.addEventListener('mouseup', releasePressAndHold);
        pressAndHoldBtn.addEventListener('mouseleave', releasePressAndHold);
        timeFormatToggle.addEventListener('click', () => {
    timeFormat = timeFormat === 'ms' ? 'frames' : 'ms';
    renderSubtitles(false);
    if(wavesurfer) {
        const currentTime = wavesurfer.getCurrentTime();
        const duration = wavesurfer.getDuration();
        // Actualiza el contador principal
        timecodeDisplay.textContent = formatSrtTime(currentTime);

        // --- L√çNEAS A√ëADIDAS ---
        // Actualiza los contadores de la nueva barra de progreso
        progressTimeCurrent.textContent = formatSrtTime(currentTime);
        progressTimeDuration.textContent = formatSrtTime(duration);
    }
});
        fpsInput.addEventListener('change', (e) => {
            const newFps = parseFloat(e.target.value);
            if (!isNaN(newFps) && newFps > 0) frameRate = newFps;
            if (timeFormat === 'frames') renderSubtitles(false);
        });
        
// ==============================================================
        // === L√ìGICA DEL MEN√ö HERRAMIENTAS (COLAB) ===
        // ==============================================================

        const colabUrls = {
            shots: "https://colab.research.google.com/drive/1bCeP0G84lxv7z9U9yVSHWopOf6AbLVtz?usp=sharing",
            transcription: "https://colab.research.google.com/drive/1LSuFLyzvPz2Empf48nfvNC5GiYL6-SXq",
            spotting: "https://colab.research.google.com/drive/1bre-yN-_eaSO4SHV_bGG0irYP-31bT_A?usp=sharing"
        };

        const openToolModal = (toolType) => {
            let messageKey = '';
            let url = '';

            switch (toolType) {
                case 'shots':
                    messageKey = 'msg_colab_shots';
                    url = colabUrls.shots;
                    break;
                case 'transcription':
                    messageKey = 'msg_colab_transcription';
                    url = colabUrls.transcription;
                    break;
                case 'spotting':
                    messageKey = 'msg_colab_spotting';
                    url = colabUrls.spotting;
                    break;
            }

            // Usamos el modal de confirmaci√≥n existente para mostrar las instrucciones
            showConfirmationModal(t(messageKey), () => {
                window.open(url, 'colab_window', 'width=900,height=700,resizable,scrollbars');
            });
        };

        // Conectar los botones del men√∫
        document.getElementById('tool-shot-change-btn').addEventListener('click', () => openToolModal('shots'));
        document.getElementById('tool-auto-transcription-btn').addEventListener('click', () => openToolModal('transcription'));
        document.getElementById('tool-auto-spotting-btn').addEventListener('click', () => openToolModal('spotting'));

        // ACTUALIZACI√ìN: El bot√≥n antiguo de la interfaz principal ahora usa esta misma funci√≥n
        detectShotsBtn.addEventListener('click', () => openToolModal('shots'));

        // ==============================================================
        // === FIN L√ìGICA HERRAMIENTAS ===
        // ==============================================================

document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); return; }
    if (e.ctrlKey && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); return; }
if (e.target === inVideoEditor && e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); setActiveSubtitle(-1); isUserEditing = false; return; }
    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT' || document.querySelector('.modal[style*="flex"]')) return;
    
    const actionName = Object.keys(shortcuts).find(name => {
        const sc = shortcuts[name];
        return sc.code === e.code && sc.ctrlKey === e.ctrlKey && sc.shiftKey === e.shiftKey && sc.altKey === e.altKey;
    });

    if (actionName) {
        e.preventDefault();
        
const actions = {
    // --- Reproducci√≥n ---
    playPause: handlePlayPause,
    playSelectedSub: () => {
                if (activeSubtitleIndex === -1 || !wavesurfer) return;
                const sub = subtitles[activeSubtitleIndex];

                // 1. Nos aseguramos de que el subt√≠tulo tenga duraci√≥n v√°lida
                if (sub.end <= sub.start) return;

                // 2. Movemos el cabezal al inicio del subt√≠tulo
                wavesurfer.setTime(sub.start);
                
                // 3. Iniciamos la reproducci√≥n
                wavesurfer.play();

                // 4. Creamos un "vigilante" que comprueba el tiempo en cada actualizaci√≥n
                const checkEndTime = (currentTime) => {
                    if (currentTime >= sub.end) {
                        wavesurfer.pause(); // ¬°FRENAR!
                        unsub(); // Dejar de vigilar
                    }
                };

                // 5. Activamos el vigilante
                const unsub = wavesurfer.on('timeupdate', checkEndTime);

                // 6. SEGURIDAD: Si el usuario pausa manualmente antes de terminar,
                // dejamos de vigilar para no causar conflictos futuros.
                wavesurfer.once('pause', () => {
                    unsub();
                });
            },
    // --- Creaci√≥n ---
    setInTime: handleSetInTime,
    setOutTime: handleSetOutTime,
    // --- Sincronizaci√≥n ---
    spottingSetIn: () => {
        if (activeSubtitleIndex === -1) return;
        saveState();
        const sub = subtitles[activeSubtitleIndex];
        sub.start = videoPlayer.currentTime;
        renderSubtitles(true);
    },
    spottingSetOutAndNext: () => {
        if (activeSubtitleIndex === -1) return;
        saveState();
        const sub = subtitles[activeSubtitleIndex];
        sub.end = videoPlayer.currentTime;
        renderSubtitles(true);
        const nextUnsyncedIndex = subtitles.findIndex((s, i) => i > activeSubtitleIndex && s.start < 0);
        setActiveSubtitle(nextUnsyncedIndex !== -1 ? nextUnsyncedIndex : -1, { focusEditor: false });
    },
    spottingHold: () => {
        if (activeSubtitleIndex !== -1 && !isSpottingHoldActive) {
            saveState();
            isSpottingHoldActive = true;
            const sub = subtitles[activeSubtitleIndex];
            sub.start = videoPlayer.currentTime;
            sub.end = sub.start;
            renderSubtitles(true);
        }
    },
    // --- Navegaci√≥n y B√∫squeda ---
    seekBackwardMedium: () => wavesurfer?.skip(-0.5),
    seekForwardMedium: () => wavesurfer?.skip(0.5),
    seekBackwardFrame: () => wavesurfer?.skip(-1 / frameRate),
    seekForwardFrame: () => wavesurfer?.skip(1 / frameRate),
    goToNextSub: () => { if (subtitles.length > 0) setActiveSubtitle((activeSubtitleIndex + 1) % subtitles.length); },
    goToPrevSub: () => { if (subtitles.length > 0) setActiveSubtitle((activeSubtitleIndex - 1 + subtitles.length) % subtitles.length); },
    goToNextUntimed: () => {
        const nextIndex = subtitles.findIndex((s, i) => i > activeSubtitleIndex && s.start < 0);
        if (nextIndex !== -1) setActiveSubtitle(nextIndex);
        else showModalAlert('No hay m√°s subt√≠tulos sin sincronizar.');
    },
    goToLastTimed: () => {
        const lastIndex = subtitles.map(s => s.start >= 0).lastIndexOf(true);
        if (lastIndex !== -1) setActiveSubtitle(lastIndex);
    },
    // --- Edici√≥n ---
    splitSub: () => {
        if (activeSubtitleIndex === -1 || !wavesurfer) return;
        document.getElementById('ctx-menu-split').click();
    },
    mergePrev: () => {
        if (activeSubtitleIndex <= 0) return;
        contextMenuIndex = activeSubtitleIndex;
        document.getElementById('ctx-menu-merge-prev').click();
    },
    mergeNext: () => {
        if (activeSubtitleIndex === -1 || activeSubtitleIndex >= subtitles.length - 1) return;
        contextMenuIndex = activeSubtitleIndex;
        document.getElementById('ctx-menu-merge-next').click();
    },
    // --- Ajuste Fino ---
    nudgeForward: () => {
        const targetIndex = activeSubtitleIndex !== -1 ? activeSubtitleIndex : lastActiveSubtitleIndex;
        if (targetIndex === -1) return;
        saveState();
        subtitles[targetIndex].end += (1 / frameRate);
        if (activeSubtitleIndex === -1) setActiveSubtitle(targetIndex);
        renderSubtitles(true);
    },
    nudgeBackward: () => {
        const targetIndex = activeSubtitleIndex !== -1 ? activeSubtitleIndex : lastActiveSubtitleIndex;
        if (targetIndex === -1) return;
        const sub = subtitles[targetIndex];
        if (sub.end - (1 / frameRate) > sub.start) {
            saveState();
            sub.end -= (1 / frameRate);
            if (activeSubtitleIndex === -1) setActiveSubtitle(targetIndex);
            renderSubtitles(true);
        }
    },

 nudgeStartForward: () => { // NUEVO: Ajusta el INICIO (Alt+X)
                const targetIndex = activeSubtitleIndex !== -1 ? activeSubtitleIndex : lastActiveSubtitleIndex;
                if (targetIndex === -1) return;
                const sub = subtitles[targetIndex];
                if (sub.start + (1 / frameRate) < sub.end) {
                    saveState();
                    sub.start += (1 / frameRate);
                    if (activeSubtitleIndex === -1) setActiveSubtitle(targetIndex);
                    renderSubtitles(true);
                }
            },
            nudgeStartBackward: () => { // NUEVO: Ajusta el INICIO (Alt+Z)
                const targetIndex = activeSubtitleIndex !== -1 ? activeSubtitleIndex : lastActiveSubtitleIndex;
                if (targetIndex === -1) return;
                saveState();
                subtitles[targetIndex].start -= (1 / frameRate);
                if (activeSubtitleIndex === -1) setActiveSubtitle(targetIndex);
                renderSubtitles(true);
            },

    correctInTime: () => {
        const targetIndex = activeSubtitleIndex !== -1 ? activeSubtitleIndex : lastActiveSubtitleIndex;
        if (targetIndex === -1 || !wavesurfer) return;
        saveState();
        subtitles[targetIndex].start = wavesurfer.getCurrentTime();
        if (activeSubtitleIndex === -1) setActiveSubtitle(targetIndex);
        renderSubtitles(true);
    },
    correctOutTime: () => {
                const targetIndex = activeSubtitleIndex !== -1 ? activeSubtitleIndex : lastActiveSubtitleIndex;
                if (targetIndex === -1 || !wavesurfer) return;
                saveState();
                subtitles[targetIndex].end = wavesurfer.getCurrentTime();
                if (activeSubtitleIndex === -1) setActiveSubtitle(targetIndex);
                renderSubtitles(true);
            }, // <-- ¬°PUNTO CLAVE: Aseg√∫rate de que esta coma est√° aqu√≠!
createAndHold: () => {
                if (!isPressAndHoldCreating) {
                    isPressAndHoldCreating = true;
                    // Aqu√≠ tambi√©n a√±adimos '!' para consistencia
                    pressAndHoldBtn.classList.add('!bg-green-500', '!text-white');
                    handleSetInTime();
                }
            },
            // --- L√çNEA A√ëADIDA ---
            createFromSelection: handleCreateSubtitleFromSelection
        };

        if (actions[actionName]) actions[actionName]();
    }
    
});


        document.addEventListener('keyup', (e) => {
            const spottingHoldShortcut = shortcuts.spottingHold;
            
            // L√≥gica para Sincro R√°pida (Spotting Hold)
            if (spottingHoldShortcut && spottingHoldShortcut.code === e.code && isSpottingHoldActive) {
                e.preventDefault();
                if (activeSubtitleIndex !== -1) {
                    const sub = subtitles[activeSubtitleIndex];
                    sub.end = videoPlayer.currentTime;
                    renderSubtitles(true);
                    
                    // Buscar el siguiente subt√≠tulo que no tenga tiempos (start < 0)
                    // Mejorado: Busca a partir del √≠ndice actual para no volver al principio
                    const nextUnsyncedIndex = subtitles.findIndex((s, i) => i > activeSubtitleIndex && s.start < 0);
                    
                    // Si no encuentra uno delante, busca desde el principio (fallback)
                    const targetIndex = nextUnsyncedIndex !== -1 
                        ? nextUnsyncedIndex 
                        : subtitles.findIndex(s => s.start < 0);

                    setActiveSubtitle(targetIndex, { focusEditor: false });
                }
                isSpottingHoldActive = false;
            }

            // L√≥gica para el Bot√≥n Panda (Create on Press / Close on Release)
            if (shortcuts.createAndHold?.code === e.code && isPressAndHoldCreating) {
                e.preventDefault();
                releasePressAndHold();
            }
        });



        // --- L√ìGICA DEL MEN√ö CONTEXTUAL ---
        const setupContextMenuAction = (id, action) => { document.getElementById(id).addEventListener('click', () => { if (contextMenuIndex !== -1) { saveState(); action(); } }); };
        setupContextMenuAction('ctx-menu-delete', () => {
            const sortedIndices = Array.from(selectedSubtitleIndices).sort((a, b) => b - a);
            sortedIndices.forEach(index => subtitles.splice(index, 1));
            selectedSubtitleIndices.clear();
            setActiveSubtitle(-1);
            renderSubtitles(true);
        });
        setupContextMenuAction('ctx-menu-merge-next', () => {
            if (contextMenuIndex < 0 || contextMenuIndex >= subtitles.length - 1) return;
            const current = subtitles[contextMenuIndex], next = subtitles[contextMenuIndex + 1];
            current.end = next.end;
            current.text += (current.text ? "\n" : "") + next.text;
            subtitles.splice(contextMenuIndex + 1, 1);
            if (activeSubtitleIndex === contextMenuIndex + 1) setActiveSubtitle(contextMenuIndex);
            renderSubtitles(true);
        });
        setupContextMenuAction('ctx-menu-merge-prev', () => {
            if (contextMenuIndex <= 0) return;
            const current = subtitles[contextMenuIndex], prev = subtitles[contextMenuIndex - 1];
            prev.end = current.end;
            prev.text += (prev.text ? "\n" : "") + current.text;
            subtitles.splice(contextMenuIndex, 1);
            if (activeSubtitleIndex === contextMenuIndex) setActiveSubtitle(contextMenuIndex - 1);
            renderSubtitles(true);
        });
        setupContextMenuAction('ctx-menu-split', () => {
            const sub = subtitles[contextMenuIndex];
            const splitTime = wavesurfer.getCurrentTime();
            if (splitTime < sub.start || splitTime > sub.end) return showModalAlert(t('alert_head_inside_sub'));
            if (activeSubtitleIndex !== contextMenuIndex) setActiveSubtitle(contextMenuIndex);
            
            // CAMBIO: L√≥gica para obtener la posici√≥n del cursor en un div contenteditable
            const selection = window.getSelection();
            let pos = 0;
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(inVideoEditor);
                preCaretRange.setEnd(range.startContainer, range.startOffset);
                pos = preCaretRange.toString().length;
            }

            const newSub = { id: 'temp', start: splitTime, end: sub.end, text: sub.text.substring(pos), style: sub.style };
            sub.end = splitTime;
            sub.text = sub.text.substring(0, pos);
            subtitles.splice(contextMenuIndex + 1, 0, newSub);
            subtitles.forEach((s, i) => s.id = String(i + 1));
            renderSubtitles(true);
            setActiveSubtitle(contextMenuIndex + 1);
        });
        document.addEventListener('click', () => { contextMenu.classList.add('hidden'); contextMenuIndex = -1; });
        
        const ctxStyleSubmenu = document.getElementById('ctx-style-submenu');
        document.getElementById('ctx-menu-change-style').addEventListener('mouseenter', () => {
            const submenuContainer = ctxStyleSubmenu.querySelector('.menu-item-container');
            submenuContainer.innerHTML = '';
            assStyles.forEach(style => {
                const item = document.createElement('div');
                item.className = 'menu-item';
                item.textContent = style.Name;
                item.onclick = () => {
                    saveState();
                    selectedSubtitleIndices.forEach(index => {
                        subtitles[index].style = style.Name;
                    });
                    renderSubtitles(false);
                    contextMenu.classList.add('hidden');
                };
                submenuContainer.appendChild(item);
            });
            ctxStyleSubmenu.style.display = 'block';
        });
        document.getElementById('ctx-menu-change-style').addEventListener('mouseleave', () => {
            ctxStyleSubmenu.style.display = 'none';
        });

document.getElementById('update-preview-btn').addEventListener('click', (e) => {
    e.preventDefault();
    updateStylePreview();
});

        // --- IMPORTACI√ìN / EXPORTACI√ìN ---
        const timeToSecondsSrt = (t) => { const [h, m, s] = t.replace(',', '.').split(':'); return parseFloat(h) * 3600 + parseFloat(m) * 60 + parseFloat(s); };
        const parseSrt = (content) => {
    const subs = [];
    // Normalizamos saltos de l√≠nea
    const blocks = content.replace(/\r/g, '').trim().split(/\n\s*\n/);
    
    blocks.forEach(block => {
        const lines = block.trim().split('\n');
        // CAMBIO IMPORTANTE: Aceptamos bloques de 2 l√≠neas (ID y Tiempo)
        if (lines.length >= 2) { 
            const timeLine = lines[1];
            // Verificamos que la segunda l√≠nea parezca un c√≥digo de tiempo
            if (timeLine.includes('-->')) {
                const [startStr, endStr] = timeLine.split(' --> ');
                
                // Si hay l√≠neas despu√©s de la 2, son el texto. Si no, texto vac√≠o.
                const textContent = lines.length > 2 ? lines.slice(2).join('\n') : "";
                
                subs.push({ 
                    id: String(subs.length + 1), 
                    start: timeToSecondsSrt(startStr), 
                    end: timeToSecondsSrt(endStr), 
                    text: textContent, 
                    style: 'Default' 
                });
            }
        }
    });
    return subs;
};
        srtLoader.addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
isTranslationMode = false;
                    saveState();
                    subtitles = parseSrt(ev.target.result);
                    renderSubtitles(true);
                    showModalAlert(subtitles.length + " " + t('header_subs').toLowerCase() + " imported."); 
                    // O para hacerlo perfecto en espa√±ol/ingles:
                    showModalAlert(`${subtitles.length} ${currentLang === 'es' ? 'subt√≠tulos importados' : 'subtitles imported'}.`);
                    } catch (err) { showModalAlert('Error al parsear el archivo SRT.'); console.error("SRT Parse Error:", err); }
            };
            reader.readAsText(file);
            e.target.value = '';
        });
        exportSrtBtn.addEventListener('click', () => {
            if (subtitles.length === 0) return showModalAlert('No hay subt√≠tulos para exportar.');
            const srt = subtitles.map((s, i) => `${i + 1}\n${formatSrtTime(s.start)} --> ${formatSrtTime(s.end)}\n${s.text}\n`).join('\n');
            const blob = new Blob([srt], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'subtitulos.srt';
            a.click();
            URL.revokeObjectURL(a.href);
        });
       
const loadProjectData = (jsonData, projectName) => {
    try {
        saveState();
        const data = JSON.parse(jsonData);
        subtitles = data.subtitles || [];
        shotChanges = data.shotChanges || [];
        assStyles = data.assStyles || [createDefaultAssStyle()];
        qaSettings = { ...qaSettings, ...data.qaSettings };
        frameRate = data.frameRate || 25;
        fpsInput.value = frameRate;
        nextSubtitleId = subtitles.length > 0 ? Math.max(...subtitles.map(s => parseInt(s.id, 10) || 0)) + 1 : 1;
        
        renderSubtitles(true);
        renderShotChanges();
        applyColumnVisibility(); // Usamos la nueva funci√≥n de visibilidad
        showModalAlert(`Proyecto "${projectName}" importado.`);
        
        // A√±ade el proyecto a la lista de recientes
        addRecentProject(projectName, jsonData);
    } catch (err) { 
        showModalAlert('Error al cargar el proyecto.'); 
        console.error("Project Load Error:", err); 
    }
};

// --- INICIO: L√≥gica de Proyectos Recientes (Versi√≥n Modal) ---
const loadProjectModal = document.getElementById('load-project-modal');
const openLoadProjectModalBtn = document.getElementById('open-load-project-modal-btn');

const getRecentProjects = () => {
    const recents = localStorage.getItem('subpanda-recent-projects');
    return recents ? JSON.parse(recents) : [];
};

const addRecentProject = (projectName, projectData) => {
    let recents = getRecentProjects();
    recents = recents.filter(p => p.name !== projectName);
    recents.unshift({ name: projectName, data: projectData });
    recents = recents.slice(0, 3);
    localStorage.setItem('subpanda-recent-projects', JSON.stringify(recents));
};

const populateLoadProjectModal = () => {
    const container = document.getElementById('modal-recent-projects-list');
    const recents = getRecentProjects();
    container.innerHTML = '';

    if (recents.length === 0) {
        container.innerHTML = '<p class="no-recent-projects">No hay proyectos recientes.</p>';
        return;
    }

    recents.forEach(project => {
        const item = document.createElement('button');
        item.className = 'recent-project-item';
        item.innerHTML = `<span class="recent-project-item-name">${project.name}</span>`;
        item.title = project.name;
        
        item.addEventListener('click', () => {
            loadProjectModal.style.display = 'none'; 
            // Combinamos la traducci√≥n con el nombre del proyecto
            showConfirmationModal(
                `${t('msg_confirm_load')} ("${project.name}")`, 
                () => loadProjectData(project.data, project.name)
            );
        });
        container.appendChild(item);
    });
};

openLoadProjectModalBtn.addEventListener('click', () => {
    populateLoadProjectModal();
    loadProjectModal.style.display = 'flex';
});

loadProjectModal.querySelector('.close-load-project-modal').addEventListener('click', () => {
    loadProjectModal.style.display = 'none';
});
// --- FIN: L√≥gica de Proyectos Recientes (Versi√≥n Modal) ---

projectLoader.addEventListener('change', (e) => {
    const file = e.target.files[0]; 
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        loadProjectData(ev.target.result, file.name);
        loadProjectModal.style.display = 'none'; // Cierra el modal si se carga desde archivo
    };
    reader.readAsText(file);
    e.target.value = '';
});        

   // --- INICIO: Nueva l√≥gica para Guardar Proyecto con ventana modal ---
const saveProjectModal = document.getElementById('save-project-modal');
const saveProjectFilenameInput = document.getElementById('save-project-filename-input');
const confirmSaveProjectBtn = document.getElementById('confirm-save-project-btn');
const cancelSaveProjectBtn = document.getElementById('cancel-save-project-btn');

exportProjectBtn.addEventListener('click', () => {
    if (subtitles.length === 0 && shotChanges.length === 0) {
        showModalAlert(t('msg_nothing_save'));
        return;
    }
    // Generar un nombre de archivo por defecto y mostrar el modal
    saveProjectFilenameInput.value = `proyecto_subpanda_${new Date().toISOString().slice(0,10)}.json`;
    saveProjectModal.style.display = 'flex';
    saveProjectFilenameInput.focus();
});

confirmSaveProjectBtn.addEventListener('click', () => {
    const projectName = saveProjectFilenameInput.value.trim();
    if (!projectName.endsWith('.json')) {
        showModalAlert(t('msg_json_error'));
        return;
    }
    
    const projectData = JSON.stringify({ subtitles, shotChanges, assStyles, qaSettings, frameRate }, null, 2);
    
    // L√≥gica de descarga
    const blob = new Blob([projectData], { type: 'application/json;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = projectName;
    a.click();
    URL.revokeObjectURL(a.href);
    
    // A√±adir a recientes y cerrar modal
    addRecentProject(projectName, projectData);
    saveProjectModal.style.display = 'none';
});

cancelSaveProjectBtn.addEventListener('click', () => {
    saveProjectModal.style.display = 'none';
});

saveProjectModal.querySelector('.close-save-project-modal').addEventListener('click', () => {
    saveProjectModal.style.display = 'none';
});
// --- FIN: Nueva l√≥gica para Guardar Proyecto ---
        
        // --- MODALES Y VISIBILIDAD ---
        const updateColumnVisibility = () => {
            const toggle = (headerId, colClass, isEnabled) => {
                document.getElementById(headerId).style.display = isEnabled ? '' : 'none';
                document.querySelectorAll(colClass).forEach(c => c.style.display = isEnabled ? '' : 'none');
            };
            toggle('cps-header', '.cps-col', qaSettings.maxCpsEnabled);
            toggle('wpm-header', '.wpm-col', qaSettings.maxWpmEnabled);
        };

       const showModalAlert = (message, titleKey = 'modal_title_notification') => {
            // titleKey ahora busca la traducci√≥n o usa el string si no existe
            const title = t(titleKey) !== titleKey ? t(titleKey) : titleKey;
            alertModal.innerHTML = `<div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">${title}</h2><button class="close-alert-modal text-2xl font-bold">&times;</button></div><p>${message}</p></div>`;
            alertModal.style.display = 'flex';
            alertModal.querySelector('.close-alert-modal').addEventListener('click', () => alertModal.style.display = 'none');
        };

        const showConfirmationModal = (message, onConfirm) => {
            confirmationModal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-xl font-bold mb-4">${t('modal_title_confirmation')}</h2>
                    <p class="mb-6">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="confirm-cancel" class="text-btn">${t('btn_cancel')}</button>
                        <button id="confirm-ok" class="text-btn bg-red-600 hover:bg-red-700">${t('btn_confirm')}</button>
                    </div>
                </div>`;
            confirmationModal.style.display = 'flex';
            document.getElementById('confirm-ok').onclick = () => {
                onConfirm();
                confirmationModal.style.display = 'none';
            };
            document.getElementById('confirm-cancel').onclick = () => {
                confirmationModal.style.display = 'none';
            };
        };

        // --- ACTUALIZACI√ìN: Modal de Ajustes de QA Traducido ---
qaSettingsModalBtn.addEventListener('click', () => {
    const createToggleSwitch = (id, isChecked) => `<label class="toggle-switch"><input type="checkbox" id="${id}-toggle" ${isChecked ? 'checked' : ''}><span class="slider"></span></label>`;
    
    const createSimpleToggleRow = (id, labelKey, descKey, enabled) => `<div><div class="flex justify-between items-center"><label for="${id}-toggle" class="text-sm font-medium">${t(labelKey)}</label>${createToggleSwitch(id, enabled)}</div><p class="qa-rule-description">${t(descKey)}</p></div>`;
    
    const createInputRow = (id, labelKey, descKey, value, enabled, hasUnitSelector = false, unit = 'ms') => `<div><div class="flex justify-between items-center"><label for="${id}-input" class="text-sm font-medium">${t(labelKey)}</label><div class="flex items-center gap-4"><div class="qa-input-group"><input type="number" step="1" id="${id}-input" value="${value}" class="bg-dark-gray border border-light-gray text-sm rounded-lg block w-full p-2.5 qa-input dark-text">${hasUnitSelector ? `<select id="${id}-unit" class="qa-unit-select"><option value="ms" ${unit === 'ms' ? 'selected' : ''}>ms</option><option value="frames" ${unit === 'frames' ? 'selected' : ''}>frames</option></select>` : ''}</div>${createToggleSwitch(id + '-enabled', enabled)}</div></div><p class="qa-rule-description">${t(descKey)}</p></div>`;

    qaSettingsModal.innerHTML = `
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${t('modal_title_qa')}</h2><button class="close-qa-modal text-3xl font-bold hover:text-red-500">&times;</button></div>
            <div class="space-y-6 overflow-y-auto pr-2" style="max-height: 70vh;"> <div class="qa-group"><h3 class="qa-group-title">${t('qa_cat_timing')}</h3><div class="space-y-4">
                    ${createInputRow('min-duration', 'qa_lbl_min_dur', 'qa_desc_min_dur', qaSettings.minDuration, qaSettings.minDurationEnabled, true, qaSettings.minDurationUnit)}
                    ${createInputRow('max-duration', 'qa_lbl_max_dur', 'qa_desc_max_dur', qaSettings.maxDuration, qaSettings.maxDurationEnabled, true, qaSettings.maxDurationUnit)}
                    ${createInputRow('min-gap-frames', 'qa_lbl_min_gap', 'qa_desc_min_gap', qaSettings.minGapFrames, qaSettings.minGapFramesEnabled, false)}
                    ${createSimpleToggleRow('overlap-enabled', 'qa_lbl_overlap', 'qa_desc_overlap', qaSettings.overlapEnabled)}
                </div></div>
                
                <div class="qa-group"><h3 class="qa-group-title">${t('qa_cat_speed')}</h3><div class="space-y-4">
                    ${createInputRow('max-cps', 'qa_lbl_max_cps', 'qa_desc_max_cps', qaSettings.maxCps, qaSettings.maxCpsEnabled)}
                    ${createInputRow('max-wpm', 'qa_lbl_max_wpm', 'qa_desc_max_wpm', qaSettings.maxWpm, qaSettings.maxWpmEnabled)}
                    ${createInputRow('max-cpl', 'qa_lbl_max_cpl', 'qa_desc_max_cpl', qaSettings.maxCpl, qaSettings.maxCplEnabled)}
                    ${createInputRow('max-lines', 'qa_lbl_max_lines', 'qa_desc_max_lines', qaSettings.maxLines, qaSettings.maxLinesEnabled)}
                </div></div>

                <div class="qa-group"><h3 class="qa-group-title">${t('qa_cat_format')}</h3><div class="space-y-4">
                    ${createSimpleToggleRow('tag-errors-enabled', 'qa_lbl_tag_errors', 'qa_desc_tag_errors', qaSettings.tagErrorsEnabled)}
                    ${createSimpleToggleRow('double-spaces-enabled', 'qa_lbl_double_spaces', 'qa_desc_double_spaces', qaSettings.doubleSpacesEnabled)}
                    ${createSimpleToggleRow('space-after-dash-enabled', 'qa_lbl_space_dash', 'qa_desc_space_dash', qaSettings.spaceAfterDashEnabled)}
                    ${createSimpleToggleRow('punctuation-pairs-enabled', 'qa_lbl_punct_pairs', 'qa_desc_punct_pairs', qaSettings.punctuationPairsEnabled)}
                    ${createSimpleToggleRow('lowercase-after-period-enabled', 'qa_lbl_low_period', 'qa_desc_low_period', qaSettings.lowercaseAfterPeriodEnabled)}
                    ${createSimpleToggleRow('space-after-period-enabled', 'qa_lbl_space_period', 'qa_desc_space_period', qaSettings.spaceAfterPeriodEnabled)}
                    ${createSimpleToggleRow('quotes-and-period-enabled', 'qa_lbl_quote_period', 'qa_desc_quote_period', qaSettings.quotesAndPeriodEnabled)}
                </div></div>

                <div class="qa-group"><h3 class="qa-group-title">${t('qa_cat_style')}</h3><div class="space-y-4">
                    ${createSimpleToggleRow('ellipsis-char-enabled', 'qa_lbl_ellipsis', 'qa_desc_ellipsis', qaSettings.ellipsisCharEnabled)}
                    ${createSimpleToggleRow('ellipsis-link-enabled', 'qa_lbl_ellipsis_link', 'qa_desc_ellipsis_link', qaSettings.ellipsisLinkEnabled)}
                    ${createSimpleToggleRow('dialogue-dash-consistency-enabled', 'qa_lbl_dash_cons', 'qa_desc_dash_cons', qaSettings.dialogueDashConsistencyEnabled)}
                    ${createSimpleToggleRow('cardinal-numbers-enabled', 'qa_lbl_cardinals', 'qa_desc_cardinals', qaSettings.cardinalNumbersEnabled)}
                    ${createSimpleToggleRow('semicolon-enabled', 'qa_lbl_semicolon', 'qa_desc_semicolon', qaSettings.semicolonEnabled)}
                    ${createSimpleToggleRow('brackets-enabled', 'qa_lbl_brackets', 'qa_desc_brackets', qaSettings.bracketsEnabled)}
                    ${createSimpleToggleRow('empty-subs-enabled', 'qa_lbl_empty_subs', 'qa_desc_empty_subs', qaSettings.emptySubsEnabled)}
                </div></div>

                <button id="save-qa-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4">${t('btn_save')}</button>
            </div>
        </div>`;
    
    qaSettingsModal.style.display = 'flex';
    
    // L√≥gica de guardado (Esta parte estaba bien en la v5, pero la pongo aqu√≠ completa para asegurar)
    qaSettingsModal.querySelector('.close-qa-modal').addEventListener('click', () => qaSettingsModal.style.display = 'none');
    
    qaSettingsModal.querySelector('#save-qa-btn').addEventListener('click', () => {
        saveState();
        const getVal = (id) => document.getElementById(id).value;
        
        // Esta parte m√°gica ya funcionaba en la v5: escanea todas las claves de qaSettings
        // y busca si existe un toggle con ese nombre. Al haber restaurado el HTML con los IDs correctos,
        // esto volver√° a funcionar autom√°ticamente.
        Object.keys(qaSettings).filter(k => k.endsWith('Enabled')).forEach(key => {
            const id = key.replace(/([A-Z])/g, '-$1').toLowerCase(); // Convierte camelCase a kebab-case
            const toggle = document.getElementById(`${id}-toggle`);
            if (toggle) qaSettings[key] = toggle.checked;
        });

        qaSettings.minDuration = parseInt(getVal('min-duration-input'), 10) || 1000;
        qaSettings.minDurationUnit = getVal('min-duration-unit');
        qaSettings.maxDuration = parseInt(getVal('max-duration-input'), 10) || 7000;
        qaSettings.maxDurationUnit = getVal('max-duration-unit');
        qaSettings.minGapFrames = parseInt(getVal('min-gap-frames-input'), 10) || 2;
        qaSettings.maxCps = parseFloat(getVal('max-cps-input')) || 20;
        qaSettings.maxWpm = parseInt(getVal('max-wpm-input'), 10) || 180;
        qaSettings.maxCpl = parseInt(getVal('max-cpl-input'), 10) || 42;
        qaSettings.maxLines = parseInt(getVal('max-lines-input'), 10) || 2;
        
        qaSettingsModal.style.display = 'none';
        renderSubtitles(false);
        updateColumnVisibility(); // Asegurar que se actualizan las columnas si cambiamos CPS/WPM
    });
});
        
        const formatShortcutForDisplay = (shortcut) => {
            if (!shortcut || !shortcut.code) return 'Ninguno';
            let parts = [];
            if (shortcut.ctrlKey) parts.push('Ctrl');
            if (shortcut.altKey) parts.push('Alt');
            if (shortcut.shiftKey) parts.push('Shift');
            let key = shortcut.code.startsWith('Key') ? shortcut.code.substring(3) : shortcut.code;
            key = key.startsWith('Arrow') ? key.substring(5) : key;
            if (key === 'Backquote') key = '¬∫';
            parts.push(key);
            return parts.join(' + ');
        };

        openShortcutsModal.addEventListener('click', () => {
            tempShortcuts = JSON.parse(JSON.stringify(shortcuts));
            
            const groupTranslations = {
                'Reproducci√≥n y sincronizaci√≥n': { es: 'Reproducci√≥n y sincronizaci√≥n', en: 'Playback & Synchronization' },
                'Creaci√≥n y edici√≥n': { es: 'Creaci√≥n y edici√≥n', en: 'Creation & Editing' },
                'Navegaci√≥n y ajuste fino': { es: 'Navegaci√≥n y ajuste fino', en: 'Navigation & Fine Tuning' }
            };

            let content = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">${t('modal_title_shortcuts')}</h2>
                        <button class="close-shortcuts-modal text-3xl font-bold hover:text-red-500">&times;</button>
                    </div>
                    <div id="shortcuts-list" class="space-y-4 mb-6 overflow-y-auto pr-2" style="max-height: 50vh;">`;

            for (const groupName in shortcutGroups) {
                const translatedGroup = groupTranslations[groupName] ? groupTranslations[groupName][currentLang] : groupName;

                content += `<div>
                                <h3 class="text-lg font-semibold text-gray-400 mb-2">${translatedGroup}</h3>
                                <div class="space-y-2">`;
                
                for (const action in shortcutGroups[groupName]) {
                    const name = t(`sc_name_${action}`);
                    const desc = t(`sc_desc_${action}`);

                    content += `
                        <div class="flex justify-between items-center p-2 bg-dark-gray rounded-lg text-sm">
                            <div>
                                <span>${name}</span>
                                <p class="text-xs text-gray-500">${desc}</p>
                            </div>
                            <input type="text" readonly class="shortcut-input text-sm" id="shortcut-input-${action}" value="${formatShortcutForDisplay(tempShortcuts[action])}" data-action="${action}">
                        </div>`;
                }
                content += `</div></div>`;
            }

            // --- AQU√ç HEMOS A√ëADIDO EL BOT√ìN DE RESTAURAR ---
            content += `</div>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-light-gray">
                         <div>
                            <button id="import-shortcuts-btn" class="text-btn">${t('btn_import_shortcuts')}</button>
                            <button id="export-shortcuts-btn" class="text-btn ml-2">${t('btn_export_shortcuts')}</button>
                            <button id="restore-shortcuts-btn" class="text-btn ml-2 hover:bg-red-900 hover:text-white transition-colors">${t('btn_restore_defaults')}</button> 
                        </div>
                        <button id="save-shortcuts-btn" class="text-btn bg-blue-600 hover:bg-blue-700">${t('btn_save')}</button>
                    </div>
                </div>`;
            shortcutsModal.innerHTML = content;
            shortcutsModal.style.display = 'flex';

            shortcutsModal.querySelector('.close-shortcuts-modal').addEventListener('click', () => shortcutsModal.style.display = 'none');
            
            shortcutsModal.querySelector('#save-shortcuts-btn').addEventListener('click', () => {
                shortcuts = JSON.parse(JSON.stringify(tempShortcuts));
                localStorage.setItem('subpanda-shortcuts', JSON.stringify(shortcuts));
                showModalAlert(t('msg_shortcuts_saved'));
                shortcutsModal.style.display = 'none';
            });
            
            shortcutsModal.querySelector('#export-shortcuts-btn').addEventListener('click', () => {
                const blob = new Blob([JSON.stringify(shortcuts, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'atajos_subpanda.json';
                a.click();
                URL.revokeObjectURL(a.href);
            });
            
            shortcutsModal.querySelector('#import-shortcuts-btn').addEventListener('click', () => shortcutsLoader.click());

            // --- L√ìGICA DEL NUEVO BOT√ìN RESTAURAR ---
            shortcutsModal.querySelector('#restore-shortcuts-btn').addEventListener('click', () => {
                if (confirm(t('msg_confirm_restore'))) {
                    // 1. Copiamos los defaults sobre los temporales
                    tempShortcuts = JSON.parse(JSON.stringify(defaultShortcuts));
                    
                    // 2. Actualizamos visualmente todos los inputs ahora mismo
                    shortcutsModal.querySelectorAll('.shortcut-input').forEach(input => {
                        const action = input.dataset.action;
                        if (tempShortcuts[action]) {
                            input.value = formatShortcutForDisplay(tempShortcuts[action]);
                        }
                    });
                }
            });
            // -----------------------------------------

            shortcutsModal.querySelectorAll('.shortcut-input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    e.preventDefault();
                    const action = e.target.dataset.action;
                    if (e.key === 'Escape') {
                         e.target.value = formatShortcutForDisplay(tempShortcuts[action]);
                         e.target.blur();
                         return;
                    }
                    if (e.key === 'Backspace' || e.key === 'Delete') {
                        tempShortcuts[action] = {};
                    } else {
                        tempShortcuts[action] = {
                            code: e.code,
                            altKey: e.altKey,
                            ctrlKey: e.ctrlKey,
                            shiftKey: e.shiftKey
                        };
                    }
                    e.target.value = formatShortcutForDisplay(tempShortcuts[action]);
                });
                input.addEventListener('focus', (e) => e.target.value = t('input_press_key'));
                input.addEventListener('blur', (e) => e.target.value = formatShortcutForDisplay(tempShortcuts[e.target.dataset.action]));
            });
        });
        
        shortcutsLoader.addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const imported = JSON.parse(ev.target.result);
                    if (Object.keys(imported).every(key => defaultShortcuts.hasOwnProperty(key))) {
                        shortcuts = imported;
                        localStorage.setItem('subpanda-shortcuts', JSON.stringify(shortcuts));
                        showModalAlert(t('msg_shortcuts_imported'));
                        shortcutsModal.style.display = 'none';
                    } else {
                        showModalAlert('El archivo de atajos no es v√°lido.');
                    }
                } catch (err) { showModalAlert(t('msg_shortcuts_error')); }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        window.addEventListener('click', (e) => {
            if (e.target === shortcutsModal) shortcutsModal.style.display = 'none';
            if (e.target === alertModal) alertModal.style.display = 'none';
            if (e.target === qaSettingsModal) qaSettingsModal.style.display = 'none';
            if (e.target === qaReviewModal) qaReviewModal.style.display = 'none';
            if (e.target === backupModal) backupModal.style.display = 'none';
            if (e.target === importTextModal) importTextModal.style.display = 'none';
            if (e.target === confirmationModal) confirmationModal.style.display = 'none';
            if (e.target === pdfNameModal) pdfNameModal.style.display = 'none';
            if (e.target === assStyleEditorModal) assStyleEditorModal.style.display = 'none';
        });

        // --- DETECCI√ìN DE CAMBIOS DE PLANO ---
       
const renderShotChanges = () => {
    if (!wsRegions) return;
    wsRegions.getRegions().filter(r => r.id.startsWith('shot_')).forEach(r => r.remove());
    shotChanges.forEach((time, i) => {
        wsRegions.addRegion({
            id: `shot_${i}`,
            start: time,
            end: time + 0.01,
            color: 'rgba(255, 255, 255, 0.7)',
            attributes: { 'data-shot-change': 'true' },
            drag: false,
            resize: false
        });
    });
};

const detectSceneChangesFFmpeg = async (options = {}) => {
    const videoFile = videoLoader.files[0];
    if (!videoPlayer.src || !videoFile) {
        return showModalAlert(t('msg_load_video_first'));
    }
    const { threshold = 0.4 } = options;
    isDetectionCancelled = false;
    detectShotsBtn.disabled = true;
    progressModal.style.display = 'flex';
    shotDetectionProgressBar.style.width = '0%';
    shotDetectionProgressText.textContent = t('msg_shot_analysis');
    shotChanges = [];

    try {
        if (!ffmpeg) {
            ffmpeg = new FFmpeg.FFmpeg();
            ffmpeg.on('log', ({ message }) => {
                if (message.includes('pts_time:')) {
                    const match = message.match(/pts_time:([\d.]+)/);
                    if (match && match[1]) { shotChanges.push(parseFloat(match[1])); }
                }
            });
            await ffmpeg.load({ coreURL: "https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js" });
        }
        ffmpeg.on('progress', ({ progress }) => {
            const progressPercent = Math.round(progress * 100);
            if (progressPercent > 0 && progressPercent <= 100) {
                 shotDetectionProgressBar.style.width = `${progressPercent}%`;
                 shotDetectionProgressText.textContent = `${t('msg_processing')} ${progressPercent}%`;
            }
        });
        
        shotDetectionProgressText.textContent = t('msg_preparing_file');
        await ffmpeg.writeFile(videoFile.name, await FFmpeg.fetchFile(videoFile));
        
        shotDetectionProgressText.textContent = t('msg_analyzing');
        await ffmpeg.exec(['-i', videoFile.name, '-vf', `select='gt(scene,${threshold})',showinfo`, '-f', 'null', '-']);

        if (!isDetectionCancelled) {
            renderShotChanges();
            showModalAlert(`${shotChanges.length} ${t('alert_shots_detected')}`);
        }
    } catch (err) {
        console.error("Error en detecci√≥n con FFmpeg:", err);
        showModalAlert(t('alert_ffmpeg_error'));
    } finally {
        progressModal.style.display = 'none';
        detectShotsBtn.disabled = false;
    }
};

cancelDetectionBtn.addEventListener('click', () => { 
    isDetectionCancelled = true; 
    if (ffmpeg) {
        // Esta funci√≥n intenta detener el proceso en curso en ffmpeg.wasm
        ffmpeg.terminate();
        ffmpeg = null; // Forzamos la recarga en el pr√≥ximo uso
    }
});

        // --- TOOLTIPS, RESIZERS, DRAG & DROP ---
        const initializeTooltips = () => {
            document.querySelectorAll('[data-tooltip]').forEach(elem => {
                elem.addEventListener('mouseenter', (e) => {
                    const target = e.currentTarget;
                    tooltip.textContent = target.dataset.tooltip;
                    tooltip.style.display = 'block';
                    const rect = target.getBoundingClientRect();
                    let top = rect.bottom + 8, left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2;
                    if (top + tooltip.offsetHeight > window.innerHeight) top = rect.top - tooltip.offsetHeight - 8;
                    if (left < 0) left = 8;
                    if (left + tooltip.offsetWidth > window.innerWidth) left = window.innerWidth - tooltip.offsetWidth - 8;
                    tooltip.style.left = `${left}px`;
                    tooltip.style.top = `${top}px`;
                    setTimeout(() => { tooltip.style.opacity = '1'; tooltip.style.transform = 'scale(1) translateY(0)'; }, 10);
                });
                elem.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = '0';
                    tooltip.style.transform = 'scale(0.95) translateY(10px)';
                    setTimeout(() => { if (tooltip.style.opacity === '0') tooltip.style.display = 'none'; }, 200);
                });
            });
        };
        resizer.addEventListener('mousedown', () => {
            document.addEventListener('mousemove', handlePanelResize);
            document.addEventListener('mouseup', () => document.removeEventListener('mousemove', handlePanelResize), { once: true });
        });
        function handlePanelResize(e) {
            const containerRect = resizer.parentElement.getBoundingClientRect();
            let leftWidth = e.clientX - containerRect.left;
            if (leftWidth < 400) leftWidth = 400;
            if (leftWidth > containerRect.width - 300) leftWidth = containerRect.width - 300;
            const leftPercentage = (leftWidth / containerRect.width) * 100;
            leftPanel.style.width = `${leftPercentage}%`;
            rightPanel.style.width = `${100 - leftPercentage}%`;
        }
        document.body.addEventListener('drop', (e) => {
            e.preventDefault(); e.stopPropagation();
            dragOverlay.classList.remove('visible');
            const file = e.dataTransfer.files[0];
            if (file?.type.startsWith('video/')) loadVideoFile(file);
            else showModalAlert('Por favor, arrastra un archivo de v√≠deo v√°lido.');
        });
        ['dragenter', 'dragover'].forEach(ev => document.body.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dragOverlay.classList.add('visible'); }));
        ['dragleave', 'drop'].forEach(ev => document.body.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dragOverlay.classList.remove('visible'); }));
        
        // --- L√ìGICA DE COPIA DE SEGURIDAD ---
        const saveBackup = () => {
            try {
                const projectData = { subtitles, shotChanges, assStyles, qaSettings, frameRate };
                localStorage.setItem('subpanda-backup', JSON.stringify(projectData));
                localStorage.setItem('subpanda-backup-timestamp', new Date().toISOString());
                updateBackupTimestamp();
            } catch (error) { console.error("Error saving backup:", error); }
        };
        const updateBackupTimestamp = () => {
            const ts = localStorage.getItem('subpanda-backup-timestamp');
            // Usamos t('backup_saved_at') y t('backup_empty')
            lastBackupTimeEl.textContent = ts ? `${t('backup_saved_at')} ${new Date(ts).toLocaleTimeString()}.` : t('backup_empty');
        };
        const getBackupData = () => {
            const json = localStorage.getItem('subpanda-backup');
            if (!json) { showModalAlert('No se encontr√≥ copia de seguridad.'); return null; }
            try { return JSON.parse(json); } 
            catch (e) { showModalAlert('Error al leer la copia de seguridad.'); return null; }
        };
        openBackupModalBtn.addEventListener('click', () => { updateBackupTimestamp(); backupModal.style.display = 'flex'; });
        backupModal.querySelector('.close-backup-modal').addEventListener('click', () => backupModal.style.display = 'none');
        restoreBackupBtn.addEventListener('click', () => {
            const data = getBackupData(); if (!data) return;
            saveState();
            subtitles = data.subtitles || [];
            shotChanges = data.shotChanges || [];
            assStyles = data.assStyles || [createDefaultAssStyle()];
            qaSettings = { ...qaSettings, ...data.qaSettings };
            frameRate = data.frameRate || 25;
            fpsInput.value = frameRate;
            nextSubtitleId = subtitles.length > 1 ? Math.max(...subtitles.map(s => parseInt(s.id, 10))) + 1 : 1;
            renderSubtitles(true);
            renderShotChanges();
            updateColumnVisibility();
            showModalAlert(t('msg_backup_restored'));
            backupModal.style.display = 'none';
        });
        exportBackupJsonBtn.addEventListener('click', () => {
            const data = getBackupData(); if (!data) return;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'backup_subpanda.json';
            a.click();
            URL.revokeObjectURL(a.href);
        });
        exportBackupSrtBtn.addEventListener('click', () => {
            const data = getBackupData();
            if (!data || data.subtitles.length === 0) return showModalAlert(t('alert_no_subs_export'));
            const srt = data.subtitles.sort((a,b) => a.start - b.start).map((s, i) => `${i + 1}\n${formatSrtTime(s.start)} --> ${formatSrtTime(s.end)}\n${s.text}\n`).join('\n');
            const blob = new Blob([srt], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'backup_subtitulos.srt';
            a.click();
            URL.revokeObjectURL(a.href);
        });

        // --- L√ìGICA DE IMPORTACI√ìN DE TEXTO ---
        let previewSubs = [];
        let textImportSearchResults = [];
        let textImportCurrentSearchIndex = -1;

        const updateTextImportPreview = () => {
            const rawText = textImportTextarea.value;
            const separator = textImportDoubleBreak.checked ? /\n\s*\n/ : (textImportSeparator.value || '|');
            
            const blocks = rawText.split(separator).filter(block => block.trim() !== '');
            previewSubs = blocks.map(block => ({ text: block.trim() }));

            textImportPreviewBody.innerHTML = '';
            previewSubs.forEach((sub, index) => {
                const lines = sub.text.split('\n');
                const cpl = lines.map(line => line.length).join(' / ');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2 text-gray-400">${index + 1}</td>
                    <td class="p-2">${sub.text.replace(/\n/g, '<br>')}</td>
                    <td class="p-2 text-center">${lines.length}</td>
                    <td class="p-2 text-center font-mono text-xs">${cpl}</td>
                `;
                textImportPreviewBody.appendChild(row);
            });
        };

        openTextImportModalBtn.addEventListener('click', () => {
            importTextModal.style.display = 'flex';
            updateTextImportPreview();
        });

        importTextModal.querySelector('.close-text-import-modal').addEventListener('click', () => {
            importTextModal.style.display = 'none';
        });

        txtLoader.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                textImportTextarea.value = event.target.result;
                updateTextImportPreview();
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        [textImportTextarea, textImportSeparator].forEach(el => el.addEventListener('input', () => {
            updateTextImportPreview();
            textImportSearchResults = [];
            textImportCurrentSearchIndex = -1;
            updateTextImportSearchCount();
        }));
        textImportDoubleBreak.addEventListener('change', updateTextImportPreview);

        textImportReplaceBtn.addEventListener('click', () => {
            const findText = textImportFind.value;
            const replaceText = textImportReplace.value;
            if (findText && textImportCurrentSearchIndex > -1) {
                const match = textImportSearchResults[textImportCurrentSearchIndex];
                const text = textImportTextarea.value;
                textImportTextarea.value = text.substring(0, match.index) + replaceText + text.substring(match.index + findText.length);
                performTextImportSearch();
            }
        });
        
        textImportReplaceAllBtn.addEventListener('click', () => {
            const findText = textImportFind.value;
            const replaceText = textImportReplace.value;
            if (findText) {
                textImportTextarea.value = textImportTextarea.value.split(findText).join(replaceText);
                updateTextImportPreview();
                textImportSearchResults = [];
                textImportCurrentSearchIndex = -1;
                updateTextImportSearchCount();
            }
        });

        const performTextImportSearch = () => {
            const searchTerm = textImportFind.value;
            const text = textImportTextarea.value;
            textImportSearchResults = [];
            if (!searchTerm) {
                updateTextImportSearchCount();
                return;
            }
            let match;
            const regex = new RegExp(searchTerm, 'gi');
            while ((match = regex.exec(text)) !== null) {
                textImportSearchResults.push({ index: match.index });
            }
            
            if (textImportSearchResults.length > 0) {
                textImportCurrentSearchIndex = 0;
                highlightTextImportMatch();
            } else {
                textImportCurrentSearchIndex = -1;
            }
            updateTextImportSearchCount();
        };

        const highlightTextImportMatch = () => {
            if (textImportCurrentSearchIndex === -1) return;
            const match = textImportSearchResults[textImportCurrentSearchIndex];
            const searchTerm = textImportFind.value;
            textImportTextarea.focus();
            textImportTextarea.setSelectionRange(match.index, match.index + searchTerm.length);
            
            const lineHeight = textImportTextarea.scrollHeight / textImportTextarea.value.split('\n').length;
            const line = textImportTextarea.value.substring(0, match.index).split('\n').length -1;
            textImportTextarea.scrollTop = line * lineHeight;
        };

        const updateTextImportSearchCount = () => {
            if (textImportSearchResults.length === 0) {
                textImportSearchCount.textContent = '0/0';
            } else {
                textImportSearchCount.textContent = `${textImportCurrentSearchIndex + 1}/${textImportSearchResults.length}`;
            }
        };

        textImportSearchBtn.addEventListener('click', performTextImportSearch);
        textImportFind.addEventListener('keydown', (e) => { if (e.key === 'Enter') performTextImportSearch(); });

        textImportNextBtn.addEventListener('click', () => {
            if (textImportSearchResults.length > 0) {
                textImportCurrentSearchIndex = (textImportCurrentSearchIndex + 1) % textImportSearchResults.length;
                highlightTextImportMatch();
                updateTextImportSearchCount();
            }
        });

        textImportPrevBtn.addEventListener('click', () => {
            if (textImportSearchResults.length > 0) {
                textImportCurrentSearchIndex = (textImportCurrentSearchIndex - 1 + textImportSearchResults.length) % textImportSearchResults.length;
                highlightTextImportMatch();
                updateTextImportSearchCount();
            }
        });


        textImportAutosplitBtn.addEventListener('click', () => {
            const text = textImportTextarea.value;
            const maxCpl = qaSettings.maxCpl;
            const separator = textImportSeparator.value || '|';
            
            let result = '';
            const paragraphs = text.split(/\n\s*\n/);
            paragraphs.forEach(p => {
                let currentLine = '';
                let currentSub = [];
                const words = p.replace(/\n/g, ' ').split(' ');
                
                words.forEach(word => {
                    if (currentLine.length + word.length + 1 <= maxCpl) {
                        currentLine += (currentLine ? ' ' : '') + word;
                    } else {
                        currentSub.push(currentLine);
                        currentLine = word;
                    }

                    if (currentSub.length >= qaSettings.maxLines) {
                        result += currentSub.join('\n') + `\n${separator}\n`;
                        currentSub = [];
                    }
                });
                
                if (currentLine) currentSub.push(currentLine);
                if (currentSub.length > 0) result += currentSub.join('\n') + `\n${separator}\n`;
            });

            textImportTextarea.value = result.trim().replace(new RegExp(`\\n${separator.replace(/\|/g, '\\|')}\\n$`), '');
            updateTextImportPreview();
        });

        createSubsFromTextBtn.addEventListener('click', () => {
            if (previewSubs.length === 0) {
            showModalAlert(t('msg_no_preview_subs'));
            return;
            }
            saveState();
            let currentNextId = getNextAvailableId(); // Obtenemos el ID inicial
        const newSubs = previewSubs.map(sub => ({
                id: String(currentNextId++), // Usamos el ID y LUEGO lo incrementamos
                start: -1, // Marcar como no sincronizado
                end: -1,
                text: sub.text,
                style: 'Default'
            }));
            
            subtitles.push(...newSubs);
            renderSubtitles(false); // No renderizar regiones todav√≠a
            showModalAlert(`${previewSubs.length} subt√≠tulos creados. Ahora puedes sincronizarlos.`);
            importTextModal.style.display = 'none';
            setActiveSubtitle(subtitles.length - newSubs.length, { focusEditor: false });
        });

        // --- Resizer para el modal de importaci√≥n de texto ---
        textImportResizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.body.style.cursor = 'row-resize';
            document.addEventListener('mousemove', handleTextImportResize);
            document.addEventListener('mouseup', () => {
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', handleTextImportResize);
            }, { once: true });
        });

        function handleTextImportResize(e) {
            const mainArea = document.getElementById('text-import-main-area');
            const mainAreaRect = mainArea.getBoundingClientRect();
            
            let newTextareaHeight = e.clientY - mainAreaRect.top;

            const minHeight = 100; // M√≠nimo 100px para cada panel
            const resizerHeight = textImportResizer.offsetHeight;
            const controlsHeight = mainArea.querySelector('.flex-shrink-0').offsetHeight;
            const totalHeight = mainArea.clientHeight;

            if (newTextareaHeight < minHeight + controlsHeight) {
                newTextareaHeight = minHeight + controlsHeight;
            }
            if (newTextareaHeight > totalHeight - minHeight - resizerHeight) {
                newTextareaHeight = totalHeight - minHeight - resizerHeight;
            }
            
            const previewHeight = totalHeight - newTextareaHeight - resizerHeight - 12; // Adjusted for margins

            textImportTextarea.style.height = `${newTextareaHeight - controlsHeight - 12}px`;
            textImportPreviewContainer.style.height = `${previewHeight}px`;
        }

        // --- L√≥gica de Modos de Trabajo ---
        const setWorkMode = (mode) => {
            workMode = mode;
            
            // Limpiamos el estado visual de los botones
            modeEditBtn.classList.remove('bg-blue-600');
            modeSyncBtn.classList.remove('bg-blue-600');
            modePreviewBtn.classList.remove('bg-blue-600');

            // --- NUEVO: Gesti√≥n de visibilidad del Preview ASS ---
            // Usamos la clase '!hidden' de Tailwind para forzar la ocultaci√≥n
            // ignorando los estilos inline que pone el renderizador ASS.
            if (mode === 'preview') {
                subtitlePreview.classList.remove('!hidden');
            } else {
                subtitlePreview.classList.add('!hidden');
            }
            // -----------------------------------------------------

            if (mode === 'edit') {
                workModeDisplay.textContent = t('mode_edit');
                modeEditBtn.classList.add('bg-blue-600');
            } else if (mode === 'sync') {
                workModeDisplay.textContent = t('mode_sync');
                modeSyncBtn.classList.add('bg-blue-600');
            } else if (mode === 'preview') {
                workModeDisplay.textContent = t('mode_preview');
                modePreviewBtn.classList.add('bg-blue-600');
                // Al entrar en preview, deseleccionamos el subt√≠tulo actual para ver el v√≠deo limpio
                if (activeSubtitleIndex !== -1) {
                    setActiveSubtitle(-1);
                }
            }
        };

        modeEditBtn.addEventListener('click', () => setWorkMode('edit'));
        modeSyncBtn.addEventListener('click', () => setWorkMode('sync'));
modePreviewBtn.addEventListener('click', () => setWorkMode('preview'));
        
// --- INICIO: L√≥gica de visibilidad de columnas ---
const loadColumnVisibility = () => {
    const saved = localStorage.getItem('subpanda-column-visibility');
    if (saved) {
        columnVisibility = JSON.parse(saved);
    } else {
        // Estado por defecto: todas visibles
        columnConfig.forEach(col => { columnVisibility[col.id] = true; });
    }
};

const saveColumnVisibility = () => {
    localStorage.setItem('subpanda-column-visibility', JSON.stringify(columnVisibility));
};

const applyColumnVisibility = () => {
    columnConfig.forEach(col => {
        const isVisible = columnVisibility[col.id];
        const displayValue = isVisible ? '' : 'none';
        
        const header = document.getElementById(col.headerId);
        if (header) header.style.display = displayValue;

        // Necesitamos ser m√°s espec√≠ficos para aplicar a las celdas correctas
        document.querySelectorAll(`.col-${col.id}`).forEach(cell => {
            cell.style.display = displayValue;
        });
    });
};

const populateColumnsMenu = () => {
    const container = document.getElementById('columns-menu-container');
    container.innerHTML = ''; 
    columnConfig.forEach(col => {
        const item = document.createElement('div');
        item.className = 'menu-item';
        // CORREGIDO: Traducir nombre de columna din√°micamente
        const translatedName = t(`col_name_${col.id}`);
        
        item.innerHTML = `
            <input type="checkbox" id="toggle-col-${col.id}" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded" ${columnVisibility[col.id] ? 'checked' : ''}>
            <label for="toggle-col-${col.id}" class="ml-2 text-sm font-medium text-gray-300 cursor-pointer">${translatedName}</label>
        `;
        
        const checkbox = item.querySelector('input');
        checkbox.addEventListener('change', () => {
            columnVisibility[col.id] = checkbox.checked;
            saveColumnVisibility();
            applyColumnVisibility();
        });
        item.addEventListener('click', (e) => e.stopPropagation());
        container.appendChild(item);
    });
    
    // CORREGIDO: Actualizar el tooltip del bot√≥n principal tambi√©n
    toggleColumnsBtn.dataset.tooltip = t('tooltip_toggle_cols');
};

const makeTableColumnsResizable = () => {
    const table = document.getElementById('subtitle-grid');
    const headers = table.querySelectorAll('th');

    headers.forEach(th => {
        // Si ya tiene resizer, lo borramos para no duplicar
        const existingResizer = th.querySelector('.th-resizer');
        if (existingResizer) existingResizer.remove();

        const resizer = document.createElement('div');
        resizer.className = 'th-resizer';
        th.appendChild(resizer);

        let startX, startWidth;

        const onMouseMove = (e) => {
            if (startX !== undefined) {
                const diff = e.pageX - startX;
                // M√≠nimo 30px para no colapsar la columna
                const newWidth = Math.max(30, startWidth + diff); 
                th.style.width = `${newWidth}px`;
            }
        };

        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            startX = undefined;
            document.body.style.cursor = '';
            // Opcional: Guardar anchos en localStorage aqu√≠ si quisieras persistencia
        };

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation(); // Evita que se ordene la columna si tuviera esa funci√≥n
            startX = e.pageX;
            startWidth = th.offsetWidth;
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.body.style.cursor = 'col-resize';
        });
        
        // Evitar que el click en el resizer se propague al th
        resizer.addEventListener('click', (e) => e.stopPropagation());
    });
};


// --- FIN: L√≥gica de visibilidad de columnas ---


        // --- CONTROLES DE VOLUMEN Y VELOCIDAD ---
        volumeSliderH.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            videoPlayer.volume = volume;
            volumeValue.textContent = `${Math.round(volume * 100)}%`;
        });

zoomSliderH.addEventListener('input', (e) => {
    const zoom = Number(e.target.value);
    if (wavesurfer) wavesurfer.zoom(zoom);
    zoomValue.textContent = zoom;
});       

        speedSliderH.addEventListener('input', (e) => {
            const speedIndex = parseInt(e.target.value, 10);
            const speed = speedLevels[speedIndex];
            videoPlayer.playbackRate = speed;
            speedValue.textContent = `${speed}x`;
        });

        // --- L√ìGICA DE ASS ---
        const timeToSecondsAss = (t) => { const [h, m, s] = t.split(':'); return parseInt(h, 10) * 3600 + parseInt(m, 10) * 60 + parseFloat(s); };
        const formatAssTime = (time) => {
            if (isNaN(time) || time < 0) return '0:00:00.00';
            const hours = Math.floor(time / 3600);
            const minutes = Math.floor((time % 3600) / 60);
            const seconds = Math.floor(time % 60);
            const centiseconds = Math.round((time - Math.floor(time)) * 100);
            return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(centiseconds).padStart(2, '0')}`;
        };

        const parseAss = (content) => {
            const lines = content.replace(/\r/g, '').split('\n');
            let stylesSection = false, eventsSection = false;
            let styleFormat = [], eventFormat = [];
            const parsedStyles = [];
            const parsedSubtitles = [];

            lines.forEach(line => {
                if (line.trim() === '[V4+ Styles]') { stylesSection = true; eventsSection = false; return; }
                if (line.trim() === '[Events]') { eventsSection = true; stylesSection = false; return; }
                if (line.trim().startsWith('[')) { stylesSection = false; eventsSection = false; return; }

                if (stylesSection && line.startsWith('Format:')) {
                    styleFormat = line.substring(8).split(',').map(s => s.trim());
                } else if (stylesSection && line.startsWith('Style:')) {
                    const values = line.substring(7).split(',');
                    const styleObj = {};
                    styleFormat.forEach((key, i) => { styleObj[key] = values[i]?.trim(); });
                    parsedStyles.push(styleObj);
                } else if (eventsSection && line.startsWith('Format:')) {
                    eventFormat = line.substring(8).split(',').map(s => s.trim());
                } else if (eventsSection && line.startsWith('Dialogue:')) {
                    const values = line.substring(10).split(',');
                    const eventObj = {};
                    eventFormat.forEach((key, i) => { eventObj[key] = values[i]?.trim(); });
                    
                    // Re-join text field if it contained commas
                    const textIndex = eventFormat.indexOf('Text');
                    if (textIndex !== -1 && values.length > eventFormat.length) {
                        eventObj.Text = values.slice(textIndex).join(',');
                    }

                    parsedSubtitles.push({
                        id: String(parsedSubtitles.length + 1),
                        start: timeToSecondsAss(eventObj.Start),
                        end: timeToSecondsAss(eventObj.End),
                        text: eventObj.Text.replace(/\\N/g, '\n'),
                        style: eventObj.Style
                    });
                }
            });

            return { styles: parsedStyles, subtitles: parsedSubtitles };
        };

        
// --- INICIO DEL BLOQUE CORREGIDO ---

assLoader.addEventListener('change', (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            // A√ëADE ESTA L√çNEA QUE FALTABA
            isTranslationMode = false; 

            saveState();
            const parsed = parseAss(ev.target.result);
            assStyles = parsed.styles.length > 0 ? parsed.styles : [createDefaultAssStyle()];
            subtitles = parsed.subtitles;
            renderSubtitles(true);
            showModalAlert(`${subtitles.length} subt√≠tulos y ${assStyles.length} estilos importados de .ASS`);
        } catch (err) { showModalAlert('Error al parsear el archivo ASS.'); console.error("ASS Parse Error:", err); }
    };
    reader.readAsText(file);
    e.target.value = '';
});

// ESTE ES EL BLOQUE DEL TRADUCTOR, AHORA EN SU PROPIO SITIO
const translationLoader = document.getElementById('translation-loader');
translationLoader.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            saveState();
            let parsedSubs;
            if (file.name.endsWith('.srt')) {
                parsedSubs = parseSrt(ev.target.result);
            } else if (file.name.endsWith('.ass')) {
                const parsed = parseAss(ev.target.result);
                assStyles = parsed.styles.length > 0 ? parsed.styles : [createDefaultAssStyle()];
                parsedSubs = parsed.subtitles;
            } else {
                showModalAlert('Formato de archivo no soportado para traducci√≥n.');
                return;
            }

            // Activa el modo traducci√≥n y prepara los subt√≠tulos
            isTranslationMode = true;
            subtitles = parsedSubs.map(sub => ({
                ...sub,
                originalText: sub.text,
                text: ''
            }));

            renderSubtitles(true);
            showModalAlert(`Modo Traducci√≥n activado. ${subtitles.length} subt√≠tulos cargados para traducir.`);

        } catch (err) {
            showModalAlert('Error al parsear el archivo para traducir.');
            console.error("Translation Parse Error:", err);
        }
    };
    reader.readAsText(file);
    e.target.value = '';
});

// --- C√ìDIGO A√ëADIDO PARA IMPORTAR CAMBIOS DE PLANO ---
        shotChangeLoader.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const content = ev.target.result;
                    // Limpiamos saltos de l√≠nea de Windows (\r) y separamos por cada l√≠nea
                    const lines = content.replace(/\r/g, '').trim().split('\n');
                    
                    shotChanges = []; // Limpiamos el array existente
                    
                    lines.forEach(line => {
                        // Convertimos la l√≠nea (ej: "10.04") a un n√∫mero
                        const time = parseFloat(line.trim());
                        // Si es un n√∫mero v√°lido, lo a√±adimos
                        if (!isNaN(time) && time >= 0) {
                            shotChanges.push(time);
                        }
                    });
                    
                    // Ordenamos los tiempos por si acaso el .txt viniera desordenado
                    shotChanges.sort((a, b) => a - b); 
                    
                    if (wavesurfer) {
                        // ¬°Esta es tu funci√≥n! La llamamos para que dibuje las l√≠neas
                        renderShotChanges();
                        showModalAlert(`${shotChanges.length} cambios de plano importados y visualizados.`);
                    } else {
                        // Si no hay v√≠deo, los guardamos para cuando se cargue
                        showModalAlert(`${shotChanges.length} cambios de plano importados. Se mostrar√°n al cargar un v√≠deo.`);
                    }

                } catch (err) { 
                    showModalAlert('Error al leer el archivo de cambios de plano.'); 
                    console.error("Shot Change Parse Error:", err); 
                }
            };
            
            reader.readAsText(file);
            e.target.value = ''; // Resetea el input para poder cargar el mismo archivo otra vez
        });
        // --- FIN DEL C√ìDIGO A√ëADIDO ---


// --- FIN DEL BLOQUE CORREGIDO ---



  
        exportAssBtn.addEventListener('click', () => {
            if (subtitles.length === 0) return showModalAlert('No hay subt√≠tulos para exportar.');
            
            const scriptInfo = `[Script Info]
Title: Subpanda Project
ScriptType: v4.00+
WrapStyle: 0
PlayResX: 1280
PlayResY: 720

`;
            const styleHeader = `[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
`;
            const styleLines = assStyles.map(s => `Style: ${Object.values(s).join(',')}`).join('\n');

            const eventHeader = `

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
`;
            const eventLines = subtitles
                .sort((a, b) => a.start - b.start)
                .map(s => `Dialogue: 0,${formatAssTime(s.start)},${formatAssTime(s.end)},${s.style},,0,0,0,,${s.text.replace(/\n/g, '\\N')}`)
                .join('\n');

            const assContent = scriptInfo + styleHeader + styleLines + eventHeader + eventLines;
            const blob = new Blob([assContent], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'subtitulos.ass';
            a.click();
            URL.revokeObjectURL(a.href);
        });

// --- REEMPLAZA LA FUNCI√ìN ANTIGUA POR ESTA VERSI√ìN COMPLETA ---
const applyAssStyleToElement = (element, style, mode = 'full') => {
    if (!element || !style) return;

    element.style.cssText = ''; // Reseteamos estilos anteriores

    // --- ESTILOS B√ÅSICOS (Tipograf√≠a) ---
    element.style.fontFamily = style.Fontname || 'Arial';
    
    // CONFIGURACI√ìN IMPORTANTE: Negrita y Cursiva
    element.style.fontWeight = style.Bold === '-1' ? 'bold' : 'normal';
    element.style.fontStyle = style.Italic === '-1' ? 'italic' : 'normal';

    // Decoraciones (Subrayado / Tachado)
    let textDecorations = [];
    if (style.Underline === '-1') textDecorations.push('underline');
    if (style.StrikeOut === '-1') textDecorations.push('line-through');
    element.style.textDecoration = textDecorations.length > 0 ? textDecorations.join(' ') : 'none';

    // === MODO EDICI√ìN (BASIC) ===
    // Aqu√≠ forzamos un tama√±o c√≥modo para trabajar y reseteamos colores
    if (mode === 'basic') {
        element.style.fontSize = '18px'; // Tama√±o fijo y c√≥modo para editar
        element.style.lineHeight = '1.5';
        element.style.color = 'var(--text-primary)';
        element.style.textAlign = 'center';
        // Opcional: A√±adir un poco de sombra suave para legibilidad sobre v√≠deo
        element.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)'; 
        return; // Terminamos aqu√≠ para el modo edici√≥n
    }

    // === MODO VISTA PREVIA (FULL) ===
    // Aqu√≠ s√≠ aplicamos el tama√±o real del subt√≠tulo y todos los efectos
    
    // 1. Tama√±o y Espaciado Real
    element.style.fontSize = style.Fontsize ? `${style.Fontsize}px` : '28px';
    element.style.letterSpacing = style.Spacing ? `${style.Spacing}px` : 'normal';
    
    // 2. Colores
    element.style.color = assColorToHex(style.PrimaryColour);
    element.style.padding = '0.1em 0.25em'; 

    // 3. Bordes y Sombras (Caja Opaca vs Contorno)
    if (style.BorderStyle === '3') {
        element.style.backgroundColor = assColorToHex(style.OutlineColour);
        element.style.textShadow = 'none';
    } else {
        element.style.backgroundColor = 'transparent';
        let textShadows = [];
        const outlineWidth = parseFloat(style.Outline) || 0;
        if (outlineWidth > 0) {
            const outlineColor = assColorToHex(style.OutlineColour);
            for (let x = -outlineWidth; x <= outlineWidth; x += 0.5) {
                for (let y = -outlineWidth; y <= outlineWidth; y += 0.5) {
                    if (x*x + y*y <= outlineWidth*outlineWidth) {
                        textShadows.push(`${x}px ${y}px 0 ${outlineColor}`);
                    }
                }
            }
        }
        const shadowDepth = parseFloat(style.Shadow) || 0;
        if (shadowDepth > 0) {
            const shadowColor = assColorToHex(style.BackColour);
            textShadows.push(`${shadowDepth}px ${shadowDepth}px 2px ${shadowColor}`);
        }
        if (textShadows.length > 0) element.style.textShadow = textShadows.join(', ');
    }

    // 4. Transformaciones (Escala y Rotaci√≥n)
    let transforms = [];
    const scaleX = (parseFloat(style.ScaleX) || 100) / 100;
    const scaleY = (parseFloat(style.ScaleY) || 100) / 100;
    if (scaleX !== 1 || scaleY !== 1) transforms.push(`scale(${scaleX}, ${scaleY})`);
    
    const angle = parseFloat(style.Angle) || 0;
    if (angle !== 0) transforms.push(`rotate(${angle}deg)`);

    // 5. Posicionamiento
    const alignment = parseInt(style.Alignment, 10);
    const marginL = style.MarginL || '10', marginR = style.MarginR || '10', marginV = style.MarginV || '10';
    
    element.style.position = 'absolute';
    element.style.bottom = 'auto'; element.style.top = 'auto'; 
    element.style.left = 'auto'; element.style.right = 'auto';

    let alignTransforms = [];

    switch (alignment) {
        case 1: element.style.bottom = `${marginV}px`; element.style.left = `${marginL}px`; element.style.textAlign = 'left'; break;
        case 2: element.style.bottom = `${marginV}px`; element.style.left = '50%'; alignTransforms.push('translateX(-50%)'); element.style.textAlign = 'center'; break;
        case 3: element.style.bottom = `${marginV}px`; element.style.right = `${marginR}px`; element.style.textAlign = 'right'; break;
        case 4: element.style.top = '50%'; element.style.left = `${marginL}px`; alignTransforms.push('translateY(-50%)'); element.style.textAlign = 'left'; break;
        case 5: element.style.top = '50%'; element.style.left = '50%'; alignTransforms.push('translate(-50%, -50%)'); element.style.textAlign = 'center'; break;
        case 6: element.style.top = '50%'; element.style.right = `${marginR}px`; alignTransforms.push('translateY(-50%)'); element.style.textAlign = 'right'; break;
        case 7: element.style.top = `${marginV}px`; element.style.left = `${marginL}px`; element.style.textAlign = 'left'; break;
        case 8: element.style.top = `${marginV}px`; element.style.left = '50%'; alignTransforms.push('translateX(-50%)'); element.style.textAlign = 'center'; break;
        case 9: element.style.top = `${marginV}px`; element.style.right = `${marginR}px`; element.style.textAlign = 'right'; break;
        default: element.style.bottom = `${marginV}px`; element.style.left = '50%'; alignTransforms.push('translateX(-50%)'); element.style.textAlign = 'center';
    }

    element.style.transform = [...alignTransforms, ...transforms].join(' ');
};

        // --- L√ìGICA DEL EDITOR DE ESTILOS ASS ---
        let activeStyleName = null;
        const styleForm = document.getElementById('style-form-container');

// --- NUEVA FUNCI√ìN PARA LA VISTA PREVIA EN VIVO ---
        const updateStylePreview = () => {
            const previewElement = document.getElementById('style-preview-text');
            if (!previewElement) return;

            const tempStyle = {};
            const styleKeys = Object.keys(createDefaultAssStyle());
            
            styleKeys.forEach(key => {
                const input = document.getElementById(`style-${key.toLowerCase()}`);
                if (input) {
                    tempStyle[key] = input.value;
                }
            });
            
            // Reutilizamos tu funci√≥n applyAssStyleToElement para la preview
            // El 'full' es importante para que aplique colores y alineaci√≥n
            applyAssStyleToElement(previewElement, tempStyle, 'full');
        };

        // --- FUNCI√ìN 'populateStyleEditor' ACTUALIZADA ---
        const populateStyleEditor = () => {
            styleList.innerHTML = '';
            assStyles.forEach(style => {
                const li = document.createElement('li');
                li.textContent = style.Name;
                li.dataset.styleName = style.Name;
                if (style.Name === activeStyleName) li.classList.add('active');
                li.addEventListener('click', () => {
                    activeStyleName = style.Name;
                    populateStyleEditor(); // Se llama a s√≠ misma para refrescar
                });
                styleList.appendChild(li);
            });

            if (activeStyleName) {
                const style = assStyles.find(s => s.Name === activeStyleName);
                if (style) {
                    // Rellena todos los campos del formulario
                    Object.keys(style).forEach(key => {
                        const inputId = `style-${key.toLowerCase()}`;
                        const input = document.getElementById(inputId);
                        if (input) input.value = style[key];
                        
                        // Sincroniza los selectores de color
                        if (key.toLowerCase().includes('colour')) {
                            const picker = document.getElementById(`${inputId}-picker`);
                            if (picker) picker.value = assColorToHex(style[key]);
                        }
                    });

                    // (NUEVO) Sincronizar el grid de alineaci√≥n visual
                    const alignment = style.Alignment || '2';
                    document.querySelectorAll('.alignment-grid button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.align === alignment);
                    });
                    
                    // (NUEVO) Actualizar la vista previa al cargar
                    updateStylePreview();
                }
            }
        };

      const assColorToHex = (assColor) => {
    if (!assColor || !assColor.startsWith('&H')) return '#FFFFFF';
    // El formato ASS es &H<AA><BB><GG><RR>
    const bbggrr = assColor.substring(assColor.length - 6); // Se obtiene la parte BBGGRR
    const bb = bbggrr.substring(0, 2) || '00';
    const gg = bbggrr.substring(2, 4) || '00';
    const rr = bbggrr.substring(4, 6) || '00';
    return `#${rr}${gg}${bb}`;
};

        const hexToAssColor = (hex) => {
            const r = hex.substring(1, 3);
            const g = hex.substring(3, 5);
            const b = hex.substring(5, 7);
            return `&H00${b.toUpperCase()}${g.toUpperCase()}${r.toUpperCase()}`;
        };

        // --- LISTENER 'openAssStyleEditorBtn' ACTUALIZADO ---
        openAssStyleEditorBtn.addEventListener('click', () => {
            activeStyleName = assStyles[0]?.Name || null;
            populateStyleEditor(); // Esto rellena el formulario y la 1¬™ preview
            assStyleEditorModal.style.display = 'flex';

            // (NUEVO) Enganchamos un listener en el contenedor del formulario
            // para actualizar la vista previa con CUALQUIER cambio.
            const formContainer = document.getElementById('style-form-container');
            
            // Usamos .oninput para que se sobrescriba y no se duplique
            formContainer.oninput = (e) => {
                // Si el cambio viene de un input o select, actualiza la preview
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    // Actualizamos el campo de texto si se usa el picker de color
                    if (e.target.type === 'color') {
                        const textInputId = e.target.id.replace('-picker', '');
                        document.getElementById(textInputId).value = hexToAssColor(e.target.value);
                    }
                    // Actualizamos el picker si se escribe en el campo de texto
                    if (e.target.type === 'text' && e.target.id.includes('colour')) {
                         const pickerId = e.target.id + '-picker';
                         const picker = document.getElementById(pickerId);
                         if (picker) picker.value = assColorToHex(e.target.value);
                    }
                    
                    updateStylePreview(); // Actualiza la preview en vivo
                }
            };
        });

        assStyleEditorModal.querySelector('.close-ass-style-editor-modal').addEventListener('click', () => assStyleEditorModal.style.display = 'none');
        
        document.getElementById('add-new-style-btn').addEventListener('click', () => {
            let newName = 'NuevoEstilo';
            let counter = 1;
            while (assStyles.some(s => s.Name === newName)) {
                newName = `NuevoEstilo${counter++}`;
            }
            const newStyle = { ...assStyles.find(s => s.Name === 'Default') || createDefaultAssStyle(), Name: newName };
            assStyles.push(newStyle);
            activeStyleName = newName;
            populateStyleEditor();
        });

        document.getElementById('delete-style-btn').addEventListener('click', () => {
            if (!activeStyleName || activeStyleName === 'Default') {
                showModalAlert(t('msg_style_delete_error'));
                return;
            }
            assStyles = assStyles.filter(s => s.Name !== activeStyleName);
            // Revert subtitles using this style to Default
            subtitles.forEach(sub => { if (sub.style === activeStyleName) sub.style = 'Default'; });
            activeStyleName = 'Default';
            populateStyleEditor();
            renderSubtitles(false);
        });

  document.getElementById('save-style-changes-btn').addEventListener('click', () => {
    if (!activeStyleName) return;
    saveState();
    const styleIndex = assStyles.findIndex(s => s.Name === activeStyleName);
    if (styleIndex === -1) return;

    const oldName = activeStyleName;
    const newStyle = {};
    const styleKeys = Object.keys(createDefaultAssStyle());
    styleKeys.forEach(key => {
        const input = document.getElementById(`style-${key.toLowerCase()}`);
        if (input) newStyle[key] = input.value;
    });

    if (newStyle.Name !== oldName && assStyles.some(s => s.Name === newStyle.Name)) {
        // En lugar de un alert, usamos el feedback no invasivo
        const feedbackEl = document.getElementById('save-style-feedback');
        feedbackEl.textContent = t('msg_style_exists');
        feedbackEl.style.color = '#f87171'; // Rojo (red-400)
        showFeedbackMessage('save-style-feedback');
        
        // Restaurar el color y texto originales despu√©s
        setTimeout(() => {
            feedbackEl.textContent = t('msg_saved');
            feedbackEl.style.color = '#4ade80'; // Verde (green-400)
        }, 2000);

        newStyle.Name = oldName;
        document.getElementById('style-name').value = oldName;
        return;
    }

    assStyles[styleIndex] = newStyle;

    if (newStyle.Name !== oldName) {
        subtitles.forEach(sub => { if (sub.style === oldName) sub.style = newStyle.Name; });
    }

    activeStyleName = newStyle.Name;
    populateStyleEditor();
    renderSubtitles(false);

    // Esta es la √∫nica l√≠nea que debe ir aqu√≠ para mostrar el aviso:
    showFeedbackMessage('save-style-feedback');
});


document.getElementById('apply-style-to-all-btn').addEventListener('click', () => {
     if (!activeStyleName) return;
     saveState();
     subtitles.forEach(sub => sub.style = activeStyleName);
     renderSubtitles(false);
     showFeedbackMessage('apply-style-feedback');
});


        // Link color pickers to text inputs
        styleForm.querySelectorAll('input[type="color"]').forEach(picker => {
            picker.addEventListener('input', (e) => {
                const textInputId = e.target.id.replace('-picker', '');
                document.getElementById(textInputId).value = hexToAssColor(e.target.value);
            });
        });
        styleForm.querySelectorAll('input[type="text"][id*="colour"]').forEach(textInput => {
            textInput.addEventListener('input', (e) => {
                const pickerId = e.target.id + '-picker';
                const picker = document.getElementById(pickerId);
                if (picker) picker.value = assColorToHex(e.target.value);
            });
        });

// --- INICIO: L√≥gica y conexiones para la barra de Buscar y Reemplazar ---
const findReplaceToolbar = document.getElementById('find-replace-toolbar');
const frBarFindInput = document.getElementById('fr-bar-find-input');
const frBarReplaceInput = document.getElementById('fr-bar-replace-input');
const frBarPrevBtn = document.getElementById('fr-bar-prev-btn');
const frBarNextBtn = document.getElementById('fr-bar-next-btn');
const frBarSearchCount = document.getElementById('fr-bar-search-count');
const frBarReplaceBtn = document.getElementById('fr-bar-replace-btn');
const frBarReplaceAllBtn = document.getElementById('fr-bar-replace-all-btn');
const frBarCloseBtn = document.getElementById('fr-bar-close-btn');
let lastFrBarSearchTerm = '';

let frBarResults = [];
let frBarCurrentIndex = -1;

const highlightFrBarMatch = () => {
    if (frBarCurrentIndex === -1 || frBarResults.length === 0) return;
    const result = frBarResults[frBarCurrentIndex];
    setActiveSubtitle(result.subtitleIndex);

    setTimeout(() => {
        inVideoEditor.focus();
        const selection = window.getSelection();
        const range = document.createRange();
        let charCount = 0;
        for (const node of inVideoEditor.childNodes) {
            if (node.nodeType === Node.TEXT_NODE) {
                const nodeLength = node.textContent.length;
                if (charCount + nodeLength >= result.matchIndex) {
                    range.setStart(node, result.matchIndex - charCount);
                    range.setEnd(node, result.matchIndex - charCount + result.text.length);
                    break;
                }
                charCount += nodeLength;
            } else {
                charCount++;
            }
        }
        selection.removeAllRanges();
        selection.addRange(range);
    }, 100);
};

const performFrBarFind = () => {
    const findText = frBarFindInput.value;
    frBarResults = [];
    frBarCurrentIndex = -1;
    if (!findText) {
        frBarSearchCount.textContent = '0 / 0';
        return;
    }

lastFrBarSearchTerm = findText; // 

    const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    subtitles.forEach((sub, subIndex) => {
        let match;
        while ((match = regex.exec(sub.text)) !== null) {
            frBarResults.push({ subtitleIndex: subIndex, matchIndex: match.index, text: match[0] });
        }
    });
    if (frBarResults.length > 0) {
        frBarCurrentIndex = 0;
        highlightFrBarMatch();
    }
    frBarSearchCount.textContent = `${frBarCurrentIndex + 1} / ${frBarResults.length}`;
};

frBarFindInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        // NOTA: Si la b√∫squeda es la misma, navega. Si es nueva, busca.
        if (frBarFindInput.value === lastFrBarSearchTerm && frBarResults.length > 0) {
            frBarNextBtn.click(); // Simula un clic en el bot√≥n "Siguiente"
        } else {
            performFrBarFind(); // Realiza una nueva b√∫squeda
        }
    }
});
frBarNextBtn.addEventListener('click', () => {
    if (frBarResults.length === 0) return;
    frBarCurrentIndex = (frBarCurrentIndex + 1) % frBarResults.length;
    frBarSearchCount.textContent = `${frBarCurrentIndex + 1} / ${frBarResults.length}`;
    highlightFrBarMatch();
});
frBarPrevBtn.addEventListener('click', () => {
    if (frBarResults.length === 0) return;
    frBarCurrentIndex = (frBarCurrentIndex - 1 + frBarResults.length) % frBarResults.length;
    frBarSearchCount.textContent = `${frBarCurrentIndex + 1} / ${frBarResults.length}`;
    highlightFrBarMatch();
});

frBarReplaceBtn.addEventListener('click', () => {
    if (frBarCurrentIndex === -1 || frBarResults.length === 0) return;
    const result = frBarResults[frBarCurrentIndex];
    const sub = subtitles[result.subtitleIndex];
    const replaceText = frBarReplaceInput.value;
    saveState();
    sub.text = sub.text.substring(0, result.matchIndex) + replaceText + sub.text.substring(result.matchIndex + result.text.length);
    renderSubtitles(false);
    performFrBarFind();
});

frBarReplaceAllBtn.addEventListener('click', () => {
    const findText = frBarFindInput.value;
    const replaceText = frBarReplaceInput.value;
    if (!findText) return;
    saveState();
    let replacementsCount = 0;
    const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    subtitles.forEach(sub => {
        const textBefore = sub.text;
        sub.text = sub.text.replace(regex, replaceText);
        if (sub.text !== textBefore) {
            // Contamos reemplazos reales
            replacementsCount += (textBefore.match(regex) || []).length;
        }
    });
    renderSubtitles(false);
    showModalAlert(`${replacementsCount} reemplazos realizados.`);
    findReplaceToolbar.classList.remove('visible');
});

// Conectar bot√≥n del men√∫ principal para mostrar/ocultar la barra
openFindReplaceModalBtn.addEventListener('click', () => {
    findReplaceToolbar.classList.toggle('visible');
    if (findReplaceToolbar.classList.contains('visible')) {
        frBarFindInput.focus();
    }
});
frBarCloseBtn.addEventListener('click', () => {
    findReplaceToolbar.classList.remove('visible');
});
// --- FIN: L√≥gica y conexiones para la barra de Buscar y Reemplazar ---

        // --- INICIALIZACI√ìN FINAL ---

loadColumnVisibility();
applyColumnVisibility();
makeTableColumnsResizable();
populateColumnsMenu();
        loadShortcuts();
        initializeTooltips();
        updateColumnVisibility();
        setWorkMode('edit');

        setInterval(saveBackup, 60000); // Guardar copia de seguridad cada minuto

// --- L√≥gica para los botones de Negrita y Cursiva del men√∫ Editar ---
const boldBtn = document.getElementById('edit-menu-bold-btn');
const italicBtn = document.getElementById('edit-menu-italic-btn');

const applyFormat = (format) => {
    inVideoEditor.focus(); // Nos aseguramos de que el foco est√° en el editor
    document.execCommand(format, false, null);
};

boldBtn.addEventListener('click', () => applyFormat('bold'));
italicBtn.addEventListener('click', () => applyFormat('italic'));

// NOTA: Los atajos Ctrl+B y Ctrl+I suelen funcionar de forma nativa en los navegadores para estas acciones.



// --- L√≥gica COMPLETA para la ventana de A√±adir S√≠mbolo con categor√≠as ---
const openSymbolModalBtn = document.getElementById('open-symbol-modal-btn');
const symbolModal = document.getElementById('symbol-modal');
const symbolCategoriesContainer = document.getElementById('symbol-categories');
const symbolGrid = document.getElementById('symbol-grid');

const symbolMap = {
    'M√°s comunes': ['‚Ä¶', '‚Äî', '‚Äò', '‚Äô', '‚Äú', '‚Äù', '¬´', '¬ª', '¬°', '¬ø', '‚ô™', '‚ô´'],
    'Moneda y legal': ['‚Ç¨', '¬£', '¬•', '$', '¬¢', '¬©', '¬Æ', '‚Ñ¢', '¬ß', '¬∞'],
    'Puntuaci√≥n y diacr√≠ticos': ['.', ',', ';', ':', '?', '!', '"', '(', ')', '[', ']', '{', '}', '/', '\\', '&', '@', '#', '%', '*', '-', '_', '+', '=', '¬∑', '¬®', '¬¥', '`', '¬∏', 'ÀÜ'],
    'Letras con acento (A-G)': ['√Å', '√Ä', '√Ç', '√Ñ', '√É', '√Ö', '√Ü', '√°', '√†', '√¢', '√§', '√£', '√•', '√¶', '√á', '√ß', '√â', '√à', '√ä', '√ã', '√©', '√®', '√™', '√´', '√ç', '√å', '√é', '√è'],
    'Letras con acento (H-Z)': ['√≠', '√¨', '√Æ', '√Ø', '√ë', '√±', '√ì', '√í', '√î', '√ñ', '√ï', '√ò', '√≥', '√≤', '√¥', '√∂', '√µ', '√∏', '√ö', '√ô', '√õ', '√ú', '√∫', '√π', '√ª', '√º', '√ù', '√Ω', '√ø', '√ü'],
    'Matem√°ticas y fracciones': ['¬π', '¬≤', '¬≥', '¬º', '¬Ω', '¬æ', '√ó', '√∑', '¬±', '‚â†', '‚âà', '‚â§', '‚â•', '‚àû', '¬µ', 'Œ£', 'Œ†', '‚àö', '‚à´', '∆í']
};

const populateSymbolGrid = (category) => {
    symbolGrid.innerHTML = '';
    const chars = symbolMap[category];
    if (!chars) return;

    chars.forEach(char => {
        const button = document.createElement('button');
        button.className = 'symbol-button';
        button.textContent = char;
        button.onclick = () => {
            inVideoEditor.focus();
            document.execCommand('insertText', false, char);
        };
        symbolGrid.appendChild(button);
    });
};

// Primero, mapeamos el nombre interno a la clave de traducci√≥n
const symbolCategoryKeys = {
    'M√°s comunes': 'sym_cat_common',
    'Moneda y legal': 'sym_cat_currency',
    'Puntuaci√≥n y diacr√≠ticos': 'sym_cat_punct',
    'Letras con acento (A-G)': 'sym_cat_accents_1',
    'Letras con acento (H-Z)': 'sym_cat_accents_2',
    'Matem√°ticas y fracciones': 'sym_cat_math'
};

const populateSymbolCategories = () => {
    symbolCategoriesContainer.innerHTML = '';
    Object.keys(symbolMap).forEach((categoryName, index) => {
        const button = document.createElement('button');
        button.className = 'category-button';
        // AQU√ç EST√Å EL CAMBIO: Usamos la clave para traducir
        button.textContent = t(symbolCategoryKeys[categoryName] || categoryName);
        
        if (index === 0) button.classList.add('active');

        button.onclick = () => {
            symbolCategoriesContainer.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            populateSymbolGrid(categoryName);
        };
        symbolCategoriesContainer.appendChild(button);
    });
};

openSymbolModalBtn.addEventListener('click', () => {
    populateSymbolCategories();
    // Poblar la rejilla con la primera categor√≠a por defecto
    const firstCategory = Object.keys(symbolMap)[0];
    populateSymbolGrid(firstCategory);
    symbolModal.style.display = 'flex';
});

symbolModal.querySelector('.close-symbol-modal').addEventListener('click', () => {
    symbolModal.style.display = 'none';
});

window.addEventListener('click', (e) => {
    if (e.target === symbolModal) symbolModal.style.display = 'none';
});

// --- L√≥gica COMPLETA y CORREGIDA de la barra de progreso personalizada ---
let isScrubbing = false;
let wasPlaying = false; // Para saber si hay que reanudar la reproducci√≥n

const handleScrub = (e) => {
    if (!wavesurfer || !wavesurfer.getDuration()) return;
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const percentage = Math.max(0, Math.min(1, clickX / rect.width));
    wavesurfer.seekTo(percentage);
};

progressBar.addEventListener('mousedown', (e) => {
    isScrubbing = true;
    wasPlaying = wavesurfer.isPlaying(); // Guardamos el estado antes de pausar
    wavesurfer.pause(); // Pausamos para un control preciso al arrastrar
    handleScrub(e);
});

document.addEventListener('mousemove', (e) => {
    if (isScrubbing) {
        handleScrub(e);
    }
});

document.addEventListener('mouseup', () => {
    if (isScrubbing) {
        isScrubbing = false;
        if (wasPlaying) {
            wavesurfer.play(); // Reanudamos la reproducci√≥n si estaba activa
        }
    }
});

// L√≥gica para la etiqueta de tiempo (tooltip) al pasar el rat√≥n
customProgressBarContainer.addEventListener('mouseenter', () => {
    // A√ëADIDO: Comprueba si hay un modal abierto
    const isModalOpen = !!document.querySelector('.modal[style*="flex"]');
    if (isModalOpen) return; // Si hay un modal, no mostrar el tooltip

    if (wavesurfer && wavesurfer.getDuration()) {
        tooltip.style.display = 'block';
    }
});

customProgressBarContainer.addEventListener('mouseleave', () => {
    tooltip.style.opacity = '0';
    tooltip.style.transform = 'scale(0.95) translateY(10px)';
    setTimeout(() => { if (tooltip.style.opacity === '0') tooltip.style.display = 'none'; }, 200);
});

customProgressBarContainer.addEventListener('mousemove', (e) => {
    // A√ëADIDO: Comprueba si hay un modal abierto
    const isModalOpen = !!document.querySelector('.modal[style*="flex"]');
    if (isModalOpen) {
        tooltip.style.display = 'none'; // Nos aseguramos de ocultarlo
        return; // Salimos de la funci√≥n
    }
    if (!wavesurfer || !wavesurfer.getDuration() || isScrubbing) return;

    const rect = progressBar.getBoundingClientRect();
    const hoverX = e.clientX - rect.left;
    const percentage = Math.max(0, Math.min(1, hoverX / rect.width));
    const hoverTime = percentage * wavesurfer.getDuration();

    tooltip.textContent = formatSrtTime(hoverTime);

    const rectContainer = customProgressBarContainer.getBoundingClientRect();
    let top = rectContainer.top - tooltip.offsetHeight - 5; // 5px por encima de la barra
    let left = e.clientX - tooltip.offsetWidth / 2;

    if (left < 0) left = 8;
    if (left + tooltip.offsetWidth > window.innerWidth) left = window.innerWidth - tooltip.offsetWidth - 8;

    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;

    setTimeout(() => {
        tooltip.style.opacity = '1';
        tooltip.style.transform = 'scale(1) translateY(0)';
    }, 10);
});

// --- NUEVO LISTENER PARA EL GRID DE ALINEACI√ìN ---
        assStyleEditorModal.querySelectorAll('.alignment-grid button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault(); // Evita que el bot√≥n env√≠e un formulario
                const newAlign = e.currentTarget.dataset.align;
                
                // Actualiza el input oculto
                document.getElementById('style-alignment').value = newAlign;
                
                // Actualiza la UI de los botones
                assStyleEditorModal.querySelectorAll('.alignment-grid button').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.currentTarget.classList.add('active');
                
                // Actualiza la vista previa
                updateStylePreview();
            });
        });

newProjectBtn.addEventListener('click', () => {
    // Comprueba si hay subt√≠tulos en el proyecto actual
    if (subtitles.length > 0) {
        // Si hay progreso, muestra una ventana de confirmaci√≥n
        showConfirmationModal(
            t('msg_confirm_new'), // Usa la clave del diccionario
            () => {
                // Esta funci√≥n se ejecuta solo si el usuario pulsa "Confirmar"
                createNewProject();
            }
        );
    } else {
        // Si no hay progreso, crea el nuevo proyecto directamente
        createNewProject();
    }
   });
    
   // --- Inicializar idioma al cargar ---
    changeLanguage('en');

   });

    </script>
</body>
</html>
